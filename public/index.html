<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<title>Visual Novel</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',system-ui,sans-serif;background:#0b0b1a;color:#eaeaea;user-select:none;-webkit-touch-callout:none}
#rotate{display:none;position:fixed;inset:0;background:#0b0b1a;z-index:9999;flex-direction:column;align-items:center;justify-content:center;gap:20px}
#rotate .ri{font-size:56px;animation:rr 2s ease-in-out infinite}
@keyframes rr{0%,100%{transform:rotate(0)}50%{transform:rotate(90deg)}}
#rotate p{font-size:17px;color:#7878a0}
@media(orientation:portrait)and(max-width:900px){#rotate{display:flex}#app{display:none!important}}
#loader{position:fixed;inset:0;background:#0b0b1a;z-index:9998;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;transition:opacity .5s}
.spinner{width:42px;height:42px;border:3px solid #2a2a50;border-top-color:#e94560;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#loader.hide{opacity:0;pointer-events:none}
#app{width:100vw;height:100vh;position:relative}
.scr{display:none;position:absolute;top:0;left:0;width:100%;height:100%}.scr.on{display:flex}
#S-menu{flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#0b0b1a,#161630,#1a1040);gap:20px}
#m-title{font-size:clamp(26px,5vw,58px);font-weight:900;letter-spacing:3px;text-align:center;text-transform:uppercase;padding:0 20px;background:linear-gradient(135deg,#e94560,#ff6b81);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#menu-status{text-align:center;min-height:24px}
.st-ok{color:#4ecca3;font-size:14px}.st-no{color:#e94560;font-size:14px}
.bplay{padding:16px 64px;font-size:20px;font-weight:700;background:#e94560;color:#fff;border:none;border-radius:50px;cursor:pointer;letter-spacing:2px;text-transform:uppercase}
.bplay:disabled{opacity:.4;cursor:not-allowed}
.bgear{position:absolute;top:14px;right:14px;width:44px;height:44px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);border-radius:12px;color:#7878a0;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}
#S-wait{flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#0b0b1a,#0d1520,#0b0b1a);gap:16px;overflow:hidden}
#w-pepe{position:absolute;bottom:10px;left:10px;width:clamp(80px,15vw,140px);cursor:pointer;filter:drop-shadow(0 0 10px rgba(100,200,100,.3));transition:transform .2s;z-index:5}
#w-pepe:active{transform:scale(.9) rotate(-5deg)}
#w-phrase{position:absolute;bottom:clamp(100px,18vw,160px);left:10px;background:rgba(30,30,60,.95);border:2px solid #4ecca3;border-radius:12px;padding:10px 18px;color:#4ecca3;font-size:clamp(12px,1.5vw,16px);font-weight:600;opacity:0;transition:opacity .3s;z-index:5;max-width:250px;pointer-events:none}
#w-phrase.show{opacity:1}
#w-msg{font-size:clamp(14px,2.2vw,24px);text-align:center;color:#a0a0c0;max-width:80%;line-height:1.6;padding:0 20px}
#w-timer{font-size:clamp(24px,4vw,52px);font-weight:900;letter-spacing:4px;color:#fff;text-shadow:0 0 20px rgba(233,69,96,.4)}
#w-timer-sub{font-size:clamp(11px,1.4vw,16px);color:#7878a0;margin-top:-8px}
#w-play{padding:14px 50px;font-size:18px;font-weight:700;background:linear-gradient(135deg,#4ecca3,#39ffdc);color:#000;border:none;border-radius:50px;cursor:pointer;letter-spacing:1px;margin-top:10px}
#w-back{position:absolute;top:12px;left:12px;padding:6px 14px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:8px;color:#aaa;font-size:13px;cursor:pointer;z-index:5}
#S-game{flex-direction:column!important}
#g-top{flex:1;position:relative;overflow:hidden;background:#1a1a3e}
#g-bg{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;background-color:#1a1a3e}
#g-char{position:absolute;bottom:0;height:85%;max-width:40%;object-fit:contain;pointer-events:none;display:none}
#g-char.vis{display:block}#g-char.pl{left:3%}#g-char.pc{left:50%;transform:translateX(-50%)}#g-char.pr{right:3%;left:auto}
.bbk{position:absolute;top:8px;left:8px;z-index:5;padding:6px 14px;background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.2);border-radius:8px;color:#fff;font-size:13px;cursor:pointer}
#g-dlg{flex-shrink:0;background:#0a0a28;border-top:3px solid #e94560;padding:16px 28px 14px;min-height:130px;cursor:pointer;position:relative}
#g-name{display:inline-block;padding:4px 16px;background:#e94560;border-radius:6px;font-size:15px;font-weight:700;color:#fff;margin-bottom:6px}
#g-name:empty{display:none}
#g-txt{font-size:17px;line-height:1.7;color:#fff;white-space:pre-wrap;min-height:36px}
#g-ind{position:absolute;bottom:10px;right:18px;color:rgba(255,255,255,.4);font-size:13px;animation:bk 1.4s infinite}
@keyframes bk{0%,100%{opacity:1}50%{opacity:.2}}
#g-choices{position:absolute;top:0;left:0;right:0;bottom:0;z-index:20;display:none;flex-direction:column;align-items:center;justify-content:center;gap:12px;background:rgba(0,0,0,.6)}
#g-choices.on{display:flex}
.chb{padding:14px 44px;min-width:260px;max-width:80%;background:rgba(20,20,50,.95);border:2px solid #e94560;border-radius:12px;color:#fff;font-size:16px;cursor:pointer;text-align:center}
#g-end{position:absolute;top:0;left:0;right:0;bottom:0;z-index:25;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.88);gap:30px}
#g-end.on{display:flex}#g-end h2{font-size:36px;color:#e94560}
#S-boss{flex-direction:row!important;background:#0a0a1e;position:relative;overflow:hidden}
#bf-bg{position:absolute;inset:0;background:radial-gradient(ellipse at 30% 50%,#1a0a2e,#0a0a1e 70%);z-index:0}
#bf-opp{position:relative;z-index:1;width:28%;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding-bottom:10px}
#bf-opp img{max-height:80%;max-width:90%;object-fit:contain;filter:drop-shadow(0 0 20px rgba(57,255,220,.3));animation:bfBob .5s ease-in-out infinite}
@keyframes bfBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
#bf-opp .oname{color:#39ffdc;font-size:clamp(12px,1.5vw,18px);font-weight:700}
#bf-lanes{position:relative;z-index:1;flex:1;display:flex;align-items:stretch;justify-content:center}
#bf-canvas{width:100%;height:100%}
#bf-hud{position:absolute;top:0;left:0;right:0;z-index:10;display:flex;align-items:center;padding:8px 16px;gap:12px;background:linear-gradient(to bottom,rgba(0,0,0,.7),transparent)}
#bf-song-name{color:#39ffdc;font-size:clamp(11px,1.3vw,16px);font-weight:600;min-width:100px}
#bf-hbar{flex:1;height:20px;background:#1a1a3e;border-radius:10px;border:2px solid #333;overflow:hidden}
#bf-hfill{height:100%;width:50%;background:linear-gradient(90deg,#e94560,#4ecca3);border-radius:8px;transition:width .3s}
#bf-score-txt{font-size:clamp(14px,1.8vw,22px);font-weight:700;color:#fff;min-width:80px;text-align:right}
#bf-combo-txt{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(28px,4vw,56px);font-weight:900;color:#fff;opacity:0;z-index:5;pointer-events:none}
#bf-combo-txt.show{opacity:1;animation:bfPop .4s ease-out}
@keyframes bfPop{0%{transform:translate(-50%,-50%) scale(1.5);opacity:0}50%{opacity:1}100%{transform:translate(-50%,-50%) scale(1)}}
#bf-rating-txt{position:absolute;top:35%;left:50%;transform:translate(-50%,-50%);font-size:clamp(20px,3vw,40px);font-weight:900;opacity:0;z-index:5;pointer-events:none}
#bf-rating-txt.show{animation:bfRate .6s ease-out forwards}
@keyframes bfRate{0%{opacity:0;transform:translate(-50%,-50%) scale(2)}20%{opacity:1;transform:translate(-50%,-50%) scale(1)}80%{opacity:1}100%{opacity:0;transform:translate(-50%,-70%)}}
#bf-ctrl{position:absolute;bottom:0;left:0;right:0;z-index:10;display:flex;justify-content:center;gap:8px;padding:8px;background:linear-gradient(to top,rgba(0,0,0,.5),transparent)}
.bf-btn{width:clamp(50px,12vw,80px);height:clamp(50px,12vw,80px);border-radius:12px;border:3px solid;font-size:clamp(20px,3vw,32px);cursor:pointer;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.4)}
.bf-btn:active{transform:scale(.9)}
.bf-btn.l{border-color:#c24b99;color:#c24b99}.bf-btn.d{border-color:#00ffff;color:#00ffff}.bf-btn.u{border-color:#12fa05;color:#12fa05}.bf-btn.r{border-color:#f9393f;color:#f9393f}
#bf-countdown{position:absolute;inset:0;z-index:30;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8);font-size:clamp(60px,10vw,120px);font-weight:900;color:#fff}
#bf-countdown.on{display:flex}
#bf-result{position:absolute;inset:0;z-index:30;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.9);gap:20px}
#bf-result.on{display:flex}
#bf-result h2{font-size:clamp(28px,5vw,52px);font-weight:900}
#bf-result .stats{color:#7878a0;font-size:clamp(14px,2vw,20px);text-align:center;line-height:2}
.win{color:#4ecca3}.lose{color:#e94560}
/* UNDERTALE */
#S-ut{flex-direction:column!important;background:#000;position:relative;overflow:hidden}
#ut-phase-indicator{position:absolute;top:4px;right:8px;font-family:'Courier New',monospace;font-size:clamp(10px,1.5vw,13px);color:#666;z-index:20}
.ut-phase2 #ut-opp-img{filter:drop-shadow(0 0 12px rgba(255,50,50,.6)) hue-rotate(20deg)!important}
.ut-phase3 #ut-opp-img{filter:drop-shadow(0 0 16px rgba(200,0,255,.7)) hue-rotate(60deg) brightness(1.2)!important}
.ut-phase4 #ut-opp-img{filter:drop-shadow(0 0 20px rgba(255,0,0,.9)) saturate(2) brightness(1.4)!important;animation:utP4pulse .5s ease-in-out infinite!important}
.ut-phase5 #ut-opp-img{filter:drop-shadow(0 0 24px rgba(255,0,200,.9)) saturate(2) brightness(1.6)!important;animation:utP4pulse .3s ease-in-out infinite!important}
#ut-phase-indicator.p5{color:#ff00cc;font-size:16px;font-weight:900;text-shadow:0 0 10px #ff00cc;animation:bk .5s infinite}
@keyframes utP4pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
#ut-top{display:flex;align-items:center;justify-content:center;padding:6px 10px;flex-shrink:0;height:18%;position:relative;min-height:60px;max-height:110px}
#ut-opp{display:flex;flex-direction:row;align-items:center;gap:10px}
#ut-opp img{max-height:clamp(48px,12vh,90px);max-width:clamp(48px,10vw,90px);object-fit:contain;image-rendering:pixelated;filter:drop-shadow(0 0 8px rgba(255,255,255,.2))}
#ut-opp-name{color:#fff;font-size:clamp(11px,1.8vw,18px);font-weight:700;font-family:'Courier New',monospace}
#ut-dlg{position:absolute;left:50%;bottom:2px;transform:translateX(-50%);background:#000;border:2px solid #fff;border-radius:10px;padding:6px 14px;color:#fff;font-family:'Courier New',monospace;font-size:clamp(11px,1.4vw,15px);max-width:75%;min-width:160px;display:none;line-height:1.4;z-index:15;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#ut-dlg.show{display:block}
#ut-mid{flex:1;display:flex;align-items:center;justify-content:center;position:relative;min-height:0}
#ut-box{position:relative;border:3px solid #fff;background:#000;overflow:hidden}
#ut-heart{position:absolute;width:18px;height:18px;z-index:5;transition:none}
#ut-heart::before{content:'‚ù§';color:#ff0000;font-size:16px;line-height:18px;display:block;text-align:center}
.ut-proj{position:absolute;border-radius:50%;z-index:3}
.ut-bone{position:absolute;z-index:3}
.ut-beam{position:absolute;z-index:4;opacity:0}
.ut-beam.warn{opacity:.3;background:rgba(255,255,255,.3)}
.ut-beam.fire{opacity:1;background:#fff}
#ut-bot{flex-shrink:0;padding:4px 12px 6px;background:#000}
#ut-hp{display:flex;align-items:center;gap:8px;margin-bottom:5px;font-family:'Courier New',monospace}
#ut-hp-label{color:#fff;font-size:clamp(11px,1.4vw,15px);font-weight:700}
#ut-hp-bar{flex:1;max-width:220px;height:16px;background:#300;border:2px solid #600;position:relative}
#ut-hp-fill{height:100%;background:#ff0;transition:width .3s}
#ut-hp-txt{color:#fff;font-size:clamp(10px,1.2vw,13px);font-family:'Courier New',monospace;min-width:55px}
#ut-actions{display:flex;justify-content:center;gap:clamp(6px,2vw,20px)}
.ut-act{padding:clamp(6px,1.2vw,12px) clamp(12px,2.5vw,30px);background:#000;border:3px solid #f00;color:#f00;font-family:'Courier New',monospace;font-size:clamp(12px,1.6vw,18px);font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:1px}
.ut-act:hover,.ut-act.sel{background:#f00;color:#fff}
#ut-atk-bar{display:none;margin-top:5px;position:relative;height:24px;background:#000;border:2px solid #fff;overflow:hidden}
#ut-atk-bar.show{display:block}
#ut-atk-cursor{position:absolute;top:0;width:4px;height:100%;background:#0f0}
#ut-atk-zone{position:absolute;top:0;height:100%;background:rgba(255,255,255,.15);border-left:2px solid #fff;border-right:2px solid #fff}
#ut-result{position:absolute;inset:0;z-index:30;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.95);gap:20px}
#ut-result.on{display:flex}
#ut-result h2{font-size:clamp(28px,5vw,52px);font-weight:900;font-family:'Courier New',monospace}
#ut-result .stats{color:#7878a0;font-size:clamp(14px,2vw,20px);text-align:center;line-height:2;font-family:'Courier New',monospace}
.ut-bbk{position:absolute;top:8px;left:8px;z-index:30;padding:6px 14px;background:rgba(0,0,0,.8);border:1px solid rgba(255,255,255,.3);border-radius:8px;color:#fff;font-size:13px;cursor:pointer}
#ut-turn-txt{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(16px,2.5vw,28px);font-weight:900;color:#fff;font-family:'Courier New',monospace;opacity:0;z-index:10;pointer-events:none}
#ut-turn-txt.show{opacity:1;animation:utFade 1s ease-out forwards}
@keyframes utFade{0%{opacity:0;transform:translate(-50%,-50%) scale(1.5)}20%{opacity:1;transform:translate(-50%,-50%) scale(1)}80%{opacity:1}100%{opacity:0}}
#ut-dmg{position:absolute;z-index:10;font-size:clamp(20px,3vw,36px);font-weight:900;font-family:'Courier New',monospace;pointer-events:none;opacity:0}
#ut-dmg.show{animation:utDmg .8s ease-out forwards}
@keyframes utDmg{0%{opacity:0;transform:translateY(0)}20%{opacity:1}100%{opacity:0;transform:translateY(-40px)}}
#ut-phase-overlay{position:absolute;inset:0;z-index:20;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.85);font-family:'Courier New',monospace;font-size:clamp(20px,3vw,36px);color:#fff;font-weight:900}
#ut-phase-overlay.on{display:flex}
#ut-totem-overlay{position:fixed;inset:0;z-index:100000;display:none;align-items:center;justify-content:center;flex-direction:column;gap:20px;background:rgba(0,0,0,.92)}
#ut-totem-overlay.on{display:flex}
#ut-totem-skull{font-size:80px;filter:drop-shadow(0 0 30px gold);animation:totemGlow 1s ease-in-out infinite;transition:font-size .5s}
@keyframes totemGlow{0%,100%{filter:drop-shadow(0 0 30px gold) brightness(1)}50%{filter:drop-shadow(0 0 60px gold) brightness(1.5)}}
#ut-totem-text{font-family:'Courier New',monospace;font-size:20px;color:gold;text-shadow:0 0 15px gold}
#ut-totem-rays{position:absolute;width:300px;height:300px;background:radial-gradient(circle,rgba(255,215,0,.3) 0%,transparent 70%);border-radius:50%;animation:totemRays 1s ease-out forwards}
@keyframes totemRays{0%{transform:scale(0);opacity:1}100%{transform:scale(4);opacity:0}}
.ut-sword{position:absolute;font-size:28px;z-index:6;pointer-events:none;filter:drop-shadow(0 0 8px rgba(255,100,100,.6))}
.ut-gun{position:absolute;font-size:24px;z-index:6;pointer-events:none;filter:drop-shadow(0 0 8px rgba(255,200,0,.6))}
.ut-bullet{position:absolute;width:6px;height:6px;background:#ff0;border-radius:50%;z-index:5}
.ut-laser{position:absolute;width:20px;height:20px;z-index:6;border-radius:3px;transition:background .3s,box-shadow .3s}
.ut-laser.blue{background:#42a5f5;box-shadow:0 0 12px #42a5f5}
.ut-laser.orange{background:#ffa726;box-shadow:0 0 12px #ffa726}
.ut-bomb-warn{position:absolute;border-radius:50%;border:2px dashed rgba(255,0,0,.5);z-index:4;animation:bombWarn .5s ease-in-out infinite}
@keyframes bombWarn{0%,100%{opacity:.3}50%{opacity:.8}}
.ut-bomb-explode{position:absolute;border-radius:50%;background:rgba(255,50,0,.7);z-index:4;animation:bombExpl .3s ease-out}
@keyframes bombExpl{0%{transform:scale(0);opacity:1}100%{transform:scale(1);opacity:.7}}
.ut-knife{position:absolute;width:4px;height:18px;background:linear-gradient(to bottom,#fff,#ccc);z-index:5;border-radius:1px}
.ut-knife.up{transform:rotate(180deg)}
.ut-reverse-hint{position:absolute;bottom:5px;left:50%;transform:translateX(-50%);font-family:'Courier New',monospace;font-size:11px;color:#ff0;z-index:10;animation:bk 1s infinite}
@keyframes sansFly{0%,100%{transform:translateY(0) rotate(-5deg)}25%{transform:translateY(-6px) rotate(0)}50%{transform:translateY(-10px) rotate(5deg)}75%{transform:translateY(-4px) rotate(2deg)}}
@keyframes papFly{0%,100%{transform:translateY(0) rotate(3deg)}50%{transform:translateY(-8px) rotate(-3deg)}}
/* CHESS BOSS */
#S-chess{flex-direction:row!important;background:#000;position:relative;overflow:hidden}
#cb-board-wrap{position:relative;flex:1;display:flex;align-items:center;justify-content:center;overflow:hidden;min-width:0}
#cb-board{width:100%;height:100%;display:block}
#cb-side{width:clamp(160px,34%,280px);flex-shrink:0;display:flex;flex-direction:column;align-items:center;padding:6px 8px;gap:5px;background:rgba(0,5,20,.95);border-left:1px solid rgba(0,255,200,.15);overflow:hidden}
#cb-boss-cvs{flex-shrink:0;display:block}
#cb-bname{font-family:'Courier New',monospace;font-size:clamp(10px,1.4vw,14px);color:#00ffcc;font-weight:700;text-align:center;letter-spacing:1px}
#cb-bhpw{display:flex;align-items:center;gap:4px;width:100%;font-family:'Courier New',monospace;font-size:10px;color:#7878a0}
#cb-bhpbar{flex:1;height:10px;background:#020818;border:1px solid #0a3030;border-radius:3px;overflow:hidden}
#cb-bhpfill{height:100%;background:linear-gradient(90deg,#00ffcc,#00aaff);transition:width .4s;border-radius:3px}
#cb-bhptxt{min-width:46px;text-align:right;font-size:9px;color:#7878a0;font-family:'Courier New',monospace}
#cb-dlg{font-family:'Courier New',monospace;font-size:clamp(9px,1.1vw,12px);color:#cce;text-align:left;min-height:28px;padding:4px 8px;background:rgba(0,255,200,.04);border-radius:5px;border:1px solid rgba(0,255,200,.1);width:100%;line-height:1.5;word-break:break-word}
#cb-acts{display:flex;gap:5px;flex-shrink:0}
.cb-btn{padding:clamp(5px,.9vw,9px) clamp(8px,1.3vw,14px);background:rgba(0,0,0,.8);border:2px solid #00ffcc;color:#00ffcc;font-family:'Courier New',monospace;font-size:clamp(10px,1.2vw,13px);font-weight:700;cursor:pointer;border-radius:5px;white-space:nowrap}
.cb-btn:disabled{opacity:.25;cursor:not-allowed}.cb-btn:hover:not(:disabled){background:#00ffcc;color:#000}
#cb-timing{width:100%;height:18px;background:#000;border:2px solid #fff;position:relative;overflow:hidden;display:none;flex-shrink:0}
#cb-timing.show{display:block}
#cb-tz{position:absolute;top:0;height:100%;background:rgba(255,255,255,.18);border-left:2px solid #fff;border-right:2px solid #fff}
#cb-tc{position:absolute;top:0;width:3px;height:100%;background:#0f0}
#cb-phpw{position:absolute;bottom:4px;left:6px;right:6px;display:flex;align-items:center;gap:4px;font-family:'Courier New',monospace;font-size:10px;color:#f66;z-index:10;pointer-events:none}
#cb-phpbar{flex:1;height:10px;background:#1a0000;border:1px solid #500;border-radius:3px;overflow:hidden}
#cb-phpfill{height:100%;background:linear-gradient(90deg,#f00,#f90);transition:width .3s;border-radius:3px}
#cb-phptxt{min-width:46px;text-align:right;font-size:9px;color:#f88;font-family:'Courier New',monospace}
#cb-phase-ind{position:absolute;top:5px;left:50%;transform:translateX(-50%);font-family:'Courier New',monospace;font-size:clamp(9px,1.2vw,12px);color:#00ffcc;z-index:20;letter-spacing:2px;pointer-events:none}
#cb-overlay-phase{position:absolute;inset:0;z-index:25;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.88);font-family:'Courier New',monospace;font-size:clamp(18px,3.5vw,44px);color:#00ffcc;font-weight:900;text-shadow:0 0 30px #00ffcc;letter-spacing:4px;flex-direction:column;gap:12px}
#cb-overlay-phase.on{display:flex}
#cb-result{position:absolute;inset:0;z-index:30;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.96);gap:18px}
#cb-result.on{display:flex}
#cb-rtitle{font-size:clamp(26px,5vw,50px);font-weight:900;font-family:'Courier New',monospace}
#cb-rstats{color:#7878a0;font-size:clamp(12px,1.8vw,18px);text-align:center;line-height:2;font-family:'Courier New',monospace}
/* DEV */
#S-dev{flex-direction:column;background:#0b0b1a}
.dh{display:flex;align-items:center;padding:10px 18px;background:#161630;border-bottom:1px solid #2a2a50;gap:14px;flex-shrink:0}.dh h1{font-size:17px;flex:1}
.dtabs{display:flex;background:#161630;border-bottom:1px solid #2a2a50;flex-shrink:0;overflow-x:auto}
.dt{padding:11px 20px;font-size:13px;color:#7878a0;cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap}.dt.on{color:#e94560;border-bottom-color:#e94560}
.dc{flex:1;overflow-y:auto;padding:20px}
.dgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:15px}
.dcard{background:#161630;border:1px solid #2a2a50;border-radius:12px;overflow:hidden;cursor:pointer}
.dcimg{width:100%;height:115px;background:#101028;background-size:cover;background-position:center}
.dcinf{padding:11px}.dcn{font-size:14px;font-weight:600;margin-bottom:3px}.dcs{font-size:12px;color:#7878a0}
.dcadd{display:flex;align-items:center;justify-content:center;min-height:165px;border-style:dashed;flex-direction:column;gap:8px}
.dcadd .ico{font-size:34px;color:#7878a0}.dcadd span{font-size:13px;color:#7878a0}
.dcard.start{border-color:#4ecca3}.dcard.start .dcs{color:#4ecca3}
.steps{display:flex;flex-direction:column;gap:12px;margin-top:10px}
.si{background:#101028;border:1px solid #2a2a50;border-radius:10px;padding:14px}
.sih{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.sin{font-size:12px;color:#e94560;font-weight:700}.sia{display:flex;gap:5px}
.sia button{width:27px;height:27px;background:rgba(255,255,255,.07);border:1px solid #2a2a50;border-radius:6px;color:#7878a0;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.sf{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.sf .fw{grid-column:1/-1}
.sf label{font-size:11px;color:#7878a0;margin-bottom:4px;display:block}
.sf input,.sf textarea,.sf select{width:100%;padding:8px 10px;background:#0b0b1a;border:1px solid #2a2a50;border-radius:6px;color:#eaeaea;font-size:13px;outline:0;font-family:inherit}
.sf textarea{min-height:48px;resize:vertical}
.csec{margin-top:10px;padding-top:10px;border-top:1px solid #2a2a50}
.crow{display:flex;gap:7px;margin-bottom:8px;align-items:center}.crow input{flex:1}.crow select{width:130px}
.crow input,.crow select{padding:7px 9px;background:#0b0b1a;border:1px solid #2a2a50;border-radius:6px;color:#eaeaea;font-size:12px;outline:0}
.crow button{width:27px;height:27px;background:rgba(233,69,96,.15);border:1px solid #e94560;border-radius:6px;color:#e94560;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.cbtog{display:flex;align-items:center;gap:8px;margin-top:10px}
.cbtog input[type=checkbox]{width:17px;height:17px;accent-color:#e94560}
.cbtog label{font-size:13px;margin:0;cursor:pointer}
.bsm{padding:5px 13px;background:rgba(255,255,255,.07);border:1px solid #2a2a50;border-radius:6px;color:#7878a0;font-size:12px;cursor:pointer;margin-top:6px}
.setsec{background:#161630;border:1px solid #2a2a50;border-radius:12px;padding:20px;margin-bottom:16px}.setsec h3{font-size:16px;margin-bottom:12px}
.bfsec{background:rgba(57,255,220,.05);border:1px solid rgba(57,255,220,.2);border-radius:10px;padding:14px;margin-top:12px}.bfsec h4{color:#39ffdc;font-size:13px;margin-bottom:10px}
.audio-info{display:flex;align-items:center;gap:10px;margin-top:8px;padding:8px 12px;background:rgba(57,255,220,.08);border-radius:8px;font-size:13px;color:#39ffdc}
.audio-info .ai-name{flex:1}
.audio-info button{padding:4px 12px;background:rgba(255,255,255,.1);border:1px solid #2a2a50;border-radius:6px;color:#eaeaea;font-size:12px;cursor:pointer}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
.modal.on{display:flex}
.mbox{background:#161630;border:1px solid #2a2a50;border-radius:16px;padding:28px;min-width:300px;max-width:92vw;max-height:90vh;overflow-y:auto}
.mbox h2{margin-bottom:18px;font-size:19px;display:flex;align-items:center;justify-content:space-between}
.mx{background:0;border:0;color:#7878a0;font-size:22px;cursor:pointer}
.mlg{width:90vw;max-width:820px}
.fg{margin-bottom:15px}
.fg label{display:block;font-size:11px;color:#7878a0;margin-bottom:5px;font-weight:600;text-transform:uppercase;letter-spacing:.8px}
.fg input,.fg textarea,.fg select{width:100%;padding:10px 13px;background:#101028;border:1px solid #2a2a50;border-radius:8px;color:#eaeaea;font-size:14px;outline:0;font-family:inherit}
.fg textarea{min-height:60px;resize:vertical}
.ipv{width:100%;max-height:130px;object-fit:contain;border-radius:8px;margin-top:8px;background:#101028}
.fbtn{display:inline-block;padding:8px 20px;background:rgba(255,255,255,.08);border:1px solid #2a2a50;border-radius:8px;color:#eaeaea;font-size:14px;cursor:pointer}
.bp{padding:10px 24px;background:#e94560;color:#fff;border:0;border-radius:8px;font-size:14px;cursor:pointer}
.bs{padding:10px 24px;background:rgba(255,255,255,.08);color:#eaeaea;border:1px solid #2a2a50;border-radius:8px;font-size:14px;cursor:pointer}
.bd{padding:10px 24px;background:0;color:#e94560;border:1px solid #e94560;border-radius:8px;font-size:14px;cursor:pointer}
.brow{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.err-msg{color:#e94560;font-size:13px}
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(100px);padding:14px 28px;border-radius:10px;font-size:15px;font-weight:600;z-index:5000;transition:transform .3s;pointer-events:none;max-width:90vw;text-align:center}
#toast.show{transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
<div id="rotate"><div class="ri">üì±</div><p>–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ</p></div>
<div id="loader"><div class="spinner"></div><div style="color:#7878a0;font-size:15px">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></div>
<div id="app">
<div id="S-menu" class="scr on">
  <button class="bgear" onclick="openCode()">üîß</button>
  <h1 id="m-title">Visual Novel</h1>
  <div id="menu-status"></div>
  <button class="bplay" id="btn-play" onclick="startGame()">–ò–≥—Ä–∞—Ç—å</button>
</div>
<div id="S-wait" class="scr">
  <button id="w-back" onclick="scr('S-menu')">‚Üê –ù–∞–∑–∞–¥</button>
  <img id="w-pepe" src="https://i.postimg.cc/d019wCRm/1645078923-3-abrakadabra-fun-p-malenkii-lyagushonok-pepe-10-removebg-preview.png" alt="" onclick="pepeTap()">
  <div id="w-phrase"></div>
  <div id="w-msg">–û—É, –ø–æ—Ö–æ–∂–µ –ù–µ–π—Ä–æ–Ω–∫–∞ –∏–≥—Ä–∞–µ—Ç —Å –∫–æ—à–∫–æ–π!<br>–í—ã –≤–µ–¥—å –Ω–µ —Å—Ç–∞–Ω–µ—Ç–µ –µ–º—É –º–µ—à–∞—Ç—å?..</div>
  <div id="w-timer">--:--:--</div>
  <div id="w-timer-sub">–¥–æ –∑–∞–ø—É—Å–∫–∞</div>
  <button id="w-play" onclick="startTrialUT()">‚öîÔ∏è –ü—Ä–æ–±–Ω—ã–π –±–æ–π</button>
</div>
<div id="S-game" class="scr">
  <div id="g-top"><div id="g-bg"></div><img id="g-char" src="" alt=""><button class="bbk" onclick="toMenu()">‚Üê –ú–µ–Ω—é</button></div>
  <div id="g-dlg" onclick="advance()"><div id="g-name"></div><div id="g-txt"></div><div id="g-ind">‚ñº</div></div>
  <div id="g-choices"></div>
  <div id="g-end"><h2>–ö–æ–Ω–µ—Ü</h2><button class="bplay" onclick="toMenu()" style="font-size:16px;padding:12px 44px">–í –º–µ–Ω—é</button></div>
</div>
<div id="S-boss" class="scr">
  <div id="bf-bg"></div>
  <div id="bf-opp"><img id="bf-opp-img" src="" alt=""><div class="oname" id="bf-opp-name"></div></div>
  <div id="bf-lanes"><canvas id="bf-canvas"></canvas></div>
  <div id="bf-hud"><div id="bf-song-name"></div><div id="bf-hbar"><div id="bf-hfill"></div></div><div id="bf-score-txt">0</div></div>
  <div id="bf-combo-txt"></div><div id="bf-rating-txt"></div>
  <div id="bf-ctrl">
    <button class="bf-btn l" onpointerdown="bfHit(0)">‚Üê</button>
    <button class="bf-btn d" onpointerdown="bfHit(1)">‚Üì</button>
    <button class="bf-btn u" onpointerdown="bfHit(2)">‚Üë</button>
    <button class="bf-btn r" onpointerdown="bfHit(3)">‚Üí</button>
  </div>
  <div id="bf-countdown"></div>
  <div id="bf-result"><h2 id="bf-res-title"></h2><div class="stats" id="bf-res-stats"></div><button class="bplay" id="bf-res-btn" style="font-size:16px;padding:12px 44px"></button></div>
</div>
<div id="S-ut" class="scr">
  <button class="ut-bbk" onclick="utGoBack()">‚Üê –ù–∞–∑–∞–¥</button>
  <div id="ut-phase-indicator"></div>
  <div id="ut-top">
    <div id="ut-opp"><img id="ut-opp-img" src="" alt=""><div id="ut-opp-name"></div></div>
    <div id="ut-dlg"></div>
  </div>
  <div id="ut-mid">
    <div id="ut-box"><div id="ut-heart"></div></div>
    <div id="ut-turn-txt"></div><div id="ut-dmg"></div>
    <div id="ut-phase-overlay"></div>
  </div>
  <div id="ut-bot">
    <div id="ut-hp"><span id="ut-hp-label">HP</span><div id="ut-hp-bar"><div id="ut-hp-fill"></div></div><span id="ut-hp-txt">92/92</span></div>
    <div id="ut-actions"><button class="ut-act" onclick="utAction('fight')">‚öî Fight</button></div>
    <div id="ut-atk-bar"><div id="ut-atk-zone"></div><div id="ut-atk-cursor"></div></div>
  </div>
  <div id="ut-result"><h2 id="ut-res-title"></h2><div class="stats" id="ut-res-stats"></div><button class="bplay" id="ut-res-btn" style="font-size:16px;padding:12px 44px;font-family:'Courier New',monospace"></button></div>
</div>
<div id="S-dev" class="scr">
  <div class="dh"><button class="bs" onclick="toMenu()" style="padding:7px 14px;font-size:13px">‚Üê –ù–∞–∑–∞–¥</button><h1>–ü–∞–Ω–µ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</h1></div>
  <div class="dtabs"><div class="dt on" onclick="dTab('bg',this)">üñº –§–æ–Ω—ã</div><div class="dt" onclick="dTab('ch',this)">üë§ –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</div><div class="dt" onclick="dTab('sc',this)">üìú –°—Ü–µ–Ω—ã</div><div class="dt" onclick="dTab('set',this)">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div></div>
  <div class="dc" id="dc"></div>
</div>
</div>
<div id="S-chess" class="scr">
  <button class="ut-bbk" onclick="cbBack()">‚Üê –ù–∞–∑–∞–¥</button>
  <div id="cb-phase-ind"></div>
  <div id="cb-board-wrap"><canvas id="cb-board"></canvas></div>
  <div id="cb-side">
    <canvas id="cb-boss-cvs"></canvas>
    <div id="cb-bname">SYSTEM.exe</div>
    <div id="cb-bhpw"><span>HP</span><div id="cb-bhpbar"><div id="cb-bhpfill"></div></div><span id="cb-bhptxt"></span></div>
    <div id="cb-dlg">> ...</div>
    <div id="cb-acts">
      <button class="cb-btn" onclick="cbAct('atk')">‚öî –ê—Ç–∞–∫–∞</button>
      <button class="cb-btn" onclick="cbAct('move')">‚ôû –•–æ–¥</button>
    </div>
    <div id="cb-timing"><div id="cb-tz"></div><div id="cb-tc"></div></div>
  </div>
  <div id="cb-phpw"><span>‚ù§</span><div id="cb-phpbar"><div id="cb-phpfill"></div></div><span id="cb-phptxt"></span></div>
  <div id="cb-overlay-phase"></div>
  <div id="cb-result">
    <h2 id="cb-rtitle"></h2>
    <div id="cb-rstats"></div>
    <button class="bplay" id="cb-rbtn" style="font-size:15px;padding:12px 40px;font-family:monospace"></button>
  </div>
</div>
<div class="modal" id="M-code"><div class="mbox"><h2>–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞</h2><div class="fg"><label>–ö–æ–¥</label><input type="password" id="i-code" maxlength="10"></div><div class="err-msg" id="code-err" style="display:none">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥</div><div class="brow"><button class="bp" onclick="checkCode()">–í–æ–π—Ç–∏</button><button class="bs" onclick="hideM('M-code')">–û—Ç–º–µ–Ω–∞</button></div></div></div>
<div class="modal" id="M-bg"><div class="mbox mlg"><h2><span id="bg-t">–§–æ–Ω</span><button class="mx" onclick="hideM('M-bg')">‚úï</button></h2><div class="fg"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="bg-name"></div><div class="fg"><label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label><label class="fbtn">üìÅ<input type="file" accept="image/*" id="bg-file" style="display:none" onchange="pvF(this,'bg-pv',1920,1080,false,'_bgD')"></label><img id="bg-pv" class="ipv" style="display:none"></div><div class="brow"><button class="bp" onclick="saveBg()">OK</button><button class="bd" id="bg-del" style="display:none" onclick="delBg()">–£–¥–∞–ª–∏—Ç—å</button></div></div></div>
<div class="modal" id="M-ch"><div class="mbox mlg"><h2><span id="ch-t">–ü–µ—Ä—Å–æ–Ω–∞–∂</span><button class="mx" onclick="hideM('M-ch')">‚úï</button></h2><div class="fg"><label>–ò–º—è</label><input id="ch-name"></div><div class="fg"><label>–°–ø—Ä–∞–π—Ç</label><label class="fbtn">üìÅ<input type="file" accept="image/*" id="ch-file" style="display:none" onchange="pvF(this,'ch-pv',600,900,true,'_chD')"></label><img id="ch-pv" class="ipv" style="display:none"></div><div class="brow"><button class="bp" onclick="saveCh()">OK</button><button class="bd" id="ch-del" style="display:none" onclick="delCh()">–£–¥–∞–ª–∏—Ç—å</button></div></div></div>
<div class="modal" id="M-sc"><div class="mbox mlg" style="max-height:88vh"><h2><span id="sc-t">–°—Ü–µ–Ω–∞</span><button class="mx" onclick="hideM('M-sc')">‚úï</button></h2><div id="sc-ed"></div></div></div>
<div id="toast"></div>
<div id="ut-totem-overlay"><div id="ut-totem-rays"></div><div id="ut-totem-skull">üíÄ</div><div id="ut-totem-text"></div></div>
<script>
var CODE='050412',isAdmin=false;
var TARGET=new Date('2026-03-01T00:00:00+03:00').getTime();
var D={title:'Visual Novel',bgs:[],chars:[],scenes:[],start:null};
var curTab='bg',editId=null,eScData=null;
window._bgD=null;window._chD=null;
var G={sid:null,step:0,typing:false,timer:null,full:''};

function $(id){return document.getElementById(id)}
function uid(){return'i'+Date.now()+'_'+Math.random().toString(36).substr(2,6)}
function esc(s){if(!s)return'';var d=document.createElement('div');d.textContent=s;return d.innerHTML}
function api(m,b){var o={method:m,headers:{'Content-Type':'application/json'}};if(b)o.body=JSON.stringify(b);return fetch('/api/data',o).then(function(r){return r.json()}).catch(function(){return null})}
function loadData(){return api('GET').then(function(d){if(d){D=d;D.title=D.title||'Visual Novel';D.bgs=D.bgs||[];D.chars=D.chars||[];D.scenes=D.scenes||[];return true}return false})}
function save(){return api('POST',D).then(function(ok){if(!ok)toast('–û—à–∏–±–∫–∞!',1);return!!ok})}
function scr(id){var a=document.querySelectorAll('.scr');for(var i=0;i<a.length;i++)a[i].classList.remove('on');$(id).classList.add('on')}
function showM(id){$(id).classList.add('on')}
function hideM(id){$(id).classList.remove('on')}
function toast(m,e){var t=$('toast');t.textContent=m;t.style.background=e?'#e94560':'#4ecca3';t.style.color=e?'#fff':'#000';t.classList.add('show');setTimeout(function(){t.classList.remove('show')},4000)}
function updateMenu(){$('m-title').textContent=D.title||'Visual Novel';var ss=D.start?D.scenes.find(function(s){return s.id===D.start}):null;var st=$('menu-status'),btn=$('btn-play');if(!D.scenes.length){st.innerHTML='<div class="st-no">‚ùå –ü—É—Å—Ç–æ</div>';btn.disabled=true}else if(!ss){st.innerHTML='<div class="st-no">‚ö†Ô∏è –ù–µ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–π</div>';btn.disabled=true}else if(!ss.steps||!ss.steps.length){st.innerHTML='<div class="st-no">‚ö†Ô∏è –ü—É—Å—Ç–∞</div>';btn.disabled=true}else{st.innerHTML='<div class="st-ok">‚úÖ '+D.scenes.length+' —Å—Ü–µ–Ω</div>';btn.disabled=false}}
function openCode(){$('i-code').value='';$('code-err').style.display='none';showM('M-code');$('i-code').focus()}
$('i-code').addEventListener('keydown',function(e){if(e.key==='Enter')checkCode()});
function checkCode(){if($('i-code').value!==CODE){$('code-err').style.display='block';return}hideM('M-code');isAdmin=true;loadData().then(function(){updateMenu();scr('S-dev');renderTab()})}
function toMenu(){stopTyping();bfStop();utStop();scr('S-menu');updateMenu()}
function readFile(f){return new Promise(function(r){var x=new FileReader;x.onload=function(e){r(e.target.result)};x.readAsDataURL(f)})}
function resize(u,mw,mh,p){return new Promise(function(r){var i=new Image;i.onload=function(){var w=i.width,h=i.height;if(w>mw||h>mh){var k=Math.min(mw/w,mh/h);w=Math.round(w*k);h=Math.round(h*k)}var c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(i,0,0,w,h);r(p?c.toDataURL('image/png'):c.toDataURL('image/jpeg',.72))};i.src=u})}
function pvF(inp,pvId,mw,mh,p,v){if(!inp.files[0])return;readFile(inp.files[0]).then(function(raw){return resize(raw,mw,mh,p)}).then(function(d){window[v]=d;$(pvId).src=d;$(pvId).style.display='block'})}

/* ‚ïê‚ïê‚ïê WAIT ROOM ‚ïê‚ïê‚ïê */
var PEPE_PHRASES=['–ù–µ –º–µ—à–∞–π!','–°–∫–æ—Ä–æ –Ω–∞—á–Ω—É!','–û—Ç—Å—Ç–∞–Ω—å!','–Ø –∑–∞–Ω—è—Ç!','–ü–æ–¥–æ–∂–¥–∏!','–ü—Ñ—Ñ...','–ï—â—ë —á—É—Ç—å-—á—É—Ç—å...','–ö—ã—à!','–î–∞–π –ø–æ—Å–ø–∞—Ç—å...','–ù–µ —Å–µ–π—á–∞—Å!'];
var phraseTimer=null;
function pepeTap(){var el=$('w-phrase');el.textContent=PEPE_PHRASES[Math.floor(Math.random()*PEPE_PHRASES.length)];el.classList.add('show');if(phraseTimer)clearTimeout(phraseTimer);phraseTimer=setTimeout(function(){el.classList.remove('show')},2500)}
function showWaitRoom(){scr('S-wait');updateWaitTimer()}
var waitTimerIv=null;
function updateWaitTimer(){if(waitTimerIv)clearInterval(waitTimerIv);function tick(){var left=TARGET-Date.now();if(left<=0){$('w-timer').textContent='üéâ –ì–û–¢–û–í–û!';$('w-timer-sub').textContent='';return}var d=Math.floor(left/864e5),h=Math.floor(left%864e5/36e5),m=Math.floor(left%36e5/6e4),s=Math.floor(left%6e4/1e3);$('w-timer').textContent=d+'–¥ '+h+'—á '+m+'–º '+s+'—Å'}tick();waitTimerIv=setInterval(tick,1000)}

/* ‚ïê‚ïê‚ïê DEV ‚ïê‚ïê‚ïê */
function dTab(t,el){curTab=t;var tabs=document.querySelectorAll('.dt');for(var i=0;i<tabs.length;i++)tabs[i].classList.remove('on');if(el)el.classList.add('on');renderTab()}
function renderTab(){var c=$('dc');if(curTab==='bg')rBgs(c);else if(curTab==='ch')rChars(c);else if(curTab==='sc')rScenes(c);else rSettings(c)}
function rBgs(c){var h='<div class="dgrid">';D.bgs.forEach(function(b){h+='<div class="dcard" onclick="eBg(\''+b.id+'\')"><div class="dcimg" style="background-image:url(\''+b.data+'\')"></div><div class="dcinf"><div class="dcn">'+esc(b.name)+'</div></div></div>'});h+='<div class="dcard dcadd" onclick="aBg()"><div class="ico">+</div><span>–î–æ–±–∞–≤–∏—Ç—å</span></div></div>';c.innerHTML=h}
function aBg(){editId=null;_bgD=null;$('bg-t').textContent='–î–æ–±–∞–≤–∏—Ç—å';$('bg-name').value='';$('bg-pv').style.display='none';$('bg-del').style.display='none';showM('M-bg')}
function eBg(id){var b=D.bgs.find(function(x){return x.id===id});if(!b)return;editId=id;_bgD=null;$('bg-t').textContent='–†–µ–¥.';$('bg-name').value=b.name;$('bg-pv').src=b.data;$('bg-pv').style.display='block';$('bg-del').style.display='inline-block';showM('M-bg')}
function saveBg(){var n=$('bg-name').value.trim();if(!n)return toast('!',1);if(editId){var b=D.bgs.find(function(x){return x.id===editId});if(b){b.name=n;if(_bgD)b.data=_bgD}}else{if(!_bgD)return toast('!',1);D.bgs.push({id:uid(),name:n,data:_bgD})}_bgD=null;save().then(function(){hideM('M-bg');renderTab();toast('OK')})}
function delBg(){if(!confirm('?'))return;D.bgs=D.bgs.filter(function(x){return x.id!==editId});save().then(function(){hideM('M-bg');renderTab()})}
function rChars(c){var h='<div class="dgrid">';D.chars.forEach(function(ch){h+='<div class="dcard" onclick="eCh(\''+ch.id+'\')"><div class="dcimg" style="background-image:url(\''+ch.data+'\');background-size:contain;background-repeat:no-repeat;background-position:center"></div><div class="dcinf"><div class="dcn">'+esc(ch.name)+'</div></div></div>'});h+='<div class="dcard dcadd" onclick="aCh()"><div class="ico">+</div><span>–î–æ–±–∞–≤–∏—Ç—å</span></div></div>';c.innerHTML=h}
function aCh(){editId=null;_chD=null;$('ch-t').textContent='–î–æ–±–∞–≤–∏—Ç—å';$('ch-name').value='';$('ch-pv').style.display='none';$('ch-del').style.display='none';showM('M-ch')}
function eCh(id){var ch=D.chars.find(function(x){return x.id===id});if(!ch)return;editId=id;_chD=null;$('ch-t').textContent='–†–µ–¥.';$('ch-name').value=ch.name;$('ch-pv').src=ch.data;$('ch-pv').style.display='block';$('ch-del').style.display='inline-block';showM('M-ch')}
function saveCh(){var n=$('ch-name').value.trim();if(!n)return toast('!',1);if(editId){var ch=D.chars.find(function(x){return x.id===editId});if(ch){ch.name=n;if(_chD)ch.data=_chD}}else{if(!_chD)return toast('!',1);D.chars.push({id:uid(),name:n,data:_chD})}_chD=null;save().then(function(){hideM('M-ch');renderTab();toast('OK')})}
function delCh(){if(!confirm('?'))return;D.chars=D.chars.filter(function(x){return x.id!==editId});save().then(function(){hideM('M-ch');renderTab()})}
function rScenes(c){var h='<div class="dgrid">';D.scenes.forEach(function(sc){var isS=sc.id===D.start;var bg=D.bgs.find(function(b){return b.id===sc.bgId});h+='<div class="dcard'+(isS?' start':'')+'" onclick="eSc(\''+sc.id+'\')"><div class="dcimg" style="'+(bg?'background-image:url(\''+bg.data+'\')':'display:flex;align-items:center;justify-content:center;font-size:38px;color:#7878a0')+'">'+(!bg?'üìú':'')+'</div><div class="dcinf"><div class="dcn">'+(sc.bossFight?'üéµ ':sc.utBoss?'üíÄ ':sc.chessBoss?'‚ôü ':'')+esc(sc.name)+'</div><div class="dcs">'+(isS?'‚≠ê':sc.steps.length+'—à–∞–≥')+'</div></div></div>'});h+='<div class="dcard dcadd" onclick="aSc()"><div class="ico">+</div><span>–î–æ–±–∞–≤–∏—Ç—å</span></div></div>';c.innerHTML=h}
function mkStep(){return{chId:null,pos:'center',text:'',hasCh:false,choices:[]}}
function aSc(){editId=null;eScData={id:uid(),name:'',bgId:null,steps:[mkStep()],next:null,bossFight:false,bfBpm:140,bfDur:60,bfSongName:'',bfChar:null,utBoss:false,utDiff:2,utBossHp:2000};$('sc-t').textContent='+';rScEd();showM('M-sc')}
function eSc(id){var sc=D.scenes.find(function(s){return s.id===id});if(!sc)return;editId=id;eScData=JSON.parse(JSON.stringify(sc));if(!eScData.bfBpm)eScData.bfBpm=140;if(!eScData.bfDur)eScData.bfDur=60;if(!eScData.utDiff)eScData.utDiff=2;if(!eScData.utBossHp)eScData.utBossHp=2000;eScData.steps.forEach(function(s){if(s.hasCh===undefined)s.hasCh=!!(s.choices&&s.choices.length)});$('sc-t').textContent='–†–µ–¥.';rScEd();showM('M-sc');if(editId)chkAudio(eScData.id)}
function chkAudio(id){fetch('/api/audio-check/'+id).then(function(r){return r.json()}).then(function(d){var el=document.getElementById('bf-ast');if(!el)return;if(d.exists)el.innerHTML='<div class="audio-info"><span class="ai-name">üéµ ('+(d.size/1024/1024).toFixed(1)+'–ú–ë)</span><button onclick="pvAud(\''+id+'\')">‚ñ∂</button><button onclick="dlAud(\''+id+'\')">‚úï</button></div>';else el.innerHTML='<div style="color:#7878a0;font-size:12px;margin-top:6px">–ê–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è</div>'}).catch(function(){})}
function ulAud(inp){if(!inp.files[0]||!eScData)return;var f=inp.files[0];var ext=f.name.split('.').pop();var el=document.getElementById('bf-ast');if(el)el.innerHTML='<div style="color:#ffcc00;font-size:13px">‚è≥...</div>';var r=new FileReader;r.onload=function(){fetch('/api/audio/'+eScData.id,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:r.result.split(',')[1],ext:ext})}).then(function(r){return r.json()}).then(function(d){if(d.ok){toast('üéµ OK');chkAudio(eScData.id)}else toast('!',1)}).catch(function(){toast('!',1)})};r.readAsDataURL(f)}
function pvAud(id){if(window._pa){window._pa.pause();window._pa=null;return}window._pa=new Audio('/api/audio/'+id);window._pa.volume=.5;window._pa.play().catch(function(){});setTimeout(function(){if(window._pa){window._pa.pause();window._pa=null}},10000)}
function dlAud(id){if(!confirm('?'))return;fetch('/api/audio/'+id,{method:'DELETE'}).then(function(){toast('OK');chkAudio(id)})}
function gather(){var ed=$('sc-ed');if(!ed)return;var v=function(s){return ed.querySelector(s)};var ni=v('#sce-name');if(ni)eScData.name=ni.value;var bi=v('#sce-bg');if(bi)eScData.bgId=bi.value||null;var nsi=v('#sce-next');if(nsi)eScData.next=nsi.value||null;var bft=v('#sce-bftype');if(bft){eScData.bossFight=(bft.value==='fnf');eScData.utBoss=(bft.value==='ut');eScData.chessBoss=(bft.value==='chess')}var utd=v('#sce-utdiff');if(utd)eScData.utDiff=parseInt(utd.value)||2;var uth=v('#sce-uthp');if(uth)eScData.utBossHp=parseInt(uth.value)||2000;var bfb=v('#sce-bfbpm');if(bfb)eScData.bfBpm=parseInt(bfb.value)||140;var bfd=v('#sce-bfdur');if(bfd)eScData.bfDur=parseInt(bfd.value)||60;var bfs=v('#sce-bfsong');if(bfs)eScData.bfSongName=bfs.value;var bfch=v('#sce-bfchar');if(bfch)eScData.bfChar=bfch.value||null;var items=ed.querySelectorAll('.si');for(var i=0;i<items.length;i++){var s=eScData.steps[i];if(!s)continue;var ch=items[i].querySelector('.sc-ch');if(ch)s.chId=ch.value||null;var ps=items[i].querySelector('.sc-ps');if(ps)s.pos=ps.value;var tx=items[i].querySelector('.sc-tx');if(tx)s.text=tx.value;var rows=items[i].querySelectorAll('.crow');for(var ci=0;ci<rows.length;ci++){if(!s.choices[ci])continue;var ct=rows[ci].querySelector('.sc-ct');if(ct)s.choices[ci].text=ct.value;var cs=rows[ci].querySelector('.sc-cs');if(cs)s.choices[ci].target=cs.value||null}}}
function rScEd(){var sc=eScData;var bgO='';D.bgs.forEach(function(b){bgO+='<option value="'+b.id+'"'+(sc.bgId===b.id?' selected':'')+'>'+esc(b.name)+'</option>'});var allSc=D.scenes.filter(function(s){return s.id!==sc.id});var chOpts='';D.chars.forEach(function(c){chOpts+='<option value="'+c.id+'"'+(sc.bfChar===c.id?' selected':'')+'>'+esc(c.name)+'</option>'});var stH='';sc.steps.forEach(function(st,i){var chO='';D.chars.forEach(function(c){chO+='<option value="'+c.id+'"'+(st.chId===c.id?' selected':'')+'>'+esc(c.name)+'</option>'});var chcH='';if(st.hasCh){chcH='<div class="csec">';(st.choices||[]).forEach(function(ch,ci){var csO='';allSc.forEach(function(s){csO+='<option value="'+s.id+'"'+(ch.target===s.id?' selected':'')+'>'+esc(s.name)+'</option>'});chcH+='<div class="crow"><input class="sc-ct" value="'+esc(ch.text)+'"><select class="sc-cs"><option value="">‚Üí</option>'+csO+'</select><button onclick="gather();eScData.steps['+i+'].choices.splice('+ci+',1);rScEd()">‚úï</button></div>'});chcH+='<button class="bsm" onclick="gather();eScData.steps['+i+'].choices.push({text:\'\',target:null});rScEd()">+</button></div>'}stH+='<div class="si"><div class="sih"><span class="sin">–®–∞–≥ '+(i+1)+'</span><div class="sia">'+(i>0?'<button onclick="gather();swSt('+i+',-1)">‚Üë</button>':'')+(i<sc.steps.length-1?'<button onclick="gather();swSt('+i+',1)">‚Üì</button>':'')+(sc.steps.length>1?'<button onclick="gather();eScData.steps.splice('+i+',1);rScEd()">‚úï</button>':'')+'</div></div><div class="sf"><div><label>–ü–µ—Ä—Å–æ–Ω–∞–∂</label><select class="sc-ch"><option value="">‚Äî</option>'+chO+'</select></div><div><label>–ü–æ–∑</label><select class="sc-ps"><option value="left"'+(st.pos==='left'?' selected':'')+'>‚Üê</option><option value="center"'+(st.pos==='center'?' selected':'')+'>‚äô</option><option value="right"'+(st.pos==='right'?' selected':'')+'>‚Üí</option></select></div><div class="fw"><label>–¢–µ–∫—Å—Ç</label><textarea class="sc-tx">'+esc(st.text)+'</textarea></div></div><div class="cbtog"><input type="checkbox" id="cb'+i+'"'+(st.hasCh?' checked':'')+' onchange="gather();eScData.steps['+i+'].hasCh=this.checked;if(this.checked&&(!eScData.steps['+i+'].choices||!eScData.steps['+i+'].choices.length))eScData.steps['+i+'].choices=[{text:\'\',target:null}];rScEd()"><label for="cb'+i+'">–í—ã–±–æ—Ä—ã</label></div>'+chcH+'</div>'});var nxO='';allSc.forEach(function(s){nxO+='<option value="'+s.id+'"'+(sc.next===s.id?' selected':'')+'>'+esc(s.name)+'</option>'});var bfT='';if(sc.bossFight)bfT='fnf';else if(sc.utBoss)bfT='ut';else if(sc.chessBoss)bfT='chess';$('sc-ed').innerHTML='<div class="fg"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="sce-name" value="'+esc(sc.name)+'"></div><div class="fg"><label>–§–æ–Ω</label><select id="sce-bg"><option value="">‚Äî</option>'+bgO+'</select></div><div class="fg"><label>–®–∞–≥–∏</label><div class="steps">'+stH+'</div><button class="bsm" onclick="gather();eScData.steps.push(mkStep());rScEd()" style="margin-top:12px">+</button></div><div class="fg"><label>–î–∞–ª–µ–µ</label><select id="sce-next"><option value="">–ö–æ–Ω–µ—Ü</option>'+nxO+'</select></div><div class="bfsec"><h4>‚öîÔ∏è –ë–æ—Å—Å</h4><div class="fg"><label>–¢–∏–ø</label><select id="sce-bftype"><option value=""'+(bfT===''?' selected':'')+'>–ù–µ—Ç</option><option value="fnf"'+(bfT==='fnf'?' selected':'')+'>üéµ FNF</option><option value="ut"'+(bfT==='ut'?' selected':'')+'>üíÄ UT</option><option value="chess"'+(bfT==='chess'?' selected':'')+'>‚ôü Chess</option></select></div><div class="sf" style="margin-top:10px"><div><label>–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫</label><select id="sce-bfchar"><option value="">‚Äî</option>'+chOpts+'</select></div><div><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input id="sce-bfsong" value="'+esc(sc.bfSongName)+'"></div><div><label>BPM</label><input type="number" id="sce-bfbpm" value="'+(sc.bfBpm||140)+'" min="60" max="300"></div><div><label>–î–ª–∏–Ω–∞(—Å)</label><input type="number" id="sce-bfdur" value="'+(sc.bfDur||60)+'" min="15" max="300"></div><div><label>–°–ª–æ–∂–Ω–æ—Å—Ç—å UT</label><select id="sce-utdiff"><option value="1"'+((sc.utDiff||2)===1?' selected':'')+'>–õ–µ–≥–∫–æ</option><option value="2"'+((sc.utDiff||2)===2?' selected':'')+'>–°—Ä–µ–¥–Ω–µ</option><option value="3"'+((sc.utDiff||2)===3?' selected':'')+'>–°–ª–æ–∂–Ω–æ</option></select></div><div><label>HP –±–æ—Å—Å–∞</label><input type="number" id="sce-uthp" value="'+(sc.utBossHp||2000)+'" min="100" max="9999"></div></div><div class="fg" style="margin-top:10px"><label>–ú—É–∑—ã–∫–∞</label><label class="fbtn">üìÅ<input type="file" accept="audio/*" style="display:none" onchange="ulAud(this)"></label><div id="bf-ast"></div></div></div><div class="brow" style="margin-top:20px"><button class="bp" onclick="saveSc()">üíæ</button>'+(editId?'<button class="bd" onclick="delSc()">üóë</button>':'')+'<button class="bs" onclick="hideM(\'M-sc\')">‚úï</button></div>'}
function swSt(i,d){var s=eScData.steps;var t=s[i];s[i]=s[i+d];s[i+d]=t;rScEd()}
function saveSc(){gather();var sc=eScData;sc.name=sc.name||'?';sc.steps.forEach(function(s){if(!s.hasCh)s.choices=[]});if(editId){for(var i=0;i<D.scenes.length;i++){if(D.scenes[i].id===editId){D.scenes[i]=sc;break}}}else{D.scenes.push(sc);if(!D.start)D.start=sc.id}save().then(function(){hideM('M-sc');renderTab();toast('OK')})}
function delSc(){if(!confirm('?'))return;if(editId)fetch('/api/audio/'+editId,{method:'DELETE'}).catch(function(){});D.scenes=D.scenes.filter(function(s){return s.id!==editId});if(D.start===editId)D.start=D.scenes.length?D.scenes[0].id:null;save().then(function(){hideM('M-sc');renderTab()})}
function rSettings(c){var scO='';D.scenes.forEach(function(s){scO+='<option value="'+s.id+'"'+(D.start===s.id?' selected':'')+'>'+esc(s.name)+'</option>'});c.innerHTML='<div class="setsec"><h3>‚úèÔ∏è –ù–∞–∑–≤–∞–Ω–∏–µ</h3><div class="fg"><input id="st-t" value="'+esc(D.title)+'" onchange="D.title=this.value;save().then(function(){updateMenu();toast(\'OK\')})"></div></div><div class="setsec"><h3>‚≠ê –ù–∞—á–∞–ª—å–Ω–∞—è</h3><div class="fg"><select id="st-s" onchange="D.start=this.value||null;save().then(function(){updateMenu();toast(\'OK\')})"><option value="">‚Äî</option>'+scO+'</select></div></div><div class="setsec"><h3>üíæ</h3><div class="brow"><button class="bs" onclick="expD()">üì§</button><label class="bs" style="cursor:pointer">üì•<input type="file" accept=".json" style="display:none" onchange="impD(this)"></label></div></div><div class="setsec"><button class="bd" onclick="clearAll()">üóë</button></div>'}
function expD(){var b=new Blob([JSON.stringify(D,null,2)],{type:'application/json'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='novel.json';a.click()}
function impD(inp){if(!inp.files[0])return;inp.files[0].text().then(function(t){try{var d=JSON.parse(t);if(d.scenes){D=d;save().then(function(){renderTab();updateMenu();toast('OK')})}}catch(e){toast('!',1)}})}
function clearAll(){if(!confirm('–í–°–Å?'))return;D={title:'Visual Novel',bgs:[],chars:[],scenes:[],start:null};save().then(function(){renderTab();updateMenu()})}

/* ‚ïê‚ïê‚ïê NOVEL ‚ïê‚ïê‚ïê */
function startGame(){if(!isAdmin&&Date.now()<TARGET){showWaitRoom();return}loadData().then(function(ok){if(!ok){toast('!',1);return}updateMenu();var ss=findScene(D.start);if(!ss||!ss.steps||!ss.steps.length){toast('–ü—É—Å—Ç–æ!',1);return}scr('S-game');$('g-end').classList.remove('on');$('g-choices').classList.remove('on');$('g-char').style.display='none';$('g-name').textContent='';$('g-txt').textContent='';gameLoad(D.start)})}
function findScene(id){for(var i=0;i<D.scenes.length;i++)if(D.scenes[i].id===id)return D.scenes[i];return null}
function findChar(id){for(var i=0;i<D.chars.length;i++)if(D.chars[i].id===id)return D.chars[i];return null}
function findBg(id){for(var i=0;i<D.bgs.length;i++)if(D.bgs[i].id===id)return D.bgs[i];return null}
function gameLoad(sid){var sc=findScene(sid);if(!sc){gameEnd();return}if(!sc.steps||!sc.steps.length){gameTrans(sc);return}G.sid=sid;G.step=0;var bg=findBg(sc.bgId);var el=$('g-bg');if(bg)el.style.backgroundImage='url('+bg.data+')';else{el.style.backgroundImage='none';el.style.backgroundColor='#1e1e3e'}gameShow()}
function gameTrans(sc){if(sc&&sc.bossFight)bfStart(sc);else if(sc&&sc.utBoss)utStart(sc);else if(sc&&sc.chessBoss)cbStart(sc);else if(sc&&sc.next)gameLoad(sc.next);else gameEnd()}
function gameShow(){var sc=findScene(G.sid);if(!sc||G.step>=sc.steps.length){gameTrans(sc);return}var st=sc.steps[G.step];var cel=$('g-char');if(st.chId){var ch=findChar(st.chId);if(ch){cel.src=ch.data;cel.className=st.pos==='left'?'vis pl':st.pos==='right'?'vis pr':'vis pc';cel.style.display='block';$('g-name').textContent=ch.name}else{cel.style.display='none';$('g-name').textContent=''}}else{cel.style.display='none';$('g-name').textContent=''}gameType(st.text||'...');$('g-ind').style.display=(st.hasCh&&st.choices&&st.choices.length)?'none':'block'}
function gameType(t){stopTyping();G.full=t;G.typing=true;var el=$('g-txt');var i=0;el.textContent='';G.timer=setInterval(function(){if(i<t.length){el.textContent+=t.charAt(i);i++}else{stopTyping();gameAfter()}},30)}
function stopTyping(){if(G.timer){clearInterval(G.timer);G.timer=null}G.typing=false}
function gameAfter(){var sc=findScene(G.sid);if(!sc)return;var st=sc.steps[G.step];if(st&&st.hasCh&&st.choices&&st.choices.length){var c=$('g-choices');var h='';for(var i=0;i<st.choices.length;i++)h+='<button class="chb" onclick="gamePick('+i+')">'+esc(st.choices[i].text||'–í–∞—Ä–∏–∞–Ω—Ç '+(i+1))+'</button>';c.innerHTML=h;c.classList.add('on')}}
function advance(){if(G.typing){stopTyping();$('g-txt').textContent=G.full;gameAfter();return}var sc=findScene(G.sid);if(!sc)return;var st=sc.steps[G.step];if(st&&st.hasCh&&st.choices&&st.choices.length)return;G.step++;if(G.step>=sc.steps.length)gameTrans(sc);else gameShow()}
function gamePick(i){var sc=findScene(G.sid);if(!sc)return;var st=sc.steps[G.step];if(!st||!st.choices||!st.choices[i])return;$('g-choices').classList.remove('on');var t=st.choices[i].target;if(t)gameLoad(t);else gameEnd()}
function gameEnd(){stopTyping();$('g-end').classList.add('on')}

/* ‚ïê‚ïê‚ïê FNF BOSS ‚ïê‚ïê‚ïê */
var BF={active:false,audio:null,actx:null,raf:null,hp:50,score:0,combo:0,maxCombo:0,hits:0,misses:0,perfects:0,notes:[],noteIdx:0,startTime:0,songDur:0,sceneData:null,canvas:null,ctx:null,laneColors:['#c24b99','#00ffff','#12fa05','#f9393f'],laneW:0,hitY:0,speed:400,pressed:[false,false,false,false],hitAnims:[[],[],[],[]]};
function bfStop(){BF.active=false;if(BF.raf)cancelAnimationFrame(BF.raf);BF.raf=null;if(BF.audio){BF.audio.pause();BF.audio=null}if(BF.actx){try{BF.actx.close()}catch(e){}BF.actx=null}}
function bfStart(sd){bfStop();BF.sceneData=sd;BF.hp=50;BF.score=0;BF.combo=0;BF.maxCombo=0;BF.hits=0;BF.misses=0;BF.perfects=0;BF.noteIdx=0;BF.pressed=[false,false,false,false];BF.hitAnims=[[],[],[],[]];var bpm=sd.bfBpm||140,dur=sd.bfDur||60;BF.songDur=dur*1000;BF.speed=Math.min(200+bpm*1.5,650);BF.notes=bfGen(bpm,dur);var ch=sd.bfChar?findChar(sd.bfChar):null;if(ch){$('bf-opp-img').src=ch.data;$('bf-opp-img').style.display='block';$('bf-opp-name').textContent=ch.name}else{$('bf-opp-img').style.display='none';$('bf-opp-name').textContent='???'}$('bf-song-name').textContent='‚ô™ '+(sd.bfSongName||'?');scr('S-boss');$('bf-result').classList.remove('on');$('bf-hfill').style.width='50%';$('bf-score-txt').textContent='0';requestAnimationFrame(function(){requestAnimationFrame(function(){bfSetup();bfLoadA(sd.id,function(has){bfCD(function(){if(has&&BF.audio){BF.audio.currentTime=0;BF.audio.play().catch(function(){})}else{BF.actx=new(window.AudioContext||window.webkitAudioContext)();bfMusic(BF.actx,bpm,dur)}BF.startTime=performance.now();BF.active=true;BF.raf=requestAnimationFrame(bfLoop)})})})})}
function bfSetup(){BF.canvas=$('bf-canvas');var r=BF.canvas.parentElement.getBoundingClientRect();BF.canvas.width=Math.max(r.width*2,100);BF.canvas.height=Math.max(r.height*2,100);BF.canvas.style.width=r.width+'px';BF.canvas.style.height=r.height+'px';BF.ctx=BF.canvas.getContext('2d');BF.ctx.scale(2,2);BF.laneW=r.width/4;BF.hitY=r.height-100}
function bfLoadA(id,cb){fetch('/api/audio-check/'+id).then(function(r){return r.json()}).then(function(d){if(d.exists){BF.audio=new Audio('/api/audio/'+id);BF.audio.preload='auto';BF.audio.volume=.7;var ok=false;BF.audio.oncanplaythrough=function(){if(!ok){ok=true;cb(true)}};BF.audio.onerror=function(){if(!ok){ok=true;cb(false)}};BF.audio.load();setTimeout(function(){if(!ok){ok=true;cb(false)}},5000)}else cb(false)}).catch(function(){cb(false)})}
function bfCD(cb){var el=$('bf-countdown');el.classList.add('on');var n=['3','2','1','‚ô™'],i=0;el.textContent=n[0];var iv=setInterval(function(){i++;if(i<n.length)el.textContent=n[i];else{clearInterval(iv);el.classList.remove('on');cb()}},700)}
function bfGen(bpm,dur){var beat=60/bpm,notes=[],t=beat*4,pats=[[0,1,2,3],[3,2,1,0],[0,2,1,3],[1,3,0,2]],pi=0,si=0;while(t<dur-2){var int=Math.min(t/(dur*.7),1),pat=pats[pi%pats.length],lane=pat[si%pat.length];notes.push({time:t*1000,lane:lane,hit:false,missed:false});if(int>.3&&Math.random()<int*.4)notes.push({time:(t+beat*.5)*1000,lane:(lane+1+Math.floor(Math.random()*3))%4,hit:false,missed:false});si++;if(si%pat.length===0&&Math.random()<.4){pi++;si=0}if(Math.random()<.15*(1-int))t+=beat;t+=beat}notes.sort(function(a,b){return a.time-b.time});return notes}
function bfMusic(c,bpm,dur){var beat=60/bpm,f=[261.63,293.66,329.63,392,440,523.25],now=c.currentTime;for(var i=0;i<BF.notes.length;i++){var n=BF.notes[i];bfTn(c,f[(n.lane*2+i)%6],now+n.time/1000,beat*.3,'square',.05)}for(var t=0;t<dur;t+=beat)bfDr(c,now+t)}
function bfTn(c,f,t,d,tp,v){var o=c.createOscillator(),g=c.createGain();o.type=tp;o.frequency.value=f;g.gain.setValueAtTime(v,t);g.gain.exponentialRampToValueAtTime(.001,t+d);o.connect(g);g.connect(c.destination);o.start(t);o.stop(t+d+.01)}
function bfDr(c,t){var o=c.createOscillator(),g=c.createGain();o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(30,t+.1);g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.15);o.connect(g);g.connect(c.destination);o.start(t);o.stop(t+.2)}
function bfLoop(){if(!BF.active)return;var el=performance.now()-BF.startTime;for(var i=BF.noteIdx;i<BF.notes.length;i++){var n=BF.notes[i];if(n.hit||n.missed)continue;if(el-n.time>160){n.missed=true;BF.misses++;BF.combo=0;BF.hp=Math.max(0,BF.hp-5);bfRt('MISS','#e94560')}if(n.time-el>2000)break}while(BF.noteIdx<BF.notes.length&&(BF.notes[BF.noteIdx].hit||BF.notes[BF.noteIdx].missed))BF.noteIdx++;$('bf-hfill').style.width=BF.hp+'%';$('bf-score-txt').textContent=Math.floor(BF.score);if(BF.hp<=0){bfEnd(false);return}if(el>=BF.songDur+1000){bfEnd(true);return}bfDraw(el);BF.raf=requestAnimationFrame(bfLoop)}
function bfDraw(el){var c=BF.ctx,w=BF.canvas.width/2,h=BF.canvas.height/2;c.clearRect(0,0,w,h);for(var i=0;i<4;i++){c.fillStyle='rgba(255,255,255,.02)';c.fillRect(i*BF.laneW,0,BF.laneW,h);var cx=i*BF.laneW+BF.laneW/2;bfAr(c,cx,BF.hitY,BF.laneW*.32,i,false,BF.pressed[i]?BF.laneColors[i]:'rgba(255,255,255,.25)')}for(var i=0;i<4;i++)for(var j=BF.hitAnims[i].length-1;j>=0;j--){var a=BF.hitAnims[i][j],age=el-a.time;if(age>300){BF.hitAnims[i].splice(j,1);continue}c.globalAlpha=1-age/300;bfAr(c,i*BF.laneW+BF.laneW/2,BF.hitY,BF.laneW*.32*(1+age/200),i,true,a.color);c.globalAlpha=1}for(var i=0;i<BF.notes.length;i++){var n=BF.notes[i];if(n.hit||n.missed)continue;var dt=n.time-el;if(dt>2000)break;if(dt<-300)continue;var y=BF.hitY-dt/1000*BF.speed;if(y<-50||y>h+50)continue;bfAr(c,n.lane*BF.laneW+BF.laneW/2,y,BF.laneW*.32,n.lane,true,BF.laneColors[n.lane])}}
function bfAr(c,x,y,s,l,fill,col){c.save();c.translate(x,y);c.rotate([Math.PI/2,Math.PI,0,-Math.PI/2][l]);c.beginPath();c.moveTo(0,-s);c.lineTo(s*.7,s*.2);c.lineTo(s*.25,s*.2);c.lineTo(s*.25,s);c.lineTo(-s*.25,s);c.lineTo(-s*.25,s*.2);c.lineTo(-s*.7,s*.2);c.closePath();if(fill){c.fillStyle=col;c.fill()}else{c.strokeStyle=col;c.lineWidth=2;c.stroke()}c.restore()}
function bfHit(lane){if(!BF.active)return;BF.pressed[lane]=true;setTimeout(function(){BF.pressed[lane]=false},100);var el=performance.now()-BF.startTime,best=null,bestDt=Infinity;for(var i=0;i<BF.notes.length;i++){var n=BF.notes[i];if(n.hit||n.missed||n.lane!==lane)continue;var dt=Math.abs(el-n.time);if(dt>200)continue;if(dt<bestDt){bestDt=dt;best=n}}if(!best)return;best.hit=true;BF.hits++;var r,p,heal,col;if(bestDt<35){r='PERFECT';p=400;heal=3;col='#ffff00';BF.perfects++}else if(bestDt<75){r='GREAT';p=280;heal=2;col='#4ecca3'}else if(bestDt<120){r='GOOD';p=150;heal=1;col='#39ffdc'}else{r='OK';p=50;heal=0;col='#7878a0'}BF.combo++;if(BF.combo>BF.maxCombo)BF.maxCombo=BF.combo;BF.score+=p*(1+Math.floor(BF.combo/10)*.15);BF.hp=Math.min(100,BF.hp+heal);BF.hitAnims[lane].push({time:performance.now()-BF.startTime,color:col});bfRt(r,col);if(BF.combo>0&&BF.combo%10===0)bfCb()}
function bfRt(t,c){var e=$('bf-rating-txt');e.textContent=t;e.style.color=c;e.classList.remove('show');void e.offsetWidth;e.classList.add('show');setTimeout(function(){e.classList.remove('show')},600)}
function bfCb(){var e=$('bf-combo-txt');e.textContent=BF.combo+'x';e.classList.remove('show');void e.offsetWidth;e.classList.add('show');setTimeout(function(){e.classList.remove('show')},800)}
function bfEnd(won){bfStop();$('bf-result').classList.add('on');$('bf-res-title').textContent=won?'–ü–û–ë–ï–î–ê!':'–ü–û–†–ê–ñ–ï–ù–ò–ï';$('bf-res-title').className=won?'win':'lose';$('bf-res-stats').innerHTML='–°—á—ë—Ç: '+Math.floor(BF.score)+'<br>–ö–æ–º–±–æ: '+BF.maxCombo+'x<br>Perfect: '+BF.perfects+'<br>–ü—Ä–æ–º–∞—Ö–∏: '+BF.misses;var btn=$('bf-res-btn'),sc=BF.sceneData;if(won){btn.textContent='–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';btn.onclick=function(){$('bf-result').classList.remove('on');if(sc&&sc.next){scr('S-game');gameLoad(sc.next)}else{scr('S-game');gameEnd()}}}else{btn.textContent='–ï—â—ë —Ä–∞–∑';btn.onclick=function(){$('bf-result').classList.remove('on');bfStart(sc)}}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UNDERTALE BOSS ‚Äî MULTI-PHASE v5
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var UT={active:false,raf:null,audio:null,tp:'player',sd:null,
  px:0,py:0,ppx:0,ppy:0,spd:3.5,hp:92,mhp:92,inv:0,moving:false,
  bhp:2000,bmhp:2000,bn:'',phase:1,
  bw:200,bh:200,proj:[],bones:[],beams:[],
  atT:0,atD:6000,atI:0,tc:0,spA:0,
  abA:false,abX:0,abD:1,keys:{},dlg:[],dlI:0,dlCb:null,diff:2,
  sA:true,sDied:false,sans:{x:0,y:0,tx:0,ty:0,mt:0,tt:0,it:0,i:false},
  pA:false,pap:{x:0,y:0,tx:0,ty:0,mt:0,tt:0,it:0,i:false},
  fd:true,trial:false,
  sword:null,gun:null,laser:null,wind:0,
  hcA:false,hcC:null,hcI:0,
  rev:false,catches:0,shake:0,bflash:0,cbHit:0,
  p5Active:false,p5Time:0,bwLimit:0,_bwShiftLeft:0,p5iv:0};

/* ‚îÄ‚îÄ –§—Ä–∞–∑—ã –°–∞–Ω—Å–∞/–ü–∞–ø–∏—Ä—É—Å–∞ ‚îÄ‚îÄ */
var SP={
  sIdle:['—Ö–µ—Ö.','—Å–∫—É—á–Ω–æ...','*–∑–µ–≤–∞–µ—Ç*','–ø—Ñ—Ñ.','—Ö–µ—Ö–µ—Ö–µ...','–Ω–µ-–∞.','—Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ.',
    '–ö–∞–∂–µ—Ç—Å—è —É —Ç—è–Ω–∫–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –Ω–∞ –Ω–∞—Å –æ—Ç—Ç—è–Ω—É—Ç—Å—è! –•–∞! –•–∞.',
    '–ß—Ç–æ, –Ω—Ä–∞–≤—è—Ç—Å—è –º–æ–∏ —Ö—Ä—É–º–µ—à–∫–∏?!','–î–∞ —ç—Ç–æ –∫–∞–∫–∞—è —Ç–æ –¢—è–Ω–∫–æ–ª–æ–≤–∞–Ω–∏—è!',
    '@SansTimelineparadox –ø–µ—Ä–µ–¥–∞—é –ø—Ä–∏–≤–µ—Ç! –û–π, —á—Ç–æ —ç—Ç–æ —è...',
    '–í—ã —Å–ª—ã—à–∏—Ç–µ –µ—ë —Å—Ç–æ–Ω—ã? –•–º, –Ω–µ—Ç, –ø–æ–∂–∞–ª—É–π —ç—Ç—É –æ—Å—Ç–∞–≤–ª—é...'],
  sThrow:['–ø–æ–ª—É—á–∞–π!','–±–µ–∑ —à–∞–Ω—Å–æ–≤.','–º–æ–π —Ö–æ–¥.','–ø–æ–ø—Ä–æ–±—É–π —É–≤–µ—Ä–Ω–∏—Å—å.','‚ò†Ô∏è','–æ–ø–∞.'],
  sCbHit:['–ö–∞–∫ —Ç–∞–∫?! –ú—ã –≤–µ–¥—å —ç—Ç–æ —Å —Ç–æ–±–æ–π –ø—Ä–æ—Ö–æ–¥–∏–ª–∏!'],
  sP2:['–û—Ö-—Ö, –∫–∞–∂–µ—Ç—Å—è —É –º–µ–Ω—è –∑–∞—Ç—Ä—è—Å–ª–∏—Å—å –∫–æ—Å—Ç–∏!'],
  sP3a:['–û–π-–µ–π, –≤ –æ–¥–∏–Ω–æ—á–∫—É –Ω–∞–º –Ω–µ —Å–ø—Ä–∞–≤–∏—Ç—Å—è!'],
  sP3r:['*—Ö—Ä—É–º-—Ö—Ä—É–º* –ê –≤–æ—Ç –∏ —è!'],
  pIdle:['–°–µ–π—á–∞—Å –≤—ã —É–≤–∏–¥–∏—Ç–µ –º–æ—ë... –ú–ê–°–¢–ï–†–°–¢–í–û –°–í–ò–î–ê–ù–ò–ô!!!',
    '–õ–æ–≤—É—à–∫–∞ –¥–ª—è —Ç—è–Ω–æ–∫, –≤–ø–µ—Ä–µ... –ù—É, –∫–∞–∫ –≤—Å–µ–≥–¥–∞.',
    '–ì–¥–µ –º–æ—è... –°–ü–ê–ì–ì–ï–¢–¢–ò –ü–£–®–ö–ê?!',
    '–¢—ã –∫–æ–Ω–µ—á–Ω–æ –Ω–µ –≥–≥ –∞–Ω–¥–µ—Ä—Ç–µ–π–ª–∞, –Ω–æ... –¢–∞–∫, –æ —á—ë–º —ç—Ç–æ —è?!',
    '–ù–¨–ï–•–ï–•–ï–•–ï!','–í–µ–ª–∏–∫–∏–π –ü–∞–ø–∏—Ä—É—Å –Ω–µ —Å–¥–∞—ë—Ç—Å—è!'],
  pThrow:['–ü–æ–ª—É—á–∞–π —Å–ø–∞–≥–µ—Ç—Ç–∏-–∞—Ç–∞–∫—É!','–ù–¨–ï–•–ï–•–ï–•–ï!','–í–µ–ª–∏–∫–∏–π –ü–∞–ø–∏—Ä—É—Å –∞—Ç–∞–∫—É–µ—Ç!'],
  pSpawnDead:['–°–µ–π—á–∞—Å —è —Ç–µ–±–µ –æ—Ç–æ–º—â—É –∑–∞ —Å–≤–æ–µ–≥–æ –°–ê–ù–°–ï–ß–ö–£!'],
  pSpawnAlive:['–ê —è –Ω–µ —Ç–∞–∫ –ø—Ä–æ—Å—Ç, –¥–∞?'],
  pCbHit:['—Ö–ê! –ü–æ–ø–∞–ª—Å—è –Ω–∞ –º–æ—é –ª–æ–≤—É—à–∫—É! –¢–∞–∫, —Å—Ç–æ–ø...'],
  pP3a:['–ô–æ-—Ö–æ-—Ö–æ! –ö–∞–∂–µ—Ç—Å—è –Ω–∞–º –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å!'],
  pP3s:['–ê –≤–æ—Ç –∏ —è, —Å–∞–ª–∞–≥–∏!']
};

/* ‚îÄ‚îÄ –§—Ä–∞–∑—ã –ë–æ—Å—Å–∞ ‚îÄ‚îÄ */
var BP={
  dmgBoss:  ['–ê—Ö!..~','–ú—Ñ~','–•–º—Ñ~','–û—Ö...~'],
  dmgPlayer:['–∫—É—Å—å —Å—Ç—Ä–∞—Å—Ç–Ω–æ –∑–∞ –≥—É–±–∫–∏ üíã','–ü–æ–ª—É—á–∞–π!','–£–º—Ä–∏!'],
  preAtk:   ['–°–µ–π—á–∞—Å —è —Ç–µ–±—è –Ω–∞–∫–∞–∂—É!','–Ø –Ω–µ —Ç–∞–∫ –ø—Ä–æ—Å—Ç–∞ –∫–∞–∫ —Ç–∞ –ø–µ–≤—á–∞—è –ø—Ç–∏—á–∫–∞!',
              '–°–µ–π—á–∞—Å —è —Å–æ—Ç—Ä—É —Ç–≤–æ—ë –º–∏–ª–æ–µ –ª–∏—á–∏–∫–æ –≤ –ø–æ—Ä–æ—à–æ–∫!','–ù–∞ –∫–æ–ª–µ–Ω–∏!'],
  sansHit:  ['–ê—Ö —Ç—ã!...','–ê–π!','–î–∞ —è —Ç–µ–±—è!..','–î–∞ –∫–∞–∫ —Ç—ã —Å–º–µ–µ—à—å?!'],
  sansDie:  ['–ü–æ–∫–∞-–ø–æ–∫–∞, —Å–∫–µ–ª–µ—Ç–∏–∫! üíî'],
  p1:['–ù—É —Ä–∞–∑ —Ç—ã —Ö–æ—á–µ—à—å –ø–æ –ø–ª–æ—Ö–æ–º—É...'],
  p2:['–ü–ª–æ—Ö–æ–π –º–∞–ª—å—á–∏–∫!'],
  p3:['–ù—É –∑–∞—á–µ–º –∂–µ —Ç–∞–∫ –∂—ë—Å—Ç–∫–æ?..'],
  p4:['–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞....'],
  p5:['–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ "–ê–≤–∞–Ω–≥–∞—Ä–¥"'],
  end:['–Ø... –Ø... –ü—Ä–æ—Å—Ç–∏ –º–µ–Ω—è, –º–∏–ª–∞—à–∫–∞.']
};

function rp(a){return a[Math.floor(Math.random()*a.length)]}

/* ‚îÄ‚îÄ –†–µ–ø–ª–∏–∫–∞ –±–æ—Å—Å–∞ ‚îÄ‚îÄ */
function utBossMsg(txt){
  var e=$('ut-dlg');
  e.textContent=txt;
  e.classList.add('show');
  clearTimeout(utBossMsg._t);
  utBossMsg._t=setTimeout(function(){e.classList.remove('show')},2800);
}

/* ‚îÄ‚îÄ –ü–æ–º–æ—â–Ω–∏–∫–∏ ‚îÄ‚îÄ */
function utMakeHelper(id,emoji,color){
  var old=document.getElementById(id);if(old)old.remove();
  var w=document.createElement('div');w.id=id;
  w.style.cssText='position:fixed;z-index:99999;pointer-events:none;';
  var blue=color==='blue';
  var glow=blue?'rgba(80,180,255,.7)':'rgba(255,167,38,.7)';
  var anim=blue?'sansFly':'papFly';
  var tc=blue?'#64b5f6':'#ffa726';var tb=blue?'#42a5f5':'#ffa726';
  w.innerHTML='<div style="font-size:48px;line-height:1;filter:drop-shadow(0 0 12px '+glow+');animation:'+anim+' 2s ease-in-out infinite">'+emoji+'</div>'
    +'<div id="'+id+'-txt" style="position:absolute;top:-32px;left:50%;transform:translateX(-50%);white-space:nowrap;font-family:monospace;font-size:12px;color:'+tc+';opacity:0;transition:opacity .3s;background:rgba(0,0,20,.9);padding:3px 10px;border-radius:8px;border:1px solid '+tb+'"></div>';
  document.body.appendChild(w);return w;
}
function utRemoveHelper(id){var e=document.getElementById(id);if(e)e.remove()}
var _htT={};
function utHelperTxt(id,txt){var e=document.getElementById(id+'-txt');if(!e)return;e.textContent=txt;e.style.opacity='1';if(_htT[id])clearTimeout(_htT[id]);_htT[id]=setTimeout(function(){if(e)e.style.opacity='0'},2500)}
function utUpdateHelper(h,id,B,idle,throwCb){
  if(!h.i){h.i=true;h.x=B.w*.06;h.y=B.h*.35;h.tx=B.w*.15;h.ty=B.h*.4;h.mt=500;h.tt=3000;h.it=2000}
  h.x+=(h.tx-h.x)*.025;h.y+=(h.ty-h.y)*.025;
  h.mt-=16;if(h.mt<=0){h.mt=1500+Math.random()*2500;h.tx=B.w*.03+Math.random()*B.w*.25;h.ty=B.h*.12+Math.random()*B.h*.55}
  h.it-=16;if(h.it<=0){h.it=4000+Math.random()*4000;if(UT.tp==='attack'||UT.tp==='player')utHelperTxt(id,rp(idle))}
  if(UT.tp==='attack'){h.tt-=16;if(h.tt<=0){h.tt=2500+Math.random()*3500;if(throwCb)throwCb()}}
  var el=document.getElementById(id);if(el){el.style.display='block';el.style.left=Math.round(B.l+h.x)+'px';el.style.top=Math.round(B.t+h.y)+'px'}
}

/* ‚îÄ‚îÄ –¢–æ—Ç–µ–º ‚îÄ‚îÄ */
function utTotem(cb){
  UT.tp='totem';var ov=$('ut-totem-overlay');ov.classList.add('on');
  $('ut-totem-text').textContent='';$('ut-totem-skull').style.fontSize='80px';
  setTimeout(function(){$('ut-totem-skull').style.fontSize='120px';$('ut-totem-text').textContent='üíõ SANS –û–¢–î–ê–õ –°–í–û–Æ –ñ–ò–ó–ù–¨'},800);
  setTimeout(function(){var r=$('ut-totem-rays');r.style.animation='none';void r.offsetWidth;r.style.animation='totemRays 1s ease-out forwards'},1200);
  setTimeout(function(){utBossMsg(rp(BP.sansDie))},1000);
  setTimeout(function(){
    ov.classList.remove('on');UT.sA=false;UT.sDied=true;utRemoveHelper('ut-sans-float');
    UT.hp=UT.mhp;UT.inv=2000;utUpdateHp();
    UT.pA=true;UT.pap.i=false;utMakeHelper('ut-pap-float','üíÄ','orange');
    utHelperTxt('ut-pap-float',rp(SP.pSpawnDead));if(cb)cb();
  },3000);
}

/* ‚îÄ‚îÄ –°–º–µ–Ω–∞ —Ñ–∞–∑—ã ‚îÄ‚îÄ */
function utCheckPhase(){
  var p=UT.bhp/UT.bmhp;
  var np;
  if     (p>0.75) np=1;
  else if(p>0.50) np=2;
  else if(p>0.25) np=3;
  else if(p>0.125)np=4;
  else            np=5;
  if(np!==UT.phase){UT.phase=np;utPhaseTr(np)}
}

function utPhaseTr(to){
  UT.tp='transition';utClearBox();
  if(UT.sword){UT.sword.el.remove();UT.sword=null}
  if(UT.gun){UT.gun.el.remove();UT.gun=null}
  if(UT.laser){UT.laser.el.remove();UT.laser=null}
  var s=$('S-ut');
  s.classList.remove('ut-phase2','ut-phase3','ut-phase4','ut-phase5');
  if(to>=2)s.classList.add('ut-phase'+Math.min(to,5));
  var ov=$('ut-phase-overlay');ov.classList.add('on');
  ov.textContent='* PHASE '+to+' *';
  $('ut-phase-indicator').textContent='Phase '+to;
  var key='p'+to;
  if(BP[key])setTimeout(function(){utBossMsg(rp(BP[key]))},600);
  if(to===2){
    if(UT.sA)utHelperTxt('ut-sans-float',rp(SP.sP2));
    if(UT.pA)utHelperTxt('ut-pap-float',rp(SP.pSpawnAlive));
    setTimeout(function(){utMakeSword()},1500);
  }
  if(to===3){
    if(!UT.pA){UT.pA=true;UT.pap.i=false;utMakeHelper('ut-pap-float','üíÄ','orange');utHelperTxt('ut-pap-float',UT.sDied?rp(SP.pP3s):rp(SP.pP3a))}
    else utHelperTxt('ut-pap-float',rp(SP.pP3a));
    if(UT.sA)utHelperTxt('ut-sans-float',rp(SP.sP3a));
    if(UT.sDied&&!UT.sA){UT.sA=true;UT.sans.i=false;utMakeHelper('ut-sans-float','üíÄ','blue');utHelperTxt('ut-sans-float',rp(SP.sP3r))}
    setTimeout(function(){utMakeGun()},1500);
  }
  if(to===4){UT.rev=true;UT.catches=0;}
  if(to===5){
    // –£–±–∏—Ä–∞–µ–º –ø–æ–º–æ—â–Ω–∏–∫–æ–≤
    utRemoveHelper('ut-sans-float');utRemoveHelper('ut-pap-float');
    UT.sA=false;UT.pA=false;UT.rev=false;UT.wind=0;
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º HP –∏–≥—Ä–æ–∫–∞
    setTimeout(function(){UT.hp=UT.mhp;UT.inv=0;utUpdateHp()},1800);
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
    UT.p5Active=true;UT.p5Time=90000;
    var pi=$('ut-phase-indicator');if(pi)pi.classList.add('p5');
  }
  setTimeout(function(){ov.classList.remove('on');UT.tp='player';utShowActs()},2000);
}

function utStop(){
  UT.active=false;
  if(UT.raf)cancelAnimationFrame(UT.raf);UT.raf=null;
  if(UT.audio){UT.audio.pause();UT.audio=null}
  UT.keys={};
  var m=$('ut-mid');if(m)m.style.transform='';
  var i=$('ut-opp-img');if(i)i.style.filter='';
  utRemoveHelper('ut-sans-float');utRemoveHelper('ut-pap-float');
  if(UT.sword){UT.sword.el.remove();UT.sword=null}
  if(UT.gun){UT.gun.el.remove();UT.gun=null}
  if(UT.laser){UT.laser.el.remove();UT.laser=null}
  $('ut-totem-overlay').classList.remove('on');
  $('S-ut').classList.remove('ut-phase2','ut-phase3','ut-phase4','ut-phase5');
  UT.rev=false;UT.wind=0;
  UT.p5Active=false;UT.bwLimit=0;UT._bwShiftLeft=0;UT.p5iv=0;
  var fs=document.getElementById('ut-field-shrink');if(fs)fs.remove();
  var rh=document.querySelector('.ut-reverse-hint');if(rh)rh.remove();
  var pi=$('ut-phase-indicator');if(pi)pi.classList.remove('p5');
}

function utGoBack(){var t=UT.trial;utStop();if(t)showWaitRoom();else toMenu()}

function utStart(sd,isTrial){
  utStop();UT.trial=!!isTrial;UT.sd=sd;UT.diff=sd.utDiff||2;
  UT.mhp=92;UT.hp=92;UT.bmhp=sd.utBossHp||2000;UT.bhp=UT.bmhp;
  UT.phase=1;UT.tc=0;UT.atI=0;UT.fd=true;
  UT.proj=[];UT.bones=[];UT.beams=[];UT.tp='dialogue';UT.dlI=0;
  UT.abA=false;UT.inv=0;UT.moving=false;UT.spA=0;
  UT.shake=0;UT.bflash=0;UT.wind=0;UT.rev=false;UT.catches=0;
  UT.p5Active=false;UT.p5Time=0;UT.bwLimit=0;UT._bwShiftLeft=0;UT.p5iv=0;
  UT.spd=[3,3.5,4.2][UT.diff-1];
  UT.sA=true;UT.sDied=false;
  UT.sans={x:0,y:0,tx:0,ty:0,mt:0,tt:3000,it:2000,i:false};
  UT.pA=false;UT.pap={x:0,y:0,tx:0,ty:0,mt:0,tt:3000,it:2000,i:false};
  UT.sword=null;UT.gun=null;UT.laser=null;UT.hcA=false;UT.cbHit=0;
  var ch=sd.bfChar?findChar(sd.bfChar):null;
  if(ch){$('ut-opp-img').src=ch.data;$('ut-opp-img').style.display='block';$('ut-opp-name').textContent=ch.name;UT.bn=ch.name}
  else{$('ut-opp-img').style.display='none';UT.bn=UT.trial?'Training Dummy':'???';$('ut-opp-name').textContent=UT.bn}
  scr('S-ut');$('ut-result').classList.remove('on');$('ut-atk-bar').classList.remove('show');
  $('ut-phase-indicator').textContent='Phase 1';$('ut-phase-overlay').classList.remove('on');
  utMakeHelper('ut-sans-float','üíÄ','blue');
  requestAnimationFrame(function(){requestAnimationFrame(function(){
    utSetupBox();utUpdateHp();
    if(UT.trial)utShowDlg(['* –ü—Ä–æ–±–Ω—ã–π –±–æ–π!','* üîµ –°–∏–Ω–∏–µ ‚Äî –ó–ê–ú–†–ò','* üü† –û—Ä–∞–Ω–∂–µ–≤—ã–µ ‚Äî –î–í–ò–ì–ê–ô–°–Ø','* –ù–∞–∂–º–∏ Fight!','* –£–¥–∞—á–∏!']);
    else utShowDlg(['* '+UT.bn+' –ø–æ—è–≤–ª—è–µ—Ç—Å—è!','* –ì–æ—Ç–æ–≤—å—Å—è –∫ –±–æ—é!']);
    utLoadAudio(sd.id);UT.active=true;UT.raf=requestAnimationFrame(utLoop);
  })});
}

function utSetupBox(){
  var m=$('ut-mid'),r=m.getBoundingClientRect();
  var sz=Math.min(r.width*.92,r.height*.92);
  sz=Math.max(sz,120);
  UT.bw=sz;UT.bh=sz;
  $('ut-box').style.width=sz+'px';$('ut-box').style.height=sz+'px';
  UT.px=sz/2-9;UT.py=sz/2-9;UT.ppx=UT.px;UT.ppy=UT.py;
  $('ut-heart').style.left=UT.px+'px';$('ut-heart').style.top=UT.py+'px';
}
function utLoadAudio(id){fetch('/api/audio-check/'+id).then(function(r){return r.json()}).then(function(d){if(d.exists){UT.audio=new Audio('/api/audio/'+id);UT.audio.loop=true;UT.audio.volume=.5;UT.audio.play().catch(function(){})}}).catch(function(){})}
function utUpdateHp(){var p=Math.max(0,UT.hp/UT.mhp*100);$('ut-hp-fill').style.width=p+'%';$('ut-hp-fill').style.background=p>50?'#ff0':p>25?'#f90':'#f00';$('ut-hp-txt').textContent=Math.max(0,Math.ceil(UT.hp))+'/'+UT.mhp}
function utShowDlg(l,cb){UT.tp='dialogue';UT.dlg=l||['...'];UT.dlI=0;UT.dlCb=cb;$('ut-dlg').textContent=UT.dlg[0];$('ut-dlg').classList.add('show');utHideActs()}
function utAdvDlg(){UT.dlI++;if(UT.dlI>=UT.dlg.length){$('ut-dlg').classList.remove('show');if(UT.dlCb){var c=UT.dlCb;UT.dlCb=null;c()}else if(UT.tp==='dialogue'){UT.tp='player';utShowActs()}}else $('ut-dlg').textContent=UT.dlg[UT.dlI]}
function utHideActs(){var a=document.querySelectorAll('.ut-act');for(var i=0;i<a.length;i++){a[i].style.opacity='.4';a[i].style.pointerEvents='none'}}
function utShowActs(){var a=document.querySelectorAll('.ut-act');for(var i=0;i<a.length;i++){a[i].style.opacity='1';a[i].style.pointerEvents='auto'}}

function utAction(t){if(UT.tp!=='player')return;$('ut-atk-bar').classList.remove('show');if(t==='fight'){utHideActs();UT.abA=true;UT.abX=0;UT.abD=1;$('ut-atk-bar').classList.add('show');var b=$('ut-atk-bar'),bw=b.offsetWidth,zw=bw*.15;$('ut-atk-zone').style.left=(bw-zw)/2+'px';$('ut-atk-zone').style.width=zw+'px'}}
function utDoHit(){if(!UT.abA)return;UT.abA=false;$('ut-atk-bar').classList.remove('show');var bw=$('ut-atk-bar').offsetWidth||300,zw=bw*.15,zx=(bw-zw)/2;var d=Math.abs(UT.abX-(zx+zw/2)),m=Math.max(0,1-d/(bw/2));var base=UT.rev?5:[25,35,50][UT.diff-1];var dmg=Math.floor(base+base*2*m*m);if(m>.85)dmg=Math.floor(dmg*1.5);UT.bhp-=dmg;utShowDmg(dmg,m>.85);utBFlash();if(UT.bhp<=0){UT.bhp=0;setTimeout(function(){utEnd(true)},800);return}utCheckPhase();setTimeout(function(){if(UT.active&&UT.tp!=='transition')utStartAtk()},1000)}
function utBFlash(){UT.bflash=300;var i=$('ut-opp-img');if(i)i.style.filter='brightness(3) saturate(0)'}
function utShowDmg(d,c){
  var e=$('ut-dmg');e.textContent=(c?'‚òÖ ':'')+d;e.style.color=c?'#ff0':'#fff';
  e.style.top='30%';e.style.left='50%';e.style.transform='translateX(-50%)';
  e.classList.remove('show');void e.offsetWidth;e.classList.add('show');
  setTimeout(function(){e.classList.remove('show')},800);
  setTimeout(function(){utBossMsg(rp(BP.dmgBoss))},100);
}
function utShowTurn(t){var e=$('ut-turn-txt');e.textContent=t;e.classList.remove('show');void e.offsetWidth;e.classList.add('show');setTimeout(function(){e.classList.remove('show')},1200)}
function utStartAtk(){UT.tp='attack';utHideActs();$('ut-dlg').classList.remove('show');utClearBox();UT.spA=0;UT.wind=0;UT.atT=performance.now();UT.atD=[5000,6500,8000][UT.diff-1];if(UT.phase>=2)UT.atD+=1500;if(UT.phase>=3)UT.atD+=2000;UT.tc++;UT.atI++;utShowTurn('–•–æ–¥ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞!')}
function utEndAtk(){UT.tp='player';utClearBox();UT.wind=0;utShowActs();if(UT.tc%2===0&&UT.bhp>0)utShowDlg(['* ...'])}
function utClearBox(){UT.proj=[];UT.bones=[];UT.beams=[];var b=$('ut-box'),o=b.querySelectorAll('.ut-proj,.ut-bone,.ut-beam,.ut-bomb-warn,.ut-bomb-explode,.ut-knife,.ut-bullet,.ut-laser,.ut-reverse-hint');for(var i=0;i<o.length;i++)o[i].remove();UT.hcA=false;UT.hcC=null}

/* ‚îÄ‚îÄ –ê—Ç–∞–∫–∏ —Ñ–∞–∑ 1-4 ‚îÄ‚îÄ */
function utSpawn(now){
  if(UT.phase===5){utSpawnP5();return}
  var iv=[500,350,220][UT.diff-1];UT.spA+=16;if(UT.spA<iv)return;UT.spA=0;
  if(Math.random()<.04)utBossMsg(rp(BP.preAtk));
  var oc=UT.pA&&Math.random()<.4;
  var pool=['boneH','boneV','projAim','blue','orange','circle','wave'];
  if(UT.phase>=2)pool.push('bomb','knife','knife');
  if(UT.phase>=3)pool.push('wave','projAim');
  var pat=pool[Math.floor(Math.random()*pool.length)];
  if(oc&&(pat==='boneH'||pat==='boneV'||pat==='blue'))pat='orange';
  switch(pat){case'boneH':utBH();break;case'boneV':utBV();break;case'projAim':utPA();break;case'blue':utBL();break;case'orange':utOR();break;case'circle':utCI();break;case'wave':utWV();break;case'bomb':utBM();break;case'knife':utKN();break}
  if(UT.phase>=2&&!UT.hcA&&Math.random()<.015)utHC();
  if(UT.phase>=3&&UT.wind===0&&Math.random()<.01)utWI();
  if(UT.diff>=2&&(now-UT.atT)>3000&&Math.random()<.002*UT.diff)utBE();
  if(UT.laser&&UT.phase>=3){UT.laser.timer-=16;if(UT.laser.timer<=0){UT.laser.timer=1500+Math.random()*1000;UT.laser.color=UT.laser.color==='blue'?'orange':'blue';UT.laser.el.classList.remove('blue','orange');UT.laser.el.classList.add(UT.laser.color)}UT.laser.mt-=16;if(UT.laser.mt<=0){UT.laser.mt=2000+Math.random()*1500;UT.laser.x=Math.random()*(UT.bw-20);UT.laser.y=Math.random()*(UT.bh-20);UT.laser.el.style.left=UT.laser.x+'px';UT.laser.el.style.top=UT.laser.y+'px'}}
}

/* ‚îÄ‚îÄ –§–∞–∑–∞ 5: –±–µ–∑–æ—Å—Ç–∞–Ω–æ–≤–æ—á–Ω—ã–µ –∞—Ç–∞–∫–∏ ‚îÄ‚îÄ */
function utSpawnP5(){
  UT.p5iv+=16;
  var iv=[180,120,80][UT.diff-1];
  if(UT.p5iv<iv)return;UT.p5iv=0;
  if(Math.random()<.04)utBossMsg(rp(BP.preAtk));
  var n=Math.floor(Math.random()*3)+2;
  var atks=['boneH','boneV','projAim','circle','wave','wave','bomb','boneH','boneV'];
  for(var i=0;i<n;i++){var a=atks[Math.floor(Math.random()*atks.length)];switch(a){case'boneH':utBH();break;case'boneV':utBV();break;case'projAim':utPA();break;case'circle':utCI();break;case'wave':utWV();break;case'bomb':utBM();break}}
  if(Math.random()<.04)UT.wind=(Math.random()>.5?1:-1)*[2,3,4][UT.diff-1];
  if(Math.random()<.06)utPiano();
  if(!UT.sword&&Math.random()<.06)utMakeSwordP5();
  else if(UT.sword&&Math.random()<.04){UT.sword.el.remove();UT.sword=null}
  if(!UT.gun&&Math.random()<.06)utMakeGunP5();
  else if(UT.gun&&Math.random()<.04){UT.gun.el.remove();UT.gun=null}
  if(!document.getElementById('ut-field-shrink')&&Math.random()<.015)utFieldShrink();
  if(Math.random()<.03*UT.diff)utBE();
}

/* ‚îÄ‚îÄ –†–æ—è–ª—å ‚îÄ‚îÄ */
function utPiano(){
  var r=[16,18,20][UT.diff-1];
  var x=r+Math.random()*(UT.bw-r*2);
  var el=document.createElement('div');
  el.style.cssText='position:absolute;font-size:30px;left:'+(x-15)+'px;top:-36px;z-index:6;pointer-events:none';
  el.textContent='üéπ';$('ut-box').appendChild(el);
  UT.proj.push({el:el,x:x,y:-20,vx:(Math.random()-.5)*0.8,vy:[5,7,9][UT.diff-1],r:r,piano:true});
}

/* ‚îÄ‚îÄ –ú–µ—á —Ñ–∞–∑—ã 5 ‚îÄ‚îÄ */
function utMakeSwordP5(){
  var el=document.createElement('div');el.className='ut-sword';el.textContent='‚öîÔ∏è';
  el.style.left=UT.bw/2+'px';el.style.top='10px';$('ut-box').appendChild(el);
  UT.sword={el:el,x:UT.bw/2,y:10,vx:2.5,vy:2,lunge:0,lt:800};
}

/* ‚îÄ‚îÄ –ü–∏—Å—Ç–æ–ª–µ—Ç —Ñ–∞–∑—ã 5 ‚îÄ‚îÄ */
function utMakeGunP5(){
  var el=document.createElement('div');el.className='ut-gun';el.textContent='üî´';
  el.style.left=Math.random()*(UT.bw-30)+'px';el.style.top=Math.random()*(UT.bh-30)+'px';
  $('ut-box').appendChild(el);
  UT.gun={el:el,x:parseFloat(el.style.left),y:parseFloat(el.style.top),st:0};
}

/* ‚îÄ‚îÄ –°–∂–∞—Ç–∏–µ –ø–æ–ª—è ‚îÄ‚îÄ */
function utFieldShrink(){
  var side=Math.random()>.5?'right':'left';
  var ov=document.createElement('div');ov.id='ut-field-shrink';
  var pct=35+Math.floor(Math.random()*20);
  ov.style.cssText='position:absolute;'+(side==='right'?'right':'left')+':0;top:0;'
    +'width:'+pct+'%;height:100%;background:rgba(0,0,0,.88);z-index:8;'
    +'border-'+(side==='right'?'left':'right')+':3px solid #f00;display:flex;'
    +'align-items:center;justify-content:center;font-size:28px;pointer-events:none;';
  ov.textContent='‚ö†Ô∏è';$('ut-box').appendChild(ov);
  if(side==='right'){UT.bwLimit=UT.bw*(1-pct/100)-18;UT._bwShiftLeft=0;}
  else{UT.bwLimit=UT.bw-18;UT._bwShiftLeft=UT.bw*(pct/100);}
  var dur=3000+Math.random()*2000;
  setTimeout(function(){var e=document.getElementById('ut-field-shrink');if(e)e.remove();UT.bwLimit=0;UT._bwShiftLeft=0;},dur);
}

/* ‚îÄ‚îÄ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∞—Ç–∞–∫–∏ ‚îÄ‚îÄ */
function utBH(){var gap=55+Math.random()*35,gy=30+Math.random()*(UT.bh-gap-60),l=Math.random()>.5,s=(l?1:-1)*[1.8,2.5,3.5][UT.diff-1];utAB(l?-20:UT.bw,0,20,gy,s,0,'white');utAB(l?-20:UT.bw,gy+gap,20,UT.bh-(gy+gap),s,0,'white')}
function utBV(){var gap=55+Math.random()*35,gx=30+Math.random()*(UT.bw-gap-60),t=Math.random()>.5,s=(t?1:-1)*[1.8,2.5,3.5][UT.diff-1];utAB(0,t?-20:UT.bh,gx,20,0,s,'white');utAB(gx+gap,t?-20:UT.bh,UT.bw-(gx+gap),20,0,s,'white')}
function utPA(){var cx=UT.px+9,cy=UT.py+9,sd=Math.floor(Math.random()*4),x,y;if(sd===0){x=Math.random()*UT.bw;y=-8}else if(sd===1){x=Math.random()*UT.bw;y=UT.bh+8}else if(sd===2){x=-8;y=Math.random()*UT.bh}else{x=UT.bw+8;y=Math.random()*UT.bh}var a=Math.atan2(cy-y,cx-x)+(Math.random()-.5)*.6,sp=[1.8,2.5,3.5][UT.diff-1];utAP(x,y,Math.cos(a)*sp,Math.sin(a)*sp,5)}
function utBL(){var l=Math.random()>.5,s=(l?1:-1)*[2,3,4][UT.diff-1],n=[2,3,4][UT.diff-1],sp=UT.bh/(n+1);for(var i=0;i<n;i++)utAB(l?-30:UT.bw+10,sp*(i+1)-10,25,20,s,0,'blue')}
function utOR(){var t=Math.random()>.5,s=(t?1:-1)*[2,3,4][UT.diff-1],n=[2,3,4][UT.diff-1],sp=UT.bw/(n+1);for(var i=0;i<n;i++)utAB(sp*(i+1)-10,t?-30:UT.bh+10,20,25,0,s,'orange')}
function utCI(){var cx=UT.bw/2,cy=UT.bh/2,n=[5,7,10][UT.diff-1],s=[1.5,2.2,3][UT.diff-1],o=Math.random()*Math.PI*2,ga=Math.random()*Math.PI*2;for(var i=0;i<n;i++){var a=o+i/n*Math.PI*2,d=Math.abs(((a-ga)%(Math.PI*2)+Math.PI*3)%(Math.PI*2)-Math.PI);if(d<.5)continue;utAP(cx,cy,Math.cos(a)*s,Math.sin(a)*s,4)}}
function utWV(){utAP(Math.random()*UT.bw,-8,0,[1.5,2.2,3][UT.diff-1],4)}
function utBM(){var box=$('ut-box'),cnt=[2,3,5][UT.diff-1];for(var i=0;i<cnt;i++){var bx=20+Math.random()*(UT.bw-40),by=20+Math.random()*(UT.bh-40),r=20+Math.random()*15;var w=document.createElement('div');w.className='ut-bomb-warn';w.style.left=(bx-r)+'px';w.style.top=(by-r)+'px';w.style.width=r*2+'px';w.style.height=r*2+'px';box.appendChild(w);(function(bx,by,r,w){setTimeout(function(){if(w.parentNode)w.remove();var e=document.createElement('div');e.className='ut-bomb-explode';e.style.left=(bx-r)+'px';e.style.top=(by-r)+'px';e.style.width=r*2+'px';e.style.height=r*2+'px';box.appendChild(e);var hx=UT.px+9,hy=UT.py+9;if(Math.sqrt((hx-bx)*(hx-bx)+(hy-by)*(hy-by))<r+5&&UT.inv<=0)utTD([5,8,12][UT.diff-1]);setTimeout(function(){if(e.parentNode)e.remove()},500)},1000)})(bx,by,r,w)}}
function utKN(){var box=$('ut-box'),top=Math.random()>.5,cnt=[3,5,7][UT.diff-1];for(var i=0;i<cnt;i++){var x=Math.random()*UT.bw,el=document.createElement('div');el.className='ut-knife'+(top?'':' up');el.style.left=x+'px';el.style.top=(top?-20:UT.bh+20)+'px';box.appendChild(el);utAP_raw(el,x,top?-20:UT.bh+20,0,(top?1:-1)*[4,6,8][UT.diff-1],6)}}
function utHC(){if(UT.hcA)return;UT.hcA=true;var box=$('ut-box'),cols=3,rows=2,cw=UT.bw/cols,ch=UT.bh/rows;UT.hcC=[];for(var r=0;r<rows;r++)for(var c=0;c<cols;c++){var el=document.createElement('div');el.className='ut-hc-cell safe';el.style.left=c*cw+'px';el.style.top=r*ch+'px';el.style.width=cw+'px';el.style.height=ch+'px';box.appendChild(el);UT.hcC.push({el:el,x:c*cw,y:r*ch,w:cw,h:ch,state:'safe'})}var order=[];for(var i=0;i<UT.hcC.length;i++)order.push(i);for(var i=order.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1)),t=order[i];order[i]=order[j];order[j]=t}UT.hcI=0;function dn(){if(!UT.hcA||UT.hcI>=order.length-1)return;var idx=order[UT.hcI],cell=UT.hcC[idx];cell.el.classList.remove('safe');cell.el.classList.add('warn');setTimeout(function(){cell.el.classList.remove('warn');cell.el.classList.add('fall');cell.state='fallen';var hx=UT.px+9,hy=UT.py+9;if(hx>=cell.x&&hx<cell.x+cell.w&&hy>=cell.y&&hy<cell.y+cell.h&&UT.inv<=0)utTD([5,8,12][UT.diff-1]);UT.hcI++;if(UT.hcI<order.length-1)setTimeout(dn,800);else setTimeout(function(){UT.hcA=false;if(UT.hcC){for(var i=0;i<UT.hcC.length;i++)if(UT.hcC[i].el.parentNode)UT.hcC[i].el.remove();UT.hcC=null}},1500)},600)}setTimeout(dn,500)}
function utWI(){UT.wind=Math.random()>.5?1:-1;for(var i=0;i<[3,5,7][UT.diff-1];i++){var x=UT.wind>0?UT.bw+10:-10;utAP(x,Math.random()*UT.bh,-UT.wind*[2,3,4][UT.diff-1],(Math.random()-.5)*1.5,4)}setTimeout(function(){UT.wind=0},3000)}
function utBE(){var h=Math.random()>.5,p=20+Math.random()*((h?UT.bh:UT.bw)-40),el=document.createElement('div');el.className='ut-beam';var box=$('ut-box');if(h){el.style.left='0';el.style.width='100%';el.style.top=p+'px';el.style.height='20px'}else{el.style.top='0';el.style.height='100%';el.style.left=p+'px';el.style.width='20px'}box.appendChild(el);el.classList.add('warn');setTimeout(function(){el.classList.remove('warn');el.classList.add('fire');UT.beams.push({el:el,horiz:h,pos:p})},1000);setTimeout(function(){el.classList.remove('fire');setTimeout(function(){if(el.parentNode)el.remove()},200);UT.beams=UT.beams.filter(function(b){return b.el!==el})},1600)}
function utAB(x,y,w,h,vx,vy,col){var el=document.createElement('div');el.className='ut-bone';el.style.left=x+'px';el.style.top=y+'px';el.style.width=Math.max(4,w)+'px';el.style.height=Math.max(4,h)+'px';if(col==='blue'){el.style.background='#42a5f5';el.style.boxShadow='0 0 8px #42a5f5'}else if(col==='orange'){el.style.background='#ffa726';el.style.boxShadow='0 0 8px #ffa726'}else el.style.background='#fff';$('ut-box').appendChild(el);UT.bones.push({el:el,x:x,y:y,w:w,h:h,vx:vx,vy:vy,color:col||'white'})}
function utAP(x,y,vx,vy,r){var el=document.createElement('div');el.className='ut-proj';el.style.width=r*2+'px';el.style.height=r*2+'px';el.style.background='#fff';el.style.borderRadius='50%';el.style.left=(x-r)+'px';el.style.top=(y-r)+'px';$('ut-box').appendChild(el);UT.proj.push({el:el,x:x,y:y,vx:vx,vy:vy,r:r})}
function utAP_raw(el,x,y,vx,vy,r){UT.proj.push({el:el,x:x,y:y,vx:vx,vy:vy,r:r})}
function utSpawnP4(){if(Math.random()<.03){var sd=Math.floor(Math.random()*4),x,y,vx,vy;if(sd===0){x=Math.random()*UT.bw;y=-8;vx=0;vy=1}else if(sd===1){x=Math.random()*UT.bw;y=UT.bh+8;vx=0;vy=-1}else if(sd===2){x=-8;y=Math.random()*UT.bh;vx=1;vy=0}else{x=UT.bw+8;y=Math.random()*UT.bh;vx=-1;vy=0}var el=document.createElement('div');el.className='ut-proj';el.style.width='12px';el.style.height='12px';el.style.background='#ff0';el.style.borderRadius='50%';el.style.boxShadow='0 0 8px #ff0';el.style.left=(x-6)+'px';el.style.top=(y-6)+'px';$('ut-box').appendChild(el);UT.proj.push({el:el,x:x,y:y,vx:vx,vy:vy,r:6,golden:true})}if(!document.querySelector('.ut-reverse-hint')){var h=document.createElement('div');h.className='ut-reverse-hint';h.textContent='‚òÖ –õ–û–í–ò –°–ù–ê–†–Ø–î–´! ‚òÖ';$('ut-box').appendChild(h)}}

/* ‚îÄ‚îÄ –ú–µ—á —Ñ–∞–∑ 2-3 ‚îÄ‚îÄ */
function utMakeSword(){var el=document.createElement('div');el.className='ut-sword';el.textContent='‚öîÔ∏è';el.style.left=UT.bw/2+'px';el.style.top='10px';$('ut-box').appendChild(el);UT.sword={el:el,x:UT.bw/2,y:10,vx:1.5,vy:1.2,lunge:0,lt:2000}}
function utUpdSword(){
  if(!UT.sword||(UT.phase<2&&!UT.p5Active))return;
  var s=UT.sword;s.lt-=16;
  if(s.lt<=0&&!s.lunge){
    s.lunge=1;var a=Math.atan2(UT.py+9-s.y,UT.px+9-s.x);
    s.vx=Math.cos(a)*[5,7,9][UT.diff-1];s.vy=Math.sin(a)*[5,7,9][UT.diff-1];
    setTimeout(function(){s.lunge=0;s.lt=1500+Math.random()*1500;s.vx=1.5*(Math.random()>.5?1:-1);s.vy=1.2*(Math.random()>.5?1:-1)},400);
  }
  s.x+=s.vx;s.y+=s.vy;
  if(s.x<0||s.x>UT.bw-28){s.vx*=-1;s.x=Math.max(0,Math.min(UT.bw-28,s.x))}
  if(s.y<0||s.y>UT.bh-28){s.vy*=-1;s.y=Math.max(0,Math.min(UT.bh-28,s.y))}
  s.el.style.left=s.x+'px';s.el.style.top=s.y+'px';
  if(UT.inv<=0){var dx=UT.px+9-s.x-14,dy=UT.py+9-s.y-14;if(Math.sqrt(dx*dx+dy*dy)<20)utTD([8,12,16][UT.diff-1])}
}

/* ‚îÄ‚îÄ –ú–µ—á —Ñ–∞–∑—ã 5 (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–µ–µ) ‚îÄ‚îÄ */
function utUpdSwordP5(){
  if(!UT.sword)return;
  var s=UT.sword;s.lt-=16;
  if(s.lt<=0&&!s.lunge){
    s.lunge=1;var a=Math.atan2(UT.py+9-s.y,UT.px+9-s.x);
    s.vx=Math.cos(a)*[7,10,13][UT.diff-1];s.vy=Math.sin(a)*[7,10,13][UT.diff-1];
    setTimeout(function(){s.lunge=0;s.lt=600+Math.random()*800;s.vx=2*(Math.random()>.5?1:-1);s.vy=2*(Math.random()>.5?1:-1)},300);
  }
  s.x+=s.vx;s.y+=s.vy;
  if(s.x<0||s.x>UT.bw-28){s.vx*=-1;s.x=Math.max(0,Math.min(UT.bw-28,s.x))}
  if(s.y<0||s.y>UT.bh-28){s.vy*=-1;s.y=Math.max(0,Math.min(UT.bh-28,s.y))}
  s.el.style.left=s.x+'px';s.el.style.top=s.y+'px';
  if(UT.inv<=0){var dx=UT.px+9-s.x-14,dy=UT.py+9-s.y-14;if(Math.sqrt(dx*dx+dy*dy)<22)utTD([10,15,20][UT.diff-1])}
}

/* ‚îÄ‚îÄ –ü–∏—Å—Ç–æ–ª–µ—Ç —Ñ–∞–∑ 3-4 ‚îÄ‚îÄ */
function utMakeGun(){var el=document.createElement('div');el.className='ut-gun';el.textContent='üî´';el.style.left=UT.bw-30+'px';el.style.top=UT.bh-30+'px';$('ut-box').appendChild(el);UT.gun={el:el,x:UT.bw-30,y:UT.bh-30,st:0};var le=document.createElement('div');le.className='ut-laser blue';le.style.left=Math.random()*(UT.bw-20)+'px';le.style.top=Math.random()*(UT.bh-20)+'px';$('ut-box').appendChild(le);UT.laser={el:le,x:parseFloat(le.style.left),y:parseFloat(le.style.top),color:'blue',timer:1500,mt:2000}}
function utUpdGun(){
  if(!UT.gun||(!UT.p5Active&&(UT.phase<3||UT.phase>=4)))return;
  var g=UT.gun;g.st-=16;
  if(g.st<=0){
    g.st=[600,400,250][UT.diff-1];
    var a=Math.atan2(UT.py+9-g.y,UT.px+9-g.x)+(Math.random()-.5)*.3;
    var b=document.createElement('div');b.className='ut-bullet';b.style.left=g.x+'px';b.style.top=g.y+'px';$('ut-box').appendChild(b);
    UT.proj.push({el:b,x:g.x,y:g.y,vx:Math.cos(a)*[3,4,5.5][UT.diff-1],vy:Math.sin(a)*[3,4,5.5][UT.diff-1],r:3});
  }
}
function utUpdGunP5(){
  if(!UT.gun)return;
  var g=UT.gun;g.st-=16;
  if(g.st<=0){
    g.st=[400,250,150][UT.diff-1];
    var a=Math.atan2(UT.py+9-g.y,UT.px+9-g.x)+(Math.random()-.5)*.2;
    var b=document.createElement('div');b.className='ut-bullet';b.style.left=g.x+'px';b.style.top=g.y+'px';$('ut-box').appendChild(b);
    UT.proj.push({el:b,x:g.x,y:g.y,vx:Math.cos(a)*[4,5.5,7][UT.diff-1],vy:Math.sin(a)*[4,5.5,7][UT.diff-1],r:3});
  }
}
function utUpdLaser(){if(!UT.laser||UT.phase<3)return;if(UT.inv<=0){var hx=UT.px+4,hy=UT.py+4;if(hx<UT.laser.x+20&&hx+10>UT.laser.x&&hy<UT.laser.y+20&&hy+10>UT.laser.y){if(UT.laser.color==='blue'&&UT.moving){utTD([5,8,12][UT.diff-1]);utCBH()}else if(UT.laser.color==='orange'&&!UT.moving){utTD([5,8,12][UT.diff-1]);utCBH()}}}}

/* ‚îÄ‚îÄ –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª ‚îÄ‚îÄ */
function utLoop(){
  if(!UT.active)return;
  if(UT.inv>0)UT.inv-=16;
  var dx=UT.px-UT.ppx,dy=UT.py-UT.ppy;
  UT.moving=Math.abs(dx)>.3||Math.abs(dy)>.3;UT.ppx=UT.px;UT.ppy=UT.py;

  // –¢–∞–π–º–µ—Ä —Ñ–∞–∑—ã 5
  if(UT.p5Active){
    UT.p5Time-=16;
    var sec=Math.ceil(UT.p5Time/1000);
    $('ut-phase-indicator').textContent='‚òÖ –í–´–ñ–ò–í–ò: '+sec+'—Å';
    if(UT.p5Time<=0){utEnd(true);return}
  }

  if(UT.tp==='attack'){
    utMoveH();utSpawn(performance.now());utMoveP();utMoveB();
    utUpdSword();utUpdGun();utUpdLaser();
    if(UT.rev)utCheckRev();else utCheckCol();
    utCheckBeams();
    if(performance.now()-UT.atT>UT.atD)utEndAtk();
  } else if(UT.tp==='player'){
    if(UT.p5Active){
      // –§–∞–∑–∞ 5: –∞—Ç–∞–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç—Å—è –¥–∞–∂–µ –≤ ¬´—Ö–æ–¥ –∏–≥—Ä–æ–∫–∞¬ª
      utMoveH();utSpawnP5();utMoveP();utMoveB();
      utUpdSwordP5();utUpdGunP5();
      utCheckCol();utCheckBeams();
    } else {
      if(UT.abA)utMoveAC();
    }
  }

  // –ü–æ–º–æ—â–Ω–∏–∫–∏
  var R=$('S-ut').getBoundingClientRect(),B={l:R.left,t:R.top,w:R.width,h:R.height};
  if(UT.sA)utUpdateHelper(UT.sans,'ut-sans-float',B,SP.sIdle,function(){
    if(Math.random()>.5){
      utAP(Math.random()*UT.bw,-10,(Math.random()-.5)*.8,[1.5,2,3][UT.diff-1],4);
      utHelperTxt('ut-sans-float',rp(SP.sThrow));
    }else{
      var d=5+Math.floor(Math.random()*15);
      UT.bhp=Math.max(0,UT.bhp-d);utBFlash();
      utBossMsg(rp(BP.sansHit));
      utHelperTxt('ut-sans-float',rp(SP.sThrow)+' -'+d);
      if(UT.bhp<=0)setTimeout(function(){utEnd(true)},800);
      utCheckPhase();
    }
  });
  if(UT.pA)utUpdateHelper(UT.pap,'ut-pap-float',B,SP.pIdle,function(){utOR();utHelperTxt('ut-pap-float',rp(SP.pThrow))});

  if(UT.bflash>0){UT.bflash-=16;if(UT.bflash<=0){UT.bflash=0;var i=$('ut-opp-img');if(i)i.style.filter=''}}
  if(UT.shake>0){UT.shake-=16;var m=$('ut-mid');if(m)m.style.transform='translate('+(Math.random()-.5)*6+'px,'+(Math.random()-.5)*6+'px)';if(UT.shake<=0&&m)m.style.transform=''}
  utUpdateHp();

  if(UT.hp<=0){
    if(UT.fd&&UT.sA&&!UT.p5Active){
      UT.fd=false;UT.hp=1;
      utTotem(function(){UT.tp='player';utShowActs()});
    }else{
      utEnd(false);
    }
    UT.raf=requestAnimationFrame(utLoop);return;
  }
  UT.raf=requestAnimationFrame(utLoop);
}

function utMoveH(){
  var s=UT.spd,k=UT.keys;
  if(k.ArrowLeft||k.KeyA||k.a||k['—Ñ'])UT.px-=s;
  if(k.ArrowRight||k.KeyD||k.d||k['–≤'])UT.px+=s;
  if(k.ArrowUp||k.KeyW||k.w||k['—Ü'])UT.py-=s;
  if(k.ArrowDown||k.KeyS||k.s||k['—ã'])UT.py+=s;
  if(UT.wind)UT.px+=UT.wind*[1,1.5,2][UT.diff-1];
  var minX=UT._bwShiftLeft||0;
  var maxX=(UT.bwLimit>0)?UT.bwLimit:UT.bw-18;
  UT.px=Math.max(minX,Math.min(maxX,UT.px));
  UT.py=Math.max(0,Math.min(UT.bh-18,UT.py));
  $('ut-heart').style.left=UT.px+'px';$('ut-heart').style.top=UT.py+'px';
  $('ut-heart').style.opacity=(UT.inv>0&&Math.floor(UT.inv/50)%2===0)?'.3':'1';
}
function utMoveP(){for(var i=UT.proj.length-1;i>=0;i--){var p=UT.proj[i];p.x+=p.vx;p.y+=p.vy;p.el.style.left=(p.x-p.r)+'px';p.el.style.top=(p.y-p.r)+'px';if(p.x<-60||p.x>UT.bw+60||p.y<-60||p.y>UT.bh+60){p.el.remove();UT.proj.splice(i,1)}}}
function utMoveB(){for(var i=UT.bones.length-1;i>=0;i--){var b=UT.bones[i];b.x+=b.vx;b.y+=b.vy;b.el.style.left=b.x+'px';b.el.style.top=b.y+'px';if(b.x<-100||b.x>UT.bw+100||b.y<-100||b.y>UT.bh+100){b.el.remove();UT.bones.splice(i,1)}}}
function utCheckCol(){if(UT.inv>0)return;var hx=UT.px+4,hy=UT.py+4,hw=10,hh=10,dmg=[5,8,12][UT.diff-1];for(var i=0;i<UT.proj.length;i++){var p=UT.proj[i];if(p.golden)continue;var dx=hx+hw/2-p.x,dy=hy+hh/2-p.y;if(Math.sqrt(dx*dx+dy*dy)<p.r+5){utTD(dmg);return}}for(var i=0;i<UT.bones.length;i++){var b=UT.bones[i];if(hx<b.x+b.w&&hx+hw>b.x&&hy<b.y+b.h&&hy+hh>b.y){if(b.color==='blue'){if(UT.moving){utTD(dmg);utCBH();return}}else if(b.color==='orange'){if(!UT.moving){utTD(dmg);utCBH();return}}else{utTD(dmg);return}}}}
function utCheckBeams(){if(UT.inv>0)return;var hx=UT.px+4,hy=UT.py+4,dmg=[8,12,18][UT.diff-1];for(var i=0;i<UT.beams.length;i++){var b=UT.beams[i];if(b.horiz){if(hy>b.pos-5&&hy<b.pos+25){utTD(dmg);return}}else{if(hx>b.pos-5&&hx<b.pos+25){utTD(dmg);return}}}}
function utCheckRev(){if(UT.inv>0)return;var hx=UT.px+4,hy=UT.py+4,hw=10,hh=10;for(var i=UT.proj.length-1;i>=0;i--){var p=UT.proj[i],dx=hx+hw/2-p.x,dy=hy+hh/2-p.y;if(Math.sqrt(dx*dx+dy*dy)<p.r+8){p.el.remove();UT.proj.splice(i,1);UT.catches++;var d=15+Math.floor(Math.random()*20);UT.bhp=Math.max(0,UT.bhp-d);utBFlash();utShowDmg(d,true);var w=UT.catches%2===0;if(UT.sA)utHelperTxt('ut-sans-float',w?'—Ö–µ—Ö! -'+d:'–µ—â—ë!');if(UT.pA)utHelperTxt('ut-pap-float',w?'':'–ù–¨–ï–•–ï–•–ï! -'+d);UT.shake=100;if(UT.bhp<=0)setTimeout(function(){utEnd(true)},800);utCheckPhase();return}}for(var i=0;i<UT.bones.length;i++){var b=UT.bones[i];if(b.color!=='white')continue;if(hx<b.x+b.w&&hx+hw>b.x&&hy<b.y+b.h&&hy+hh>b.y){utTD([3,5,7][UT.diff-1]);return}}}
function utCBH(){if(performance.now()-UT.cbHit<3000)return;UT.cbHit=performance.now();if(UT.sA)utHelperTxt('ut-sans-float',rp(SP.sCbHit));else if(UT.pA)utHelperTxt('ut-pap-float',rp(SP.pCbHit))}
function utTD(d){
  UT.hp-=d;UT.inv=1000;UT.shake=250;utUpdateHp();
  if(Math.random()<.35)utBossMsg(rp(BP.dmgPlayer));
}
function utMoveAC(){var bw=$('ut-atk-bar').offsetWidth||300,sp=[4,6,9][UT.diff-1];UT.abX+=sp*UT.abD;if(UT.abX>=bw){UT.abX=bw;UT.abD=-1}if(UT.abX<=0){UT.abX=0;UT.abD=1}$('ut-atk-cursor').style.left=UT.abX+'px'}

function utEnd(won){
  utStop();
  if(won&&!UT.trial){utBossMsg(rp(BP.end));}
  setTimeout(function(){
    $('ut-result').classList.add('on');
    $('ut-res-title').textContent=won?'* YOU WON!':'* YOU DIED';
    $('ut-res-title').className=won?'win':'lose';
    var extra=UT.p5Active||won&&UT.phase===5?'<br>‚òÖ –í—ã–∂–∏–ª –≤ –§–∞–∑–µ 5!':'';
    var stats='HP: '+Math.ceil(Math.max(0,UT.hp))+'/'+UT.mhp
      +'<br>Boss HP: '+Math.ceil(Math.max(0,UT.bhp))+'/'+UT.bmhp
      +'<br>Phase: '+UT.phase
      +(UT.rev?'<br>Catches: '+UT.catches:'')
      +'<br>Turns: '+UT.tc+extra;
    if(UT.trial){
      stats+='<br><br>üéÆ –ü—Ä–æ–±–Ω—ã–π —Ä–µ–∂–∏–º';
      $('ut-res-stats').innerHTML=stats;
      var btn=$('ut-res-btn');btn.textContent='‚Üê –ù–∞–∑–∞–¥';
      btn.onclick=function(){$('ut-result').classList.remove('on');utStop();showWaitRoom()};
      var rb=document.createElement('button');rb.className='bplay';
      rb.style.cssText='font-size:14px;padding:10px 30px;font-family:monospace;margin-top:10px;background:#39ffdc;color:#000';
      rb.textContent='‚öîÔ∏è –ï—â—ë —Ä–∞–∑';
      rb.onclick=function(){$('ut-result').classList.remove('on');startTrialUT()};
      $('ut-res-stats').appendChild(document.createElement('br'));$('ut-res-stats').appendChild(rb);
    }else{
      $('ut-res-stats').innerHTML=stats;
      var btn=$('ut-res-btn'),sc=UT.sd;
      if(won){btn.textContent='* Continue';btn.onclick=function(){$('ut-result').classList.remove('on');if(sc&&sc.next){scr('S-game');gameLoad(sc.next)}else{scr('S-game');gameEnd()}}}
      else{btn.textContent='* Try Again';btn.onclick=function(){$('ut-result').classList.remove('on');utStart(sc)}}
    }
  },won&&!UT.trial?2000:0);
}

/* ‚îÄ‚îÄ –ü—Ä–æ–±–Ω—ã–π –±–æ–π ‚îÄ‚îÄ */
function startTrialUT(){utStart({id:'trial',name:'Trial',utBoss:true,utDiff:1,utBossHp:2000,bfChar:null,bfSongName:'Training',next:null},true)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CHESS FINAL BOSS ‚Äî CODE SILHOUETTE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var CB={
  active:false,raf:null,audio:null,sd:null,
  px:3,py:6,hp:100,mhp:100,inv:0,
  bhp:3000,bmhp:3000,phase:1,turn:0,
  pieces:[],validMoves:[],selMode:false,
  abA:false,abX:0,abD:1,
  tp:'dialogue',
  bw:0,bh:0,bossW:0,bossH:0,
  t:0,shake:0,glitch:0,
  dangerSquares:[]
};

var CB_CODE=['01','if','fn','{}','[]','<>','//','&&','||','==','!=','++',
  'for','var','let','int','def','new','end','nil','ret','get','set',
  '0x','::','->','=>','null','true','void','err','NaN','>>>','...'];

var CBM={
  intro:['> –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...','> –û–±–Ω–∞—Ä—É–∂–µ–Ω –Ω–∞—Ä—É—à–∏—Ç–µ–ª—å.','> –ù–∞—á–∞–ª–æ —É–¥–∞–ª–µ–Ω–∏—è.'],
  p2:['> –û–®–ò–ë–ö–ê. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫...','> –ü—Ä–æ—Ç–æ–∫–æ–ª 2.0 –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.'],
  p3:['> –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –°–ë–û–ô.','> –°–ò–°–¢–ï–ú–ê –í –û–ü–ê–°–ù–û–°–¢–ò.'],
  p4:['> KERNEL PANIC','> –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞...'],
  atk:['> Execute()','> Kill -9','> Segfault','> rm -rf *'],
  win:['> ...–ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à—ë–Ω.']
};

function cbBack(){cbStop();if(CB.sd&&CB.sd.trial)showWaitRoom();else toMenu()}

function cbStop(){
  CB.active=false;
  if(CB.raf){cancelAnimationFrame(CB.raf);CB.raf=null}
  if(CB.audio){CB.audio.pause();CB.audio=null}
  CB.validMoves=[];CB.selMode=false;CB.dangerSquares=[];CB.abA=false;
  $('cb-board-wrap').style.transform='';
}

function cbStart(sd){
  cbStop();CB.sd=sd;
  var diff=sd.utDiff||2;
  CB.mhp=100;CB.hp=100;CB.bmhp=sd.utBossHp||3000;CB.bhp=CB.bmhp;
  CB.phase=1;CB.turn=0;CB.tp='dialogue';CB.inv=0;CB.t=0;
  CB.shake=0;CB.glitch=0;CB.dangerSquares=[];
  CB.px=3;CB.py=6;CB.validMoves=[];CB.selMode=false;CB.abA=false;
  CB.pieces=[];cbSpawnPieces(1);
  var ch=sd.bfChar?findChar(sd.bfChar):null;
  $('cb-bname').textContent=ch?ch.name:'SYSTEM.exe';
  scr('S-chess');
  $('cb-result').classList.remove('on');
  $('cb-overlay-phase').classList.remove('on');
  $('cb-phase-ind').textContent='‚óà PHASE 1';
  cbHideActs();
  requestAnimationFrame(function(){requestAnimationFrame(function(){
    cbSetup();cbUpdateHP();cbUpdateBHP();
    cbBossDlg(CBM.intro,function(){CB.tp='player';cbShowActs()});
    cbLoadAudio(sd.id);
    CB.active=true;CB.raf=requestAnimationFrame(cbLoop);
  })});
}

function cbSetup(){
  var bwrap=$('cb-board-wrap'),br=bwrap.getBoundingClientRect();
  var bd=$('cb-board');
  bd.width=Math.floor(br.width*2);bd.height=Math.floor(br.height*2);
  bd.style.width=br.width+'px';bd.style.height=br.height+'px';
  CB.bw=br.width;CB.bh=br.height;
  var side=$('cb-side'),sr=side.getBoundingClientRect();
  var sz=Math.min(sr.width*0.85,180);
  var bc=$('cb-boss-cvs');
  bc.width=Math.floor(sz*2);bc.height=Math.floor(sz*3);
  bc.style.width=sz+'px';bc.style.height=(sz*1.5)+'px';
  CB.bossW=sz;CB.bossH=sz*1.5;
}

function cbLoadAudio(id){
  if(!id||id==='trial')return;
  fetch('/api/audio-check/'+id).then(function(r){return r.json()}).then(function(d){
    if(d.exists){CB.audio=new Audio('/api/audio/'+id);CB.audio.loop=true;CB.audio.volume=.5;CB.audio.play().catch(function(){})}
  }).catch(function(){});
}

/* ‚îÄ‚îÄ –ü—Ä–æ–µ–∫—Ü–∏—è 3D –¥–æ—Å–∫–∏ ‚îÄ‚îÄ */
function cbProj(col,row){
  var w=CB.bw,h=CB.bh;
  var hy=h*.06,ny=h*.95;
  var fl=w*.22,fr=w*.78,nl=0,nr=w;
  var t=row/8,e=t*t*(3-2*t);
  var left=fl+(nl-fl)*e,right=fr+(nr-fr)*e;
  return{x:left+(right-left)*col/8,y:hy+(ny-hy)*e};
}

function cbTileC(col,row){
  var a=cbProj(col,row),b=cbProj(col+1,row),c=cbProj(col+1,row+1),d=cbProj(col,row+1);
  return{x:(a.x+b.x+c.x+d.x)/4,y:(a.y+b.y+c.y+d.y)/4,sz:Math.max(20,(c.y-a.y)*.75)};
}

/* ‚îÄ‚îÄ –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª ‚îÄ‚îÄ */
function cbLoop(){
  if(!CB.active)return;
  CB.t+=16;
  if(CB.inv>0)CB.inv-=16;
  if(CB.shake>0)CB.shake-=16;
  if(CB.glitch>0)CB.glitch-=16;

  // Draw board
  var bd=$('cb-board'),ctx=bd.getContext('2d');
  ctx.save();ctx.scale(2,2);cbDrawBoard(ctx);ctx.restore();

  // Draw boss
  var bc=$('cb-boss-cvs'),bctx=bc.getContext('2d');
  bctx.save();bctx.scale(2,2);cbDrawBoss(bctx,CB.bossW,CB.bossH);bctx.restore();

  // Attack bar
  if(CB.abA){
    var tw=$('cb-timing').offsetWidth||200;
    var sp=[4,6,9][Math.min(2,(CB.sd.utDiff||2)-1)];
    CB.abX+=sp*CB.abD;
    if(CB.abX>=tw){CB.abX=tw;CB.abD=-1}else if(CB.abX<=0){CB.abX=0;CB.abD=1}
    $('cb-tc').style.left=CB.abX+'px';
  }

  // Shake
  if(CB.shake>0)$('cb-board-wrap').style.transform='translate('+(Math.random()-.5)*8+'px,'+(Math.random()-.5)*8+'px)';
  else $('cb-board-wrap').style.transform='';

  CB.raf=requestAnimationFrame(cbLoop);
}

/* ‚îÄ‚îÄ –†–∏—Å—É–µ–º –¥–æ—Å–∫—É ‚îÄ‚îÄ */
function cbDrawBoard(ctx){
  var w=CB.bw,h=CB.bh;
  ctx.clearRect(0,0,w,h);
  var gr=ctx.createLinearGradient(0,0,0,h);
  gr.addColorStop(0,CB.phase>=4?'#0c0018':'#050015');
  gr.addColorStop(1,'#000510');
  ctx.fillStyle=gr;ctx.fillRect(0,0,w,h);

  // Stars
  ctx.fillStyle='rgba(200,220,255,.5)';
  for(var s=0;s<25;s++){ctx.fillRect((Math.sin(s*137.5)*.5+.5)*w,(Math.cos(s*89.3)*.5+.5)*h*.12,1,1)}

  // Tiles
  for(var r=0;r<8;r++){
    for(var c=0;c<8;c++){
      var p00=cbProj(c,r),p10=cbProj(c+1,r),p11=cbProj(c+1,r+1),p01=cbProj(c,r+1);
      var dark=(r+c)%2===0;
      var lc=['#0e2040','#061020'],lc2=['#0a1830','#060e18'],lc3=['#140830','#08041a'],lc4=['#1a0025','#0d0018'];
      var pair=[lc,lc2,lc3,lc4][Math.min(3,CB.phase-1)];
      ctx.fillStyle=dark?pair[1]:pair[0];
      // Danger
      var isDanger=false;
      for(var d=0;d<CB.dangerSquares.length;d++){if(CB.dangerSquares[d].c===c&&CB.dangerSquares[d].r===r){isDanger=true;break}}
      if(isDanger)ctx.fillStyle='rgba(255,'+(CB.phase>=3?0:30)+',50,'+(0.5+.4*Math.sin(CB.t*.02))+')';
      // Valid move
      var isValid=false;
      for(var v=0;v<CB.validMoves.length;v++){if(CB.validMoves[v].c===c&&CB.validMoves[v].r===r){isValid=true;break}}
      if(isValid)ctx.fillStyle='rgba(0,255,180,.4)';
      // Player
      if(c===CB.px&&r===CB.py)ctx.fillStyle='rgba(255,215,0,'+(0.18+.1*Math.sin(CB.t*.012))+')';

      ctx.beginPath();ctx.moveTo(p00.x,p00.y);ctx.lineTo(p10.x,p10.y);ctx.lineTo(p11.x,p11.y);ctx.lineTo(p01.x,p01.y);ctx.closePath();ctx.fill();
      ctx.strokeStyle='rgba(0,200,255,.1)';ctx.lineWidth=.5;ctx.stroke();
    }
  }

  // Grid lines
  var gc=CB.phase>=3?'rgba(0,200,255,.3)':'rgba(0,200,255,.18)';
  ctx.strokeStyle=gc;ctx.lineWidth=.8;
  for(var c=0;c<=8;c++){var pt=cbProj(c,0),pb=cbProj(c,8);ctx.beginPath();ctx.moveTo(pt.x,pt.y);ctx.lineTo(pb.x,pb.y);ctx.stroke()}
  for(var r=0;r<=8;r++){var pl=cbProj(0,r),pr=cbProj(8,r);ctx.beginPath();ctx.moveTo(pl.x,pl.y);ctx.lineTo(pr.x,pr.y);ctx.stroke()}

  // Enemy pieces
  for(var i=0;i<CB.pieces.length;i++)cbDrawPieceAt(ctx,CB.pieces[i].col,CB.pieces[i].row,CB.pieces[i].sym,false);
  // Player
  cbDrawPieceAt(ctx,CB.px,CB.py,'‚ôî',true);
}

function cbDrawPieceAt(ctx,col,row,sym,isPlayer){
  var tc=cbTileC(col,row);
  var sz=tc.sz;
  var bob=Math.sin(CB.t*.004+(col+row)*.9)*2.5;
  ctx.save();ctx.globalAlpha=.3;ctx.fillStyle='#000';
  ctx.beginPath();ctx.ellipse(tc.x,tc.y+sz*.12,sz*.32,sz*.1,0,0,Math.PI*2);ctx.fill();ctx.restore();
  ctx.save();
  ctx.shadowBlur=isPlayer?24:14;
  ctx.shadowColor=isPlayer?'#ffd700':'#ff3366';
  ctx.font='bold '+Math.round(sz)+'px serif';
  ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillStyle=isPlayer?'#ffe566':'#ff6688';
  ctx.fillText(sym,tc.x,tc.y-bob-sz*.04);
  ctx.restore();
}

/* ‚îÄ‚îÄ –†–∏—Å—É–µ–º —Å–∏–ª—É—ç—Ç –±–æ—Å—Å–∞ ‚îÄ‚îÄ */
function cbDrawBoss(ctx,w,h){
  ctx.clearRect(0,0,w,h);
  var t=CB.t,cx=w/2,sc2=w*.42;
  var color=CB.phase>=4?'#ff00cc':CB.phase>=3?'#ff4444':CB.phase>=2?'#44aaff':'#00ffcc';
  ctx.fillStyle='#000010';ctx.fillRect(0,0,w,h);
  var grd=ctx.createRadialGradient(cx,h*.4,0,cx,h*.4,w);
  grd.addColorStop(0,'rgba(0,255,180,.04)');grd.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=grd;ctx.fillRect(0,0,w,h);

  function drawSil(){
    ctx.beginPath();
    ctx.ellipse(cx,h*.1,sc2*.28,sc2*.31,0,0,Math.PI*2);
    ctx.moveTo(cx-sc2*.42,h*.25);
    ctx.bezierCurveTo(cx-sc2*.55,h*.22,cx-sc2*.7,h*.3,cx-sc2*.75,h*.48);
    ctx.lineTo(cx-sc2*.85,h*.65);ctx.lineTo(cx-sc2*.65,h*.67);
    ctx.lineTo(cx-sc2*.5,h*.46);ctx.lineTo(cx-sc2*.37,h*.65);
    ctx.lineTo(cx-sc2*.42,h*.96);ctx.lineTo(cx-sc2*.18,h*.96);
    ctx.lineTo(cx-sc2*.08,h*.71);ctx.lineTo(cx+sc2*.08,h*.71);
    ctx.lineTo(cx+sc2*.18,h*.96);ctx.lineTo(cx+sc2*.42,h*.96);
    ctx.lineTo(cx+sc2*.37,h*.65);ctx.lineTo(cx+sc2*.5,h*.46);
    ctx.lineTo(cx+sc2*.65,h*.67);ctx.lineTo(cx+sc2*.85,h*.65);
    ctx.lineTo(cx+sc2*.75,h*.48);
    ctx.bezierCurveTo(cx+sc2*.7,h*.3,cx+sc2*.55,h*.22,cx+sc2*.42,h*.25);
    ctx.closePath();
  }

  // Clip and fill with scrolling code
  ctx.save();drawSil();ctx.clip();
  ctx.fillStyle='#000020';ctx.fillRect(0,0,w,h);
  var cw=9,ch2=12,nc=Math.ceil(w/cw)+1,nr=Math.ceil(h/ch2)+2;
  ctx.font='8px "Courier New",monospace';
  for(var r=0;r<nr;r++){
    var rowOff=(t*.025+r*.18)%1;
    for(var c=0;c<nc;c++){
      var idx=Math.floor(Math.abs(Math.sin(t*.001+r*3.7+c*1.3))*CB_CODE.length)%CB_CODE.length;
      var alpha=.2+.8*Math.abs(Math.sin(t*.002+r*.5+c*1.1));
      if(Math.random()<.007)alpha=1;
      ctx.globalAlpha=Math.min(1,alpha);
      ctx.fillStyle=color;
      ctx.fillText(CB_CODE[idx],c*cw,(r+rowOff)*ch2);
    }
  }
  ctx.globalAlpha=1;ctx.restore();

  // Outline
  ctx.save();
  ctx.shadowBlur=18+8*Math.sin(t*.005);ctx.shadowColor=color;
  ctx.strokeStyle=color;ctx.lineWidth=CB.phase>=3?2:1.5;
  ctx.globalAlpha=.7+.3*Math.sin(t*.004);
  drawSil();ctx.stroke();
  ctx.restore();

  // Glitch lines
  if(CB.glitch>0){
    var gf=CB.glitch/800;
    ctx.save();
    for(var g=0;g<4;g++){
      ctx.globalAlpha=gf*Math.random()*.5;
      ctx.fillStyle=['#ff0','#f0f','#0ff','#f00'][g];
      ctx.fillRect(0,Math.random()*h,w,1+Math.random()*8);
    }
    ctx.restore();
  }
}

/* ‚îÄ‚îÄ –§–∏–≥—É—Ä—ã ‚îÄ‚îÄ */
function cbSpawnPieces(phase){
  CB.pieces=[];
  var P=function(col,row,type,sym){return{col:col,row:row,type:type,sym:sym}};
  if(phase===1)CB.pieces=[P(1,1,'pawn','‚ôü'),P(4,0,'pawn','‚ôü'),P(6,1,'pawn','‚ôü')];
  else if(phase===2)CB.pieces=[P(0,0,'bishop','‚ôù'),P(7,0,'bishop','‚ôù'),P(2,0,'rook','‚ôú'),P(5,1,'pawn','‚ôü'),P(3,1,'knight','‚ôû')];
  else if(phase===3)CB.pieces=[P(0,0,'rook','‚ôú'),P(7,0,'rook','‚ôú'),P(1,0,'knight','‚ôû'),P(6,0,'knight','‚ôû'),P(4,1,'bishop','‚ôù')];
  else CB.pieces=[P(3,0,'queen','‚ôõ'),P(0,0,'rook','‚ôú'),P(7,0,'rook','‚ôú'),P(2,1,'knight','‚ôû'),P(5,1,'knight','‚ôû')];
}

function cbShowActs(){var b=document.querySelectorAll('.cb-btn');for(var i=0;i<b.length;i++)b[i].disabled=false}
function cbHideActs(){var b=document.querySelectorAll('.cb-btn');for(var i=0;i<b.length;i++)b[i].disabled=true}

function cbBossDlg(lines,cb){
  CB.tp='dialogue';cbHideActs();
  var el=$('cb-dlg'),idx=0;
  function show(){el.textContent=lines[Math.min(idx,lines.length-1)];idx++;if(idx<lines.length)setTimeout(show,1700);else setTimeout(function(){if(cb)cb()},1000)}
  show();
}

function cbBMsg(txt){$('cb-dlg').textContent=txt}
function cbUpdateHP(){var p=Math.max(0,CB.hp/CB.mhp*100);$('cb-phpfill').style.width=p+'%';$('cb-phptxt').textContent=Math.ceil(Math.max(0,CB.hp))+'/'+CB.mhp}
function cbUpdateBHP(){var p=Math.max(0,CB.bhp/CB.bmhp*100);$('cb-bhpfill').style.width=p+'%';$('cb-bhptxt').textContent=Math.ceil(Math.max(0,CB.bhp))+'/'+CB.bmhp}

function cbCheckPhase(){
  var p=CB.bhp/CB.bmhp,np=p>.75?1:p>.5?2:p>.25?3:4;
  if(np>CB.phase){CB.phase=np;cbPhaseTr(np)}
}

function cbPhaseTr(p){
  CB.tp='transition';cbHideActs();CB.abA=false;
  $('cb-timing').classList.remove('show');
  CB.glitch=1200;CB.shake=900;
  var ov=$('cb-overlay-phase');
  var phaseColors=['','#00ffcc','#44aaff','#ff4444','#ff00cc'];
  ov.style.color=phaseColors[p]||'#00ffcc';
  ov.style.textShadow='0 0 30px '+(phaseColors[p]||'#00ffcc');
  ov.textContent='‚óà PHASE '+p+' ‚óà';
  ov.classList.add('on');
  $('cb-phase-ind').textContent='‚óà PHASE '+p;
  var m=CBM['p'+p];if(m)setTimeout(function(){cbBMsg(rp(m))},600);
  cbSpawnPieces(p);CB.dangerSquares=[];
  setTimeout(function(){ov.classList.remove('on');CB.tp='player';cbShowActs()},2300);
}

function cbAct(type){
  if(CB.tp!=='player')return;
  if(type==='atk'){
    var hasAdj=false;
    for(var i=0;i<CB.pieces.length;i++){var p=CB.pieces[i];if(Math.abs(p.col-CB.px)<=1&&Math.abs(p.row-CB.py)<=1){hasAdj=true;break}}
    if(!hasAdj){cbBMsg('> –ù–µ—Ç –≤—Ä–∞–≥–æ–≤ –≤ –∑–æ–Ω–µ –¥–æ—Å—è–≥–∞–µ–º–æ—Å—Ç–∏');return}
    CB.tp='attack';cbHideActs();CB.abA=true;CB.abX=0;CB.abD=1;
    var el=$('cb-timing');el.classList.add('show');
    var tw=el.offsetWidth||200,zw=tw*.16;
    $('cb-tz').style.left=(tw-zw)/2+'px';$('cb-tz').style.width=zw+'px';
    cbBMsg('> –ù–∞–∂–º–∏ –≤ –Ω—É–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç!');
  }else{
    CB.selMode=true;CB.validMoves=[];
    var dirs=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
    for(var d=0;d<dirs.length;d++){
      var nc=CB.px+dirs[d][0],nr=CB.py+dirs[d][1];
      if(nc>=0&&nc<8&&nr>=0&&nr<8){
        var occ=false;for(var i=0;i<CB.pieces.length;i++){if(CB.pieces[i].col===nc&&CB.pieces[i].row===nr){occ=true;break}}
        if(!occ)CB.validMoves.push({c:nc,r:nr});
      }
    }
    cbBMsg('> –í—ã–±–µ—Ä–∏ –∫–ª–µ—Ç–∫—É –¥–ª—è —Ö–æ–¥–∞');
  }
}

function cbHitAtk(){
  if(!CB.active||CB.tp!=='attack'||!CB.abA)return;
  CB.abA=false;$('cb-timing').classList.remove('show');
  var tw=$('cb-timing').offsetWidth||200,zw=tw*.16,zx=(tw-zw)/2;
  var dist=Math.abs(CB.abX-(zx+zw/2));
  var m=Math.max(0,1-dist/(tw/2));
  var diff=(CB.sd.utDiff||2)-1;
  var base=[35,50,70][diff];
  var dmg=Math.floor(base+base*2*m*m),crit=m>.82;
  if(crit)dmg=Math.floor(dmg*1.6);
  CB.bhp=Math.max(0,CB.bhp-dmg);CB.glitch=crit?700:300;CB.shake=crit?450:200;
  cbUpdateBHP();cbBMsg((crit?'> CRITICAL! -':'> -')+dmg);
  if(CB.bhp<=0){setTimeout(function(){cbEnd(true)},800);return}
  cbCheckPhase();CB.tp='player';
  setTimeout(cbEnemyTurn,700);
}

function cbTileClick(e){
  if(!CB.active||!CB.selMode||CB.tp!=='player')return;
  e.stopPropagation();
  var bd=$('cb-board'),rect=bd.getBoundingClientRect();
  var cl=e.touches?e.touches[0].clientX:e.clientX;
  var ct=e.touches?e.touches[0].clientY:e.clientY;
  var mx=cl-rect.left,my=ct-rect.top;
  var best=null,bestD=110;
  for(var i=0;i<CB.validMoves.length;i++){
    var v=CB.validMoves[i],tc=cbTileC(v.c,v.r);
    var d=Math.sqrt((mx-tc.x)*(mx-tc.x)+(my-tc.y)*(my-tc.y));
    if(d<bestD){bestD=d;best=v}
  }
  if(!best)return;
  CB.selMode=false;CB.validMoves=[];
  CB.px=best.c;CB.py=best.r;
  for(var i=CB.pieces.length-1;i>=0;i--){
    if(CB.pieces[i].col===CB.px&&CB.pieces[i].row===CB.py){
      CB.pieces.splice(i,1);
      var capDmg=Math.floor(20+Math.random()*35);
      CB.bhp=Math.max(0,CB.bhp-capDmg);CB.glitch=400;cbUpdateBHP();
      cbBMsg('> –ó–∞—Ö–≤–∞—Ç! -'+capDmg);
      if(CB.bhp<=0){setTimeout(function(){cbEnd(true)},800);return}
      cbCheckPhase();break;
    }
  }
  setTimeout(cbEnemyTurn,600);
}

function cbEnemyTurn(){
  if(!CB.active||CB.bhp<=0)return;
  CB.tp='enemy';cbHideActs();CB.turn++;
  for(var i=0;i<CB.pieces.length;i++){
    var p=CB.pieces[i],dc=CB.px-p.col,dr=CB.py-p.row,mc=0,mr=0;
    switch(p.type){
      case'pawn':mr=dr>0?1:-1;if(Math.abs(dc)>1)mc=dc>0?1:-1;break;
      case'bishop':mc=dc>0?1:-1;mr=dr>0?1:-1;break;
      case'rook':if(Math.abs(dc)>=Math.abs(dr))mc=dc>0?1:-1;else mr=dr>0?1:-1;break;
      case'knight':
        var km=[[-2,-1],[-2,1],[2,-1],[2,1],[-1,-2],[-1,2],[1,-2],[1,2]],kb=null,kbd=999;
        for(var k=0;k<km.length;k++){var knc=p.col+km[k][0],knr=p.row+km[k][1];if(knc<0||knc>7||knr<0||knr>7)continue;var kd=Math.sqrt((CB.px-knc)*(CB.px-knc)+(CB.py-knr)*(CB.py-knr));if(kd<kbd){kbd=kd;kb={c:km[k][0],r:km[k][1]}}}
        if(kb){mc=kb.c;mr=kb.r}break;
      case'queen':
        var ax=Math.abs(dc),ay=Math.abs(dr);
        if(ax===0)mr=dr>0?1:-1;else if(ay===0)mc=dc>0?1:-1;else{mc=dc>0?1:-1;mr=dr>0?1:-1}break;
    }
    var nc=p.col+mc,nr=p.row+mr;
    if(nc>=0&&nc<8&&nr>=0&&nr<8){p.col=nc;p.row=nr}
    if(p.col===CB.px&&p.row===CB.py&&CB.inv<=0){
      var diff=(CB.sd.utDiff||2)-1;
      var dmg=[8,13,20][diff]*(p.type==='queen'?2:1);
      CB.hp-=dmg;CB.inv=1000;CB.shake=350;cbUpdateHP();
      cbBMsg(rp(CBM.atk)+' -'+dmg);
    }
  }
  if(CB.hp<=0){setTimeout(function(){cbEnd(false)},600);return}
  var freq=[4,3,2][(CB.sd.utDiff||2)-1];
  if(CB.turn%freq===0){cbBossAtk();return}
  setTimeout(function(){if(CB.active){CB.tp='player';cbShowActs()}},500);
}

function cbBossAtk(){
  cbBMsg(rp(CBM.atk));CB.dangerSquares=[];
  var n=3+CB.phase+Math.floor(Math.random()*3),att=0;
  while(CB.dangerSquares.length<Math.min(n,24)&&att<60){
    att++;var dc=Math.floor(Math.random()*8),dr=Math.floor(Math.random()*8);
    if(dc===CB.px&&dr===CB.py)continue;
    var dup=false;for(var d=0;d<CB.dangerSquares.length;d++){if(CB.dangerSquares[d].c===dc&&CB.dangerSquares[d].r===dr){dup=true;break}}
    if(!dup)CB.dangerSquares.push({c:dc,r:dr});
  }
  setTimeout(function(){
    for(var d=0;d<CB.dangerSquares.length;d++){
      if(CB.dangerSquares[d].c===CB.px&&CB.dangerSquares[d].r===CB.py&&CB.inv<=0){
        var diff=(CB.sd.utDiff||2)-1;
        var dmg=Math.floor([12,18,28][diff]*(1+CB.phase*.25));
        CB.hp-=dmg;CB.inv=800;CB.shake=500;cbUpdateHP();cbBMsg('> EXECUTE -'+dmg);break;
      }
    }
    CB.dangerSquares=[];
    if(CB.hp<=0){setTimeout(function(){cbEnd(false)},500);return}
    setTimeout(function(){if(CB.active){CB.tp='player';cbShowActs()}},300);
  },2200);
}

function cbEnd(won){
  cbStop();
  $('cb-result').classList.add('on');
  $('cb-rtitle').textContent=won?'> –ü–û–ë–ï–î–ê':'> –ü–û–†–ê–ñ–ï–ù–ò–ï';
  $('cb-rtitle').className=won?'win':'lose';
  $('cb-rstats').innerHTML='Boss: '+Math.ceil(Math.max(0,CB.bhp))+'/'+CB.bmhp
    +'<br>HP: '+Math.ceil(Math.max(0,CB.hp))+'/'+CB.mhp
    +'<br>Phase: '+CB.phase+'<br>–•–æ–¥–æ–≤: '+CB.turn;
  var btn=$('cb-rbtn'),sc=CB.sd;
  if(won){btn.textContent='–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';btn.onclick=function(){$('cb-result').classList.remove('on');if(sc&&sc.next){scr('S-game');gameLoad(sc.next)}else{scr('S-game');gameEnd()}}}
  else{btn.textContent='–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';btn.onclick=function(){$('cb-result').classList.remove('on');cbStart(sc)}}
}

/* ‚ïê‚ïê‚ïê –£–ü–†–ê–í–õ–ï–ù–ò–ï ‚ïê‚ïê‚ïê */
document.addEventListener('keydown',function(e){
  if(BF.active){if(e.key==='ArrowLeft'||e.code==='KeyA')bfHit(0);else if(e.key==='ArrowDown'||e.code==='KeyS')bfHit(1);else if(e.key==='ArrowUp'||e.code==='KeyW')bfHit(2);else if(e.key==='ArrowRight'||e.code==='KeyD')bfHit(3)}
  UT.keys[e.key]=true;UT.keys[e.code]=true;
  if(UT.active){if(UT.tp==='dialogue'&&(e.key==='z'||e.key==='Enter'||e.key===' '||e.key==='—è'))utAdvDlg();if(UT.abA&&(e.key==='z'||e.key==='Enter'||e.key===' '||e.key==='—è'))utDoHit()}
});
document.addEventListener('keyup',function(e){UT.keys[e.key]=false;UT.keys[e.code]=false});
document.addEventListener('click',function(e){if(!UT.active)return;if(UT.tp==='dialogue')utAdvDlg();else if(UT.abA)utDoHit()});
(function(){var tx=0,ty=0,t=false;
  document.addEventListener('touchstart',function(e){if(!UT.active||UT.tp!=='attack')return;t=true;tx=e.touches[0].clientX;ty=e.touches[0].clientY});
  document.addEventListener('touchmove',function(e){if(!t||!UT.active||UT.tp!=='attack')return;e.preventDefault();var c=e.touches[0];UT.px+=c.clientX-tx;UT.py+=c.clientY-ty;UT.px=Math.max(UT._bwShiftLeft||0,Math.min((UT.bwLimit>0?UT.bwLimit:UT.bw-18),UT.px));UT.py=Math.max(0,Math.min(UT.bh-18,UT.py));tx=c.clientX;ty=c.clientY},{passive:false});
  document.addEventListener('touchend',function(){t=false});
})();

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
// Chess board handlers
(function(){
  var bd=$('cb-board');
  bd.addEventListener('click',cbTileClick);
  bd.addEventListener('touchend',function(e){e.preventDefault();cbTileClick(e)},{passive:false});
  document.addEventListener('click',function(e){if(CB.active&&CB.tp==='attack'&&CB.abA)cbHitAtk()});
})();
(function(){if(window.Telegram&&Telegram.WebApp){Telegram.WebApp.ready();Telegram.WebApp.expand()}loadData().then(function(){updateMenu();$('loader').classList.add('hide');setTimeout(function(){$('loader').style.display='none'},600)})})();
</script>
</body>
</html>
