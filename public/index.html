<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<title>Visual Novel - Avangard</title>
<style>
/* –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',sans-serif;background:#0b0b1a;color:#eaeaea;user-select:none}

/* –ü–û–í–û–†–û–¢ –≠–ö–†–ê–ù–ê */
#rotate{display:none;position:fixed;inset:0;background:#0b0b1a;z-index:9999;flex-direction:column;align-items:center;justify-content:center;gap:20px}
.ri{font-size:56px;animation:rr 2s ease-in-out infinite}
@keyframes rr{0%,100%{transform:rotate(0)}50%{transform:rotate(90deg)}}
@media(orientation:portrait)and(max-width:900px){#rotate{display:flex}#app{display:none!important}}

/* –õ–û–ê–î–ï–† */
#loader{position:fixed;inset:0;background:#0b0b1a;z-index:9998;display:flex;align-items:center;justify-content:center;flex-direction:column;transition:opacity .5s}
.spinner{width:40px;height:40px;border:3px solid #2a2a50;border-top-color:#e94560;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#loader.hide{opacity:0;pointer-events:none}

/* –≠–ö–†–ê–ù–´ */
.scr{display:none;position:absolute;inset:0;width:100%;height:100%}.scr.on{display:flex}

/* –ú–ï–ù–Æ */
#S-menu{flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#0b0b1a,#1a1040);gap:20px}
#m-title{font-size:clamp(30px,6vw,60px);font-weight:900;letter-spacing:4px;text-transform:uppercase;background:linear-gradient(135deg,#e94560,#ff6b81);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.bplay{padding:16px 60px;font-size:20px;font-weight:700;background:#e94560;color:#fff;border:none;border-radius:50px;cursor:pointer;text-transform:uppercase}
.bgear{position:absolute;top:15px;right:15px;width:45px;height:45px;background:rgba(255,255,255,0.1);border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(255,255,255,0.2)}

/* –û–ñ–ò–î–ê–ù–ò–ï */
#S-wait{flex-direction:column;align-items:center;justify-content:center;gap:20px;background:#0b0b1a}
#w-pepe{width:130px;cursor:pointer;filter:drop-shadow(0 0 10px rgba(0,255,0,0.2))}
#w-timer{font-size:48px;font-weight:900;text-shadow:0 0 20px #e94560}
#w-phrase{position:absolute;bottom:180px;background:rgba(30,30,60,0.95);border:2px solid #4ecca3;padding:12px;border-radius:12px;color:#4ecca3;opacity:0;transition:0.3s}
#w-phrase.show{opacity:1}

/* –ù–û–í–ï–õ–õ–ê */
#S-game{flex-direction:column!important}
#g-top{flex:1;position:relative;background:#000;overflow:hidden}
#g-bg{position:absolute;inset:0;background-size:cover;background-position:center}
#g-char{position:absolute;bottom:0;height:85%;max-width:40%;object-fit:contain;display:none}
#g-char.vis{display:block}#g-char.pl{left:5%}#g-char.pc{left:50%;transform:translateX(-50%)}#g-char.pr{right:5%}
#g-dlg{flex-shrink:0;background:#0a0a28;border-top:3px solid #e94560;padding:20px;min-height:140px;cursor:pointer;position:relative}
#g-name{display:inline-block;padding:4px 15px;background:#e94560;border-radius:5px;font-weight:700;margin-bottom:10px}
#g-txt{font-size:18px;line-height:1.6}
#g-choices{position:absolute;inset:0;background:rgba(0,0,0,0.8);display:none;flex-direction:column;align-items:center;justify-content:center;gap:15px;z-index:50}
#g-choices.on{display:flex}
.chb{padding:15px 40px;min-width:280px;background:#161632;border:2px solid #e94560;color:#fff;border-radius:10px;cursor:pointer}

/* UNDERTALE BOSS (V5 AVANGARD) */
#S-ut{flex-direction:column!important;background:#000;position:relative;overflow:hidden}
#ut-phase-indicator{position:absolute;top:10px;right:10px;font-family:monospace;color:#555;font-size:14px}
#ut-top{height:38%;position:relative;display:flex;justify-content:center;align-items:center}
#ut-opp-img{max-height:180px;image-rendering:pixelated;filter:drop-shadow(0 0 10px rgba(255,255,255,0.2));transition:0.3s}
#ut-dlg{position:absolute;bottom:5px;background:#000;border:3px solid #fff;border-radius:10px;padding:12px;color:#fff;font-family:monospace;max-width:85%;text-align:center;display:none;z-index:20}
#ut-dlg.show{display:block}
#ut-mid{flex:1;display:flex;align-items:center;justify-content:center}
#ut-box{position:relative;border:4px solid #fff;background:#000;overflow:hidden;transition:0.3s}
#ut-heart{position:absolute;width:20px;height:20px;z-index:30}
#ut-heart::before{content:'‚ù§';color:#f00;font-size:18px;display:block;text-align:center}
#ut-hp{display:flex;align-items:center;gap:12px;padding:10px;font-family:monospace}
#ut-hp-bar{width:220px;height:22px;background:#300;border:2px solid #fff;position:relative}
#ut-hp-fill{height:100%;background:#ff0;transition:width 0.3s}
#ut-actions{display:flex;justify-content:center;gap:25px;padding-bottom:15px}
.ut-act{padding:12px 35px;background:#000;border:3px solid #f00;color:#f00;font-family:monospace;font-weight:900;cursor:pointer;font-size:18px}
.ut-act:hover, .ut-act.sel{background:#f00;color:#fff}
#ut-atk-bar{height:35px;border:3px solid #fff;margin:0 25px;position:relative;display:none}
#ut-atk-bar.show{display:block}
#ut-atk-cursor{position:absolute;width:5px;height:100%;background:#0f0;box-shadow:0 0 10px #0f0}
#ut-atk-zone{position:absolute;height:100%;background:rgba(255,255,255,0.25);border-left:2px solid #fff;border-right:2px solid #fff}
.ut-proj, .ut-bone{position:absolute;z-index:10}
.ut-beam{position:absolute;z-index:11;opacity:0}
.ut-beam.warn{opacity:0.3;background:#fff}
.ut-beam.fire{opacity:1;background:#fff;box-shadow:0 0 20px #fff}
#ut-dmg{position:absolute;font-family:monospace;font-size:32px;font-weight:900;color:#fff;pointer-events:none;opacity:0;z-index:100}
#ut-dmg.show{animation:utDmg 0.8s forwards}
@keyframes utDmg{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-60px)}}
#ut-phase-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:1000;display:none;align-items:center;justify-content:center;color:#fff;font-size:36px;font-family:monospace;text-align:center;padding:20px}
#ut-phase-overlay.on{display:flex}
#ut-totem-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:2000;display:none;align-items:center;justify-content:center;flex-direction:column;gap:20px}
#ut-totem-overlay.on{display:flex}
#ut-totem-skull{font-size:100px;filter:drop-shadow(0 0 30px gold);animation:totemGlow 1s infinite}
@keyframes totemGlow{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.ut-piano{position:absolute;font-size:60px;z-index:15;filter:drop-shadow(0 0 10px rgba(255,255,255,0.5))}
.ut-sword{position:absolute;font-size:30px;z-index:16;filter:drop-shadow(0 0 10px red)}
.ut-gun{position:absolute;font-size:28px;z-index:16;filter:drop-shadow(0 0 10px orange)}

/* FNF BOSS */
#S-boss{background:#050510;flex-direction:column!important}
#bf-canvas{width:100%;height:100%}
#bf-hud{position:absolute;top:0;width:100%;padding:10px;display:flex;align-items:center;gap:15px;background:linear-gradient(to bottom,rgba(0,0,0,0.7),transparent)}
#bf-hbar{flex:1;height:18px;background:#1a1a3e;border-radius:10px;border:2px solid #333;overflow:hidden}
#bf-hfill{height:100%;width:50%;background:linear-gradient(90deg,#e94560,#4ecca3);transition:0.2s}
#bf-score-txt{font-weight:700;font-size:20px}

/* DEV PANEL */
#S-dev{flex-direction:column;background:#0b0b1a}
.dtabs{display:flex;background:#161630;border-bottom:1px solid #2a2a50}
.dt{padding:15px 25px;cursor:pointer;color:#7878a0;font-size:14px}.dt.on{color:#e94560;border-bottom:2px solid #e94560}
.dc{flex:1;overflow-y:auto;padding:20px}
#toast{position:fixed;bottom:25px;left:50%;transform:translateX(-50%) translateY(100px);padding:14px 30px;border-radius:10px;z-index:10000;transition:0.3s;font-weight:600}
#toast.show{transform:translateX(-50%) translateY(0)}

/* –ü–õ–ò–¢–ö–ò DEV */
.dgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px}
.dcard{background:#161630;border:1px solid #2a2a50;border-radius:12px;overflow:hidden;cursor:pointer}
.dcimg{width:100%;height:110px;background-size:cover;background-position:center;background-color:#000}
.dcinf{padding:10px}.dcn{font-weight:600;font-size:14px}
</style>
</head>
<body>

<div id="rotate"><div class="ri">üì±</div><p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</p></div>
<div id="loader"><div class="spinner"></div><div style="margin-top:15px;color:#7878a0">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div></div>

<div id="app">
    <!-- MENU -->
    <div id="S-menu" class="scr on">
        <button class="bgear" onclick="openCode()">üîß</button>
        <h1 id="m-title">Visual Novel</h1>
        <div id="menu-status" style="margin-bottom:10px"></div>
        <button class="bplay" id="btn-play" onclick="startGame()">–ò–≥—Ä–∞—Ç—å</button>
    </div>

    <!-- WAIT ROOM -->
    <div id="S-wait" class="scr">
        <button style="position:absolute;top:15px;left:15px;padding:8px 15px;background:rgba(255,255,255,0.1);border:1px solid #444;border-radius:8px;color:#fff" onclick="scr('S-menu')">‚Üê –ù–∞–∑–∞–¥</button>
        <img id="w-pepe" src="https://i.postimg.cc/d019wCRm/1645078923-3-abrakadabra-fun-p-malenkii-lyagushonok-pepe-10-removebg-preview.png" onclick="pepeTap()">
        <div id="w-phrase"></div>
        <div id="w-timer">00:00:00</div>
        <div style="color:#7878a0;margin-top:-10px">–¥–æ –∑–∞–ø—É—Å–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å—é–∂–µ—Ç–∞</div>
        <button class="bplay" onclick="startTrialUT()" style="font-size:16px;padding:12px 40px;margin-top:20px;background:#4ecca3;color:#000">‚öîÔ∏è –ü—Ä–æ–±–Ω—ã–π –±–æ–π</button>
    </div>

    <!-- NOVEL ENGINE -->
    <div id="S-game" class="scr">
        <div id="g-top">
            <div id="g-bg"></div>
            <img id="g-char" src="" alt="">
            <button style="position:absolute;top:10px;left:10px;z-index:10;padding:6px 12px;background:rgba(0,0,0,0.6);color:#fff;border:1px solid #666;border-radius:5px" onclick="toMenu()">‚Üê –ú–µ–Ω—é</button>
        </div>
        <div id="g-dlg" onclick="advance()">
            <div id="g-name"></div>
            <div id="g-txt"></div>
            <div style="position:absolute;bottom:10px;right:20px;opacity:0.4;animation:bk 1s infinite">‚ñº</div>
        </div>
        <div id="g-choices"></div>
        <div id="g-end" class="scr" style="background:rgba(0,0,0,0.9);flex-direction:column;align-items:center;justify-content:center;display:none;z-index:100">
            <h2 style="font-size:48px;color:#e94560;margin-bottom:30px">–ö–û–ù–ï–¶</h2>
            <button class="bplay" onclick="toMenu()">–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
        </div>
    </div>

    <!-- FNF BOSS -->
    <div id="S-boss" class="scr">
        <canvas id="bf-canvas"></canvas>
        <div id="bf-hud">
            <div id="bf-song-name" style="color:#39ffdc;font-weight:700">‚ô™ SONG</div>
            <div id="bf-hbar"><div id="bf-hfill"></div></div>
            <div id="bf-score-txt" style="color:#fff;min-width:80px;text-align:right">0</div>
        </div>
        <div id="bf-rating-txt" style="position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);font-weight:900;pointer-events:none"></div>
        <div id="bf-ctrl" style="position:absolute;bottom:20px;width:100%;display:flex;justify-content:center;gap:15px">
            <button class="bplay" style="width:80px;padding:20px" onpointerdown="bfHit(0)">‚Üê</button>
            <button class="bplay" style="width:80px;padding:20px" onpointerdown="bfHit(1)">‚Üì</button>
            <button class="bplay" style="width:80px;padding:20px" onpointerdown="bfHit(2)">‚Üë</button>
            <button class="bplay" style="width:80px;padding:20px" onpointerdown="bfHit(3)">‚Üí</button>
        </div>
    </div>

    <!-- UNDERTALE BOSS (V5) -->
    <div id="S-ut" class="scr">
        <div id="ut-phase-indicator">Phase 1</div>
        <div id="ut-top">
            <div id="ut-opp">
                <img id="ut-opp-img" src="" alt="">
                <div id="ut-opp-name" style="color:#fff;font-family:monospace;margin-top:5px">Boss</div>
            </div>
            <div id="ut-dlg"></div>
        </div>
        <div id="ut-mid">
            <div id="ut-box"><div id="ut-heart"></div></div>
        </div>
        <div id="ut-bot">
            <div id="ut-hp">
                <span style="color:#fff;font-weight:bold">HP</span>
                <div id="ut-hp-bar"><div id="ut-hp-fill"></div></div>
                <span id="ut-hp-txt" style="color:#fff;min-width:60px">92/92</span>
            </div>
            <div id="ut-actions">
                <button class="ut-act" id="ut-btn-fight" onclick="utAction('fight')">‚öî FIGHT</button>
            </div>
            <div id="ut-atk-bar"><div id="ut-atk-zone"></div><div id="ut-atk-cursor"></div></div>
        </div>
        <div id="ut-dmg"></div>
        <div id="ut-phase-overlay"></div>
        <div id="ut-totem-overlay">
            <div id="ut-totem-skull">üíÄ</div>
            <div id="ut-totem-text" style="color:gold;font-family:monospace;font-size:20px;text-align:center"></div>
        </div>
        
        <!-- UT RESULT -->
        <div id="ut-result" class="scr" style="background:rgba(0,0,0,0.95);flex-direction:column;align-items:center;justify-content:center;z-index:5000;display:none">
            <h2 id="ut-res-title" style="font-size:50px;font-family:monospace;margin-bottom:20px"></h2>
            <div id="ut-res-stats" style="color:#aaa;font-family:monospace;text-align:center;line-height:2;margin-bottom:30px"></div>
            <button class="bplay" id="ut-res-btn" style="font-family:monospace"></button>
        </div>
    </div>

    <!-- DEV -->
    <div id="S-dev" class="scr">
        <div style="padding:15px;background:#161630;display:flex;align-items:center;gap:20px">
            <button onclick="toMenu()" style="padding:8px 15px;background:#333;color:#fff;border:none;border-radius:5px">‚Üê –ù–∞–∑–∞–¥</button>
            <h2 style="font-size:18px">–ü–∞–Ω–µ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</h2>
        </div>
        <div class="dtabs">
            <div class="dt on" onclick="dTab('bg',this)">üñº –§–æ–Ω—ã</div>
            <div class="dt" onclick="dTab('ch',this)">üë§ –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</div>
            <div class="dt" onclick="dTab('sc',this)">üìú –°—Ü–µ–Ω—ã</div>
            <div class="dt" onclick="dTab('set',this)">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        </div>
        <div class="dc" id="dc"></div>
    </div>
</div>

<div id="toast"></div>

<!-- –ú–û–î–ê–õ–ö–ò (–ü—Ä–∏–º–µ—Ä –æ–¥–Ω–æ–π –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏) -->
<div id="M-code" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center">
    <div style="background:#161630;padding:30px;border-radius:15px;width:300px">
        <h3 style="margin-bottom:15px">–î–æ—Å—Ç—É–ø</h3>
        <input type="password" id="i-code" style="width:100%;padding:10px;background:#000;border:1px solid #444;color:#fff;margin-bottom:15px">
        <div style="display:flex;gap:10px">
            <button onclick="checkCode()" style="flex:1;padding:10px;background:#e94560;color:#fff;border:none;border-radius:5px">–í–æ–π—Ç–∏</button>
            <button onclick="hideM('M-code')" style="flex:1;padding:10px;background:#333;color:#fff;border:none;border-radius:5px">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê GLOBAL VARIABLES ‚ïê‚ïê‚ïê */
var CODE = '050412', isAdmin = false;
var TARGET = new Date('2026-03-01T00:00:00+03:00').getTime();
var D = { title: 'Visual Novel', bgs: [], chars: [], scenes: [], start: null };
var G = { sid: null, step: 0, typing: false, timer: null, full: '' };

/* ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê */
function $(id){ return document.getElementById(id); }
function scr(id){ 
    document.querySelectorAll('.scr').forEach(s => s.classList.remove('on'));
    $(id).classList.add('on'); 
}
function toast(m, e){
    var t = $('toast'); t.textContent = m;
    t.style.background = e ? '#e94560' : '#4ecca3';
    t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000);
}

/* ‚ïê‚ïê‚ïê CORE LOAD ‚ïê‚ïê‚ïê */
async function loadData() {
    try {
        const r = await fetch('/api/data');
        const data = await r.json();
        if (data) D = data;
        updateMenu();
    } catch (e) { console.error(e); }
    $('loader').classList.add('hide');
}

function updateMenu() {
    $('m-title').textContent = D.title || 'Visual Novel';
    var st = $('menu-status'), btn = $('btn-play');
    if (!D.scenes || D.scenes.length === 0) {
        st.innerHTML = '<span style="color:#e94560">–ü—É—Å—Ç–æ</span>';
        btn.disabled = true;
    } else {
        st.innerHTML = `<span style="color:#4ecca3">–ì–æ—Ç–æ–≤–æ: ${D.scenes.length} —Å—Ü–µ–Ω</span>`;
        btn.disabled = false;
    }
}

/* ‚ïê‚ïê‚ïê VN ENGINE ‚ïê‚ïê‚ïê */
function startGame() {
    if (!isAdmin && Date.now() < TARGET) {
        scr('S-wait'); startWaitTimer(); return;
    }
    if (!D.start) return toast('–ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ü–µ–Ω–∞ –Ω–µ –∑–∞–¥–∞–Ω–∞', 1);
    scr('S-game'); gameLoad(D.start);
}

function gameLoad(sid) {
    G.sid = sid; G.step = 0;
    var sc = D.scenes.find(s => s.id === sid);
    if (!sc) return gameEnd();
    
    // Background
    if (sc.bgId) {
        var bg = D.bgs.find(b => b.id === sc.bgId);
        if (bg) $('g-bg').style.backgroundImage = `url(${bg.data})`;
    } else {
        $('g-bg').style.backgroundImage = 'none';
    }
    gameShow();
}

function gameShow() {
    var sc = D.scenes.find(s => s.id === G.sid);
    var st = sc.steps[G.step];
    
    // Character
    var cel = $('g-char');
    if (st.chId) {
        var ch = D.chars.find(c => c.id === st.chId);
        if (ch) {
            cel.src = ch.data; cel.className = 'vis ' + (st.pos === 'left' ? 'pl' : st.pos === 'right' ? 'pr' : 'pc');
            $('g-name').textContent = ch.name; $('g-name').style.display = 'inline-block';
        }
    } else {
        cel.classList.remove('vis'); $('g-name').style.display = 'none';
    }
    
    gameType(st.text || '...');
}

function gameType(t) {
    G.typing = true; G.full = t;
    var el = $('g-txt'), i = 0; el.textContent = '';
    clearInterval(G.timer);
    G.timer = setInterval(() => {
        if (i < t.length) { el.textContent += t[i]; i++; }
        else { clearInterval(G.timer); G.typing = false; checkChoices(); }
    }, 30);
}

function advance() {
    if (G.typing) {
        clearInterval(G.timer); $('g-txt').textContent = G.full;
        G.typing = false; checkChoices(); return;
    }
    var sc = D.scenes.find(s => s.id === G.sid);
    var st = sc.steps[G.step];
    if (st.hasCh) return; // Wait for choice
    
    G.step++;
    if (G.step >= sc.steps.length) {
        // –ü–µ—Ä–µ—Ö–æ–¥ –≤ –±–∏—Ç–≤—É –∏–ª–∏ —Å–ª–µ–¥—É—é—â—É—é —Å—Ü–µ–Ω—É
        if (sc.utBoss) utStart(sc);
        else if (sc.bossFight) bfStart(sc);
        else if (sc.next) gameLoad(sc.next);
        else gameEnd();
    } else {
        gameShow();
    }
}

function checkChoices() {
    var sc = D.scenes.find(s => s.id === G.sid);
    var st = sc.steps[G.step];
    if (st.hasCh && st.choices && st.choices.length > 0) {
        var box = $('g-choices'); box.innerHTML = '';
        st.choices.forEach((c, idx) => {
            var b = document.createElement('button');
            b.className = 'chb'; b.textContent = c.text;
            b.onclick = () => { box.classList.remove('on'); if (c.target) gameLoad(c.target); else gameEnd(); };
            box.appendChild(b);
        });
        box.classList.add('on');
    }
}

function gameEnd() { scr('S-game'); $('g-end').style.display = 'flex'; }
function toMenu() { utStop(); bfStop(); scr('S-menu'); }

/* ‚ïê‚ïê‚ïê UNDERTALE BOSS V5 (AVANGARD) ‚ïê‚ïê‚ïê */
var UT = {
    active: false, raf: null, tp: 'player', bhp: 2000, bmhp: 2000, hp: 92, mhp: 92,
    phase: 1, px: 0, py: 0, spd: 3.5, inv: 0, keys: {}, proj: [], bones: [], beams: [],
    atT: 0, atD: 6000, spA: 0, abA: false, abX: 0, abD: 1, sA: true, pA: false, sDied: false,
    trial: false, p5Timer: 90, sword: null, gun: null, wind: 0, shake: 0, bflash: 0
};

var SP = {
    bossHit: ["–ê—Ö!..~", "–ú—Ñ~", "–•–º—Ñ~", "–û—Ö...~"],
    playerHit: ["*–∫—É—Å—å —Å—Ç—Ä–∞—Å—Ç–Ω–æ –∑–∞ –≥—É–±–∫–∏*", "–ü–æ–ª—É—á–∞–π!", "–£–º—Ä–∏!"],
    bossIdle: ["–°–µ–π—á–∞—Å —è —Ç–µ–±—è –Ω–∞–∫–∞–∂—É!", "–Ø –Ω–µ —Ç–∞–∫ –ø—Ä–æ—Å—Ç–∞ –∫–∞–∫ —Ç–∞ –ø–µ–≤—á–∞—è –ø—Ç–∏—á–∫–∞!", "–°–µ–π—á–∞—Å —è —Å–æ—Ç—Ä—É —Ç–≤–æ–µ –º–∏–ª–æ–µ –ª–∏—á–∏–∫–æ –≤ –ø–æ—Ä–æ—à–æ–∫!", "–ù–∞ –∫–æ–ª–µ–Ω–∏!"],
    sansHitBoss: ["–ê—Ö —Ç—ã!...", "–ê–π!", "–î–∞ —è —Ç–µ–±—è!..", "–î–∞ –∫–∞–∫ —Ç—ã —Å–º–µ–µ—à—å?!"],
    sansDeath: "–ü–æ–∫–∞-–ø–æ–∫–∞, —Å–∫–µ–ª–µ—Ç–∏–∫!",
    phaseStarts: {
        1: "–ù—É —Ä–∞–∑ —Ç—ã —Ö–æ—á–µ—à—å –ø–æ –ø–ª–æ—Ö–æ–º—É...",
        2: "–ü–ª–æ—Ö–æ–π –º–∞–ª—å—á–∏–∫!",
        3: "–ù—É –∑–∞—á–µ–º –∂–µ —Ç–∞–∫ –∂—ë—Å—Ç–∫–æ?..",
        4: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞....",
        5: "–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ '–ê–≤–∞–Ω–≥–∞—Ä–¥'"
    },
    end: "–Ø... –Ø... –ü—Ä–æ—Å—Ç–∏ –º–µ–Ω—è, –º–∏–ª–∞—à–∫–∞."
};

function utStart(sd) {
    UT.active = true; UT.sd = sd; UT.bhp = 2000; UT.bmhp = 2000; UT.hp = 92;
    UT.phase = 1; UT.sA = true; UT.pA = false; UT.sDied = false; UT.p5Timer = 90;
    UT.proj = []; UT.bones = []; UT.beams = [];
    
    scr('S-ut'); utSetupBox(); utUpdateHp();
    
    var ch = D.chars.find(c => c.id === sd.bfChar);
    if (ch) $('ut-opp-img').src = ch.data;
    
    utShowDlg([SP.phaseStarts[1]]);
    UT.raf = requestAnimationFrame(utLoop);
}

function utSetupBox() {
    var sz = 240; UT.bw = sz; UT.bh = sz;
    var b = $('ut-box'); b.style.width = sz+'px'; b.style.height = sz+'px';
    UT.px = sz/2 - 10; UT.py = sz/2 - 10;
}

function utUpdateHp() {
    var p = (UT.hp / UT.mhp) * 100;
    $('ut-hp-fill').style.width = p+'%';
    $('ut-hp-txt').textContent = Math.ceil(UT.hp)+'/'+UT.mhp;
}

function utShowDlg(lines) {
    UT.tp = 'dialogue'; UT.dlg = lines; UT.dlI = 0;
    var el = $('ut-dlg'); el.textContent = lines[0]; el.classList.add('show');
    $('ut-btn-fight').style.display = 'none';
}

function utAdvDlg() {
    UT.dlI++;
    if (UT.dlI >= UT.dlg.length) {
        $('ut-dlg').classList.remove('show');
        if (UT.phase === 5) { UT.tp = 'attack'; UT.atT = performance.now(); UT.atD = 999999; }
        else { UT.tp = 'player'; $('ut-btn-fight').style.display = 'block'; }
    } else {
        $('ut-dlg').textContent = UT.dlg[UT.dlI];
    }
}

function utAction(t) {
    if (t === 'fight') {
        UT.tp = 'attack_cursor'; UT.abA = true; UT.abX = 0; UT.abD = 1;
        $('ut-atk-bar').classList.add('show'); $('ut-btn-fight').style.display = 'none';
    }
}

function utDoHit() {
    if (!UT.abA) return; UT.abA = false;
    $('ut-atk-bar').classList.remove('show');
    var barW = $('ut-atk-bar').offsetWidth, zoneW = barW * 0.2, zoneX = (barW - zoneW)/2;
    var dist = Math.abs(UT.abX - (zoneX + zoneW/2));
    var m = Math.max(0, 1 - dist/(barW/2));
    var dmg = Math.floor(60 + 140 * m); if (m > 0.85) dmg = Math.floor(dmg * 1.5);
    
    UT.bhp -= dmg; utShowDmg(dmg, m > 0.85);
    utCheckPhase();
    setTimeout(() => { if (UT.bhp > 0 && UT.phase < 5) utStartAtk(); }, 1000);
}

function utCheckPhase() {
    var np = 1;
    if (UT.bhp <= 250) np = 5;
    else if (UT.bhp <= 500) np = 4;
    else if (UT.bhp <= 1000) np = 3;
    else if (UT.bhp <= 1500) np = 2;

    if (np !== UT.phase) { UT.phase = np; utPhaseTr(np); }
}

function utPhaseTr(to) {
    UT.tp = 'transition'; utClearBox();
    if (to === 5) { UT.hp = UT.mhp; utUpdateHp(); UT.sA = false; UT.pA = false; }
    
    var ov = $('ut-phase-overlay'); ov.textContent = SP.phaseStarts[to];
    ov.classList.add('on');
    setTimeout(() => {
        ov.classList.remove('on');
        if (to === 5) { UT.tp = 'attack'; UT.atT = performance.now(); UT.atD = 999999; }
        else utShowDlg(["* –¢–≤–æ–π —Ö–æ–¥."]);
    }, 2000);
}

function utStartAtk() {
    UT.tp = 'attack'; UT.atT = performance.now(); UT.spA = 0; utClearBox();
    UT.atD = 6000 + (UT.phase * 1000);
}

function utClearBox() {
    UT.proj.forEach(p => p.el.remove()); UT.proj = [];
    UT.bones.forEach(b => b.el.remove()); UT.bones = [];
    UT.beams.forEach(b => b.el.remove()); UT.beams = [];
}

function utLoop() {
    if (!UT.active) return;
    if (UT.inv > 0) UT.inv -= 16;
    
    // Movement
    if (['attack', 'attack_cursor', 'player'].includes(UT.tp)) {
        var s = UT.spd;
        if (UT.keys.ArrowLeft || UT.keys.KeyA) UT.px -= s;
        if (UT.keys.ArrowRight || UT.keys.KeyD) UT.px += s;
        if (UT.keys.ArrowUp || UT.keys.KeyW) UT.py -= s;
        if (UT.keys.ArrowDown || UT.keys.KeyS) UT.py += s;
        UT.px += UT.wind; UT.px = Math.max(0, Math.min(UT.bw - 20, UT.px));
        UT.py = Math.max(0, Math.min(UT.bh - 20, UT.py));
        $('ut-heart').style.left = UT.px+'px'; $('ut-heart').style.top = UT.py+'px';
        $('ut-heart').style.opacity = (UT.inv > 0 && Math.floor(UT.inv/50)%2 === 0) ? 0.3 : 1;
    }

    if (UT.tp === 'attack') {
        if (UT.phase < 5) utSpawnNormal(); else utSpawnP5();
        utMoveObj(); utCheckCol();
        if (performance.now() - UT.atT > UT.atD && UT.phase < 5) {
            UT.tp = 'player'; utClearBox(); $('ut-btn-fight').style.display = 'block';
        }
    }

    if (UT.tp === 'attack_cursor') {
        UT.abX += 7 * UT.abD; if (UT.abX >= 250 || UT.abX <= 0) UT.abD *= -1;
        $('ut-atk-cursor').style.left = UT.abX+'px';
    }

    if (UT.bhp <= 0 && UT.tp !== 'ending') {
        UT.tp = 'ending'; utClearBox(); utShowDlg([SP.end]);
        setTimeout(() => utEnd(true), 3000);
    }
    
    // Sans hitting boss
    if (UT.sA && UT.active && UT.tp === 'attack' && Math.random() < 0.005) {
        UT.bhp -= 20; utBFlash(); utShowBossMsg(rp(SP.sansHitBoss)); utCheckPhase();
    }

    UT.raf = requestAnimationFrame(utLoop);
}

function utSpawnNormal() {
    UT.spA += 16; if (UT.spA > (450 - UT.phase * 50)) {
        UT.spA = 0; var r = Math.random();
        if (r < 0.4) utAddBone(); else utAddProj();
    }
}

function utSpawnP5() {
    UT.p5Timer -= 0.016; $('ut-phase-indicator').textContent = "AVANGARD: " + Math.ceil(UT.p5Timer) + "s";
    if (UT.p5Timer <= 0) { UT.bhp = 0; return; }
    UT.spA += 16; if (UT.spA > 140) {
        UT.spA = 0; var r = Math.random();
        if (r < 0.2) utAddPiano(); else if (r < 0.6) utAddProj(true); else utAddBone(true);
        if (Math.random() < 0.1) UT.wind = (Math.random() - 0.5) * 8;
        if (Math.random() < 0.05) utAddSword();
    }
}

function utAddProj(f) {
    var el = document.createElement('div'); el.className = 'ut-proj';
    el.style.width = '12px'; el.style.height = '12px'; el.style.background = '#fff'; el.style.borderRadius = '50%';
    var x = Math.random()*UT.bw, y = -15;
    $('ut-box').appendChild(el);
    UT.proj.push({el, x, y, vx: (Math.random()-0.5)*3, vy: f?6:4, r:6});
}

function utAddBone(f) {
    var el = document.createElement('div'); el.className = 'ut-bone';
    var w = 12, h = 50 + Math.random()*70;
    el.style.width = w+'px'; el.style.height = h+'px'; el.style.background = '#fff';
    var x = UT.bw, y = UT.bh - h;
    $('ut-box').appendChild(el);
    UT.bones.push({el, x, y, vx: f?-7:-5, vy: 0, w, h});
}

function utAddPiano() {
    var el = document.createElement('div'); el.className = 'ut-piano'; el.textContent = 'üéπ';
    var x = Math.random()*(UT.bw - 50); el.style.left = x+'px'; el.style.top = '-60px';
    $('ut-box').appendChild(el);
    UT.proj.push({el, x: x+25, y: -30, vx: 0, vy: 9, r: 25, isPiano: true});
}

function utAddSword() {
    var el = document.createElement('div'); el.className = 'ut-sword'; el.textContent = '‚öîÔ∏è';
    var x = Math.random()*UT.bw, y = Math.random()*UT.bh;
    el.style.left = x+'px'; el.style.top = y+'px';
    $('ut-box').appendChild(el);
    setTimeout(() => { if (el.parentNode) el.remove(); }, 2000);
}

function utMoveObj() {
    for (var i = UT.proj.length - 1; i >= 0; i--) {
        var p = UT.proj[i]; p.x += p.vx; p.y += p.vy;
        p.el.style.left = (p.x - p.r) + 'px'; p.el.style.top = (p.y - p.r) + 'px';
        if (p.y > UT.bh + 60) { p.el.remove(); UT.proj.splice(i, 1); }
    }
    for (var i = UT.bones.length - 1; i >= 0; i--) {
        var b = UT.bones[i]; b.x += b.vx; b.el.style.left = b.x + 'px';
        if (b.x < -60) { b.el.remove(); UT.bones.splice(i, 1); }
    }
}

function utCheckCol() {
    if (UT.inv > 0) return;
    var hx = UT.px + 10, hy = UT.py + 10;
    UT.proj.forEach(p => {
        if (Math.sqrt((hx-p.x)**2 + (hy-p.y)**2) < p.r + 8) utTD(p.isPiano ? 25 : 12);
    });
    UT.bones.forEach(b => {
        if (hx > b.x && hx < b.x+b.w && hy > b.y && hy < b.y+b.h) utTD(15);
    });
}

function utTD(d) {
    UT.hp -= d; UT.inv = 1000; utUpdateHp(); utShowBossMsg(rp(SP.playerHit));
    if (UT.hp <= 0) { if (UT.sA && !UT.sDied) utTotem(); else utEnd(false); }
}

function utTotem() {
    UT.active = false; UT.tp = 'totem';
    var ov = $('ut-totem-overlay'); ov.classList.add('on');
    $('ut-totem-text').textContent = SP.sansDeath;
    setTimeout(() => {
        $('ut-totem-text').textContent = "üíõ SANS –û–¢–î–ê–õ –°–í–û–Æ –ñ–ò–ó–ù–¨";
        UT.hp = UT.mhp; UT.sDied = true; UT.sA = false; utUpdateHp();
    }, 2000);
    setTimeout(() => {
        ov.classList.remove('on'); UT.active = true; UT.tp = 'player';
        UT.raf = requestAnimationFrame(utLoop); utStartAtk();
    }, 4500);
}

function utShowDmg(d, c) {
    var e = $('ut-dmg'); e.textContent = (c ? '‚òÖ ' : '') + d;
    e.style.left = '50%'; e.style.top = '35%'; e.classList.add('show');
    utShowBossMsg(rp(SP.bossHit));
    setTimeout(() => e.classList.remove('show'), 800);
}

function utShowBossMsg(txt) {
    var el = $('ut-dlg'); el.textContent = txt; el.classList.add('show');
    setTimeout(() => { if (UT.tp !== 'dialogue') el.classList.remove('show'); }, 1800);
}

function utEnd(won) {
    UT.active = false; cancelAnimationFrame(UT.raf);
    var res = $('ut-result'); res.style.display = 'flex';
    $('ut-res-title').textContent = won ? "–ü–û–ë–ï–î–ê!" : "–¢–´ –ü–û–ì–ò–ë";
    $('ut-res-title').style.color = won ? "#4ecca3" : "#e94560";
    $('ut-res-stats').innerHTML = `HP: ${Math.ceil(UT.hp)}<br>–§–ê–ó–ê: ${UT.phase}`;
    var btn = $('ut-res-btn'); btn.textContent = won ? "–ü–†–û–î–û–õ–ñ–ò–¢–¨" : "–ü–û–ü–†–û–ë–û–í–ê–¢–¨ –°–ù–û–í–ê";
    btn.onclick = () => { res.style.display = 'none'; if (won) toMenu(); else utStart(UT.sd); };
}

function utStop() { UT.active = false; cancelAnimationFrame(UT.raf); }
function utGoBack() { utStop(); toMenu(); }
function startTrialUT() { utStart({ id: 'trial', name: '–ü—Ä–æ–±–Ω—ã–π –±–æ–π', bfChar: null }); }
function rp(a) { return a[Math.floor(Math.random() * a.length)]; }
function utBFlash() { UT.bflash = 10; document.body.style.background = '#333'; setTimeout(() => document.body.style.background = '#0b0b1a', 50); }

/* ‚ïê‚ïê‚ïê INITIALIZATION ‚ïê‚ïê‚ïê */
window.onload = () => {
    loadData();
    window.addEventListener('keydown', e => { UT.keys[e.code] = true; });
    window.addEventListener('keyup', e => { UT.keys[e.code] = false; });
    window.addEventListener('click', () => { 
        if (UT.tp === 'dialogue') utAdvDlg(); 
        if (UT.abA) utDoHit(); 
    });
};

function startWaitTimer() {
    setInterval(() => {
        var left = TARGET - Date.now();
        if (left < 0) { $('w-timer').textContent = "–ì–û–¢–û–í–û!"; return; }
        var d = Math.floor(left / 864e5), h = Math.floor((left % 864e5) / 36e5), m = Math.floor((left % 36e5) / 6e4), s = Math.floor((left % 6e4) / 1e3);
        $('w-timer').textContent = `${d}–¥ ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }, 1000);
}

function pepeTap() {
    var p = ["–ù–µ –º–µ—à–∞–π!", "–°–∫–æ—Ä–æ...", "–£–π–¥–∏!", "–Ø –∑–∞–Ω—è—Ç!", "–ü—Å—Å, —Ö–æ—á–µ—à—å —Å–ø–æ–π–ª–µ—Ä?", "–ú—è—É?"];
    var el = $('w-phrase'); el.textContent = rp(p); el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2000);
}

function openCode() { $('M-code').style.display = 'flex'; $('i-code').focus(); }
function hideM(id) { $(id).style.display = 'none'; }
function checkCode() { if ($('i-code').value === CODE) { isAdmin = true; hideM('M-code'); scr('S-dev'); } else { toast('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥', 1); } }
</script>
