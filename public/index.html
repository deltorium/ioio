<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<title>Visual Novel</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0b0b1a;--card:#161630;--inp:#101028;
  --acc:#e94560;--acc2:#ff6b81;--txt:#eaeaea;--sub:#7878a0;
  --brd:#2a2a50;--ok:#4ecca3;--bad:#e94560
}
html,body{width:100%;height:100%;overflow:hidden;
  font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
  background:var(--bg);color:var(--txt);user-select:none;touch-action:manipulation}

/* ‚ïê‚ïê‚ïê ROTATE ‚ïê‚ïê‚ïê */
#rotate{display:none;position:fixed;inset:0;background:var(--bg);z-index:9999;
  flex-direction:column;align-items:center;justify-content:center;gap:20px}
#rotate .ri{font-size:56px;animation:rr 2s ease-in-out infinite}
@keyframes rr{0%,100%{transform:rotate(0)}50%{transform:rotate(90deg)}}
#rotate p{font-size:17px;color:var(--sub)}
@media(orientation:portrait)and(max-width:900px){
  #rotate{display:flex}#app{display:none!important}}

/* ‚ïê‚ïê‚ïê LOADER ‚ïê‚ïê‚ïê */
#loader{position:fixed;inset:0;background:var(--bg);z-index:9998;
  display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;transition:opacity .5s}
.spinner{width:42px;height:42px;border:3px solid var(--brd);border-top-color:var(--acc);
  border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#loader.hide{opacity:0;pointer-events:none}

/* ‚ïê‚ïê‚ïê SCREENS ‚ïê‚ïê‚ïê */
#app{width:100vw;height:100vh;position:relative}
.scr{display:none;position:absolute;inset:0}.scr.on{display:flex}

/* ‚ïê‚ïê‚ïê MENU ‚ïê‚ïê‚ïê */
#S-menu{flex-direction:column;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#0b0b1a 0%,#161630 40%,#1a1040 100%);gap:20px}
#m-title{font-size:clamp(26px,5vw,58px);font-weight:900;letter-spacing:3px;text-align:center;
  text-transform:uppercase;padding:0 20px;
  background:linear-gradient(135deg,var(--acc),var(--acc2),var(--acc));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  animation:glo 3s ease-in-out infinite}
@keyframes glo{0%,100%{filter:brightness(1)}50%{filter:brightness(1.4)}}
#menu-status{text-align:center;margin:10px 0;min-height:24px}
#menu-status .st-ok{color:var(--ok);font-size:14px}
#menu-status .st-no{color:var(--bad);font-size:14px}
.bplay{padding:16px 64px;font-size:20px;font-weight:700;background:var(--acc);color:#fff;
  border:none;border-radius:50px;cursor:pointer;transition:.3s;letter-spacing:2px;text-transform:uppercase}
.bplay:hover{background:var(--acc2);transform:scale(1.05);box-shadow:0 0 40px rgba(233,69,96,.4)}
.bplay:disabled{opacity:.4;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.bgear{position:absolute;top:14px;right:14px;width:44px;height:44px;
  background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);border-radius:12px;
  color:var(--sub);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.3s}
.bgear:hover{background:rgba(255,255,255,.15);color:var(--txt)}

/* ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:1000;
  align-items:center;justify-content:center;backdrop-filter:blur(6px)}
.modal.on{display:flex}
.mbox{background:var(--card);border:1px solid var(--brd);border-radius:16px;
  padding:28px;min-width:300px;max-width:92vw;max-height:90vh;overflow-y:auto}
.mbox h2{margin-bottom:18px;font-size:19px;display:flex;align-items:center;justify-content:space-between}
.mx{background:0;border:0;color:var(--sub);font-size:22px;cursor:pointer;padding:4px}
.mx:hover{color:var(--txt)}
.mlg{width:90vw;max-width:820px}
.fg{margin-bottom:15px}
.fg label{display:block;font-size:11px;color:var(--sub);margin-bottom:5px;
  font-weight:600;text-transform:uppercase;letter-spacing:.8px}
.fg input,.fg textarea,.fg select{width:100%;padding:10px 13px;background:var(--inp);
  border:1px solid var(--brd);border-radius:8px;color:var(--txt);font-size:14px;outline:0;font-family:inherit}
.fg input:focus,.fg textarea:focus,.fg select:focus{border-color:var(--acc)}
.fg textarea{min-height:60px;resize:vertical}
.fg select{cursor:pointer}
.ipv{width:100%;max-height:130px;object-fit:contain;border-radius:8px;margin-top:8px;background:var(--inp)}
.fbtn{display:inline-block;padding:8px 20px;background:rgba(255,255,255,.08);
  border:1px solid var(--brd);border-radius:8px;color:var(--txt);font-size:14px;cursor:pointer;transition:.3s}
.fbtn:hover{background:rgba(255,255,255,.15)}
.bp{padding:10px 24px;background:var(--acc);color:#fff;border:0;border-radius:8px;font-size:14px;cursor:pointer;transition:.3s}
.bp:hover{background:var(--acc2)}
.bs{padding:10px 24px;background:rgba(255,255,255,.08);color:var(--txt);
  border:1px solid var(--brd);border-radius:8px;font-size:14px;cursor:pointer;transition:.3s}
.bs:hover{background:rgba(255,255,255,.14)}
.bd{padding:10px 24px;background:0;color:var(--bad);border:1px solid var(--bad);
  border-radius:8px;font-size:14px;cursor:pointer;transition:.3s}
.bd:hover{background:var(--bad);color:#fff}
.brow{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.err-msg{color:var(--bad);font-size:13px;margin-top:-8px;margin-bottom:10px}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GAME SCREEN ‚Äî all fixed
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#S-game{
  flex-direction:column;
  position:relative;
  /* visible gradient instead of pure black */
  background:linear-gradient(135deg,#0d0d2b 0%,#1a1040 50%,#0d0d2b 100%);
}

/* background image layer */
#g-bg{
  position:absolute;inset:0;z-index:0;
  background-size:cover;
  background-position:center;
  background-color:#1a1a2e;
  transition:background-image .5s ease;
}

/* slight dim over background */
#g-dim{position:absolute;inset:0;background:rgba(0,0,0,.08);z-index:1;pointer-events:none}

/* character sprite */
#g-char{
  position:absolute;bottom:0;z-index:2;
  height:78%;max-width:42%;object-fit:contain;
  pointer-events:none;
  opacity:0;transition:opacity .4s;
}
#g-char.vis{opacity:1}
#g-char.pl{left:3%}
#g-char.pc{left:50%;transform:translateX(-50%)}
#g-char.pr{right:3%;left:auto}

/* ‚îÄ‚îÄ‚îÄ DIALOGUE BOX: solid visible background ‚îÄ‚îÄ‚îÄ */
#g-dlg{
  position:absolute;
  bottom:0;left:0;right:0;
  z-index:5;
  cursor:pointer;
  /* solid dark background ‚Äî always visible */
  background:rgba(8,8,30,.95);
  border-top:2px solid rgba(233,69,96,.3);
  min-height:25vh;
  padding:20px 40px 20px;
  display:flex;
  flex-direction:column;
  justify-content:center;
}

#g-name-wrap{margin-bottom:8px}
#g-name{
  display:inline-block;
  padding:5px 18px;
  background:var(--acc);
  border-radius:8px;
  font-size:clamp(13px,1.6vw,17px);
  font-weight:700;
  color:#fff;
}
#g-name:empty{display:none}

#g-txt{
  font-size:clamp(15px,1.8vw,20px);
  line-height:1.7;
  white-space:pre-wrap;
  min-height:2em;
  color:#ffffff;
}

#g-ind{
  position:absolute;
  bottom:14px;right:24px;
  font-size:14px;
  color:rgba(255,255,255,.4);
  animation:bk 1.4s infinite;
}
@keyframes bk{0%,100%{opacity:1}50%{opacity:.2}}

/* choices overlay */
#g-choices{
  position:absolute;inset:0;z-index:10;
  display:none;flex-direction:column;
  align-items:center;justify-content:center;gap:12px;
  background:rgba(0,0,0,.6);backdrop-filter:blur(4px);
}
#g-choices.on{display:flex}
.chb{padding:14px 44px;min-width:260px;max-width:80%;
  background:rgba(20,20,50,.95);border:2px solid var(--acc);border-radius:12px;
  color:#fff;font-size:clamp(13px,1.7vw,17px);cursor:pointer;transition:.3s;text-align:center}
.chb:hover{background:var(--acc);transform:scale(1.03)}

/* back button */
.bbk{position:absolute;top:10px;left:10px;z-index:20;padding:8px 18px;
  background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.2);border-radius:8px;
  color:#fff;font-size:13px;cursor:pointer;transition:.3s}
.bbk:hover{background:rgba(0,0,0,.85)}

/* end screen */
#g-end{position:absolute;inset:0;z-index:15;display:none;flex-direction:column;
  align-items:center;justify-content:center;background:rgba(0,0,0,.88);gap:30px}
#g-end.on{display:flex}
#g-end h2{font-size:clamp(28px,4vw,48px);
  background:linear-gradient(135deg,var(--acc),var(--acc2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}

/* debug overlay */
#g-debug{
  position:absolute;top:10px;right:10px;z-index:20;
  background:rgba(0,0,0,.7);color:#0f0;font-size:11px;
  padding:6px 10px;border-radius:6px;font-family:monospace;
  display:none;max-width:300px;word-break:break-all;
}

/* ‚ïê‚ïê‚ïê DEV PANEL ‚ïê‚ïê‚ïê */
#S-dev{flex-direction:column;background:var(--bg)}
.dh{display:flex;align-items:center;padding:10px 18px;background:var(--card);
  border-bottom:1px solid var(--brd);gap:14px;flex-shrink:0}
.dh h1{font-size:17px;flex:1}
.dtabs{display:flex;background:var(--card);border-bottom:1px solid var(--brd);flex-shrink:0;overflow-x:auto}
.dt{padding:11px 20px;font-size:13px;color:var(--sub);cursor:pointer;
  border-bottom:2px solid transparent;transition:.3s;white-space:nowrap}
.dt:hover{color:var(--txt);background:rgba(255,255,255,.04)}
.dt.on{color:var(--acc);border-bottom-color:var(--acc)}
.dc{flex:1;overflow-y:auto;padding:20px}
.dgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:15px}
.dcard{background:var(--card);border:1px solid var(--brd);border-radius:12px;overflow:hidden;
  cursor:pointer;transition:.3s}
.dcard:hover{border-color:var(--acc);transform:translateY(-2px);box-shadow:0 4px 18px rgba(233,69,96,.18)}
.dcimg{width:100%;height:115px;background:var(--inp);background-size:cover;background-position:center}
.dcinf{padding:11px}
.dcn{font-size:14px;font-weight:600;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dcs{font-size:12px;color:var(--sub)}
.dcadd{display:flex;align-items:center;justify-content:center;min-height:165px;
  border-style:dashed;flex-direction:column;gap:8px}
.dcadd .ico{font-size:34px;color:var(--sub)}
.dcadd span{font-size:13px;color:var(--sub)}
.dcard.start{border-color:var(--ok)}
.dcard.start .dcs{color:var(--ok)}
.steps{display:flex;flex-direction:column;gap:12px;margin-top:10px}
.si{background:var(--inp);border:1px solid var(--brd);border-radius:10px;padding:14px}
.sih{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.sin{font-size:12px;color:var(--acc);font-weight:700;text-transform:uppercase}
.sia{display:flex;gap:5px}
.sia button{width:27px;height:27px;background:rgba(255,255,255,.07);border:1px solid var(--brd);
  border-radius:6px;color:var(--sub);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.sia button:hover{background:rgba(255,255,255,.14);color:var(--txt)}
.sf{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.sf .fw{grid-column:1/-1}
.sf label{font-size:11px;color:var(--sub);margin-bottom:4px;display:block}
.sf input,.sf textarea,.sf select{width:100%;padding:8px 10px;background:var(--bg);
  border:1px solid var(--brd);border-radius:6px;color:var(--txt);font-size:13px;outline:0;font-family:inherit}
.sf textarea{min-height:48px;resize:vertical}
.csec{margin-top:10px;padding-top:10px;border-top:1px solid var(--brd)}
.crow{display:flex;gap:7px;margin-bottom:8px;align-items:center}
.crow input{flex:1}
.crow select{width:130px}
.crow input,.crow select{padding:7px 9px;background:var(--bg);border:1px solid var(--brd);
  border-radius:6px;color:var(--txt);font-size:12px;outline:0}
.crow button{width:27px;height:27px;background:rgba(233,69,96,.15);border:1px solid var(--bad);
  border-radius:6px;color:var(--bad);cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:13px;flex-shrink:0}
.cbtog{display:flex;align-items:center;gap:8px;margin-top:10px}
.cbtog input[type=checkbox]{width:17px;height:17px;accent-color:var(--acc)}
.cbtog label{font-size:13px;color:var(--txt);margin:0;cursor:pointer}
.bsm{padding:5px 13px;background:rgba(255,255,255,.07);border:1px solid var(--brd);
  border-radius:6px;color:var(--sub);font-size:12px;cursor:pointer;margin-top:6px}
.bsm:hover{background:rgba(255,255,255,.14);color:var(--txt)}
.setsec{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:20px;margin-bottom:16px}
.setsec h3{font-size:16px;margin-bottom:12px}

#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(100px);
  padding:14px 28px;border-radius:10px;font-size:15px;font-weight:600;z-index:5000;
  transition:transform .3s;pointer-events:none;max-width:90vw;text-align:center}
#toast.show{transform:translateX(-50%) translateY(0)}

::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:0}
::-webkit-scrollbar-thumb{background:var(--brd);border-radius:3px}
@media(max-height:500px){
  #g-dlg{min-height:30vh;padding:14px 24px 14px}
  .bplay{padding:12px 40px;font-size:17px}
}
</style>
</head>
<body>

<div id="rotate"><div class="ri">üì±</div><p>–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ</p></div>

<div id="loader">
  <div class="spinner"></div>
  <div style="color:var(--sub);font-size:15px">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
</div>

<div id="app">

<!-- ‚ïê‚ïê MENU ‚ïê‚ïê -->
<div id="S-menu" class="scr on">
  <button class="bgear" onclick="openCode()">üîß</button>
  <h1 id="m-title">–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ</h1>
  <div id="menu-status"></div>
  <button class="bplay" id="btn-play" onclick="startGame()">–ò–≥—Ä–∞—Ç—å</button>
</div>

<!-- ‚ïê‚ïê GAME ‚ïê‚ïê -->
<div id="S-game" class="scr">
  <button class="bbk" onclick="toMenu()">‚Üê –ú–µ–Ω—é</button>
  <div id="g-bg"></div>
  <div id="g-dim"></div>
  <img id="g-char" src="" alt="">
  <div id="g-debug"></div>
  <div id="g-dlg" onclick="advance()">
    <div id="g-name-wrap"><span id="g-name"></span></div>
    <div id="g-txt"></div>
    <div id="g-ind">‚ñº</div>
  </div>
  <div id="g-choices"></div>
  <div id="g-end">
    <h2>–ö–æ–Ω–µ—Ü</h2>
    <button class="bplay" onclick="toMenu()" style="font-size:16px;padding:12px 44px">–í –º–µ–Ω—é</button>
  </div>
</div>

<!-- ‚ïê‚ïê DEV PANEL ‚ïê‚ïê -->
<div id="S-dev" class="scr">
  <div class="dh">
    <button class="bs" onclick="toMenu()" style="padding:7px 14px;font-size:13px">‚Üê –ù–∞–∑–∞–¥</button>
    <h1>–ü–∞–Ω–µ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</h1>
  </div>
  <div class="dtabs">
    <div class="dt on" onclick="dTab('bg',this)">üñº –§–æ–Ω—ã</div>
    <div class="dt" onclick="dTab('ch',this)">üë§ –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</div>
    <div class="dt" onclick="dTab('sc',this)">üìú –°—Ü–µ–Ω—ã</div>
    <div class="dt" onclick="dTab('set',this)">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
  </div>
  <div class="dc" id="dc"></div>
</div>

</div>

<!-- ‚ïê‚ïê MODALS ‚ïê‚ïê -->
<div class="modal" id="M-code"><div class="mbox">
  <h2>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞</h2>
  <div class="fg">
    <label for="i-code">–ö–æ–¥</label>
    <input type="password" id="i-code" name="access-code" placeholder="–ö–æ–¥‚Ä¶" maxlength="10">
  </div>
  <div class="err-msg" id="code-err" style="display:none">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥</div>
  <div class="brow">
    <button class="bp" onclick="checkCode()">–í–æ–π—Ç–∏</button>
    <button class="bs" onclick="hideM('M-code')">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div></div>

<div class="modal" id="M-bg"><div class="mbox mlg">
  <h2><span id="bg-t">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ–Ω</span><button class="mx" onclick="hideM('M-bg')">‚úï</button></h2>
  <div class="fg">
    <label for="bg-name">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
    <input id="bg-name" name="bg-name" placeholder="–õ–µ—Å, –®–∫–æ–ª–∞‚Ä¶">
  </div>
  <div class="fg">
    <label for="bg-file">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
    <label class="fbtn">üìÅ –í—ã–±—Ä–∞—Ç—å
      <input type="file" accept="image/*" id="bg-file" name="bg-file" style="display:none"
        onchange="pvF(this,'bg-pv',1920,1080,false,'_bgD')">
    </label>
    <img id="bg-pv" class="ipv" style="display:none">
  </div>
  <div class="brow">
    <button class="bp" onclick="saveBg()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="bd" id="bg-del" style="display:none" onclick="delBg()">–£–¥–∞–ª–∏—Ç—å</button>
  </div>
</div></div>

<div class="modal" id="M-ch"><div class="mbox mlg">
  <h2><span id="ch-t">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</span><button class="mx" onclick="hideM('M-ch')">‚úï</button></h2>
  <div class="fg">
    <label for="ch-name">–ò–º—è</label>
    <input id="ch-name" name="ch-name" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞">
  </div>
  <div class="fg">
    <label for="ch-file">–°–ø—Ä–∞–π—Ç (PNG)</label>
    <label class="fbtn">üìÅ –í—ã–±—Ä–∞—Ç—å
      <input type="file" accept="image/*" id="ch-file" name="ch-file" style="display:none"
        onchange="pvF(this,'ch-pv',600,900,true,'_chD')">
    </label>
    <img id="ch-pv" class="ipv" style="display:none">
  </div>
  <div class="brow">
    <button class="bp" onclick="saveCh()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="bd" id="ch-del" style="display:none" onclick="delCh()">–£–¥–∞–ª–∏—Ç—å</button>
  </div>
</div></div>

<div class="modal" id="M-sc"><div class="mbox mlg" style="max-height:88vh">
  <h2><span id="sc-t">–î–æ–±–∞–≤–∏—Ç—å —Å—Ü–µ–Ω—É</span><button class="mx" onclick="hideM('M-sc')">‚úï</button></h2>
  <div id="sc-ed"></div>
</div></div>

<div id="toast"></div>

<script>
const CODE='050412';
const DEBUG=true; // –ø–æ—Å—Ç–∞–≤—å—Ç–µ false —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å –æ—Ç–ª–∞–¥–∫—É

let D={title:'–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ',bgs:[],chars:[],scenes:[],start:null};
let curTab='bg',editId=null,eScData=null;
window._bgD=null;window._chD=null;
let G={sid:null,step:0,typing:false,timer:null,full:''};

/* ‚ïê‚ïê‚ïê DEBUG ‚ïê‚ïê‚ïê */
function dbg(msg){
  console.log('[VN]',msg);
  if(!DEBUG)return;
  const el=$('g-debug');
  if(el){el.style.display='block';el.textContent=msg}
}

/* ‚ïê‚ïê‚ïê API ‚ïê‚ïê‚ïê */
async function api(method,body){
  try{
    const opt={method,headers:{'Content-Type':'application/json'}};
    if(body)opt.body=JSON.stringify(body);
    const r=await fetch('/api/data',opt);
    if(!r.ok)throw new Error('HTTP '+r.status);
    return await r.json();
  }catch(e){console.error('API error:',e);return null}
}

async function loadData(){
  const d=await api('GET');
  if(d){
    D=d;
    D.title=D.title||'–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ';
    D.bgs=D.bgs||[];
    D.chars=D.chars||[];
    D.scenes=D.scenes||[];
    console.log('[VN] Loaded:',D.scenes.length,'scenes, start=',D.start);
    return true;
  }
  console.error('[VN] Failed to load data');
  return false;
}

async function save(){
  const ok=await api('POST',D);
  if(!ok)toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!',1);
  return !!ok;
}

/* ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê */
function uid(){return'i'+Date.now()+'_'+Math.random().toString(36).substr(2,6)}
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function $(id){return document.getElementById(id)}

/* ‚ïê‚ïê‚ïê UI ‚ïê‚ïê‚ïê */
function scr(id){
  document.querySelectorAll('.scr').forEach(s=>s.classList.remove('on'));
  $(id).classList.add('on');
}
function showM(id){$(id).classList.add('on')}
function hideM(id){$(id).classList.remove('on')}

function toast(m,err){
  const t=$('toast');t.textContent=m;
  t.style.background=err?'var(--bad)':'var(--ok)';
  t.style.color=err?'#fff':'#000';
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),4000);
}

function updateMenu(){
  $('m-title').textContent=D.title||'–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ';
  const startScene=D.start?D.scenes.find(s=>s.id===D.start):null;
  const st=$('menu-status');
  const btn=$('btn-play');

  if(!D.scenes.length){
    st.innerHTML='<div class="st-no">‚ùå –ù–æ–≤–µ–ª–ª–∞ –ø—É—Å—Ç–∞ ‚Äî –Ω–∞–∂–º–∏—Ç–µ üîß –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è</div>';
    btn.disabled=true;
  }else if(!D.start||!startScene){
    st.innerHTML='<div class="st-no">‚ö†Ô∏è –ù–µ –≤—ã–±—Ä–∞–Ω–∞ –Ω–∞—á–∞–ª—å–Ω–∞—è —Å—Ü–µ–Ω–∞ ‚Äî üîß ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>';
    btn.disabled=true;
  }else if(!startScene.steps||!startScene.steps.length){
    st.innerHTML='<div class="st-no">‚ö†Ô∏è –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ü–µ–Ω–∞ –ø—É—Å—Ç–∞ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ —à–∞–≥–∏</div>';
    btn.disabled=true;
  }else{
    st.innerHTML=`<div class="st-ok">‚úÖ ${D.scenes.length} —Å—Ü–µ–Ω(—ã) ¬∑ –ù–∞—á–∞–ª—å–Ω–∞—è: ${esc(startScene.name)}</div>`;
    btn.disabled=false;
  }
}

/* ‚ïê‚ïê‚ïê MENU ‚ïê‚ïê‚ïê */
function openCode(){
  $('i-code').value='';$('code-err').style.display='none';
  showM('M-code');$('i-code').focus();
}
$('i-code').addEventListener('keydown',e=>{if(e.key==='Enter')checkCode()});

async function checkCode(){
  if($('i-code').value!==CODE){$('code-err').style.display='block';return}
  hideM('M-code');await loadData();updateMenu();scr('S-dev');renderTab();
}

function toMenu(){stopTyping();scr('S-menu');updateMenu()}

/* ‚ïê‚ïê‚ïê IMAGE ‚ïê‚ïê‚ïê */
function readFile(f){return new Promise(r=>{const x=new FileReader;x.onload=e=>r(e.target.result);x.readAsDataURL(f)})}
function resize(url,mw,mh,png){return new Promise(r=>{const i=new Image;i.onload=()=>{
  let w=i.width,h=i.height;
  if(w>mw||h>mh){const k=Math.min(mw/w,mh/h);w=Math.round(w*k);h=Math.round(h*k)}
  const c=document.createElement('canvas');c.width=w;c.height=h;
  c.getContext('2d').drawImage(i,0,0,w,h);
  r(png?c.toDataURL('image/png'):c.toDataURL('image/jpeg',.72))};i.src=url})}
async function pvF(inp,pvId,mw,mh,png,varName){
  if(!inp.files[0])return;const raw=await readFile(inp.files[0]);
  const data=await resize(raw,mw,mh,png);window[varName]=data;
  const p=$(pvId);p.src=data;p.style.display='block'}

/* ‚ïê‚ïê‚ïê DEV TABS ‚ïê‚ïê‚ïê */
function dTab(t,el){curTab=t;document.querySelectorAll('.dt').forEach(x=>x.classList.remove('on'));
  if(el)el.classList.add('on');renderTab()}
function renderTab(){const c=$('dc');
  if(curTab==='bg')rBgs(c);else if(curTab==='ch')rChars(c);
  else if(curTab==='sc')rScenes(c);else rSettings(c)}

/* ‚îÄ‚îÄ Backgrounds ‚îÄ‚îÄ */
function rBgs(c){let h='<div class="dgrid">';
  D.bgs.forEach(b=>{h+=`<div class="dcard" onclick="eBg('${b.id}')">
    <div class="dcimg" style="background-image:url('${b.data}')"></div>
    <div class="dcinf"><div class="dcn">${esc(b.name)}</div><div class="dcs">–§–æ–Ω</div></div></div>`});
  h+=`<div class="dcard dcadd" onclick="aBg()"><div class="ico">+</div><span>–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ–Ω</span></div></div>`;
  c.innerHTML=h}
function aBg(){editId=null;_bgD=null;$('bg-t').textContent='–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ–Ω';
  $('bg-name').value='';$('bg-file').value='';$('bg-pv').style.display='none';
  $('bg-del').style.display='none';showM('M-bg')}
function eBg(id){const b=D.bgs.find(x=>x.id===id);if(!b)return;
  editId=id;_bgD=null;$('bg-t').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
  $('bg-name').value=b.name;$('bg-file').value='';
  $('bg-pv').src=b.data;$('bg-pv').style.display='block';
  $('bg-del').style.display='inline-block';showM('M-bg')}
async function saveBg(){const n=$('bg-name').value.trim();
  if(!n){toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ',1);return}
  if(editId){const b=D.bgs.find(x=>x.id===editId);if(b){b.name=n;if(_bgD)b.data=_bgD}}
  else{if(!_bgD){toast('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',1);return}D.bgs.push({id:uid(),name:n,data:_bgD})}
  _bgD=null;await save();hideM('M-bg');renderTab();toast('–§–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω')}
async function delBg(){if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;
  D.bgs=D.bgs.filter(x=>x.id!==editId);await save();hideM('M-bg');renderTab();toast('–£–¥–∞–ª–µ–Ω–æ')}

/* ‚îÄ‚îÄ Characters ‚îÄ‚îÄ */
function rChars(c){let h='<div class="dgrid">';
  D.chars.forEach(ch=>{h+=`<div class="dcard" onclick="eCh('${ch.id}')">
    <div class="dcimg" style="background-image:url('${ch.data}');background-size:contain;background-repeat:no-repeat;background-position:center"></div>
    <div class="dcinf"><div class="dcn">${esc(ch.name)}</div><div class="dcs">–ü–µ—Ä—Å–æ–Ω–∞–∂</div></div></div>`});
  h+=`<div class="dcard dcadd" onclick="aCh()"><div class="ico">+</div><span>–î–æ–±–∞–≤–∏—Ç—å</span></div></div>`;
  c.innerHTML=h}
function aCh(){editId=null;_chD=null;$('ch-t').textContent='–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞';
  $('ch-name').value='';$('ch-file').value='';$('ch-pv').style.display='none';
  $('ch-del').style.display='none';showM('M-ch')}
function eCh(id){const ch=D.chars.find(x=>x.id===id);if(!ch)return;
  editId=id;_chD=null;$('ch-t').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
  $('ch-name').value=ch.name;$('ch-file').value='';
  $('ch-pv').src=ch.data;$('ch-pv').style.display='block';
  $('ch-del').style.display='inline-block';showM('M-ch')}
async function saveCh(){const n=$('ch-name').value.trim();
  if(!n){toast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è',1);return}
  if(editId){const ch=D.chars.find(x=>x.id===editId);if(ch){ch.name=n;if(_chD)ch.data=_chD}}
  else{if(!_chD){toast('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',1);return}D.chars.push({id:uid(),name:n,data:_chD})}
  _chD=null;await save();hideM('M-ch');renderTab();toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')}
async function delCh(){if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;
  D.chars=D.chars.filter(x=>x.id!==editId);await save();hideM('M-ch');renderTab();toast('–£–¥–∞–ª–µ–Ω–æ')}

/* ‚îÄ‚îÄ Scenes ‚îÄ‚îÄ */
function rScenes(c){let h='<div class="dgrid">';
  D.scenes.forEach(sc=>{const isS=sc.id===D.start;const bg=D.bgs.find(b=>b.id===sc.bgId);
    h+=`<div class="dcard${isS?' start':''}" onclick="eSc('${sc.id}')">
      <div class="dcimg" style="${bg?`background-image:url('${bg.data}')`:'display:flex;align-items:center;justify-content:center;font-size:38px;color:var(--sub)'}">
        ${bg?'':'üìú'}</div>
      <div class="dcinf"><div class="dcn">${esc(sc.name||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
      <div class="dcs">${isS?'‚≠ê –ù–∞—á–∞–ª—å–Ω–∞—è':sc.steps.length+' —à–∞–≥(–æ–≤)'}</div></div></div>`});
  h+=`<div class="dcard dcadd" onclick="aSc()"><div class="ico">+</div><span>–î–æ–±–∞–≤–∏—Ç—å —Å—Ü–µ–Ω—É</span></div></div>`;
  c.innerHTML=h}

function mkStep(){return{chId:null,pos:'center',text:'',hasCh:false,choices:[]}}

function aSc(){editId=null;
  eScData={id:uid(),name:'',bgId:null,steps:[mkStep()],next:null};
  $('sc-t').textContent='–î–æ–±–∞–≤–∏—Ç—å —Å—Ü–µ–Ω—É';rScEd();showM('M-sc')}

function eSc(id){const sc=D.scenes.find(s=>s.id===id);if(!sc)return;
  editId=id;eScData=JSON.parse(JSON.stringify(sc));
  eScData.steps.forEach(s=>{if(s.hasCh===undefined)s.hasCh=!!(s.choices&&s.choices.length)});
  $('sc-t').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';rScEd();showM('M-sc')}

function gather(){const ed=$('sc-ed');if(!ed)return;
  const v=x=>ed.querySelector(x);
  const ni=v('#sce-name');if(ni)eScData.name=ni.value;
  const bi=v('#sce-bg');if(bi)eScData.bgId=bi.value||null;
  const nsi=v('#sce-next');if(nsi)eScData.next=nsi.value||null;
  ed.querySelectorAll('.si').forEach((el,i)=>{const s=eScData.steps[i];if(!s)return;
    const gv=x=>el.querySelector(x);
    const ch=gv('.sc-ch');if(ch)s.chId=ch.value||null;
    const ps=gv('.sc-ps');if(ps)s.pos=ps.value;
    const tx=gv('.sc-tx');if(tx)s.text=tx.value;
    el.querySelectorAll('.crow').forEach((cr,ci)=>{if(!s.choices[ci])return;
      const ct=cr.querySelector('.sc-ct');if(ct)s.choices[ci].text=ct.value;
      const cs=cr.querySelector('.sc-cs');if(cs)s.choices[ci].target=cs.value||null})})}

function rScEd(){const sc=eScData;
  const bgO=D.bgs.map(b=>`<option value="${b.id}"${sc.bgId===b.id?' selected':''}>${esc(b.name)}</option>`).join('');
  const allSc=D.scenes.filter(s=>s.id!==sc.id);
  let stH='';
  sc.steps.forEach((st,i)=>{
    const chO=D.chars.map(c=>`<option value="${c.id}"${st.chId===c.id?' selected':''}>${esc(c.name)}</option>`).join('');
    let chcH='';
    if(st.hasCh){
      chcH='<div class="csec"><label style="font-size:11px;color:var(--sub)">–í–∞—Ä–∏–∞–Ω—Ç—ã:</label>';
      (st.choices||[]).forEach((ch,ci)=>{
        const csO=allSc.map(s=>`<option value="${s.id}"${ch.target===s.id?' selected':''}>${esc(s.name)}</option>`).join('');
        chcH+=`<div class="crow"><input class="sc-ct" name="choice-text-${i}-${ci}" value="${esc(ch.text)}" placeholder="–¢–µ–∫—Å—Ç">
          <select class="sc-cs" name="choice-scene-${i}-${ci}"><option value="">‚Üí –°—Ü–µ–Ω–∞‚Ä¶</option>${csO}</select>
          <button onclick="gather();eScData.steps[${i}].choices.splice(${ci},1);rScEd()">‚úï</button></div>`});
      chcH+=`<button class="bsm" onclick="gather();eScData.steps[${i}].choices.push({text:'',target:null});rScEd()">+ –í–∞—Ä–∏–∞–Ω—Ç</button></div>`}
    stH+=`<div class="si"><div class="sih"><span class="sin">–®–∞–≥ ${i+1}</span><div class="sia">
      ${i>0?`<button onclick="gather();swSt(${i},-1)">‚Üë</button>`:''}
      ${i<sc.steps.length-1?`<button onclick="gather();swSt(${i},1)">‚Üì</button>`:''}
      ${sc.steps.length>1?`<button onclick="gather();eScData.steps.splice(${i},1);rScEd()">‚úï</button>`:''}
    </div></div>
    <div class="sf">
      <div><label for="sc-ch-${i}">–ü–µ—Ä—Å–æ–Ω–∞–∂</label><select class="sc-ch" id="sc-ch-${i}" name="sc-ch-${i}"><option value="">‚Äî –†–∞—Å—Å–∫–∞–∑—á–∏–∫ ‚Äî</option>${chO}</select></div>
      <div><label for="sc-ps-${i}">–ü–æ–∑–∏—Ü–∏—è</label><select class="sc-ps" id="sc-ps-${i}" name="sc-ps-${i}">
        <option value="left"${st.pos==='left'?' selected':''}>–°–ª–µ–≤–∞</option>
        <option value="center"${st.pos==='center'?' selected':''}>–ü–æ —Ü–µ–Ω—Ç—Ä—É</option>
        <option value="right"${st.pos==='right'?' selected':''}>–°–ø—Ä–∞–≤–∞</option></select></div>
      <div class="fw"><label for="sc-tx-${i}">–¢–µ–∫—Å—Ç</label><textarea class="sc-tx" id="sc-tx-${i}" name="sc-tx-${i}" placeholder="–î–∏–∞–ª–æ–≥‚Ä¶">${esc(st.text)}</textarea></div>
    </div>
    <div class="cbtog">
      <input type="checkbox" id="cb${i}" name="cb${i}"${st.hasCh?' checked':''}
        onchange="gather();eScData.steps[${i}].hasCh=this.checked;if(this.checked&&(!eScData.steps[${i}].choices||!eScData.steps[${i}].choices.length))eScData.steps[${i}].choices=[{text:'',target:null}];rScEd()">
      <label for="cb${i}">–í–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞</label>
    </div>${chcH}</div>`});

  const nxO=allSc.map(s=>`<option value="${s.id}"${sc.next===s.id?' selected':''}>${esc(s.name)}</option>`).join('');
  $('sc-ed').innerHTML=`
    <div class="fg"><label for="sce-name">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="sce-name" name="sce-name" value="${esc(sc.name)}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ‚Ä¶"></div>
    <div class="fg"><label for="sce-bg">–§–æ–Ω</label><select id="sce-bg" name="sce-bg"><option value="">‚Äî –ë–µ–∑ —Ñ–æ–Ω–∞ ‚Äî</option>${bgO}</select></div>
    <div class="fg"><label>–®–∞–≥–∏</label><div class="steps">${stH}</div>
      <button class="bsm" onclick="gather();eScData.steps.push(mkStep());rScEd()" style="margin-top:12px">+ –®–∞–≥</button></div>
    <div class="fg"><label for="sce-next">–°–ª–µ–¥—É—é—â–∞—è —Å—Ü–µ–Ω–∞</label>
      <select id="sce-next" name="sce-next"><option value="">‚Äî –ö–æ–Ω–µ—Ü ‚Äî</option>${nxO}</select></div>
    <div class="brow" style="margin-top:18px">
      <button class="bp" onclick="saveSc()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      ${editId?'<button class="bd" onclick="delSc()">–£–¥–∞–ª–∏—Ç—å</button>':''}</div>`}

function swSt(i,d){const s=eScData.steps;[s[i],s[i+d]]=[s[i+d],s[i]];rScEd()}

async function saveSc(){gather();const sc=eScData;sc.name=sc.name||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
  sc.steps.forEach(s=>{if(!s.hasCh)s.choices=[]});
  if(editId){const idx=D.scenes.findIndex(s=>s.id===editId);if(idx>=0)D.scenes[idx]=sc}
  else{D.scenes.push(sc);if(!D.start)D.start=sc.id}
  await save();hideM('M-sc');renderTab();toast('–°—Ü–µ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞')}

async function delSc(){if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;
  D.scenes=D.scenes.filter(s=>s.id!==editId);
  if(D.start===editId)D.start=D.scenes.length?D.scenes[0].id:null;
  await save();hideM('M-sc');renderTab();toast('–£–¥–∞–ª–µ–Ω–æ')}

/* ‚îÄ‚îÄ Settings ‚îÄ‚îÄ */
function rSettings(c){
  const scO=D.scenes.map(s=>`<option value="${s.id}"${D.start===s.id?' selected':''}>${esc(s.name)}</option>`).join('');
  c.innerHTML=`
    <div class="setsec"><h3>‚úèÔ∏è –ù–∞–∑–≤–∞–Ω–∏–µ</h3><div class="fg">
      <label for="set-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–≤–µ–ª–ª—ã</label>
      <input id="set-title" name="set-title" value="${esc(D.title)}" onchange="D.title=this.value;save();updateMenu();toast('–û–±–Ω–æ–≤–ª–µ–Ω–æ')"></div></div>
    <div class="setsec"><h3>‚≠ê –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ü–µ–Ω–∞</h3><div class="fg">
      <label for="set-start">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω—É</label>
      <select id="set-start" name="set-start" onchange="D.start=this.value||null;save();updateMenu();toast('–û–±–Ω–æ–≤–ª–µ–Ω–æ')">
        <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–∞ ‚Äî</option>${scO}</select></div></div>
    <div class="setsec"><h3>üíæ –≠–∫—Å–ø–æ—Ä—Ç / –ò–º–ø–æ—Ä—Ç</h3><div class="brow">
      <button class="bs" onclick="expD()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
      <label class="bs" style="cursor:pointer">üì• –ò–º–ø–æ—Ä—Ç
        <input type="file" accept=".json" name="import-file" style="display:none" onchange="impD(this)"></label></div></div>
    <div class="setsec"><h3>üóë –û—á–∏—Å—Ç–∫–∞</h3>
      <p style="color:var(--sub);font-size:13px;margin-bottom:10px">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ.</p>
      <button class="bd" onclick="clearAll()">–£–¥–∞–ª–∏—Ç—å –≤—Å—ë</button></div>
    <div class="setsec"><h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
      <p style="color:var(--sub);font-size:13px">–§–æ–Ω–æ–≤: ${D.bgs.length} ¬∑ –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π: ${D.chars.length} ¬∑ –°—Ü–µ–Ω: ${D.scenes.length}</p></div>`}

function expD(){const b=new Blob([JSON.stringify(D,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='novel.json';a.click()}
async function impD(inp){if(!inp.files[0])return;try{const t=await inp.files[0].text();const d=JSON.parse(t);
  if(d.bgs&&d.scenes){D=d;await save();renderTab();updateMenu();toast('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ')}
  else toast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç',1)}catch(e){toast('–û—à–∏–±–∫–∞',1)}}
async function clearAll(){if(!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï?'))return;
  D={title:'–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ',bgs:[],chars:[],scenes:[],start:null};
  await save();renderTab();updateMenu();toast('–û—á–∏—â–µ–Ω–æ')}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GAME ENGINE ‚Äî simplified, no double timeout
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

async function startGame(){
  dbg('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');

  const ok=await loadData();
  updateMenu();

  if(!ok){
    toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞!',1);
    return;
  }

  if(!D.scenes.length){
    toast('–ù–æ–≤–µ–ª–ª–∞ –ø—É—Å—Ç–∞! –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ üîß',1);
    return;
  }

  const startScene=D.scenes.find(s=>s.id===D.start);
  if(!D.start||!startScene){
    toast('–ù–µ –≤—ã–±—Ä–∞–Ω–∞ –Ω–∞—á–∞–ª—å–Ω–∞—è —Å—Ü–µ–Ω–∞! üîß ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏',1);
    return;
  }

  if(!startScene.steps||!startScene.steps.length){
    toast('–í –Ω–∞—á–∞–ª—å–Ω–æ–π —Å—Ü–µ–Ω–µ –Ω–µ—Ç —à–∞–≥–æ–≤ –¥–∏–∞–ª–æ–≥–∞!',1);
    return;
  }

  dbg('–ó–∞–ø—É—Å–∫: '+startScene.name+' ('+startScene.steps.length+' —à–∞–≥–æ–≤)');

  // –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —ç–∫—Ä–∞–Ω –∏–≥—Ä—ã
  scr('S-game');

  // —Å–±—Ä–æ—Å
  $('g-end').classList.remove('on');
  $('g-choices').classList.remove('on');
  $('g-char').classList.remove('vis','pl','pc','pr');
  $('g-name').textContent='';
  $('g-txt').textContent='';

  // –°–†–ê–ó–£ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ü–µ–Ω—É –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
  loadScene(D.start);
}

function loadScene(sid){
  try{
    dbg('loadScene: '+sid);
    const sc=D.scenes.find(s=>s.id===sid);

    if(!sc){
      dbg('ERROR: —Å—Ü–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: '+sid);
      toast('–û—à–∏–±–∫–∞: —Å—Ü–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!',1);
      endGame();
      return;
    }

    if(!sc.steps||!sc.steps.length){
      dbg('–°—Ü–µ–Ω–∞ –ø—É—Å—Ç–∞, –ø–µ—Ä–µ—Ö–æ–¥: '+sc.next);
      if(sc.next)loadScene(sc.next);
      else endGame();
      return;
    }

    G.sid=sid;
    G.step=0;

    // —Ñ–æ–Ω ‚Äî –°–†–ê–ó–£, –±–µ–∑ setTimeout
    const bg=D.bgs.find(b=>b.id===sc.bgId);
    const bgEl=$('g-bg');
    if(bg){
      bgEl.style.backgroundImage=`url('${bg.data}')`;
      bgEl.style.backgroundColor='transparent';
      dbg('–§–æ–Ω: '+bg.name);
    }else{
      bgEl.style.backgroundImage='none';
      bgEl.style.backgroundColor='#1e1e3e';
      dbg('–§–æ–Ω: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
    }

    // –ø–µ—Ä–≤—ã–π —à–∞–≥ ‚Äî –°–†–ê–ó–£
    showStep();

  }catch(e){
    dbg('ERROR loadScene: '+e.message);
    console.error(e);
    toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ü–µ–Ω—ã!',1);
  }
}

function showStep(){
  try{
    const sc=D.scenes.find(s=>s.id===G.sid);
    if(!sc){dbg('ERROR: –Ω–µ—Ç —Å—Ü–µ–Ω—ã');endGame();return}

    if(G.step>=sc.steps.length){
      dbg('–í—Å–µ —à–∞–≥–∏ –ø—Ä–æ–π–¥–µ–Ω—ã ‚Üí next='+sc.next);
      if(sc.next)loadScene(sc.next);else endGame();
      return;
    }

    const st=sc.steps[G.step];
    dbg('–®–∞–≥ '+(G.step+1)+'/'+sc.steps.length);

    // –ø–µ—Ä—Å–æ–Ω–∞–∂
    const cel=$('g-char');
    if(st.chId){
      const ch=D.chars.find(c=>c.id===st.chId);
      if(ch){
        cel.src=ch.data;
        cel.classList.remove('pl','pc','pr');
        const p=st.pos||'center';
        cel.classList.add(p==='left'?'pl':p==='right'?'pr':'pc');
        cel.classList.add('vis');
        $('g-name').textContent=ch.name;
      }else{
        cel.classList.remove('vis');
        $('g-name').textContent='';
      }
    }else{
      cel.classList.remove('vis');
      $('g-name').textContent='';
    }

    // —Ç–µ–∫—Å—Ç
    const txt=st.text||'(–ø—É—Å—Ç–æ–π —à–∞–≥)';
    typeText(txt);

    // –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    $('g-ind').style.display=(st.hasCh&&st.choices&&st.choices.length)?'none':'block';

  }catch(e){
    dbg('ERROR showStep: '+e.message);
    console.error(e);
  }
}

function typeText(text){
  stopTyping();
  G.full=text;
  G.typing=true;
  const el=$('g-txt');
  let i=0;
  el.textContent='';
  G.timer=setInterval(()=>{
    if(i<text.length){el.textContent+=text[i];i++}
    else{stopTyping();afterType()}
  },28);
}

function stopTyping(){
  if(G.timer){clearInterval(G.timer);G.timer=null}
  G.typing=false;
}

function afterType(){
  const sc=D.scenes.find(s=>s.id===G.sid);if(!sc)return;
  const st=sc.steps[G.step];
  if(st&&st.hasCh&&st.choices&&st.choices.length){
    showChoicesUI(st.choices);
  }
}

function advance(){
  if(G.typing){
    stopTyping();
    $('g-txt').textContent=G.full;
    afterType();
    return;
  }
  const sc=D.scenes.find(s=>s.id===G.sid);if(!sc)return;
  const st=sc.steps[G.step];
  if(st&&st.hasCh&&st.choices&&st.choices.length)return;
  G.step++;
  if(G.step>=sc.steps.length){
    if(sc.next)loadScene(sc.next);else endGame();
  }else showStep();
}

function showChoicesUI(choices){
  const c=$('g-choices');
  c.innerHTML=choices.map((ch,i)=>
    `<button class="chb" onclick="pick(${i})">${esc(ch.text||'–í–∞—Ä–∏–∞–Ω—Ç '+(i+1))}</button>`
  ).join('');
  c.classList.add('on');
}

function pick(i){
  const sc=D.scenes.find(s=>s.id===G.sid);if(!sc)return;
  const st=sc.steps[G.step];if(!st||!st.choices||!st.choices[i])return;
  $('g-choices').classList.remove('on');
  const t=st.choices[i].target;
  if(t)loadScene(t);else endGame();
}

function endGame(){
  stopTyping();
  dbg('–ö–û–ù–ï–¶ –ò–ì–†–´');
  $('g-end').classList.add('on');
}

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
(async()=>{
  if(window.Telegram&&Telegram.WebApp){Telegram.WebApp.ready();Telegram.WebApp.expand()}
  await loadData();
  updateMenu();
  $('loader').classList.add('hide');
  setTimeout(()=>$('loader').style.display='none',600);
})();
</script>
</body>
</html>
