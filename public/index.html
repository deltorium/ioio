<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<title>Visual Novel</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',system-ui,sans-serif;background:#0b0b1a;color:#eaeaea;user-select:none}
#rotate{display:none;position:fixed;inset:0;background:#0b0b1a;z-index:9999;flex-direction:column;align-items:center;justify-content:center;gap:20px}
#rotate .ri{font-size:56px;animation:rr 2s ease-in-out infinite}
@keyframes rr{0%,100%{transform:rotate(0)}50%{transform:rotate(90deg)}}
#rotate p{font-size:17px;color:#7878a0}
@media(orientation:portrait)and(max-width:900px){#rotate{display:flex}#app{display:none!important}}
#loader{position:fixed;inset:0;background:#0b0b1a;z-index:9998;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;transition:opacity .5s}
.spinner{width:42px;height:42px;border:3px solid #2a2a50;border-top-color:#e94560;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#loader.hide{opacity:0;pointer-events:none}
#app{width:100vw;height:100vh;position:relative}
.scr{display:none;position:absolute;inset:0}.scr.on{display:flex}

/* MENU */
#S-menu{flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#0b0b1a,#161630,#1a1040);gap:20px}
#m-title{font-size:clamp(26px,5vw,58px);font-weight:900;letter-spacing:3px;text-align:center;text-transform:uppercase;padding:0 20px;background:linear-gradient(135deg,#e94560,#ff6b81);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#menu-status{text-align:center;min-height:24px}
.st-ok{color:#4ecca3;font-size:14px}.st-no{color:#e94560;font-size:14px}
.bplay{padding:16px 64px;font-size:20px;font-weight:700;background:#e94560;color:#fff;border:none;border-radius:50px;cursor:pointer;letter-spacing:2px;text-transform:uppercase}
.bplay:disabled{opacity:.4;cursor:not-allowed}
.bgear{position:absolute;top:14px;right:14px;width:44px;height:44px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);border-radius:12px;color:#7878a0;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}

/* WAIT ROOM */
#S-wait{flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#0b0b1a,#0d1520,#0b0b1a);gap:16px;position:relative}
#w-pepe{position:absolute;bottom:10px;left:10px;width:clamp(80px,15vw,140px);cursor:pointer;filter:drop-shadow(0 0 10px rgba(100,200,100,.3));transition:transform .2s;z-index:5}
#w-pepe:active{transform:scale(.9) rotate(-5deg)}
#w-phrase{position:absolute;bottom:clamp(100px,18vw,160px);left:10px;background:rgba(30,30,60,.95);border:2px solid #4ecca3;border-radius:12px;padding:10px 18px;color:#4ecca3;font-size:clamp(12px,1.5vw,16px);font-weight:600;opacity:0;transition:opacity .3s;z-index:5;max-width:250px;pointer-events:none}
#w-phrase.show{opacity:1}
#w-msg{font-size:clamp(14px,2.2vw,24px);text-align:center;color:#a0a0c0;max-width:80%;line-height:1.6;padding:0 20px}
#w-timer{font-size:clamp(24px,4vw,52px);font-weight:900;letter-spacing:4px;color:#fff;text-shadow:0 0 20px rgba(233,69,96,.4)}
#w-timer-sub{font-size:clamp(11px,1.4vw,16px);color:#7878a0;margin-top:-8px}
#w-play{padding:14px 50px;font-size:18px;font-weight:700;background:linear-gradient(135deg,#4ecca3,#39ffdc);color:#000;border:none;border-radius:50px;cursor:pointer;letter-spacing:1px;margin-top:10px}
#w-back{position:absolute;top:12px;left:12px;padding:6px 14px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:8px;color:#aaa;font-size:13px;cursor:pointer;z-index:5}

/* DINO GAME */
#S-dino{flex-direction:column;background:#1a1a2e;position:relative}
#d-hud{display:flex;align-items:center;justify-content:space-between;padding:8px 20px;background:#0a0a1e;flex-shrink:0;z-index:2}
#d-score{font-size:clamp(16px,2vw,24px);font-weight:700;color:#4ecca3}
#d-back{padding:6px 14px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:8px;color:#aaa;font-size:13px;cursor:pointer}
#d-area{flex:1;position:relative;overflow:hidden;cursor:pointer}
#d-canvas{width:100%;height:100%}
#d-over{position:absolute;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.7);gap:16px;z-index:5}
#d-over.on{display:flex}
#d-over h2{font-size:clamp(24px,4vw,44px);color:#e94560}
#d-over p{color:#7878a0;font-size:16px}

/* MODALS */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
.modal.on{display:flex}
.mbox{background:#161630;border:1px solid #2a2a50;border-radius:16px;padding:28px;min-width:300px;max-width:92vw;max-height:90vh;overflow-y:auto}
.mbox h2{margin-bottom:18px;font-size:19px;display:flex;align-items:center;justify-content:space-between}
.mx{background:0;border:0;color:#7878a0;font-size:22px;cursor:pointer}
.mlg{width:90vw;max-width:820px}
.fg{margin-bottom:15px}
.fg label{display:block;font-size:11px;color:#7878a0;margin-bottom:5px;font-weight:600;text-transform:uppercase;letter-spacing:.8px}
.fg input,.fg textarea,.fg select{width:100%;padding:10px 13px;background:#101028;border:1px solid #2a2a50;border-radius:8px;color:#eaeaea;font-size:14px;outline:0;font-family:inherit}
.fg textarea{min-height:60px;resize:vertical}
.ipv{width:100%;max-height:130px;object-fit:contain;border-radius:8px;margin-top:8px;background:#101028}
.fbtn{display:inline-block;padding:8px 20px;background:rgba(255,255,255,.08);border:1px solid #2a2a50;border-radius:8px;color:#eaeaea;font-size:14px;cursor:pointer}
.bp{padding:10px 24px;background:#e94560;color:#fff;border:0;border-radius:8px;font-size:14px;cursor:pointer}
.bs{padding:10px 24px;background:rgba(255,255,255,.08);color:#eaeaea;border:1px solid #2a2a50;border-radius:8px;font-size:14px;cursor:pointer}
.bd{padding:10px 24px;background:0;color:#e94560;border:1px solid #e94560;border-radius:8px;font-size:14px;cursor:pointer}
.brow{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.err-msg{color:#e94560;font-size:13px}

/* GAME */
#S-game{flex-direction:column!important}
#g-top{flex:1;position:relative;overflow:hidden;background:#1a1a3e}
#g-bg{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;background-color:#1a1a3e}
#g-char{position:absolute;bottom:0;height:85%;max-width:40%;object-fit:contain;pointer-events:none;display:none}
#g-char.vis{display:block}#g-char.pl{left:3%}#g-char.pc{left:50%;transform:translateX(-50%)}#g-char.pr{right:3%;left:auto}
.bbk{position:absolute;top:8px;left:8px;z-index:5;padding:6px 14px;background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.2);border-radius:8px;color:#fff;font-size:13px;cursor:pointer}
#g-dlg{flex-shrink:0;background:#0a0a28;border-top:3px solid #e94560;padding:16px 28px 14px;min-height:130px;cursor:pointer;position:relative}
#g-name{display:inline-block;padding:4px 16px;background:#e94560;border-radius:6px;font-size:15px;font-weight:700;color:#fff;margin-bottom:6px}
#g-name:empty{display:none}
#g-txt{font-size:17px;line-height:1.7;color:#fff;white-space:pre-wrap;min-height:36px}
#g-ind{position:absolute;bottom:10px;right:18px;color:rgba(255,255,255,.4);font-size:13px;animation:bk 1.4s infinite}
@keyframes bk{0%,100%{opacity:1}50%{opacity:.2}}
#g-choices{position:absolute;top:0;left:0;right:0;bottom:0;z-index:20;display:none;flex-direction:column;align-items:center;justify-content:center;gap:12px;background:rgba(0,0,0,.6)}
#g-choices.on{display:flex}
.chb{padding:14px 44px;min-width:260px;max-width:80%;background:rgba(20,20,50,.95);border:2px solid #e94560;border-radius:12px;color:#fff;font-size:16px;cursor:pointer;text-align:center}
#g-end{position:absolute;top:0;left:0;right:0;bottom:0;z-index:25;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.88);gap:30px}
#g-end.on{display:flex}#g-end h2{font-size:36px;color:#e94560}

/* BOSS */
#S-boss{flex-direction:row!important;background:#0a0a1e;position:relative;overflow:hidden}
#bf-bg{position:absolute;inset:0;background:radial-gradient(ellipse at 30% 50%,#1a0a2e,#0a0a1e 70%);z-index:0}
#bf-opp{position:relative;z-index:1;width:28%;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding-bottom:10px}
#bf-opp img{max-height:80%;max-width:90%;object-fit:contain;filter:drop-shadow(0 0 20px rgba(57,255,220,.3));animation:bfBob .5s ease-in-out infinite}
@keyframes bfBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
#bf-opp .oname{color:#39ffdc;font-size:clamp(12px,1.5vw,18px);font-weight:700}
#bf-lanes{position:relative;z-index:1;flex:1;display:flex;align-items:stretch;justify-content:center}
#bf-canvas{width:100%;height:100%}
#bf-hud{position:absolute;top:0;left:0;right:0;z-index:10;display:flex;align-items:center;padding:8px 16px;gap:12px;background:linear-gradient(to bottom,rgba(0,0,0,.7),transparent)}
#bf-song-name{color:#39ffdc;font-size:clamp(11px,1.3vw,16px);font-weight:600;min-width:100px}
#bf-hbar{flex:1;height:20px;background:#1a1a3e;border-radius:10px;border:2px solid #333;overflow:hidden}
#bf-hfill{height:100%;width:50%;background:linear-gradient(90deg,#e94560,#4ecca3);border-radius:8px;transition:width .3s}
#bf-score-txt{font-size:clamp(14px,1.8vw,22px);font-weight:700;color:#fff;min-width:80px;text-align:right}
#bf-combo-txt{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(28px,4vw,56px);font-weight:900;color:#fff;opacity:0;z-index:5;pointer-events:none}
#bf-combo-txt.show{opacity:1;animation:bfPop .4s ease-out}
@keyframes bfPop{0%{transform:translate(-50%,-50%) scale(1.5);opacity:0}50%{opacity:1}100%{transform:translate(-50%,-50%) scale(1)}}
#bf-rating-txt{position:absolute;top:35%;left:50%;transform:translate(-50%,-50%);font-size:clamp(20px,3vw,40px);font-weight:900;opacity:0;z-index:5;pointer-events:none}
#bf-rating-txt.show{animation:bfRate .6s ease-out forwards}
@keyframes bfRate{0%{opacity:0;transform:translate(-50%,-50%) scale(2)}20%{opacity:1;transform:translate(-50%,-50%) scale(1)}80%{opacity:1}100%{opacity:0;transform:translate(-50%,-70%)}}
#bf-ctrl{position:absolute;bottom:0;left:0;right:0;z-index:10;display:flex;justify-content:center;gap:8px;padding:8px;background:linear-gradient(to top,rgba(0,0,0,.5),transparent)}
.bf-btn{width:clamp(50px,12vw,80px);height:clamp(50px,12vw,80px);border-radius:12px;border:3px solid;font-size:clamp(20px,3vw,32px);cursor:pointer;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.4);-webkit-tap-highlight-color:transparent}
.bf-btn:active{transform:scale(.9)}
.bf-btn.l{border-color:#c24b99;color:#c24b99}.bf-btn.d{border-color:#00ffff;color:#00ffff}.bf-btn.u{border-color:#12fa05;color:#12fa05}.bf-btn.r{border-color:#f9393f;color:#f9393f}
#bf-countdown{position:absolute;inset:0;z-index:30;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8);font-size:clamp(60px,10vw,120px);font-weight:900;color:#fff}
#bf-countdown.on{display:flex}
#bf-result{position:absolute;inset:0;z-index:30;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.9);gap:20px}
#bf-result.on{display:flex}
#bf-result h2{font-size:clamp(28px,5vw,52px);font-weight:900}
#bf-result .stats{color:#7878a0;font-size:clamp(14px,2vw,20px);text-align:center;line-height:2}
.win{color:#4ecca3}.lose{color:#e94560}

/* DEV */
#S-dev{flex-direction:column;background:#0b0b1a}
.dh{display:flex;align-items:center;padding:10px 18px;background:#161630;border-bottom:1px solid #2a2a50;gap:14px;flex-shrink:0}.dh h1{font-size:17px;flex:1}
.dtabs{display:flex;background:#161630;border-bottom:1px solid #2a2a50;flex-shrink:0;overflow-x:auto}
.dt{padding:11px 20px;font-size:13px;color:#7878a0;cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap}.dt.on{color:#e94560;border-bottom-color:#e94560}
.dc{flex:1;overflow-y:auto;padding:20px}
.dgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:15px}
.dcard{background:#161630;border:1px solid #2a2a50;border-radius:12px;overflow:hidden;cursor:pointer}
.dcimg{width:100%;height:115px;background:#101028;background-size:cover;background-position:center}
.dcinf{padding:11px}.dcn{font-size:14px;font-weight:600;margin-bottom:3px}.dcs{font-size:12px;color:#7878a0}
.dcadd{display:flex;align-items:center;justify-content:center;min-height:165px;border-style:dashed;flex-direction:column;gap:8px}
.dcadd .ico{font-size:34px;color:#7878a0}.dcadd span{font-size:13px;color:#7878a0}
.dcard.start{border-color:#4ecca3}.dcard.start .dcs{color:#4ecca3}
.steps{display:flex;flex-direction:column;gap:12px;margin-top:10px}
.si{background:#101028;border:1px solid #2a2a50;border-radius:10px;padding:14px}
.sih{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.sin{font-size:12px;color:#e94560;font-weight:700}.sia{display:flex;gap:5px}
.sia button{width:27px;height:27px;background:rgba(255,255,255,.07);border:1px solid #2a2a50;border-radius:6px;color:#7878a0;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.sf{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.sf .fw{grid-column:1/-1}
.sf label{font-size:11px;color:#7878a0;margin-bottom:4px;display:block}
.sf input,.sf textarea,.sf select{width:100%;padding:8px 10px;background:#0b0b1a;border:1px solid #2a2a50;border-radius:6px;color:#eaeaea;font-size:13px;outline:0;font-family:inherit}
.sf textarea{min-height:48px;resize:vertical}
.csec{margin-top:10px;padding-top:10px;border-top:1px solid #2a2a50}
.crow{display:flex;gap:7px;margin-bottom:8px;align-items:center}.crow input{flex:1}.crow select{width:130px}
.crow input,.crow select{padding:7px 9px;background:#0b0b1a;border:1px solid #2a2a50;border-radius:6px;color:#eaeaea;font-size:12px;outline:0}
.crow button{width:27px;height:27px;background:rgba(233,69,96,.15);border:1px solid #e94560;border-radius:6px;color:#e94560;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.cbtog{display:flex;align-items:center;gap:8px;margin-top:10px}
.cbtog input[type=checkbox]{width:17px;height:17px;accent-color:#e94560}
.cbtog label{font-size:13px;margin:0;cursor:pointer}
.bsm{padding:5px 13px;background:rgba(255,255,255,.07);border:1px solid #2a2a50;border-radius:6px;color:#7878a0;font-size:12px;cursor:pointer;margin-top:6px}
.setsec{background:#161630;border:1px solid #2a2a50;border-radius:12px;padding:20px;margin-bottom:16px}.setsec h3{font-size:16px;margin-bottom:12px}
.bfsec{background:rgba(57,255,220,.05);border:1px solid rgba(57,255,220,.2);border-radius:10px;padding:14px;margin-top:12px}.bfsec h4{color:#39ffdc;font-size:13px;margin-bottom:10px}
.audio-info{display:flex;align-items:center;gap:10px;margin-top:8px;padding:8px 12px;background:rgba(57,255,220,.08);border-radius:8px;font-size:13px;color:#39ffdc}
.audio-info .ai-name{flex:1}
.audio-info button{padding:4px 12px;background:rgba(255,255,255,.1);border:1px solid #2a2a50;border-radius:6px;color:#eaeaea;font-size:12px;cursor:pointer}
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(100px);padding:14px 28px;border-radius:10px;font-size:15px;font-weight:600;z-index:5000;transition:transform .3s;pointer-events:none;max-width:90vw;text-align:center}
#toast.show{transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
<div id="rotate"><div class="ri">üì±</div><p>–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ</p></div>
<div id="loader"><div class="spinner"></div><div style="color:#7878a0;font-size:15px">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></div>

<div id="app">
<!-- MENU -->
<div id="S-menu" class="scr on">
  <button class="bgear" onclick="openCode()">üîß</button>
  <h1 id="m-title">–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ</h1>
  <div id="menu-status"></div>
  <button class="bplay" id="btn-play" onclick="startGame()">–ò–≥—Ä–∞—Ç—å</button>
</div>

<!-- WAIT ROOM -->
<div id="S-wait" class="scr">
  <button id="w-back" onclick="scr('S-menu')">‚Üê –ù–∞–∑–∞–¥</button>
  <img id="w-pepe" src="https://i.postimg.cc/d019wCRm/1645078923-3-abrakadabra-fun-p-malenkii-lyagushonok-pepe-10-removebg-preview.png" alt="" onclick="pepeTap()">
  <div id="w-phrase"></div>
  <div id="w-msg">–û—É, –ø–æ—Ö–æ–∂–µ –ù–µ–π—Ä–æ–Ω–∫–∞ –∏–≥—Ä–∞–µ—Ç —Å –∫–æ—à–∫–æ–π!<br>–í—ã –≤–µ–¥—å –Ω–µ —Å—Ç–∞–Ω–µ—Ç–µ –µ–º—É –º–µ—à–∞—Ç—å?..</div>
  <div id="w-timer">--:--:--</div>
  <div id="w-timer-sub">–¥–æ –∑–∞–ø—É—Å–∫–∞</div>
  <button id="w-play" onclick="startDino()">üéÆ –ò–≥—Ä–∞—Ç—å</button>
</div>

<!-- DINO GAME -->
<div id="S-dino" class="scr">
  <div id="d-hud">
    <div id="d-score">–°—á—ë—Ç: 0</div>
    <button id="d-back" onclick="stopDino();scr('S-wait')">‚Üê –ù–∞–∑–∞–¥</button>
  </div>
  <div id="d-area" onclick="dinoJump()" ontouchstart="dinoJump()">
    <canvas id="d-canvas"></canvas>
    <div id="d-over">
      <h2>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
      <p id="d-final"></p>
      <button class="bplay" onclick="startDinoGame()" style="font-size:16px;padding:12px 40px">–ï—â—ë —Ä–∞–∑</button>
    </div>
  </div>
</div>

<!-- GAME -->
<div id="S-game" class="scr">
  <div id="g-top"><div id="g-bg"></div><img id="g-char" src="" alt=""><button class="bbk" onclick="toMenu()">‚Üê –ú–µ–Ω—é</button></div>
  <div id="g-dlg" onclick="advance()"><div id="g-name"></div><div id="g-txt"></div><div id="g-ind">‚ñº</div></div>
  <div id="g-choices"></div>
  <div id="g-end"><h2>–ö–æ–Ω–µ—Ü</h2><button class="bplay" onclick="toMenu()" style="font-size:16px;padding:12px 44px">–í –º–µ–Ω—é</button></div>
</div>

<!-- BOSS -->
<div id="S-boss" class="scr">
  <div id="bf-bg"></div>
  <div id="bf-opp"><img id="bf-opp-img" src="" alt=""><div class="oname" id="bf-opp-name"></div></div>
  <div id="bf-lanes"><canvas id="bf-canvas"></canvas></div>
  <div id="bf-hud"><div id="bf-song-name"></div><div id="bf-hbar"><div id="bf-hfill"></div></div><div id="bf-score-txt">0</div></div>
  <div id="bf-combo-txt"></div><div id="bf-rating-txt"></div>
  <div id="bf-ctrl">
    <button class="bf-btn l" onpointerdown="bfHit(0)">‚Üê</button>
    <button class="bf-btn d" onpointerdown="bfHit(1)">‚Üì</button>
    <button class="bf-btn u" onpointerdown="bfHit(2)">‚Üë</button>
    <button class="bf-btn r" onpointerdown="bfHit(3)">‚Üí</button>
  </div>
  <div id="bf-countdown"></div>
  <div id="bf-result"><h2 id="bf-res-title"></h2><div class="stats" id="bf-res-stats"></div><button class="bplay" id="bf-res-btn" style="font-size:16px;padding:12px 44px"></button></div>
</div>

<!-- DEV -->
<div id="S-dev" class="scr">
  <div class="dh"><button class="bs" onclick="toMenu()" style="padding:7px 14px;font-size:13px">‚Üê –ù–∞–∑–∞–¥</button><h1>–ü–∞–Ω–µ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</h1></div>
  <div class="dtabs">
    <div class="dt on" onclick="dTab('bg',this)">üñº –§–æ–Ω—ã</div>
    <div class="dt" onclick="dTab('ch',this)">üë§ –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</div>
    <div class="dt" onclick="dTab('sc',this)">üìú –°—Ü–µ–Ω—ã</div>
    <div class="dt" onclick="dTab('set',this)">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
  </div>
  <div class="dc" id="dc"></div>
</div>
</div>

<!-- MODALS -->
<div class="modal" id="M-code"><div class="mbox"><h2>–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞</h2><div class="fg"><label for="i-code">–ö–æ–¥</label><input type="password" id="i-code" name="code" maxlength="10"></div><div class="err-msg" id="code-err" style="display:none">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥</div><div class="brow"><button class="bp" onclick="checkCode()">–í–æ–π—Ç–∏</button><button class="bs" onclick="hideM('M-code')">–û—Ç–º–µ–Ω–∞</button></div></div></div>
<div class="modal" id="M-bg"><div class="mbox mlg"><h2><span id="bg-t">–§–æ–Ω</span><button class="mx" onclick="hideM('M-bg')">‚úï</button></h2><div class="fg"><label for="bg-name">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="bg-name" name="bg-name"></div><div class="fg"><label for="bg-file">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label><label class="fbtn">üìÅ<input type="file" accept="image/*" id="bg-file" name="bg-file" style="display:none" onchange="pvF(this,'bg-pv',1920,1080,false,'_bgD')"></label><img id="bg-pv" class="ipv" style="display:none" alt=""></div><div class="brow"><button class="bp" onclick="saveBg()">OK</button><button class="bd" id="bg-del" style="display:none" onclick="delBg()">–£–¥–∞–ª–∏—Ç—å</button></div></div></div>
<div class="modal" id="M-ch"><div class="mbox mlg"><h2><span id="ch-t">–ü–µ—Ä—Å–æ–Ω–∞–∂</span><button class="mx" onclick="hideM('M-ch')">‚úï</button></h2><div class="fg"><label for="ch-name">–ò–º—è</label><input id="ch-name" name="ch-name"></div><div class="fg"><label for="ch-file">–°–ø—Ä–∞–π—Ç</label><label class="fbtn">üìÅ<input type="file" accept="image/*" id="ch-file" name="ch-file" style="display:none" onchange="pvF(this,'ch-pv',600,900,true,'_chD')"></label><img id="ch-pv" class="ipv" style="display:none" alt=""></div><div class="brow"><button class="bp" onclick="saveCh()">OK</button><button class="bd" id="ch-del" style="display:none" onclick="delCh()">–£–¥–∞–ª–∏—Ç—å</button></div></div></div>
<div class="modal" id="M-sc"><div class="mbox mlg" style="max-height:88vh"><h2><span id="sc-t">–°—Ü–µ–Ω–∞</span><button class="mx" onclick="hideM('M-sc')">‚úï</button></h2><div id="sc-ed"></div></div></div>
<div id="toast"></div>

<script>
var CODE='050412',isAdmin=false;
var TARGET=new Date('2026-03-01T00:00:00+03:00').getTime();
var D={title:'–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ',bgs:[],chars:[],scenes:[],start:null};
var curTab='bg',editId=null,eScData=null;
window._bgD=null;window._chD=null;
var G={sid:null,step:0,typing:false,timer:null,full:''};

function $(id){return document.getElementById(id)}
function uid(){return'i'+Date.now()+'_'+Math.random().toString(36).substr(2,6)}
function esc(s){if(!s)return'';var d=document.createElement('div');d.textContent=s;return d.innerHTML}
function api(m,b){var o={method:m,headers:{'Content-Type':'application/json'}};if(b)o.body=JSON.stringify(b);return fetch('/api/data',o).then(function(r){return r.json()}).catch(function(){return null})}
function loadData(){return api('GET').then(function(d){if(d){D=d;D.title=D.title||'–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ';D.bgs=D.bgs||[];D.chars=D.chars||[];D.scenes=D.scenes||[];return true}return false})}
function save(){return api('POST',D).then(function(ok){if(!ok)toast('–û—à–∏–±–∫–∞!',1);return!!ok})}
function scr(id){var a=document.querySelectorAll('.scr');for(var i=0;i<a.length;i++)a[i].classList.remove('on');$(id).classList.add('on')}
function showM(id){$(id).classList.add('on')}
function hideM(id){$(id).classList.remove('on')}
function toast(m,e){var t=$('toast');t.textContent=m;t.style.background=e?'#e94560':'#4ecca3';t.style.color=e?'#fff':'#000';t.classList.add('show');setTimeout(function(){t.classList.remove('show')},4000)}
function updateMenu(){$('m-title').textContent=D.title||'–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ';var ss=D.start?D.scenes.find(function(s){return s.id===D.start}):null;var st=$('menu-status'),btn=$('btn-play');if(!D.scenes.length){st.innerHTML='<div class="st-no">‚ùå –ü—É—Å—Ç–æ</div>';btn.disabled=true}else if(!ss){st.innerHTML='<div class="st-no">‚ö†Ô∏è –ù–µ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–π</div>';btn.disabled=true}else if(!ss.steps||!ss.steps.length){st.innerHTML='<div class="st-no">‚ö†Ô∏è –ü—É—Å—Ç–∞</div>';btn.disabled=true}else{st.innerHTML='<div class="st-ok">‚úÖ '+D.scenes.length+' —Å—Ü–µ–Ω</div>';btn.disabled=false}}
function openCode(){$('i-code').value='';$('code-err').style.display='none';showM('M-code');$('i-code').focus()}
$('i-code').addEventListener('keydown',function(e){if(e.key==='Enter')checkCode()});
function checkCode(){if($('i-code').value!==CODE){$('code-err').style.display='block';return}hideM('M-code');isAdmin=true;loadData().then(function(){updateMenu();scr('S-dev');renderTab()})}
function toMenu(){stopTyping();bfStop();stopDino();scr('S-menu');updateMenu()}
function readFile(f){return new Promise(function(r){var x=new FileReader;x.onload=function(e){r(e.target.result)};x.readAsDataURL(f)})}
function resize(u,mw,mh,p){return new Promise(function(r){var i=new Image;i.onload=function(){var w=i.width,h=i.height;if(w>mw||h>mh){var k=Math.min(mw/w,mh/h);w=Math.round(w*k);h=Math.round(h*k)}var c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(i,0,0,w,h);r(p?c.toDataURL('image/png'):c.toDataURL('image/jpeg',.72))};i.src=u})}
function pvF(inp,pvId,mw,mh,p,v){if(!inp.files[0])return;readFile(inp.files[0]).then(function(raw){return resize(raw,mw,mh,p)}).then(function(d){window[v]=d;$(pvId).src=d;$(pvId).style.display='block'})}

/* ‚ïê‚ïê‚ïê WAIT ROOM ‚ïê‚ïê‚ïê */
var PEPE_PHRASES=['–ù–µ –º–µ—à–∞–π!','–°–∫–æ—Ä–æ –Ω–∞—á–Ω—É —Ä–∞–±–æ—Ç–∞—Ç—å!','–û—Ç—Å—Ç–∞–Ω—å!','–Ø –∑–∞–Ω—è—Ç!','–ú—è—É... —Ç–æ –µ—Å—Ç—å –∫—ã—à!','–ü–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ!','–ù–µ–π—Ä–æ–Ω–∫–∞ –Ω–µ –≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏!','–ü—Ñ—Ñ...','–ï—â—ë —á—É—Ç—å-—á—É—Ç—å...','–ö—ã—à –æ—Ç—Å—é–¥–∞!','–î–∞–π –ø–æ—Å–ø–∞—Ç—å...','–ö–≤–∞... –≤ —Å–º—ã—Å–ª–µ —É–π–¥–∏!','–ù–µ —Å–µ–π—á–∞—Å!','–ß–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç–æ—á–µ–∫...'];
var phraseTimer=null;
function pepeTap(){
  var el=$('w-phrase');
  el.textContent=PEPE_PHRASES[Math.floor(Math.random()*PEPE_PHRASES.length)];
  el.classList.add('show');
  if(phraseTimer)clearTimeout(phraseTimer);
  phraseTimer=setTimeout(function(){el.classList.remove('show')},2500);
}
function showWaitRoom(){scr('S-wait');updateWaitTimer()}
var waitTimerIv=null;
function updateWaitTimer(){
  if(waitTimerIv)clearInterval(waitTimerIv);
  function tick(){
    var left=TARGET-Date.now();
    if(left<=0){$('w-timer').textContent='üéâ –ì–û–¢–û–í–û!';$('w-timer-sub').textContent='';return}
    var d=Math.floor(left/86400000);var h=Math.floor(left%86400000/3600000);var m=Math.floor(left%3600000/60000);var s=Math.floor(left%60000/1000);
    $('w-timer').textContent=d+'–¥ '+h+'—á '+m+'–º '+s+'—Å';
  }
  tick();waitTimerIv=setInterval(tick,1000);
}

/* ‚ïê‚ïê‚ïê DINO GAME ‚ïê‚ïê‚ïê */
var DG={active:false,raf:null,score:0,speed:5,ground:0,char:{x:80,y:0,vy:0,w:50,h:60,jumping:false},obs:[],nextObs:0,img:null,imgLoaded:false};
function startDino(){
  scr('S-dino');
  $('d-over').classList.remove('on');
  if(!DG.img){
    DG.img=new Image();
    DG.img.crossOrigin='anonymous';
    DG.img.onload=function(){DG.imgLoaded=true;startDinoGame()};
    DG.img.onerror=function(){DG.imgLoaded=false;startDinoGame()};
    DG.img.src='https://i.postimg.cc/qRrM2smW/c4e045949489d91e9b3eecd95313cd65-removebg-preview.png';
  }else{startDinoGame()}
}
function startDinoGame(){
  $('d-over').classList.remove('on');
  var cv=$('d-canvas');var area=$('d-area');var rect=area.getBoundingClientRect();
  cv.width=rect.width*2;cv.height=rect.height*2;cv.style.width=rect.width+'px';cv.style.height=rect.height+'px';
  DG.ground=rect.height-40;DG.score=0;DG.speed=5;DG.obs=[];DG.nextObs=120;
  DG.char.y=DG.ground-DG.char.h;DG.char.vy=0;DG.char.jumping=false;
  DG.active=true;$('d-score').textContent='–°—á—ë—Ç: 0';
  if(DG.raf)cancelAnimationFrame(DG.raf);
  DG.raf=requestAnimationFrame(dinoLoop);
}
function stopDino(){DG.active=false;if(DG.raf){cancelAnimationFrame(DG.raf);DG.raf=null}}
function dinoJump(){if(!DG.active)return;if(!DG.char.jumping){DG.char.vy=-14;DG.char.jumping=true}}
document.addEventListener('keydown',function(e){if(DG.active&&(e.code==='Space'||e.key==='ArrowUp'||e.key==='w')){e.preventDefault();dinoJump()}});

function dinoLoop(){
  if(!DG.active)return;
  var cv=$('d-canvas');var c=cv.getContext('2d');var w=cv.width/2;var h=cv.height/2;
  c.setTransform(2,0,0,2,0,0);c.clearRect(0,0,w,h);

  // ground
  c.fillStyle='#2a2a50';c.fillRect(0,DG.ground,w,40);
  c.strokeStyle='#3a3a60';c.lineWidth=2;
  for(var i=(DG.score*2)%40-40;i<w;i+=40){c.beginPath();c.moveTo(i,DG.ground);c.lineTo(i+20,DG.ground);c.stroke()}

  // physics
  DG.char.vy+=0.8;DG.char.y+=DG.char.vy;
  if(DG.char.y>=DG.ground-DG.char.h){DG.char.y=DG.ground-DG.char.h;DG.char.vy=0;DG.char.jumping=false}

  // draw character
  if(DG.imgLoaded){c.drawImage(DG.img,DG.char.x-5,DG.char.y-5,DG.char.w+10,DG.char.h+10)}
  else{c.fillStyle='#4ecca3';c.fillRect(DG.char.x,DG.char.y,DG.char.w,DG.char.h)}

  // obstacles
  DG.nextObs--;
  if(DG.nextObs<=0){
    var oh=30+Math.random()*30;
    DG.obs.push({x:w+20,y:DG.ground-oh,w:20+Math.random()*15,h:oh});
    DG.nextObs=60+Math.random()*80/(1+DG.score/200);
  }
  for(var i=DG.obs.length-1;i>=0;i--){
    var o=DG.obs[i];o.x-=DG.speed;
    if(o.x+o.w<0){DG.obs.splice(i,1);continue}
    // draw
    c.fillStyle='#e94560';
    c.fillRect(o.x,o.y,o.w,o.h);
    c.fillStyle='#ff6b81';
    c.fillRect(o.x+3,o.y+3,o.w-6,o.h-6);
    // collision
    if(DG.char.x+DG.char.w-8>o.x&&DG.char.x+8<o.x+o.w&&DG.char.y+DG.char.h-4>o.y){
      DG.active=false;$('d-over').classList.add('on');$('d-final').textContent='–°—á—ë—Ç: '+Math.floor(DG.score);return;
    }
  }

  DG.score+=0.1;DG.speed=5+DG.score/50;
  $('d-score').textContent='–°—á—ë—Ç: '+Math.floor(DG.score);
  DG.raf=requestAnimationFrame(dinoLoop);
}

/* ‚ïê‚ïê‚ïê DEV ‚ïê‚ïê‚ïê */
function dTab(t,el){curTab=t;var tabs=document.querySelectorAll('.dt');for(var i=0;i<tabs.length;i++)tabs[i].classList.remove('on');if(el)el.classList.add('on');renderTab()}
function renderTab(){var c=$('dc');if(curTab==='bg')rBgs(c);else if(curTab==='ch')rChars(c);else if(curTab==='sc')rScenes(c);else rSettings(c)}
function rBgs(c){var h='<div class="dgrid">';D.bgs.forEach(function(b){h+='<div class="dcard" onclick="eBg(\''+b.id+'\')"><div class="dcimg" style="background-image:url(\''+b.data+'\')"></div><div class="dcinf"><div class="dcn">'+esc(b.name)+'</div></div></div>'});h+='<div class="dcard dcadd" onclick="aBg()"><div class="ico">+</div><span>–î–æ–±–∞–≤–∏—Ç—å</span></div></div>';c.innerHTML=h}
function aBg(){editId=null;_bgD=null;$('bg-t').textContent='–î–æ–±–∞–≤–∏—Ç—å';$('bg-name').value='';$('bg-pv').style.display='none';$('bg-del').style.display='none';showM('M-bg')}
function eBg(id){var b=D.bgs.find(function(x){return x.id===id});if(!b)return;editId=id;_bgD=null;$('bg-t').textContent='–†–µ–¥.';$('bg-name').value=b.name;$('bg-pv').src=b.data;$('bg-pv').style.display='block';$('bg-del').style.display='inline-block';showM('M-bg')}
function saveBg(){var n=$('bg-name').value.trim();if(!n)return toast('!',1);if(editId){var b=D.bgs.find(function(x){return x.id===editId});if(b){b.name=n;if(_bgD)b.data=_bgD}}else{if(!_bgD)return toast('!',1);D.bgs.push({id:uid(),name:n,data:_bgD})}_bgD=null;save().then(function(){hideM('M-bg');renderTab();toast('OK')})}
function delBg(){if(!confirm('?'))return;D.bgs=D.bgs.filter(function(x){return x.id!==editId});save().then(function(){hideM('M-bg');renderTab()})}
function rChars(c){var h='<div class="dgrid">';D.chars.forEach(function(ch){h+='<div class="dcard" onclick="eCh(\''+ch.id+'\')"><div class="dcimg" style="background-image:url(\''+ch.data+'\');background-size:contain;background-repeat:no-repeat;background-position:center"></div><div class="dcinf"><div class="dcn">'+esc(ch.name)+'</div></div></div>'});h+='<div class="dcard dcadd" onclick="aCh()"><div class="ico">+</div><span>–î–æ–±–∞–≤–∏—Ç—å</span></div></div>';c.innerHTML=h}
function aCh(){editId=null;_chD=null;$('ch-t').textContent='–î–æ–±–∞–≤–∏—Ç—å';$('ch-name').value='';$('ch-pv').style.display='none';$('ch-del').style.display='none';showM('M-ch')}
function eCh(id){var ch=D.chars.find(function(x){return x.id===id});if(!ch)return;editId=id;_chD=null;$('ch-t').textContent='–†–µ–¥.';$('ch-name').value=ch.name;$('ch-pv').src=ch.data;$('ch-pv').style.display='block';$('ch-del').style.display='inline-block';showM('M-ch')}
function saveCh(){var n=$('ch-name').value.trim();if(!n)return toast('!',1);if(editId){var ch=D.chars.find(function(x){return x.id===editId});if(ch){ch.name=n;if(_chD)ch.data=_chD}}else{if(!_chD)return toast('!',1);D.chars.push({id:uid(),name:n,data:_chD})}_chD=null;save().then(function(){hideM('M-ch');renderTab();toast('OK')})}
function delCh(){if(!confirm('?'))return;D.chars=D.chars.filter(function(x){return x.id!==editId});save().then(function(){hideM('M-ch');renderTab()})}
function rScenes(c){var h='<div class="dgrid">';D.scenes.forEach(function(sc){var isS=sc.id===D.start;var bg=D.bgs.find(function(b){return b.id===sc.bgId});h+='<div class="dcard'+(isS?' start':'')+'" onclick="eSc(\''+sc.id+'\')"><div class="dcimg" style="'+(bg?'background-image:url(\''+bg.data+'\')':'display:flex;align-items:center;justify-content:center;font-size:38px;color:#7878a0')+'">'+(!bg?'üìú':'')+'</div><div class="dcinf"><div class="dcn">'+(sc.bossFight?'üéµ ':'')+esc(sc.name)+'</div><div class="dcs">'+(isS?'‚≠ê':sc.steps.length+'—à–∞–≥')+'</div></div></div>'});h+='<div class="dcard dcadd" onclick="aSc()"><div class="ico">+</div><span>–î–æ–±–∞–≤–∏—Ç—å</span></div></div>';c.innerHTML=h}
function mkStep(){return{chId:null,pos:'center',text:'',hasCh:false,choices:[]}}
function aSc(){editId=null;eScData={id:uid(),name:'',bgId:null,steps:[mkStep()],next:null,bossFight:false,bfBpm:140,bfDur:60,bfSongName:'',bfChar:null};$('sc-t').textContent='+';rScEd();showM('M-sc')}
function eSc(id){var sc=D.scenes.find(function(s){return s.id===id});if(!sc)return;editId=id;eScData=JSON.parse(JSON.stringify(sc));if(!eScData.bfBpm)eScData.bfBpm=140;if(!eScData.bfDur)eScData.bfDur=60;eScData.steps.forEach(function(s){if(s.hasCh===undefined)s.hasCh=!!(s.choices&&s.choices.length)});$('sc-t').textContent='–†–µ–¥.';rScEd();showM('M-sc');if(editId)chkAudio(eScData.id)}
function chkAudio(id){fetch('/api/audio-check/'+id).then(function(r){return r.json()}).then(function(d){var el=document.getElementById('bf-ast');if(!el)return;if(d.exists)el.innerHTML='<div class="audio-info"><span class="ai-name">üéµ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ('+(d.size/1024/1024).toFixed(1)+'–ú–ë)</span><button onclick="pvAud(\''+id+'\')">‚ñ∂</button><button onclick="dlAud(\''+id+'\')">‚úï</button></div>';else el.innerHTML='<div style="color:#7878a0;font-size:12px;margin-top:6px">–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ‚Üí –∞–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è</div>'}).catch(function(){})}
function ulAud(inp){if(!inp.files[0]||!eScData)return;var f=inp.files[0];var ext=f.name.split('.').pop();var el=document.getElementById('bf-ast');if(el)el.innerHTML='<div style="color:#ffcc00;font-size:13px">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';var r=new FileReader;r.onload=function(){fetch('/api/audio/'+eScData.id,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:r.result.split(',')[1],ext:ext})}).then(function(r){return r.json()}).then(function(d){if(d.ok){toast('üéµ OK');chkAudio(eScData.id)}else toast('–û—à–∏–±–∫–∞!',1)}).catch(function(){toast('–û—à–∏–±–∫–∞!',1)})};r.readAsDataURL(f)}
function pvAud(id){if(window._pa){window._pa.pause();window._pa=null;return}window._pa=new Audio('/api/audio/'+id);window._pa.volume=.5;window._pa.play().catch(function(){});setTimeout(function(){if(window._pa){window._pa.pause();window._pa=null}},10000)}
function dlAud(id){if(!confirm('?'))return;fetch('/api/audio/'+id,{method:'DELETE'}).then(function(){toast('OK');chkAudio(id)})}
function gather(){var ed=$('sc-ed');if(!ed)return;var v=function(s){return ed.querySelector(s)};var ni=v('#sce-name');if(ni)eScData.name=ni.value;var bi=v('#sce-bg');if(bi)eScData.bgId=bi.value||null;var nsi=v('#sce-next');if(nsi)eScData.next=nsi.value||null;var bfc=v('#sce-bf');if(bfc)eScData.bossFight=bfc.checked;var bfb=v('#sce-bfbpm');if(bfb)eScData.bfBpm=parseInt(bfb.value)||140;var bfd=v('#sce-bfdur');if(bfd)eScData.bfDur=parseInt(bfd.value)||60;var bfs=v('#sce-bfsong');if(bfs)eScData.bfSongName=bfs.value;var bfch=v('#sce-bfchar');if(bfch)eScData.bfChar=bfch.value||null;var items=ed.querySelectorAll('.si');for(var i=0;i<items.length;i++){var s=eScData.steps[i];if(!s)continue;var ch=items[i].querySelector('.sc-ch');if(ch)s.chId=ch.value||null;var ps=items[i].querySelector('.sc-ps');if(ps)s.pos=ps.value;var tx=items[i].querySelector('.sc-tx');if(tx)s.text=tx.value;var rows=items[i].querySelectorAll('.crow');for(var ci=0;ci<rows.length;ci++){if(!s.choices[ci])continue;var ct=rows[ci].querySelector('.sc-ct');if(ct)s.choices[ci].text=ct.value;var cs=rows[ci].querySelector('.sc-cs');if(cs)s.choices[ci].target=cs.value||null}}}
function rScEd(){var sc=eScData;var bgO='';D.bgs.forEach(function(b){bgO+='<option value="'+b.id+'"'+(sc.bgId===b.id?' selected':'')+'>'+esc(b.name)+'</option>'});var allSc=D.scenes.filter(function(s){return s.id!==sc.id});var chOpts='';D.chars.forEach(function(c){chOpts+='<option value="'+c.id+'"'+(sc.bfChar===c.id?' selected':'')+'>'+esc(c.name)+'</option>'});var stH='';
  sc.steps.forEach(function(st,i){var chO='';D.chars.forEach(function(c){chO+='<option value="'+c.id+'"'+(st.chId===c.id?' selected':'')+'>'+esc(c.name)+'</option>'});var chcH='';if(st.hasCh){chcH='<div class="csec">';(st.choices||[]).forEach(function(ch,ci){var csO='';allSc.forEach(function(s){csO+='<option value="'+s.id+'"'+(ch.target===s.id?' selected':'')+'>'+esc(s.name)+'</option>'});chcH+='<div class="crow"><input class="sc-ct" name="ct'+i+'_'+ci+'" value="'+esc(ch.text)+'"><select class="sc-cs" name="cs'+i+'_'+ci+'"><option value="">‚Üí</option>'+csO+'</select><button onclick="gather();eScData.steps['+i+'].choices.splice('+ci+',1);rScEd()">‚úï</button></div>'});chcH+='<button class="bsm" onclick="gather();eScData.steps['+i+'].choices.push({text:\'\',target:null});rScEd()">+</button></div>'}
    stH+='<div class="si"><div class="sih"><span class="sin">–®–∞–≥ '+(i+1)+'</span><div class="sia">'+(i>0?'<button onclick="gather();swSt('+i+',-1)">‚Üë</button>':'')+(i<sc.steps.length-1?'<button onclick="gather();swSt('+i+',1)">‚Üì</button>':'')+(sc.steps.length>1?'<button onclick="gather();eScData.steps.splice('+i+',1);rScEd()">‚úï</button>':'')+'</div></div><div class="sf"><div><label for="sch'+i+'">–ü–µ—Ä—Å–æ–Ω–∞–∂</label><select class="sc-ch" id="sch'+i+'" name="sch'+i+'"><option value="">‚Äî</option>'+chO+'</select></div><div><label for="sps'+i+'">–ü–æ–∑</label><select class="sc-ps" id="sps'+i+'" name="sps'+i+'"><option value="left"'+(st.pos==='left'?' selected':'')+'>‚Üê</option><option value="center"'+(st.pos==='center'?' selected':'')+'>‚äô</option><option value="right"'+(st.pos==='right'?' selected':'')+'>‚Üí</option></select></div><div class="fw"><label for="stx'+i+'">–¢–µ–∫—Å—Ç</label><textarea class="sc-tx" id="stx'+i+'" name="stx'+i+'">'+esc(st.text)+'</textarea></div></div><div class="cbtog"><input type="checkbox" id="cb'+i+'" name="cb'+i+'"'+(st.hasCh?' checked':'')+' onchange="gather();eScData.steps['+i+'].hasCh=this.checked;if(this.checked&&(!eScData.steps['+i+'].choices||!eScData.steps['+i+'].choices.length))eScData.steps['+i+'].choices=[{text:\'\',target:null}];rScEd()"><label for="cb'+i+'">–í—ã–±–æ—Ä</label></div>'+chcH+'</div>'});
  var nxO='';allSc.forEach(function(s){nxO+='<option value="'+s.id+'"'+(sc.next===s.id?' selected':'')+'>'+esc(s.name)+'</option>'});
  $('sc-ed').innerHTML='<div class="fg"><label for="sce-name">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="sce-name" name="sce-name" value="'+esc(sc.name)+'"></div><div class="fg"><label for="sce-bg">–§–æ–Ω</label><select id="sce-bg" name="sce-bg"><option value="">‚Äî</option>'+bgO+'</select></div><div class="fg"><label>–®–∞–≥–∏</label><div class="steps">'+stH+'</div><button class="bsm" onclick="gather();eScData.steps.push(mkStep());rScEd()" style="margin-top:12px">+–®–∞–≥</button></div><div class="fg"><label for="sce-next">–î–∞–ª–µ–µ</label><select id="sce-next" name="sce-next"><option value="">–ö–æ–Ω–µ—Ü</option>'+nxO+'</select></div><div class="bfsec"><h4>üéµ –ë–æ—Å—Å-—Ñ–∞–π—Ç</h4><div class="cbtog"><input type="checkbox" id="sce-bf" name="sce-bf"'+(sc.bossFight?' checked':'')+'><label for="sce-bf">–í–∫–ª—é—á–∏—Ç—å</label></div><div class="sf" style="margin-top:10px"><div><label for="sce-bfchar">–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫</label><select id="sce-bfchar" name="sce-bfchar"><option value="">‚Äî</option>'+chOpts+'</select></div><div><label for="sce-bfsong">–ü–µ—Å–Ω—è</label><input id="sce-bfsong" name="sce-bfsong" value="'+esc(sc.bfSongName)+'"></div><div><label for="sce-bfbpm">BPM</label><input type="number" id="sce-bfbpm" name="sce-bfbpm" value="'+(sc.bfBpm||140)+'" min="60" max="300"></div><div><label for="sce-bfdur">–î–ª–∏–Ω–∞(—Å)</label><input type="number" id="sce-bfdur" name="sce-bfdur" value="'+(sc.bfDur||60)+'" min="15" max="300"></div></div><div class="fg" style="margin-top:10px"><label>–ú—É–∑—ã–∫–∞</label><label class="fbtn">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å<input type="file" accept="audio/*" style="display:none" onchange="ulAud(this)"></label><div id="bf-ast"></div></div></div><div class="brow" style="margin-top:18px"><button class="bp" onclick="saveSc()">OK</button>'+(editId?'<button class="bd" onclick="delSc()">–£–¥–∞–ª–∏—Ç—å</button>':'')+'</div>'}
function swSt(i,d){var s=eScData.steps;var t=s[i];s[i]=s[i+d];s[i+d]=t;rScEd()}
function saveSc(){gather();var sc=eScData;sc.name=sc.name||'?';sc.steps.forEach(function(s){if(!s.hasCh)s.choices=[]});if(editId){for(var i=0;i<D.scenes.length;i++){if(D.scenes[i].id===editId){D.scenes[i]=sc;break}}}else{D.scenes.push(sc);if(!D.start)D.start=sc.id}save().then(function(){hideM('M-sc');renderTab();toast('OK')})}
function delSc(){if(!confirm('?'))return;if(editId)fetch('/api/audio/'+editId,{method:'DELETE'}).catch(function(){});D.scenes=D.scenes.filter(function(s){return s.id!==editId});if(D.start===editId)D.start=D.scenes.length?D.scenes[0].id:null;save().then(function(){hideM('M-sc');renderTab()})}
function rSettings(c){var scO='';D.scenes.forEach(function(s){scO+='<option value="'+s.id+'"'+(D.start===s.id?' selected':'')+'>'+esc(s.name)+'</option>'});c.innerHTML='<div class="setsec"><h3>‚úèÔ∏è –ù–∞–∑–≤–∞–Ω–∏–µ</h3><div class="fg"><label for="st-t">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input id="st-t" name="st-t" value="'+esc(D.title)+'" onchange="D.title=this.value;save().then(function(){updateMenu();toast(\'OK\')})"></div></div><div class="setsec"><h3>‚≠ê –ù–∞—á–∞–ª—å–Ω–∞—è</h3><div class="fg"><label for="st-s">–°—Ü–µ–Ω–∞</label><select id="st-s" name="st-s" onchange="D.start=this.value||null;save().then(function(){updateMenu();toast(\'OK\')})"><option value="">‚Äî</option>'+scO+'</select></div></div><div class="setsec"><h3>üíæ</h3><div class="brow"><button class="bs" onclick="expD()">üì§</button><label class="bs" style="cursor:pointer">üì•<input type="file" accept=".json" name="imp" style="display:none" onchange="impD(this)"></label></div></div><div class="setsec"><button class="bd" onclick="clearAll()">üóë –£–¥–∞–ª–∏—Ç—å –≤—Å—ë</button></div>'}
function expD(){var b=new Blob([JSON.stringify(D,null,2)],{type:'application/json'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='novel.json';a.click()}
function impD(inp){if(!inp.files[0])return;inp.files[0].text().then(function(t){try{var d=JSON.parse(t);if(d.scenes){D=d;save().then(function(){renderTab();updateMenu();toast('OK')})}}catch(e){toast('!',1)}})}
function clearAll(){if(!confirm('–í–°–Å?'))return;D={title:'–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ',bgs:[],chars:[],scenes:[],start:null};save().then(function(){renderTab();updateMenu()})}

/* ‚ïê‚ïê‚ïê NOVEL ‚ïê‚ïê‚ïê */
function startGame(){
  if(!isAdmin&&Date.now()<TARGET){showWaitRoom();return}
  loadData().then(function(ok){if(!ok){toast('!',1);return}updateMenu();var ss=findScene(D.start);if(!ss||!ss.steps||!ss.steps.length){toast('–ü—É—Å—Ç–æ!',1);return}scr('S-game');$('g-end').classList.remove('on');$('g-choices').classList.remove('on');$('g-char').style.display='none';$('g-name').textContent='';$('g-txt').textContent='';gameLoad(D.start)})
}
function findScene(id){for(var i=0;i<D.scenes.length;i++)if(D.scenes[i].id===id)return D.scenes[i];return null}
function findChar(id){for(var i=0;i<D.chars.length;i++)if(D.chars[i].id===id)return D.chars[i];return null}
function findBg(id){for(var i=0;i<D.bgs.length;i++)if(D.bgs[i].id===id)return D.bgs[i];return null}
function gameLoad(sid){var sc=findScene(sid);if(!sc){gameEnd();return}if(!sc.steps||!sc.steps.length){gameTrans(sc);return}G.sid=sid;G.step=0;var bg=findBg(sc.bgId);var el=$('g-bg');if(bg){el.style.backgroundImage='url('+bg.data+')'}else{el.style.backgroundImage='none';el.style.backgroundColor='#1e1e3e'}gameShow()}
function gameTrans(sc){if(sc&&sc.bossFight){bfStart(sc)}else if(sc&&sc.next){gameLoad(sc.next)}else{gameEnd()}}
function gameShow(){var sc=findScene(G.sid);if(!sc||G.step>=sc.steps.length){gameTrans(sc);return}var st=sc.steps[G.step];var cel=$('g-char');if(st.chId){var ch=findChar(st.chId);if(ch){cel.src=ch.data;cel.className=st.pos==='left'?'vis pl':st.pos==='right'?'vis pr':'vis pc';cel.style.display='block';$('g-name').textContent=ch.name}else{cel.style.display='none';$('g-name').textContent=''}}else{cel.style.display='none';$('g-name').textContent=''}gameType(st.text||'...');$('g-ind').style.display=(st.hasCh&&st.choices&&st.choices.length)?'none':'block'}
function gameType(t){stopTyping();G.full=t;G.typing=true;var el=$('g-txt');var i=0;el.textContent='';G.timer=setInterval(function(){if(i<t.length){el.textContent+=t.charAt(i);i++}else{stopTyping();gameAfter()}},30)}
function stopTyping(){if(G.timer){clearInterval(G.timer);G.timer=null}G.typing=false}
function gameAfter(){var sc=findScene(G.sid);if(!sc)return;var st=sc.steps[G.step];if(st&&st.hasCh&&st.choices&&st.choices.length){var c=$('g-choices');var h='';for(var i=0;i<st.choices.length;i++)h+='<button class="chb" onclick="gamePick('+i+')">'+esc(st.choices[i].text||'–í–∞—Ä–∏–∞–Ω—Ç '+(i+1))+'</button>';c.innerHTML=h;c.classList.add('on')}}
function advance(){if(G.typing){stopTyping();$('g-txt').textContent=G.full;gameAfter();return}var sc=findScene(G.sid);if(!sc)return;var st=sc.steps[G.step];if(st&&st.hasCh&&st.choices&&st.choices.length)return;G.step++;if(G.step>=sc.steps.length)gameTrans(sc);else gameShow()}
function gamePick(i){var sc=findScene(G.sid);if(!sc)return;var st=sc.steps[G.step];if(!st||!st.choices||!st.choices[i])return;$('g-choices').classList.remove('on');var t=st.choices[i].target;if(t)gameLoad(t);else gameEnd()}
function gameEnd(){stopTyping();$('g-end').classList.add('on')}

/* ‚ïê‚ïê‚ïê BOSS FIGHT ‚ïê‚ïê‚ïê */
var BF={active:false,audio:null,actx:null,raf:null,hp:50,score:0,combo:0,maxCombo:0,hits:0,misses:0,perfects:0,notes:[],noteIdx:0,startTime:0,songDur:0,sceneData:null,canvas:null,ctx:null,laneColors:['#c24b99','#00ffff','#12fa05','#f9393f'],laneW:0,hitY:0,speed:400,pressed:[false,false,false,false],hitAnims:[[],[],[],[]]};

function bfStop(){BF.active=false;if(BF.raf){cancelAnimationFrame(BF.raf);BF.raf=null}if(BF.audio){BF.audio.pause();BF.audio=null}if(BF.actx){try{BF.actx.close()}catch(e){}BF.actx=null}}

function bfStart(sd){
  bfStop();BF.sceneData=sd;BF.hp=50;BF.score=0;BF.combo=0;BF.maxCombo=0;BF.hits=0;BF.misses=0;BF.perfects=0;BF.noteIdx=0;
  BF.pressed=[false,false,false,false];BF.hitAnims=[[],[],[],[]];
  var bpm=sd.bfBpm||140;var dur=sd.bfDur||60;BF.songDur=dur*1000;
  BF.speed=Math.min(200+bpm*1.5,650);
  BF.notes=bfGenBeatmap(bpm,dur);
  var ch=sd.bfChar?findChar(sd.bfChar):null;
  if(ch){$('bf-opp-img').src=ch.data;$('bf-opp-img').style.display='block';$('bf-opp-name').textContent=ch.name}
  else{$('bf-opp-img').style.display='none';$('bf-opp-name').textContent='???'}
  $('bf-song-name').textContent='‚ô™ '+(sd.bfSongName||'Unknown');
  scr('S-boss');$('bf-result').classList.remove('on');$('bf-hfill').style.width='50%';$('bf-score-txt').textContent='0';
  // FIX: wait 2 frames for layout before setting up canvas
  requestAnimationFrame(function(){requestAnimationFrame(function(){
    bfSetupCanvas();
    bfLoadAudio(sd.id,function(has){
      bfCountdown(function(){
        if(has&&BF.audio){BF.audio.currentTime=0;BF.audio.play().catch(function(){})}
        else{BF.actx=new(window.AudioContext||window.webkitAudioContext)();bfGenMusic(BF.actx,bpm,dur)}
        BF.startTime=performance.now();BF.active=true;BF.raf=requestAnimationFrame(bfLoop);
      });
    });
  })});
}

function bfSetupCanvas(){
  BF.canvas=$('bf-canvas');var rect=BF.canvas.parentElement.getBoundingClientRect();
  BF.canvas.width=Math.max(rect.width*2,100);BF.canvas.height=Math.max(rect.height*2,100);
  BF.canvas.style.width=rect.width+'px';BF.canvas.style.height=rect.height+'px';
  BF.ctx=BF.canvas.getContext('2d');BF.ctx.scale(2,2);
  BF.laneW=rect.width/4;BF.hitY=rect.height-100;
}

function bfLoadAudio(id,cb){
  fetch('/api/audio-check/'+id).then(function(r){return r.json()}).then(function(d){
    if(d.exists){BF.audio=new Audio('/api/audio/'+id);BF.audio.preload='auto';BF.audio.volume=.7;var ok=false;BF.audio.oncanplaythrough=function(){if(!ok){ok=true;cb(true)}};BF.audio.onerror=function(){if(!ok){ok=true;cb(false)}};BF.audio.load();setTimeout(function(){if(!ok){ok=true;cb(BF.audio&&BF.audio.readyState>=2)}},5000)}
    else cb(false)
  }).catch(function(){cb(false)})
}

function bfCountdown(cb){var el=$('bf-countdown');el.classList.add('on');var n=['3','2','1','‚ô™'];var i=0;el.textContent=n[0];var iv=setInterval(function(){i++;if(i<n.length)el.textContent=n[i];else{clearInterval(iv);el.classList.remove('on');cb()}},700)}

/* RHYTHM-SYNCED BEATMAP */
function bfGenBeatmap(bpm,dur){
  var beat=60/bpm;var notes=[];var t=beat*4;
  // musical patterns: sequences of lane indices
  var patterns=[
    [0,1,2,3],[3,2,1,0],[0,2,1,3],[1,3,0,2],
    [0,0,2,2],[1,1,3,3],[0,1,0,1],[2,3,2,3],
    [0,2,0,3],[1,3,1,2],[3,1,0,2],[2,0,3,1],
    [0,1,2,1],[3,2,1,2],[0,3,0,3],[1,2,1,2]
  ];
  var pi=Math.floor(Math.random()*patterns.length);
  var si=0; // step within pattern
  var intensity=0; // increases over time
  
  while(t<dur-2){
    intensity=Math.min(t/(dur*0.7),1); // 0‚Üí1 over 70% of song
    var pat=patterns[pi%patterns.length];
    
    // always place on exact beats for rhythm feel
    var lane=pat[si%pat.length];
    notes.push({time:t*1000,lane:lane,hit:false,missed:false});
    
    // add off-beat notes based on intensity
    if(intensity>0.2&&Math.random()<intensity*0.5){
      // 8th note (half beat)
      var lane2=(lane+1+Math.floor(Math.random()*3))%4;
      notes.push({time:(t+beat*0.5)*1000,lane:lane2,hit:false,missed:false});
    }
    if(intensity>0.5&&Math.random()<(intensity-0.5)*0.6){
      // 16th notes for intense sections
      notes.push({time:(t+beat*0.25)*1000,lane:Math.floor(Math.random()*4),hit:false,missed:false});
    }
    if(intensity>0.7&&Math.random()<0.15){
      // triplet feel
      notes.push({time:(t+beat*0.33)*1000,lane:(lane+2)%4,hit:false,missed:false});
      notes.push({time:(t+beat*0.67)*1000,lane:(lane+3)%4,hit:false,missed:false});
    }
    
    si++;
    // switch pattern every 4-8 beats
    if(si%pat.length===0&&Math.random()<0.4){pi++;si=0}
    
    // sometimes skip a beat for breathing room
    if(Math.random()<0.15*(1-intensity)){t+=beat}
    t+=beat;
  }
  notes.sort(function(a,b){return a.time-b.time});
  return notes;
}

function bfGenMusic(actx,bpm,dur){var beat=60/bpm;var f=[261.63,293.66,329.63,349.23,392,440,493.88,523.25];var now=actx.currentTime;for(var i=0;i<BF.notes.length;i++){var n=BF.notes[i];bfTn(actx,f[(n.lane*2+i)%8],now+n.time/1000,beat*.35,'square',.06)}for(var t=0;t<dur;t+=beat)bfTn(actx,f[Math.floor(t/beat/4)%4]/2,now+t,beat*.5,'triangle',.1);for(var t=0;t<dur;t+=beat)bfDr(actx,now+t);for(var t=beat/2;t<dur;t+=beat)bfNs(actx,now+t,.02,.03)}
function bfTn(c,f,t,d,tp,v){var o=c.createOscillator();var g=c.createGain();o.type=tp;o.frequency.value=f;g.gain.setValueAtTime(v,t);g.gain.exponentialRampToValueAtTime(.001,t+d);o.connect(g);g.connect(c.destination);o.start(t);o.stop(t+d+.01)}
function bfDr(c,t){var o=c.createOscillator();var g=c.createGain();o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(30,t+.1);g.gain.setValueAtTime(.12,t);g.gain.exponentialRampToValueAtTime(.001,t+.15);o.connect(g);g.connect(c.destination);o.start(t);o.stop(t+.2)}
function bfNs(c,t,d,v){var b=c.createBuffer(1,c.sampleRate*d,c.sampleRate);var da=b.getChannelData(0);for(var i=0;i<da.length;i++)da[i]=Math.random()*2-1;var s=c.createBufferSource();s.buffer=b;var g=c.createGain();g.gain.setValueAtTime(v,t);g.gain.exponentialRampToValueAtTime(.001,t+d);var fl=c.createBiquadFilter();fl.type='highpass';fl.frequency.value=8000;s.connect(fl);fl.connect(g);g.connect(c.destination);s.start(t)}

function bfLoop(){
  if(!BF.active)return;var el=performance.now()-BF.startTime;
  for(var i=BF.noteIdx;i<BF.notes.length;i++){var n=BF.notes[i];if(n.hit||n.missed)continue;if(el-n.time>160){n.missed=true;BF.misses++;BF.combo=0;BF.hp=Math.max(0,BF.hp-5);bfRt('MISS','#e94560')}if(n.time-el>2000)break}
  while(BF.noteIdx<BF.notes.length&&(BF.notes[BF.noteIdx].hit||BF.notes[BF.noteIdx].missed))BF.noteIdx++;
  $('bf-hfill').style.width=BF.hp+'%';$('bf-score-txt').textContent=Math.floor(BF.score);
  if(BF.hp<=0){bfEnd(false);return}
  if(el>=BF.songDur+1000){bfEnd(true);return}
  bfRender(el);BF.raf=requestAnimationFrame(bfLoop);
}

function bfRender(el){
  var c=BF.ctx;var w=BF.canvas.width/2;var h=BF.canvas.height/2;c.clearRect(0,0,w,h);
  for(var i=0;i<4;i++){c.fillStyle='rgba(255,255,255,0.02)';c.fillRect(i*BF.laneW,0,BF.laneW,h);c.strokeStyle='rgba(255,255,255,0.06)';c.strokeRect(i*BF.laneW,0,BF.laneW,h)}
  // hit zone with glow
  for(var i=0;i<4;i++){
    var cx=i*BF.laneW+BF.laneW/2;
    if(BF.pressed[i]){c.fillStyle=BF.laneColors[i]+'22';c.fillRect(i*BF.laneW,BF.hitY-30,BF.laneW,60)}
    bfAr(c,cx,BF.hitY,BF.laneW*.32,i,false,BF.pressed[i]?BF.laneColors[i]:'rgba(255,255,255,0.25)');
  }
  // hit anims
  for(var i=0;i<4;i++){for(var j=BF.hitAnims[i].length-1;j>=0;j--){var a=BF.hitAnims[i][j];var age=el-a.time;if(age>300){BF.hitAnims[i].splice(j,1);continue}c.globalAlpha=1-age/300;bfAr(c,i*BF.laneW+BF.laneW/2,BF.hitY,BF.laneW*.32*(1+age/200),i,true,a.color);c.globalAlpha=1}}
  // notes ‚Äî scroll from top to hit zone
  for(var i=0;i<BF.notes.length;i++){var n=BF.notes[i];if(n.hit||n.missed)continue;var dt=n.time-el;if(dt>2000)break;if(dt<-300)continue;
    // note goes from top (far) to hitY (close)
    var y=BF.hitY-dt/1000*BF.speed;
    if(y<-50||y>h+50)continue;
    bfAr(c,n.lane*BF.laneW+BF.laneW/2,y,BF.laneW*.32,n.lane,true,BF.laneColors[n.lane]);
  }
}

function bfAr(c,x,y,s,l,fill,col){c.save();c.translate(x,y);var r=[Math.PI/2,Math.PI,0,-Math.PI/2];c.rotate(r[l]);c.beginPath();c.moveTo(0,-s);c.lineTo(s*.7,s*.2);c.lineTo(s*.25,s*.2);c.lineTo(s*.25,s);c.lineTo(-s*.25,s);c.lineTo(-s*.25,s*.2);c.lineTo(-s*.7,s*.2);c.closePath();if(fill){c.fillStyle=col;c.fill();c.strokeStyle='rgba(255,255,255,.2)';c.lineWidth=1;c.stroke()}else{c.strokeStyle=col;c.lineWidth=2;c.stroke()}c.restore()}

function bfHit(lane){
  if(!BF.active)return;BF.pressed[lane]=true;setTimeout(function(){BF.pressed[lane]=false},100);
  var el=performance.now()-BF.startTime;var best=null,bestDt=Infinity;
  for(var i=0;i<BF.notes.length;i++){var n=BF.notes[i];if(n.hit||n.missed||n.lane!==lane)continue;var dt=Math.abs(el-n.time);if(dt>200)continue;if(dt<bestDt){bestDt=dt;best=n}}
  if(!best)return;best.hit=true;BF.hits++;
  var r,p,heal,col;
  if(bestDt<35){r='PERFECT';p=400;heal=3;col='#ffff00';BF.perfects++}
  else if(bestDt<75){r='GREAT';p=280;heal=2;col='#4ecca3'}
  else if(bestDt<120){r='GOOD';p=150;heal=1;col='#39ffdc'}
  else{r='OK';p=50;heal=0;col='#7878a0'}
  BF.combo++;if(BF.combo>BF.maxCombo)BF.maxCombo=BF.combo;
  BF.score+=p*(1+Math.floor(BF.combo/10)*0.15);BF.hp=Math.min(100,BF.hp+heal);
  BF.hitAnims[lane].push({time:performance.now()-BF.startTime,color:col});
  bfRt(r,col);if(BF.combo>0&&BF.combo%10===0)bfCb();
}
function bfRt(t,c){var e=$('bf-rating-txt');e.textContent=t;e.style.color=c;e.classList.remove('show');void e.offsetWidth;e.classList.add('show');setTimeout(function(){e.classList.remove('show')},600)}
function bfCb(){var e=$('bf-combo-txt');e.textContent=BF.combo+'x';e.classList.remove('show');void e.offsetWidth;e.classList.add('show');setTimeout(function(){e.classList.remove('show')},800)}
function bfEnd(won){bfStop();$('bf-result').classList.add('on');$('bf-res-title').textContent=won?'–ü–û–ë–ï–î–ê!':'–ü–û–†–ê–ñ–ï–ù–ò–ï';$('bf-res-title').className=won?'win':'lose';$('bf-res-stats').innerHTML='–°—á—ë—Ç: '+Math.floor(BF.score)+'<br>–ö–æ–º–±–æ: '+BF.maxCombo+'x<br>Perfect: '+BF.perfects+'<br>–ü—Ä–æ–º–∞—Ö–∏: '+BF.misses;var btn=$('bf-res-btn');var sc=BF.sceneData;if(won){btn.textContent='–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';btn.onclick=function(){$('bf-result').classList.remove('on');if(sc&&sc.next){scr('S-game');gameLoad(sc.next)}else{scr('S-game');gameEnd()}}}else{btn.textContent='–ï—â—ë —Ä–∞–∑';btn.onclick=function(){$('bf-result').classList.remove('on');bfStart(sc)}}}
document.addEventListener('keydown',function(e){if(BF.active){if(e.key==='ArrowLeft'||e.key==='a')bfHit(0);else if(e.key==='ArrowDown'||e.key==='s')bfHit(1);else if(e.key==='ArrowUp'||e.key==='w')bfHit(2);else if(e.key==='ArrowRight'||e.key==='d')bfHit(3)}});

/* INIT */
(function(){if(window.Telegram&&Telegram.WebApp){Telegram.WebApp.ready();Telegram.WebApp.expand()}loadData().then(function(){updateMenu();$('loader').classList.add('hide');setTimeout(function(){$('loader').style.display='none'},600)})})();
</script>
</body>
</html>
