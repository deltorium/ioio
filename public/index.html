<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<title>Visual Novel</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',system-ui,sans-serif;background:#0b0b1a;color:#eaeaea;user-select:none;-webkit-touch-callout:none}
#rotate{display:none;position:fixed;inset:0;background:#0b0b1a;z-index:9999;flex-direction:column;align-items:center;justify-content:center;gap:20px}
#rotate .ri{font-size:56px;animation:rr 2s ease-in-out infinite}
@keyframes rr{0%,100%{transform:rotate(0)}50%{transform:rotate(90deg)}}
#rotate p{font-size:17px;color:#7878a0}
@media(orientation:portrait)and(max-width:900px){#rotate{display:flex}#app{display:none!important}}
#loader{position:fixed;inset:0;background:#0b0b1a;z-index:9998;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;transition:opacity .5s}
.spinner{width:42px;height:42px;border:3px solid #2a2a50;border-top-color:#e94560;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#loader.hide{opacity:0;pointer-events:none}
#app{width:100vw;height:100vh;position:relative}
.scr{display:none;position:absolute;top:0;left:0;width:100%;height:100%}.scr.on{display:flex}
#S-menu{flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#0b0b1a,#161630,#1a1040);gap:20px}
#m-title{font-size:clamp(26px,5vw,58px);font-weight:900;letter-spacing:3px;text-align:center;text-transform:uppercase;padding:0 20px;background:linear-gradient(135deg,#e94560,#ff6b81);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#menu-status{text-align:center;min-height:24px}
.st-ok{color:#4ecca3;font-size:14px}.st-no{color:#e94560;font-size:14px}
.bplay{padding:16px 64px;font-size:20px;font-weight:700;background:#e94560;color:#fff;border:none;border-radius:50px;cursor:pointer;letter-spacing:2px;text-transform:uppercase}
.bplay:disabled{opacity:.4;cursor:not-allowed}
.bgear{position:absolute;top:14px;right:14px;width:44px;height:44px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);border-radius:12px;color:#7878a0;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}
#S-wait{flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#0b0b1a,#0d1520,#0b0b1a);gap:16px;overflow:hidden}
#w-pepe{position:absolute;bottom:10px;left:10px;width:clamp(80px,15vw,140px);cursor:pointer;filter:drop-shadow(0 0 10px rgba(100,200,100,.3));transition:transform .2s;z-index:5}
#w-pepe:active{transform:scale(.9) rotate(-5deg)}
#w-phrase{position:absolute;bottom:clamp(100px,18vw,160px);left:10px;background:rgba(30,30,60,.95);border:2px solid #4ecca3;border-radius:12px;padding:10px 18px;color:#4ecca3;font-size:clamp(12px,1.5vw,16px);font-weight:600;opacity:0;transition:opacity .3s;z-index:5;max-width:250px;pointer-events:none}
#w-phrase.show{opacity:1}
#w-msg{font-size:clamp(14px,2.2vw,24px);text-align:center;color:#a0a0c0;max-width:80%;line-height:1.6;padding:0 20px}
#w-timer{font-size:clamp(24px,4vw,52px);font-weight:900;letter-spacing:4px;color:#fff;text-shadow:0 0 20px rgba(233,69,96,.4)}
#w-timer-sub{font-size:clamp(11px,1.4vw,16px);color:#7878a0;margin-top:-8px}
#w-play{padding:14px 50px;font-size:18px;font-weight:700;background:linear-gradient(135deg,#4ecca3,#39ffdc);color:#000;border:none;border-radius:50px;cursor:pointer;letter-spacing:1px;margin-top:10px}
#w-back{position:absolute;top:12px;left:12px;padding:6px 14px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:8px;color:#aaa;font-size:13px;cursor:pointer;z-index:5}
#S-dino{flex-direction:column;background:#1a1a2e;position:relative}
#d-hud{display:flex;align-items:center;justify-content:space-between;padding:8px 20px;background:#0a0a1e;flex-shrink:0;z-index:2}
#d-score{font-size:clamp(16px,2vw,24px);font-weight:700;color:#4ecca3}
#d-back{padding:6px 14px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:8px;color:#aaa;font-size:13px;cursor:pointer}
#d-area{flex:1;position:relative;overflow:hidden;cursor:pointer}
#d-canvas{width:100%;height:100%}
#d-over{position:absolute;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.7);gap:16px;z-index:5}
#d-over.on{display:flex}
@keyframes sansBob{0%,100%{transform:translateY(0) rotate(-3deg)}50%{transform:translateY(-8px) rotate(3deg)}}
#d-over h2{font-size:clamp(24px,4vw,44px);color:#e94560}
#d-over p{color:#7878a0;font-size:16px}
#S-game{flex-direction:column!important}
#g-top{flex:1;position:relative;overflow:hidden;background:#1a1a3e}
#g-bg{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;background-color:#1a1a3e}
#g-char{position:absolute;bottom:0;height:85%;max-width:40%;object-fit:contain;pointer-events:none;display:none}
#g-char.vis{display:block}#g-char.pl{left:3%}#g-char.pc{left:50%;transform:translateX(-50%)}#g-char.pr{right:3%;left:auto}
.bbk{position:absolute;top:8px;left:8px;z-index:5;padding:6px 14px;background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.2);border-radius:8px;color:#fff;font-size:13px;cursor:pointer}
#g-dlg{flex-shrink:0;background:#0a0a28;border-top:3px solid #e94560;padding:16px 28px 14px;min-height:130px;cursor:pointer;position:relative}
#g-name{display:inline-block;padding:4px 16px;background:#e94560;border-radius:6px;font-size:15px;font-weight:700;color:#fff;margin-bottom:6px}
#g-name:empty{display:none}
#g-txt{font-size:17px;line-height:1.7;color:#fff;white-space:pre-wrap;min-height:36px}
#g-ind{position:absolute;bottom:10px;right:18px;color:rgba(255,255,255,.4);font-size:13px;animation:bk 1.4s infinite}
@keyframes bk{0%,100%{opacity:1}50%{opacity:.2}}
#g-choices{position:absolute;top:0;left:0;right:0;bottom:0;z-index:20;display:none;flex-direction:column;align-items:center;justify-content:center;gap:12px;background:rgba(0,0,0,.6)}
#g-choices.on{display:flex}
.chb{padding:14px 44px;min-width:260px;max-width:80%;background:rgba(20,20,50,.95);border:2px solid #e94560;border-radius:12px;color:#fff;font-size:16px;cursor:pointer;text-align:center}
#g-end{position:absolute;top:0;left:0;right:0;bottom:0;z-index:25;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.88);gap:30px}
#g-end.on{display:flex}#g-end h2{font-size:36px;color:#e94560}
#S-boss{flex-direction:row!important;background:#0a0a1e;position:relative;overflow:hidden}
#bf-bg{position:absolute;inset:0;background:radial-gradient(ellipse at 30% 50%,#1a0a2e,#0a0a1e 70%);z-index:0}
#bf-opp{position:relative;z-index:1;width:28%;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding-bottom:10px}
#bf-opp img{max-height:80%;max-width:90%;object-fit:contain;filter:drop-shadow(0 0 20px rgba(57,255,220,.3));animation:bfBob .5s ease-in-out infinite}
@keyframes bfBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
#bf-opp .oname{color:#39ffdc;font-size:clamp(12px,1.5vw,18px);font-weight:700}
#bf-lanes{position:relative;z-index:1;flex:1;display:flex;align-items:stretch;justify-content:center}
#bf-canvas{width:100%;height:100%}
#bf-hud{position:absolute;top:0;left:0;right:0;z-index:10;display:flex;align-items:center;padding:8px 16px;gap:12px;background:linear-gradient(to bottom,rgba(0,0,0,.7),transparent)}
#bf-song-name{color:#39ffdc;font-size:clamp(11px,1.3vw,16px);font-weight:600;min-width:100px}
#bf-hbar{flex:1;height:20px;background:#1a1a3e;border-radius:10px;border:2px solid #333;overflow:hidden}
#bf-hfill{height:100%;width:50%;background:linear-gradient(90deg,#e94560,#4ecca3);border-radius:8px;transition:width .3s}
#bf-score-txt{font-size:clamp(14px,1.8vw,22px);font-weight:700;color:#fff;min-width:80px;text-align:right}
#bf-combo-txt{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(28px,4vw,56px);font-weight:900;color:#fff;opacity:0;z-index:5;pointer-events:none}
#bf-combo-txt.show{opacity:1;animation:bfPop .4s ease-out}
@keyframes bfPop{0%{transform:translate(-50%,-50%) scale(1.5);opacity:0}50%{opacity:1}100%{transform:translate(-50%,-50%) scale(1)}}
#bf-rating-txt{position:absolute;top:35%;left:50%;transform:translate(-50%,-50%);font-size:clamp(20px,3vw,40px);font-weight:900;opacity:0;z-index:5;pointer-events:none}
#bf-rating-txt.show{animation:bfRate .6s ease-out forwards}
@keyframes bfRate{0%{opacity:0;transform:translate(-50%,-50%) scale(2)}20%{opacity:1;transform:translate(-50%,-50%) scale(1)}80%{opacity:1}100%{opacity:0;transform:translate(-50%,-70%)}}
#bf-ctrl{position:absolute;bottom:0;left:0;right:0;z-index:10;display:flex;justify-content:center;gap:8px;padding:8px;background:linear-gradient(to top,rgba(0,0,0,.5),transparent)}
.bf-btn{width:clamp(50px,12vw,80px);height:clamp(50px,12vw,80px);border-radius:12px;border:3px solid;font-size:clamp(20px,3vw,32px);cursor:pointer;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.4)}
.bf-btn:active{transform:scale(.9)}
.bf-btn.l{border-color:#c24b99;color:#c24b99}.bf-btn.d{border-color:#00ffff;color:#00ffff}.bf-btn.u{border-color:#12fa05;color:#12fa05}.bf-btn.r{border-color:#f9393f;color:#f9393f}
#bf-countdown{position:absolute;inset:0;z-index:30;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8);font-size:clamp(60px,10vw,120px);font-weight:900;color:#fff}
#bf-countdown.on{display:flex}
#bf-result{position:absolute;inset:0;z-index:30;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.9);gap:20px}
#bf-result.on{display:flex}
#bf-result h2{font-size:clamp(28px,5vw,52px);font-weight:900}
#bf-result .stats{color:#7878a0;font-size:clamp(14px,2vw,20px);text-align:center;line-height:2}
.win{color:#4ecca3}.lose{color:#e94560}
/* SANS HELPER */
#ut-sans{
  position:fixed;
  z-index:9000;
  pointer-events:none;
  display:none;
  transition:none;
}
#ut-sans-body{
  font-size:48px;
  line-height:1;
  animation:sansFly 2s ease-in-out infinite;
  filter:drop-shadow(0 0 12px rgba(80,180,255,.7));
  text-shadow:0 0 15px rgba(100,200,255,.5);
}
@keyframes sansFly{
  0%,100%{transform:translateY(0) rotate(-5deg)}
  25%{transform:translateY(-6px) rotate(0deg)}
  50%{transform:translateY(-10px) rotate(5deg)}
  75%{transform:translateY(-4px) rotate(2deg)}
}
#ut-sans-txt{
  position:absolute;
  top:-32px;left:50%;transform:translateX(-50%);
  white-space:nowrap;
  font-family:'Courier New',monospace;
  font-size:13px;color:#64b5f6;
  opacity:0;transition:opacity .3s;
  background:rgba(0,0,20,.9);
  padding:4px 12px;border-radius:8px;
  border:1px solid #42a5f5;
  text-shadow:0 0 5px #42a5f5;
}
#ut-sans-txt.show{opacity:1}
  
/* ‚ïê‚ïê‚ïê UNDERTALE BOSS ‚ïê‚ïê‚ïê */
#S-ut{flex-direction:column!important;background:#000;position:relative;overflow:hidden}
#ut-top{display:flex;align-items:flex-start;justify-content:center;padding:12px 20px;flex-shrink:0;height:30%;position:relative}
#ut-opp{display:flex;flex-direction:column;align-items:center;gap:4px;position:relative}
#ut-opp img{max-height:100%;max-width:180px;object-fit:contain;image-rendering:pixelated;filter:drop-shadow(0 0 8px rgba(255,255,255,.2))}
#ut-opp-name{color:#fff;font-size:clamp(12px,1.6vw,18px);font-weight:700;font-family:'Courier New',monospace}
#ut-boss-hpbar{width:clamp(100px,15vw,180px);height:8px;background:#333;border:1px solid #555;border-radius:4px;overflow:hidden;margin-top:2px}
#ut-boss-hpfill{height:100%;background:#4ecca3;transition:width .3s;width:100%}
/* Dialogue bubble –±–ª–∏–∂–µ –∫ –±–æ—Å—Å—É */
#ut-dlg{position:absolute;right:5%;top:35%;transform:translateY(-50%);background:#000;border:3px solid #fff;border-radius:12px;padding:14px 20px;color:#fff;font-family:'Courier New',monospace;font-size:clamp(13px,1.6vw,18px);max-width:50%;min-width:180px;display:none;line-height:1.5;z-index:15}
#ut-dlg.show{display:block}
#ut-dlg::before{content:'';position:absolute;left:-12px;top:50%;transform:translateY(-50%);border:6px solid transparent;border-right-color:#fff}
#ut-mid{flex:1;display:flex;align-items:center;justify-content:center;position:relative}
#ut-box{position:relative;border:3px solid #fff;background:#000;overflow:hidden}
#ut-heart{position:absolute;width:18px;height:18px;z-index:5;transition:none}
#ut-heart::before{content:'‚ù§';color:#ff0000;font-size:16px;line-height:18px;display:block;text-align:center}
.ut-proj{position:absolute;border-radius:50%;z-index:3}
.ut-bone{position:absolute;background:#fff;z-index:3;border-radius:2px}
.ut-bone-blue{background:#00cfff!important;box-shadow:0 0 8px rgba(0,207,255,.6);animation:utBPulse .6s ease-in-out infinite}
/* Blue/Orange bone glow */
.ut-bone[style*="background: rgb(66, 165, 245)"]{animation:utBluePulse 0.8s ease-in-out infinite}
@keyframes utBluePulse{0%,100%{box-shadow:0 0 6px #42a5f5}50%{box-shadow:0 0 14px #42a5f5,0 0 20px rgba(66,165,245,.4)}}
.ut-bone-orange{background:#ff8c00!important;box-shadow:0 0 8px rgba(255,140,0,.6);animation:utOPulse .5s ease-in-out infinite}
/* Legend for bone colors */
#ut-legend{position:absolute;bottom:2px;right:8px;font-family:'Courier New',monospace;font-size:10px;color:#666;z-index:10;display:flex;gap:10px}
#ut-legend span{display:flex;align-items:center;gap:3px}
#ut-legend .lb{width:10px;height:10px;border-radius:2px}
@keyframes utBPulse{0%,100%{opacity:1;box-shadow:0 0 8px rgba(0,207,255,.6)}50%{opacity:.75;box-shadow:0 0 14px rgba(0,207,255,.9)}}
@keyframes utOPulse{0%,100%{opacity:1;box-shadow:0 0 8px rgba(255,140,0,.6)}50%{opacity:.8;box-shadow:0 0 14px rgba(255,140,0,.9)}}
.ut-beam{position:absolute;z-index:4;opacity:0}
.ut-beam.warn{opacity:.3;background:repeating-linear-gradient(45deg,rgba(255,255,255,.2),rgba(255,255,255,.2) 4px,transparent 4px,transparent 8px)}
.ut-beam.fire{opacity:1;background:#fff}
.ut-rock{position:absolute;width:10px;height:10px;background:#a08060;border-radius:3px;z-index:3;box-shadow:0 0 4px rgba(160,128,96,.6)}
.ut-trail{position:absolute;width:14px;height:14px;z-index:4;pointer-events:none;opacity:.25;font-size:12px;line-height:14px;text-align:center;color:#f00}
#ut-sans{position:absolute;z-index:8;width:32px;height:32px;pointer-events:none;font-size:26px;line-height:32px;text-align:center;filter:drop-shadow(0 0 10px rgba(50,130,255,.5));opacity:0;transition:opacity .6s}
#ut-sans.show{opacity:1}
#ut-sans-txt{position:absolute;z-index:9;background:rgba(0,0,30,.95);border:2px solid #4169e1;border-radius:8px;padding:3px 10px;color:#64b5f6;font-family:'Courier New',monospace;font-size:clamp(10px,1.2vw,13px);white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .3s}
#ut-sans-txt.show{opacity:1}
#ut-hint{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.92);border-radius:8px;padding:5px 14px;font-family:'Courier New',monospace;font-size:clamp(11px,1.3vw,14px);font-weight:700;z-index:12;pointer-events:none;opacity:0;transition:opacity .4s;white-space:nowrap}
#ut-hint.show{opacity:1}
#ut-hint.blue{border:2px solid #00cfff;color:#00cfff}
#ut-hint.orange{border:2px solid #ff8c00;color:#ff8c00}
#ut-bot{flex-shrink:0;padding:10px 20px;background:#000}
#ut-hp{display:flex;align-items:center;gap:10px;margin-bottom:10px;font-family:'Courier New',monospace}
#ut-hp-label{color:#fff;font-size:clamp(12px,1.4vw,16px);font-weight:700}
#ut-hp-bar{flex:1;max-width:250px;height:22px;background:#300;border:2px solid #600;position:relative}
#ut-hp-fill{height:100%;background:#ff0;transition:width .3s}
#ut-hp-txt{color:#fff;font-size:clamp(11px,1.3vw,15px);font-family:'Courier New',monospace;min-width:60px}
#ut-actions{display:flex;justify-content:center;gap:clamp(8px,2vw,20px)}
.ut-act{padding:clamp(8px,1.5vw,14px) clamp(16px,3vw,36px);background:#000;border:3px solid #f90;color:#f90;font-family:'Courier New',monospace;font-size:clamp(13px,1.6vw,20px);font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:1px;position:relative;transition:background .15s,color .15s}
.ut-act.fight{border-color:#f00;color:#f00}.ut-act.fight:hover,.ut-act.fight.sel{background:#f00;color:#fff}
.ut-act.act{border-color:#f90;color:#f90}.ut-act.act:hover,.ut-act.act.sel{background:#f90;color:#000}
.ut-act.item{border-color:#0f0;color:#0f0}.ut-act.item:hover,.ut-act.item.sel{background:#0f0;color:#000}
.ut-act.mercy{border-color:#ff0;color:#ff0}.ut-act.mercy:hover,.ut-act.mercy.sel{background:#ff0;color:#000}
#ut-sub{display:none;justify-content:center;gap:clamp(6px,1.5vw,16px);margin-top:8px;flex-wrap:wrap}
#ut-sub.show{display:flex}
.ut-sub-btn{padding:6px 18px;background:#000;border:2px solid #fff;color:#fff;font-family:'Courier New',monospace;font-size:clamp(12px,1.4vw,16px);cursor:pointer;transition:background .15s}
.ut-sub-btn:hover{background:#fff;color:#000}
#ut-atk-bar{display:none;margin-top:10px;position:relative;height:30px;background:#000;border:2px solid #fff;overflow:hidden}
#ut-atk-bar.show{display:block}
#ut-atk-cursor{position:absolute;top:0;width:4px;height:100%;background:#0f0}
#ut-atk-zone{position:absolute;top:0;height:100%;background:rgba(255,255,255,.15);border-left:2px solid #fff;border-right:2px solid #fff}
#ut-result{position:absolute;inset:0;z-index:30;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.95);gap:20px}
#ut-result.on{display:flex}
#ut-result h2{font-size:clamp(28px,5vw,52px);font-weight:900;font-family:'Courier New',monospace}
#ut-result .stats{color:#7878a0;font-size:clamp(14px,2vw,20px);text-align:center;line-height:2;font-family:'Courier New',monospace}
.ut-bbk{position:absolute;top:8px;left:8px;z-index:30;padding:6px 14px;background:rgba(0,0,0,.8);border:1px solid rgba(255,255,255,.3);border-radius:8px;color:#fff;font-size:13px;cursor:pointer}
#ut-turn-txt{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(16px,2.5vw,28px);font-weight:900;color:#fff;font-family:'Courier New',monospace;opacity:0;z-index:10;pointer-events:none}
#ut-turn-txt.show{opacity:1;animation:utFade 1.2s ease-out forwards}
@keyframes utFade{0%{opacity:0;transform:translate(-50%,-50%) scale(1.5)}15%{opacity:1;transform:translate(-50%,-50%) scale(1)}75%{opacity:1}100%{opacity:0}}
#ut-dmg{position:absolute;z-index:10;font-size:clamp(20px,3vw,36px);font-weight:900;font-family:'Courier New',monospace;pointer-events:none;opacity:0}
#ut-dmg.show{animation:utDmg .8s ease-out forwards}
@keyframes utDmg{0%{opacity:0;transform:translateY(0)}20%{opacity:1}100%{opacity:0;transform:translateY(-40px)}}
@keyframes utShake{0%,100%{transform:translate(0)}25%{transform:translate(-3px,2px)}50%{transform:translate(3px,-2px)}75%{transform:translate(-2px,-3px)}}
/* ‚ïê‚ïê‚ïê UT PHASES ‚ïê‚ïê‚ïê */
#ut-phase-indicator{position:absolute;top:8px;right:8px;font-family:'Courier New',monospace;font-size:12px;color:#666;z-index:20}
.ut-phase2 #ut-opp-img{filter:drop-shadow(0 0 12px rgba(255,50,50,.6)) hue-rotate(20deg)!important}
.ut-phase3 #ut-opp-img{filter:drop-shadow(0 0 16px rgba(200,0,255,.7)) hue-rotate(60deg) brightness(1.2)!important}
.ut-phase4 #ut-opp-img{filter:drop-shadow(0 0 20px rgba(255,0,0,.9)) saturate(2) brightness(1.4)!important;animation:utP4pulse 0.5s ease-in-out infinite!important}
@keyframes utP4pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
#ut-dlg{position:absolute;left:50%;bottom:2%;transform:translateX(-50%);right:auto;top:auto;background:#000;border:3px solid #fff;border-radius:12px;padding:10px 18px;color:#fff;font-family:'Courier New',monospace;font-size:clamp(12px,1.4vw,16px);max-width:70%;min-width:180px;display:none;line-height:1.4;z-index:15;text-align:center}
#ut-dlg.show{display:block}
#ut-dlg::before{display:none}
@keyframes sansFly{0%,100%{transform:translateY(0) rotate(-5deg)}25%{transform:translateY(-6px) rotate(0)}50%{transform:translateY(-10px) rotate(5deg)}75%{transform:translateY(-4px) rotate(2deg)}}
@keyframes papFly{0%,100%{transform:translateY(0) rotate(3deg)}50%{transform:translateY(-8px) rotate(-3deg)}}
/* Totem */
#ut-totem-overlay{position:fixed;inset:0;z-index:100000;display:none;align-items:center;justify-content:center;flex-direction:column;gap:20px;background:rgba(0,0,0,.9)}
#ut-totem-overlay.on{display:flex}
#ut-totem-skull{font-size:80px;filter:drop-shadow(0 0 30px gold);animation:totemGlow 1s ease-in-out infinite}
@keyframes totemGlow{0%,100%{filter:drop-shadow(0 0 30px gold) brightness(1)}50%{filter:drop-shadow(0 0 60px gold) brightness(1.5)}}
#ut-totem-text{font-family:'Courier New',monospace;font-size:20px;color:gold;text-shadow:0 0 15px gold}
#ut-totem-rays{position:absolute;width:300px;height:300px;background:radial-gradient(circle,rgba(255,215,0,.3) 0%,transparent 70%);border-radius:50%;animation:totemRays 1s ease-out forwards}
@keyframes totemRays{0%{transform:scale(0);opacity:1}100%{transform:scale(4);opacity:0}}
/* Sword */
.ut-sword{position:absolute;font-size:28px;z-index:6;pointer-events:none;filter:drop-shadow(0 0 8px rgba(255,100,100,.6));transition:none}
/* Gun */
.ut-gun{position:absolute;font-size:24px;z-index:6;pointer-events:none;filter:drop-shadow(0 0 8px rgba(255,200,0,.6))}
.ut-bullet{position:absolute;width:6px;height:6px;background:#ff0;border-radius:50%;z-index:5}
/* Laser bone */
.ut-laser{position:absolute;width:20px;height:20px;z-index:6;border-radius:3px;transition:background .3s,box-shadow .3s}
.ut-laser.blue{background:#42a5f5;box-shadow:0 0 12px #42a5f5}
.ut-laser.orange{background:#ffa726;box-shadow:0 0 12px #ffa726}
/* Bombs */
.ut-bomb-warn{position:absolute;border-radius:50%;border:2px dashed rgba(255,0,0,.5);z-index:4;animation:bombWarn .5s ease-in-out infinite}
@keyframes bombWarn{0%,100%{opacity:.3}50%{opacity:.8}}
.ut-bomb-explode{position:absolute;border-radius:50%;background:rgba(255,50,0,.7);z-index:4;animation:bombExpl .3s ease-out}
@keyframes bombExpl{0%{transform:scale(0);opacity:1}100%{transform:scale(1);opacity:.7}}
/* Honeycomb */
.ut-hc-cell{position:absolute;z-index:4;border:1px solid rgba(255,255,255,.2);transition:background .3s,opacity .3s}
.ut-hc-cell.safe{background:rgba(78,204,163,.15)}
.ut-hc-cell.warn{background:rgba(255,0,0,.3);animation:hcWarn .3s infinite}
.ut-hc-cell.fall{background:rgba(255,0,0,.6);opacity:0}
.ut-hc-cell.visited{background:rgba(78,204,163,.3);border-color:#4ecca3}
@keyframes hcWarn{0%,100%{opacity:.3}50%{opacity:.7}}
/* Knife */
.ut-knife{position:absolute;width:4px;height:18px;background:linear-gradient(to bottom,#fff,#ccc);z-index:5;border-radius:1px}
.ut-knife.up{transform:rotate(180deg)}
/* Phase transition overlay */
#ut-phase-overlay{position:absolute;inset:0;z-index:20;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.85);font-family:'Courier New',monospace;font-size:clamp(20px,3vw,36px);color:#fff;font-weight:900}
#ut-phase-overlay.on{display:flex}
/* Reverse mode indicator */
.ut-reverse-hint{position:absolute;bottom:5px;left:50%;transform:translateX(-50%);font-family:'Courier New',monospace;font-size:11px;color:#ff0;z-index:10;animation:bk 1s infinite}

/* DEV */
#S-dev{flex-direction:column;background:#0b0b1a}
.dh{display:flex;align-items:center;padding:10px 18px;background:#161630;border-bottom:1px solid #2a2a50;gap:14px;flex-shrink:0}.dh h1{font-size:17px;flex:1}
.dtabs{display:flex;background:#161630;border-bottom:1px solid #2a2a50;flex-shrink:0;overflow-x:auto}
.dt{padding:11px 20px;font-size:13px;color:#7878a0;cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap}.dt.on{color:#e94560;border-bottom-color:#e94560}
.dc{flex:1;overflow-y:auto;padding:20px}
.dgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:15px}
.dcard{background:#161630;border:1px solid #2a2a50;border-radius:12px;overflow:hidden;cursor:pointer}
.dcimg{width:100%;height:115px;background:#101028;background-size:cover;background-position:center}
.dcinf{padding:11px}.dcn{font-size:14px;font-weight:600;margin-bottom:3px}.dcs{font-size:12px;color:#7878a0}
.dcadd{display:flex;align-items:center;justify-content:center;min-height:165px;border-style:dashed;flex-direction:column;gap:8px}
.dcadd .ico{font-size:34px;color:#7878a0}.dcadd span{font-size:13px;color:#7878a0}
.dcard.start{border-color:#4ecca3}.dcard.start .dcs{color:#4ecca3}
.steps{display:flex;flex-direction:column;gap:12px;margin-top:10px}
.si{background:#101028;border:1px solid #2a2a50;border-radius:10px;padding:14px}
.sih{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.sin{font-size:12px;color:#e94560;font-weight:700}.sia{display:flex;gap:5px}
.sia button{width:27px;height:27px;background:rgba(255,255,255,.07);border:1px solid #2a2a50;border-radius:6px;color:#7878a0;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.sf{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.sf .fw{grid-column:1/-1}
.sf label{font-size:11px;color:#7878a0;margin-bottom:4px;display:block}
.sf input,.sf textarea,.sf select{width:100%;padding:8px 10px;background:#0b0b1a;border:1px solid #2a2a50;border-radius:6px;color:#eaeaea;font-size:13px;outline:0;font-family:inherit}
.sf textarea{min-height:48px;resize:vertical}
.csec{margin-top:10px;padding-top:10px;border-top:1px solid #2a2a50}
.crow{display:flex;gap:7px;margin-bottom:8px;align-items:center}.crow input{flex:1}.crow select{width:130px}
.crow input,.crow select{padding:7px 9px;background:#0b0b1a;border:1px solid #2a2a50;border-radius:6px;color:#eaeaea;font-size:12px;outline:0}
.crow button{width:27px;height:27px;background:rgba(233,69,96,.15);border:1px solid #e94560;border-radius:6px;color:#e94560;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.cbtog{display:flex;align-items:center;gap:8px;margin-top:10px}
.cbtog input[type=checkbox]{width:17px;height:17px;accent-color:#e94560}
.cbtog label{font-size:13px;margin:0;cursor:pointer}
.bsm{padding:5px 13px;background:rgba(255,255,255,.07);border:1px solid #2a2a50;border-radius:6px;color:#7878a0;font-size:12px;cursor:pointer;margin-top:6px}
.setsec{background:#161630;border:1px solid #2a2a50;border-radius:12px;padding:20px;margin-bottom:16px}.setsec h3{font-size:16px;margin-bottom:12px}
.bfsec{background:rgba(57,255,220,.05);border:1px solid rgba(57,255,220,.2);border-radius:10px;padding:14px;margin-top:12px}.bfsec h4{color:#39ffdc;font-size:13px;margin-bottom:10px}
.audio-info{display:flex;align-items:center;gap:10px;margin-top:8px;padding:8px 12px;background:rgba(57,255,220,.08);border-radius:8px;font-size:13px;color:#39ffdc}
.audio-info .ai-name{flex:1}
.audio-info button{padding:4px 12px;background:rgba(255,255,255,.1);border:1px solid #2a2a50;border-radius:6px;color:#eaeaea;font-size:12px;cursor:pointer}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
.modal.on{display:flex}
.mbox{background:#161630;border:1px solid #2a2a50;border-radius:16px;padding:28px;min-width:300px;max-width:92vw;max-height:90vh;overflow-y:auto}
.mbox h2{margin-bottom:18px;font-size:19px;display:flex;align-items:center;justify-content:space-between}
.mx{background:0;border:0;color:#7878a0;font-size:22px;cursor:pointer}
.mlg{width:90vw;max-width:820px}
.fg{margin-bottom:15px}
.fg label{display:block;font-size:11px;color:#7878a0;margin-bottom:5px;font-weight:600;text-transform:uppercase;letter-spacing:.8px}
.fg input,.fg textarea,.fg select{width:100%;padding:10px 13px;background:#101028;border:1px solid #2a2a50;border-radius:8px;color:#eaeaea;font-size:14px;outline:0;font-family:inherit}
.fg textarea{min-height:60px;resize:vertical}
.ipv{width:100%;max-height:130px;object-fit:contain;border-radius:8px;margin-top:8px;background:#101028}
.fbtn{display:inline-block;padding:8px 20px;background:rgba(255,255,255,.08);border:1px solid #2a2a50;border-radius:8px;color:#eaeaea;font-size:14px;cursor:pointer}
.bp{padding:10px 24px;background:#e94560;color:#fff;border:0;border-radius:8px;font-size:14px;cursor:pointer}
.bs{padding:10px 24px;background:rgba(255,255,255,.08);color:#eaeaea;border:1px solid #2a2a50;border-radius:8px;font-size:14px;cursor:pointer}
.bd{padding:10px 24px;background:0;color:#e94560;border:1px solid #e94560;border-radius:8px;font-size:14px;cursor:pointer}
.brow{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.err-msg{color:#e94560;font-size:13px}
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(100px);padding:14px 28px;border-radius:10px;font-size:15px;font-weight:600;z-index:5000;transition:transform .3s;pointer-events:none;max-width:90vw;text-align:center}
#toast.show{transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
<div id="rotate"><div class="ri">üì±</div><p>–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ</p></div>
<div id="loader"><div class="spinner"></div><div style="color:#7878a0;font-size:15px">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></div>
<div id="app">
<div id="S-menu" class="scr on">
  <button class="bgear" onclick="openCode()">üîß</button>
  <h1 id="m-title">–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ</h1>
  <div id="menu-status"></div>
  <button class="bplay" id="btn-play" onclick="startGame()">–ò–≥—Ä–∞—Ç—å</button>
</div>
<div id="S-wait" class="scr">
  <button id="w-back" onclick="scr('S-menu')">‚Üê –ù–∞–∑–∞–¥</button>
  <img id="w-pepe" src="https://i.postimg.cc/d019wCRm/1645078923-3-abrakadabra-fun-p-malenkii-lyagushonok-pepe-10-removebg-preview.png" alt="" onclick="pepeTap()">
  <div id="w-phrase"></div>
  <div id="w-msg">–û—É, –ø–æ—Ö–æ–∂–µ –ù–µ–π—Ä–æ–Ω–∫–∞ –∏–≥—Ä–∞–µ—Ç —Å –∫–æ—à–∫–æ–π!<br>–í—ã –≤–µ–¥—å –Ω–µ —Å—Ç–∞–Ω–µ—Ç–µ –µ–º—É –º–µ—à–∞—Ç—å?..</div>
  <div id="w-timer">--:--:--</div>
  <div id="w-timer-sub">–¥–æ –∑–∞–ø—É—Å–∫–∞</div>
  <button id="w-play" onclick="startDino()">üéÆ –ò–≥—Ä–∞—Ç—å</button>
</div>
<div id="S-dino" class="scr">
  <div id="d-hud"><div id="d-score">–°—á—ë—Ç: 0</div><button id="d-back" onclick="stopDino();scr('S-wait')">‚Üê –ù–∞–∑–∞–¥</button></div>
  <div id="d-area" onclick="dinoJump()" ontouchstart="dinoJump()"><canvas id="d-canvas"></canvas><div id="d-over"><h2>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2><p id="d-final"></p><button class="bplay" onclick="startDinoGame()" style="font-size:16px;padding:12px 40px">–ï—â—ë —Ä–∞–∑</button></div></div>
</div>
<div id="S-game" class="scr">
  <div id="g-top"><div id="g-bg"></div><img id="g-char" src="" alt=""><button class="bbk" onclick="toMenu()">‚Üê –ú–µ–Ω—é</button></div>
  <div id="g-dlg" onclick="advance()"><div id="g-name"></div><div id="g-txt"></div><div id="g-ind">‚ñº</div></div>
  <div id="g-choices"></div>
  <div id="g-end"><h2>–ö–æ–Ω–µ—Ü</h2><button class="bplay" onclick="toMenu()" style="font-size:16px;padding:12px 44px">–í –º–µ–Ω—é</button></div>
</div>
<div id="S-boss" class="scr">
  <div id="bf-bg"></div>
  <div id="bf-opp"><img id="bf-opp-img" src="" alt=""><div class="oname" id="bf-opp-name"></div></div>
  <div id="bf-lanes"><canvas id="bf-canvas"></canvas></div>
  <div id="bf-hud"><div id="bf-song-name"></div><div id="bf-hbar"><div id="bf-hfill"></div></div><div id="bf-score-txt">0</div></div>
  <div id="bf-combo-txt"></div><div id="bf-rating-txt"></div>
  <div id="bf-ctrl"><button class="bf-btn l" onpointerdown="bfHit(0)">‚Üê</button><button class="bf-btn d" onpointerdown="bfHit(1)">‚Üì</button><button class="bf-btn u" onpointerdown="bfHit(2)">‚Üë</button><button class="bf-btn r" onpointerdown="bfHit(3)">‚Üí</button></div>
  <div id="bf-countdown"></div>
  <div id="bf-result"><h2 id="bf-res-title"></h2><div class="stats" id="bf-res-stats"></div><button class="bplay" id="bf-res-btn" style="font-size:16px;padding:12px 44px"></button></div>
</div>

<div id="S-ut" class="scr">
  <button class="ut-bbk" onclick="utStop();toMenu()">‚Üê –ú–µ–Ω—é</button>
  <div id="ut-phase-indicator"></div>
  <div id="ut-top">
    <div id="ut-opp">
      <img id="ut-opp-img" src="" alt="">
      <div id="ut-opp-name"></div>
    </div>
    <div id="ut-dlg"></div>
  </div>
  <div id="ut-mid">
    <div id="ut-box">
      <div id="ut-heart"></div>
    </div>
    <div id="ut-turn-txt"></div>
    <div id="ut-dmg"></div>
    <div id="ut-phase-overlay"></div>
  </div>
  <div id="ut-bot">
    <div id="ut-hp">
      <span id="ut-hp-label">HP</span>
      <div id="ut-hp-bar"><div id="ut-hp-fill"></div></div>
      <span id="ut-hp-txt">92 / 92</span>
    </div>
    <div id="ut-actions">
      <button class="ut-act fight" onclick="utAction('fight')">‚öî Fight</button>
    </div>
    <div id="ut-atk-bar"><div id="ut-atk-zone"></div><div id="ut-atk-cursor"></div></div>
  </div>
  <div id="ut-result">
    <h2 id="ut-res-title"></h2>
    <div class="stats" id="ut-res-stats"></div>
    <button class="bplay" id="ut-res-btn" style="font-size:16px;padding:12px 44px;font-family:'Courier New',monospace"></button>
  </div>
</div>
<div id="ut-totem-overlay"><div id="ut-totem-rays"></div><div id="ut-totem-skull">üíÄ</div><div id="ut-totem-text"></div></div>

<!-- SANS –≤–Ω–µ S-ut —á—Ç–æ–±—ã overflow:hidden –Ω–µ –æ–±—Ä–µ–∑–∞–ª -->
<div id="ut-sans">
  <div id="ut-sans-body">üíÄ</div>
  <div id="ut-sans-txt"></div>
</div>
  
<div id="S-dev" class="scr">
  <div class="dh"><button class="bs" onclick="toMenu()" style="padding:7px 14px;font-size:13px">‚Üê –ù–∞–∑–∞–¥</button><h1>–ü–∞–Ω–µ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</h1></div>
  <div class="dtabs"><div class="dt on" onclick="dTab('bg',this)">üñº –§–æ–Ω—ã</div><div class="dt" onclick="dTab('ch',this)">üë§ –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</div><div class="dt" onclick="dTab('sc',this)">üìú –°—Ü–µ–Ω—ã</div><div class="dt" onclick="dTab('set',this)">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div></div>
  <div class="dc" id="dc"></div>
</div>
</div>
<div class="modal" id="M-code"><div class="mbox"><h2>–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞</h2><div class="fg"><label for="i-code">–ö–æ–¥</label><input type="password" id="i-code" name="code" maxlength="10"></div><div class="err-msg" id="code-err" style="display:none">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥</div><div class="brow"><button class="bp" onclick="checkCode()">–í–æ–π—Ç–∏</button><button class="bs" onclick="hideM('M-code')">–û—Ç–º–µ–Ω–∞</button></div></div></div>
<div class="modal" id="M-bg"><div class="mbox mlg"><h2><span id="bg-t">–§–æ–Ω</span><button class="mx" onclick="hideM('M-bg')">‚úï</button></h2><div class="fg"><label for="bg-name">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="bg-name" name="bg-name"></div><div class="fg"><label for="bg-file">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label><label class="fbtn">üìÅ<input type="file" accept="image/*" id="bg-file" name="bg-file" style="display:none" onchange="pvF(this,'bg-pv',1920,1080,false,'_bgD')"></label><img id="bg-pv" class="ipv" style="display:none" alt=""></div><div class="brow"><button class="bp" onclick="saveBg()">OK</button><button class="bd" id="bg-del" style="display:none" onclick="delBg()">–£–¥–∞–ª–∏—Ç—å</button></div></div></div>
<div class="modal" id="M-ch"><div class="mbox mlg"><h2><span id="ch-t">–ü–µ—Ä—Å–æ–Ω–∞–∂</span><button class="mx" onclick="hideM('M-ch')">‚úï</button></h2><div class="fg"><label for="ch-name">–ò–º—è</label><input id="ch-name" name="ch-name"></div><div class="fg"><label for="ch-file">–°–ø—Ä–∞–π—Ç</label><label class="fbtn">üìÅ<input type="file" accept="image/*" id="ch-file" name="ch-file" style="display:none" onchange="pvF(this,'ch-pv',600,900,true,'_chD')"></label><img id="ch-pv" class="ipv" style="display:none" alt=""></div><div class="brow"><button class="bp" onclick="saveCh()">OK</button><button class="bd" id="ch-del" style="display:none" onclick="delCh()">–£–¥–∞–ª–∏—Ç—å</button></div></div></div>
<div class="modal" id="M-sc"><div class="mbox mlg" style="max-height:88vh"><h2><span id="sc-t">–°—Ü–µ–Ω–∞</span><button class="mx" onclick="hideM('M-sc')">‚úï</button></h2><div id="sc-ed"></div></div></div>
<div id="toast"></div>

<script>
var CODE='050412',isAdmin=false;
var TARGET=new Date('2026-03-01T00:00:00+03:00').getTime();
var D={title:'–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ',bgs:[],chars:[],scenes:[],start:null};
var curTab='bg',editId=null,eScData=null;
window._bgD=null;window._chD=null;
var G={sid:null,step:0,typing:false,timer:null,full:''};

function $(id){return document.getElementById(id)}
function uid(){return'i'+Date.now()+'_'+Math.random().toString(36).substr(2,6)}
function esc(s){if(!s)return'';var d=document.createElement('div');d.textContent=s;return d.innerHTML}
function api(m,b){var o={method:m,headers:{'Content-Type':'application/json'}};if(b)o.body=JSON.stringify(b);return fetch('/api/data',o).then(function(r){return r.json()}).catch(function(){return null})}
function loadData(){return api('GET').then(function(d){if(d){D=d;D.title=D.title||'–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ';D.bgs=D.bgs||[];D.chars=D.chars||[];D.scenes=D.scenes||[];return true}return false})}
function save(){return api('POST',D).then(function(ok){if(!ok)toast('–û—à–∏–±–∫–∞!',1);return!!ok})}
function scr(id){var a=document.querySelectorAll('.scr');for(var i=0;i<a.length;i++)a[i].classList.remove('on');$(id).classList.add('on')}
function showM(id){$(id).classList.add('on')}
function hideM(id){$(id).classList.remove('on')}
function toast(m,e){var t=$('toast');t.textContent=m;t.style.background=e?'#e94560':'#4ecca3';t.style.color=e?'#fff':'#000';t.classList.add('show');setTimeout(function(){t.classList.remove('show')},4000)}
function updateMenu(){$('m-title').textContent=D.title||'–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ';var ss=D.start?D.scenes.find(function(s){return s.id===D.start}):null;var st=$('menu-status'),btn=$('btn-play');if(!D.scenes.length){st.innerHTML='<div class="st-no">‚ùå –ü—É—Å—Ç–æ</div>';btn.disabled=true}else if(!ss){st.innerHTML='<div class="st-no">‚ö†Ô∏è –ù–µ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–π</div>';btn.disabled=true}else if(!ss.steps||!ss.steps.length){st.innerHTML='<div class="st-no">‚ö†Ô∏è –ü—É—Å—Ç–∞</div>';btn.disabled=true}else{st.innerHTML='<div class="st-ok">‚úÖ '+D.scenes.length+' —Å—Ü–µ–Ω</div>';btn.disabled=false}}
function openCode(){$('i-code').value='';$('code-err').style.display='none';showM('M-code');$('i-code').focus()}
$('i-code').addEventListener('keydown',function(e){if(e.key==='Enter')checkCode()});
function checkCode(){if($('i-code').value!==CODE){$('code-err').style.display='block';return}hideM('M-code');isAdmin=true;loadData().then(function(){updateMenu();scr('S-dev');renderTab()})}
function toMenu(){stopTyping();bfStop();utStop();stopDino();scr('S-menu');updateMenu()}
function readFile(f){return new Promise(function(r){var x=new FileReader;x.onload=function(e){r(e.target.result)};x.readAsDataURL(f)})}
function resize(u,mw,mh,p){return new Promise(function(r){var i=new Image;i.onload=function(){var w=i.width,h=i.height;if(w>mw||h>mh){var k=Math.min(mw/w,mh/h);w=Math.round(w*k);h=Math.round(h*k)}var c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(i,0,0,w,h);r(p?c.toDataURL('image/png'):c.toDataURL('image/jpeg',.72))};i.src=u})}
function pvF(inp,pvId,mw,mh,p,v){if(!inp.files[0])return;readFile(inp.files[0]).then(function(raw){return resize(raw,mw,mh,p)}).then(function(d){window[v]=d;$(pvId).src=d;$(pvId).style.display='block'})}

/* ‚ïê‚ïê‚ïê WAIT ROOM ‚ïê‚ïê‚ïê */
var PEPE_PHRASES=['–ù–µ –º–µ—à–∞–π!','–°–∫–æ—Ä–æ –Ω–∞—á–Ω—É —Ä–∞–±–æ—Ç–∞—Ç—å!','–û—Ç—Å—Ç–∞–Ω—å!','–Ø –∑–∞–Ω—è—Ç!','–ú—è—É... —Ç–æ –µ—Å—Ç—å –∫—ã—à!','–ü–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ!','–ù–µ–π—Ä–æ–Ω–∫–∞ –Ω–µ –≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏!','–ü—Ñ—Ñ...','–ï—â—ë —á—É—Ç—å-—á—É—Ç—å...','–ö—ã—à –æ—Ç—Å—é–¥–∞!','–î–∞–π –ø–æ—Å–ø–∞—Ç—å...','–ö–≤–∞... –≤ —Å–º—ã—Å–ª–µ —É–π–¥–∏!','–ù–µ —Å–µ–π—á–∞—Å!','–ß–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç–æ—á–µ–∫...'];
var phraseTimer=null;
function pepeTap(){var el=$('w-phrase');el.textContent=PEPE_PHRASES[Math.floor(Math.random()*PEPE_PHRASES.length)];el.classList.add('show');if(phraseTimer)clearTimeout(phraseTimer);phraseTimer=setTimeout(function(){el.classList.remove('show')},2500)}
function showWaitRoom(){scr('S-wait');updateWaitTimer()}
var waitTimerIv=null;
function updateWaitTimer(){if(waitTimerIv)clearInterval(waitTimerIv);function tick(){var left=TARGET-Date.now();if(left<=0){$('w-timer').textContent='üéâ –ì–û–¢–û–í–û!';$('w-timer-sub').textContent='';return}var d=Math.floor(left/86400000);var h=Math.floor(left%86400000/3600000);var m=Math.floor(left%3600000/60000);var s=Math.floor(left%60000/1000);$('w-timer').textContent=d+'–¥ '+h+'—á '+m+'–º '+s+'—Å'}tick();waitTimerIv=setInterval(tick,1000)}

/* ‚ïê‚ïê‚ïê DINO ‚ïê‚ïê‚ïê */
var DG={active:false,raf:null,score:0,speed:5,ground:0,char:{x:80,y:0,vy:0,w:50,h:60,jumping:false},obs:[],nextObs:0,img:null,imgLoaded:false};
function startDino(){scr('S-dino');$('d-over').classList.remove('on');if(!DG.img){DG.img=new Image();DG.img.crossOrigin='anonymous';DG.img.onload=function(){DG.imgLoaded=true;startDinoGame()};DG.img.onerror=function(){DG.imgLoaded=false;startDinoGame()};DG.img.src='https://i.postimg.cc/qRrM2smW/c4e045949489d91e9b3eecd95313cd65-removebg-preview.png'}else startDinoGame()}
function startDinoGame(){$('d-over').classList.remove('on');var cv=$('d-canvas');var area=$('d-area');var rect=area.getBoundingClientRect();cv.width=rect.width*2;cv.height=rect.height*2;cv.style.width=rect.width+'px';cv.style.height=rect.height+'px';DG.ground=rect.height-40;DG.score=0;DG.speed=5;DG.obs=[];DG.nextObs=120;DG.char.y=DG.ground-DG.char.h;DG.char.vy=0;DG.char.jumping=false;DG.active=true;$('d-score').textContent='–°—á—ë—Ç: 0';if(DG.raf)cancelAnimationFrame(DG.raf);DG.raf=requestAnimationFrame(dinoLoop)}
function stopDino(){DG.active=false;if(DG.raf){cancelAnimationFrame(DG.raf);DG.raf=null}}
function dinoJump(){if(!DG.active||DG.char.jumping)return;DG.char.vy=-14;DG.char.jumping=true}
document.addEventListener('keydown',function(e){if(DG.active&&(e.code==='Space'||e.key==='ArrowUp'||e.key==='w')){e.preventDefault();dinoJump()}});
function dinoLoop(){if(!DG.active)return;var cv=$('d-canvas');var c=cv.getContext('2d');var w=cv.width/2;var h=cv.height/2;c.setTransform(2,0,0,2,0,0);c.clearRect(0,0,w,h);c.fillStyle='#2a2a50';c.fillRect(0,DG.ground,w,40);c.strokeStyle='#3a3a60';c.lineWidth=2;for(var i=(DG.score*2)%40-40;i<w;i+=40){c.beginPath();c.moveTo(i,DG.ground);c.lineTo(i+20,DG.ground);c.stroke()}DG.char.vy+=.8;DG.char.y+=DG.char.vy;if(DG.char.y>=DG.ground-DG.char.h){DG.char.y=DG.ground-DG.char.h;DG.char.vy=0;DG.char.jumping=false}if(DG.imgLoaded)c.drawImage(DG.img,DG.char.x-5,DG.char.y-5,DG.char.w+10,DG.char.h+10);else{c.fillStyle='#4ecca3';c.fillRect(DG.char.x,DG.char.y,DG.char.w,DG.char.h)}DG.nextObs--;if(DG.nextObs<=0){var oh=30+Math.random()*30;DG.obs.push({x:w+20,y:DG.ground-oh,w:20+Math.random()*15,h:oh});DG.nextObs=60+Math.random()*80/(1+DG.score/200)}for(var i=DG.obs.length-1;i>=0;i--){var o=DG.obs[i];o.x-=DG.speed;if(o.x+o.w<0){DG.obs.splice(i,1);continue}c.fillStyle='#e94560';c.fillRect(o.x,o.y,o.w,o.h);c.fillStyle='#ff6b81';c.fillRect(o.x+3,o.y+3,o.w-6,o.h-6);if(DG.char.x+DG.char.w-8>o.x&&DG.char.x+8<o.x+o.w&&DG.char.y+DG.char.h-4>o.y){DG.active=false;$('d-over').classList.add('on');$('d-final').textContent='–°—á—ë—Ç: '+Math.floor(DG.score);return}}DG.score+=.1;DG.speed=5+DG.score/50;$('d-score').textContent='–°—á—ë—Ç: '+Math.floor(DG.score);DG.raf=requestAnimationFrame(dinoLoop)}

/* ‚ïê‚ïê‚ïê DEV ‚ïê‚ïê‚ïê */
function dTab(t,el){curTab=t;var tabs=document.querySelectorAll('.dt');for(var i=0;i<tabs.length;i++)tabs[i].classList.remove('on');if(el)el.classList.add('on');renderTab()}
function renderTab(){var c=$('dc');if(curTab==='bg')rBgs(c);else if(curTab==='ch')rChars(c);else if(curTab==='sc')rScenes(c);else rSettings(c)}
function rBgs(c){var h='<div class="dgrid">';D.bgs.forEach(function(b){h+='<div class="dcard" onclick="eBg(\''+b.id+'\')"><div class="dcimg" style="background-image:url(\''+b.data+'\')"></div><div class="dcinf"><div class="dcn">'+esc(b.name)+'</div></div></div>'});h+='<div class="dcard dcadd" onclick="aBg()"><div class="ico">+</div><span>–î–æ–±–∞–≤–∏—Ç—å</span></div></div>';c.innerHTML=h}
function aBg(){editId=null;_bgD=null;$('bg-t').textContent='–î–æ–±–∞–≤–∏—Ç—å';$('bg-name').value='';$('bg-pv').style.display='none';$('bg-del').style.display='none';showM('M-bg')}
function eBg(id){var b=D.bgs.find(function(x){return x.id===id});if(!b)return;editId=id;_bgD=null;$('bg-t').textContent='–†–µ–¥.';$('bg-name').value=b.name;$('bg-pv').src=b.data;$('bg-pv').style.display='block';$('bg-del').style.display='inline-block';showM('M-bg')}
function saveBg(){var n=$('bg-name').value.trim();if(!n)return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!',1);if(editId){var b=D.bgs.find(function(x){return x.id===editId});if(b){b.name=n;if(_bgD)b.data=_bgD}}else{if(!_bgD)return toast('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!',1);D.bgs.push({id:uid(),name:n,data:_bgD})}_bgD=null;save().then(function(){hideM('M-bg');renderTab();toast('OK')})}
function delBg(){if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω?'))return;D.bgs=D.bgs.filter(function(x){return x.id!==editId});save().then(function(){hideM('M-bg');renderTab()})}
function rChars(c){var h='<div class="dgrid">';D.chars.forEach(function(ch){h+='<div class="dcard" onclick="eCh(\''+ch.id+'\')"><div class="dcimg" style="background-image:url(\''+ch.data+'\');background-size:contain;background-repeat:no-repeat;background-position:center"></div><div class="dcinf"><div class="dcn">'+esc(ch.name)+'</div></div></div>'});h+='<div class="dcard dcadd" onclick="aCh()"><div class="ico">+</div><span>–î–æ–±–∞–≤–∏—Ç—å</span></div></div>';c.innerHTML=h}
function aCh(){editId=null;_chD=null;$('ch-t').textContent='–î–æ–±–∞–≤–∏—Ç—å';$('ch-name').value='';$('ch-pv').style.display='none';$('ch-del').style.display='none';showM('M-ch')}
function eCh(id){var ch=D.chars.find(function(x){return x.id===id});if(!ch)return;editId=id;_chD=null;$('ch-t').textContent='–†–µ–¥.';$('ch-name').value=ch.name;$('ch-pv').src=ch.data;$('ch-pv').style.display='block';$('ch-del').style.display='inline-block';showM('M-ch')}
function saveCh(){var n=$('ch-name').value.trim();if(!n)return toast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!',1);if(editId){var ch=D.chars.find(function(x){return x.id===editId});if(ch){ch.name=n;if(_chD)ch.data=_chD}}else{if(!_chD)return toast('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø—Ä–∞–π—Ç!',1);D.chars.push({id:uid(),name:n,data:_chD})}_chD=null;save().then(function(){hideM('M-ch');renderTab();toast('OK')})}
function delCh(){if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞?'))return;D.chars=D.chars.filter(function(x){return x.id!==editId});save().then(function(){hideM('M-ch');renderTab()})}

function rScenes(c){var h='<div class="dgrid">';D.scenes.forEach(function(sc){var isS=sc.id===D.start;var bg=D.bgs.find(function(b){return b.id===sc.bgId});h+='<div class="dcard'+(isS?' start':'')+'" onclick="eSc(\''+sc.id+'\')"><div class="dcimg" style="'+(bg?'background-image:url(\''+bg.data+'\')':'display:flex;align-items:center;justify-content:center;font-size:38px;color:#7878a0')+'">'+(!bg?'üìú':'')+'</div><div class="dcinf"><div class="dcn">'+(sc.bossFight?'üéµ ':sc.utBoss?'üíÄ ':'')+esc(sc.name)+'</div><div class="dcs">'+(isS?'‚≠ê –ù–∞—á–∞–ª—å–Ω–∞—è':sc.steps.length+' —à–∞–≥.')+'</div></div></div>'});h+='<div class="dcard dcadd" onclick="aSc()"><div class="ico">+</div><span>–î–æ–±–∞–≤–∏—Ç—å</span></div></div>';c.innerHTML=h}

function mkStep(){return{chId:null,pos:'center',text:'',hasCh:false,choices:[]}}
function aSc(){editId=null;eScData={id:uid(),name:'',bgId:null,steps:[mkStep()],next:null,bossFight:false,bfBpm:140,bfDur:60,bfSongName:'',bfChar:null,utBoss:false,utDiff:2,utBossHp:500};$('sc-t').textContent='+ –°—Ü–µ–Ω–∞';rScEd();showM('M-sc')}
function eSc(id){var sc=D.scenes.find(function(s){return s.id===id});if(!sc)return;editId=id;eScData=JSON.parse(JSON.stringify(sc));if(!eScData.bfBpm)eScData.bfBpm=140;if(!eScData.bfDur)eScData.bfDur=60;if(!eScData.utDiff)eScData.utDiff=2;if(!eScData.utBossHp)eScData.utBossHp=500;eScData.steps.forEach(function(s){if(s.hasCh===undefined)s.hasCh=!!(s.choices&&s.choices.length)});$('sc-t').textContent='–†–µ–¥. —Å—Ü–µ–Ω—É';rScEd();showM('M-sc');if(editId)chkAudio(eScData.id)}
function chkAudio(id){fetch('/api/audio-check/'+id).then(function(r){return r.json()}).then(function(d){var el=document.getElementById('bf-ast');if(!el)return;if(d.exists)el.innerHTML='<div class="audio-info"><span class="ai-name">üéµ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ('+(d.size/1024/1024).toFixed(1)+'–ú–ë)</span><button onclick="pvAud(\''+id+'\')">‚ñ∂</button><button onclick="dlAud(\''+id+'\')">‚úï</button></div>';else el.innerHTML='<div style="color:#7878a0;font-size:12px;margin-top:6px">–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ‚Üí –∞–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è</div>'}).catch(function(){})}
function ulAud(inp){if(!inp.files[0]||!eScData)return;var f=inp.files[0];var ext=f.name.split('.').pop();var el=document.getElementById('bf-ast');if(el)el.innerHTML='<div style="color:#ffcc00;font-size:13px">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';var r=new FileReader;r.onload=function(){fetch('/api/audio/'+eScData.id,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:r.result.split(',')[1],ext:ext})}).then(function(r){return r.json()}).then(function(d){if(d.ok){toast('üéµ OK');chkAudio(eScData.id)}else toast('–û—à–∏–±–∫–∞!',1)}).catch(function(){toast('–û—à–∏–±–∫–∞!',1)})};r.readAsDataURL(f)}
function pvAud(id){if(window._pa){window._pa.pause();window._pa=null;return}window._pa=new Audio('/api/audio/'+id);window._pa.volume=.5;window._pa.play().catch(function(){});setTimeout(function(){if(window._pa){window._pa.pause();window._pa=null}},10000)}
function dlAud(id){if(!confirm('–£–¥–∞–ª–∏—Ç—å –∞—É–¥–∏–æ?'))return;fetch('/api/audio/'+id,{method:'DELETE'}).then(function(){toast('OK');chkAudio(id)})}

function gather(){
  var ed=$('sc-ed');if(!ed)return;
  var v=function(s){return ed.querySelector(s)};
  var ni=v('#sce-name');if(ni)eScData.name=ni.value;
  var bi=v('#sce-bg');if(bi)eScData.bgId=bi.value||null;
  var nsi=v('#sce-next');if(nsi)eScData.next=nsi.value||null;
  var bft=v('#sce-bftype');if(bft){eScData.bossFight=(bft.value==='fnf');eScData.utBoss=(bft.value==='ut')}
  var utd=v('#sce-utdiff');if(utd)eScData.utDiff=parseInt(utd.value)||2;
  var uth=v('#sce-uthp');if(uth)eScData.utBossHp=parseInt(uth.value)||500;
  var bfb=v('#sce-bfbpm');if(bfb)eScData.bfBpm=parseInt(bfb.value)||140;
  var bfd=v('#sce-bfdur');if(bfd)eScData.bfDur=parseInt(bfd.value)||60;
  var bfs=v('#sce-bfsong');if(bfs)eScData.bfSongName=bfs.value;
  var bfch=v('#sce-bfchar');if(bfch)eScData.bfChar=bfch.value||null;
  var items=ed.querySelectorAll('.si');
  for(var i=0;i<items.length;i++){
    var s=eScData.steps[i];if(!s)continue;
    var ch=items[i].querySelector('.sc-ch');if(ch)s.chId=ch.value||null;
    var ps=items[i].querySelector('.sc-ps');if(ps)s.pos=ps.value;
    var tx=items[i].querySelector('.sc-tx');if(tx)s.text=tx.value;
    var rows=items[i].querySelectorAll('.crow');
    for(var ci=0;ci<rows.length;ci++){
      if(!s.choices[ci])continue;
      var ct=rows[ci].querySelector('.sc-ct');if(ct)s.choices[ci].text=ct.value;
      var cs=rows[ci].querySelector('.sc-cs');if(cs)s.choices[ci].target=cs.value||null;
    }
  }
}

function rScEd(){
  var sc=eScData;
  var bgO='';D.bgs.forEach(function(b){bgO+='<option value="'+b.id+'"'+(sc.bgId===b.id?' selected':'')+'>'+esc(b.name)+'</option>'});
  var allSc=D.scenes.filter(function(s){return s.id!==sc.id});
  var chOpts='';D.chars.forEach(function(c){chOpts+='<option value="'+c.id+'"'+(sc.bfChar===c.id?' selected':'')+'>'+esc(c.name)+'</option>'});
  var stH='';
  sc.steps.forEach(function(st,i){
    var chO='';D.chars.forEach(function(c){chO+='<option value="'+c.id+'"'+(st.chId===c.id?' selected':'')+'>'+esc(c.name)+'</option>'});
    var chcH='';
    if(st.hasCh){
      chcH='<div class="csec">';
      (st.choices||[]).forEach(function(ch,ci){
        var csO='';allSc.forEach(function(s){csO+='<option value="'+s.id+'"'+(ch.target===s.id?' selected':'')+'>'+esc(s.name)+'</option>'});
        chcH+='<div class="crow"><input class="sc-ct" name="ct'+i+'_'+ci+'" value="'+esc(ch.text)+'" placeholder="–¢–µ–∫—Å—Ç"><select class="sc-cs" name="cs'+i+'_'+ci+'"><option value="">‚Üí –ö–æ–Ω–µ—Ü</option>'+csO+'</select><button onclick="gather();eScData.steps['+i+'].choices.splice('+ci+',1);rScEd()">‚úï</button></div>';
      });
      chcH+='<button class="bsm" onclick="gather();eScData.steps['+i+'].choices.push({text:\'\',target:null});rScEd()">+ –í—ã–±–æ—Ä</button></div>';
    }
    stH+='<div class="si"><div class="sih"><span class="sin">–®–∞–≥ '+(i+1)+'</span><div class="sia">'
      +(i>0?'<button onclick="gather();swSt('+i+',-1)">‚Üë</button>':'')
      +(i<sc.steps.length-1?'<button onclick="gather();swSt('+i+',1)">‚Üì</button>':'')
      +(sc.steps.length>1?'<button onclick="gather();eScData.steps.splice('+i+',1);rScEd()">‚úï</button>':'')
      +'</div></div><div class="sf">'
      +'<div><label>–ü–µ—Ä—Å–æ–Ω–∞–∂</label><select class="sc-ch" name="sch'+i+'"><option value="">‚Äî</option>'+chO+'</select></div>'
      +'<div><label>–ü–æ–∑–∏—Ü–∏—è</label><select class="sc-ps" name="sps'+i+'"><option value="left"'+(st.pos==='left'?' selected':'')+'>‚Üê</option><option value="center"'+(st.pos==='center'?' selected':'')+'>‚äô</option><option value="right"'+(st.pos==='right'?' selected':'')+'>‚Üí</option></select></div>'
      +'<div class="fw"><label>–¢–µ–∫—Å—Ç</label><textarea class="sc-tx" name="stx'+i+'">'+esc(st.text)+'</textarea></div></div>'
      +'<div class="cbtog"><input type="checkbox" id="cb'+i+'" name="cb'+i+'"'+(st.hasCh?' checked':'')+' onchange="gather();eScData.steps['+i+'].hasCh=this.checked;if(this.checked&&(!eScData.steps['+i+'].choices||!eScData.steps['+i+'].choices.length))eScData.steps['+i+'].choices=[{text:\'\',target:null}];rScEd()"><label for="cb'+i+'">–í—ã–±–æ—Ä—ã</label></div>'
      +chcH+'</div>';
  });
  var nxO='';allSc.forEach(function(s){nxO+='<option value="'+s.id+'"'+(sc.next===s.id?' selected':'')+'>'+esc(s.name)+'</option>'});
  var bfTypeVal='';if(sc.bossFight)bfTypeVal='fnf';else if(sc.utBoss)bfTypeVal='ut';
  var html='<div class="fg"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="sce-name" name="sce-name" value="'+esc(sc.name)+'"></div>'
    +'<div class="fg"><label>–§–æ–Ω</label><select id="sce-bg" name="sce-bg"><option value="">‚Äî</option>'+bgO+'</select></div>'
    +'<div class="fg"><label>–®–∞–≥–∏</label><div class="steps">'+stH+'</div><button class="bsm" onclick="gather();eScData.steps.push(mkStep());rScEd()" style="margin-top:12px">+ –®–∞–≥</button></div>'
    +'<div class="fg"><label>–î–∞–ª–µ–µ</label><select id="sce-next" name="sce-next"><option value="">‚Äî –ö–æ–Ω–µ—Ü ‚Äî</option>'+nxO+'</select></div>'
    +'<div class="bfsec"><h4>‚öîÔ∏è –ë–æ—Å—Å-—Ñ–∞–π—Ç</h4>'
    +'<div class="fg"><label>–¢–∏–ø</label><select id="sce-bftype" name="sce-bftype"><option value=""'+(bfTypeVal===''?' selected':'')+'>–ù–µ—Ç</option><option value="fnf"'+(bfTypeVal==='fnf'?' selected':'')+'>üéµ FNF</option><option value="ut"'+(bfTypeVal==='ut'?' selected':'')+'>üíÄ Undertale</option></select></div>'
    +'<div class="sf" style="margin-top:10px">'
    +'<div><label>–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫</label><select id="sce-bfchar" name="sce-bfchar"><option value="">‚Äî</option>'+chOpts+'</select></div>'
    +'<div><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input id="sce-bfsong" name="sce-bfsong" value="'+esc(sc.bfSongName)+'"></div>'
    +'<div><label>BPM</label><input type="number" id="sce-bfbpm" name="sce-bfbpm" value="'+(sc.bfBpm||140)+'" min="60" max="300"></div>'
    +'<div><label>–î–ª–∏–Ω–∞(—Å)</label><input type="number" id="sce-bfdur" name="sce-bfdur" value="'+(sc.bfDur||60)+'" min="15" max="300"></div>'
    +'<div><label>–°–ª–æ–∂–Ω–æ—Å—Ç—å UT</label><select id="sce-utdiff" name="sce-utdiff"><option value="1"'+((sc.utDiff||2)===1?' selected':'')+'>–õ–µ–≥–∫–æ</option><option value="2"'+((sc.utDiff||2)===2?' selected':'')+'>–°—Ä–µ–¥–Ω–µ</option><option value="3"'+((sc.utDiff||2)===3?' selected':'')+'>–°–ª–æ–∂–Ω–æ</option></select></div>'
    +'<div><label>HP –±–æ—Å—Å–∞ UT</label><input type="number" id="sce-uthp" name="sce-uthp" value="'+(sc.utBossHp||500)+'" min="100" max="9999"></div>'
    +'</div>'
    +'<div class="fg" style="margin-top:10px"><label>–ú—É–∑—ã–∫–∞</label><label class="fbtn">üìÅ<input type="file" accept="audio/*" style="display:none" onchange="ulAud(this)"></label><div id="bf-ast"></div></div></div>'
    +'<div class="brow" style="margin-top:20px"><button class="bp" onclick="saveSc()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>'
    +(editId?'<button class="bd" onclick="delSc()">üóë –£–¥–∞–ª–∏—Ç—å</button>':'')
    +'<button class="bs" onclick="hideM(\'M-sc\')">–û—Ç–º–µ–Ω–∞</button></div>';
  $('sc-ed').innerHTML=html;
}
function swSt(i,d){var s=eScData.steps;var t=s[i];s[i]=s[i+d];s[i+d]=t;rScEd()}
function saveSc(){gather();var sc=eScData;sc.name=sc.name||'?';sc.steps.forEach(function(s){if(!s.hasCh)s.choices=[]});if(editId){for(var i=0;i<D.scenes.length;i++){if(D.scenes[i].id===editId){D.scenes[i]=sc;break}}}else{D.scenes.push(sc);if(!D.start)D.start=sc.id}save().then(function(){hideM('M-sc');renderTab();toast('OK')})}
function delSc(){if(!confirm('?'))return;if(editId)fetch('/api/audio/'+editId,{method:'DELETE'}).catch(function(){});D.scenes=D.scenes.filter(function(s){return s.id!==editId});if(D.start===editId)D.start=D.scenes.length?D.scenes[0].id:null;save().then(function(){hideM('M-sc');renderTab()})}
function rSettings(c){var scO='';D.scenes.forEach(function(s){scO+='<option value="'+s.id+'"'+(D.start===s.id?' selected':'')+'>'+esc(s.name)+'</option>'});c.innerHTML='<div class="setsec"><h3>‚úèÔ∏è –ù–∞–∑–≤–∞–Ω–∏–µ</h3><div class="fg"><input id="st-t" value="'+esc(D.title)+'" onchange="D.title=this.value;save().then(function(){updateMenu();toast(\'OK\')})"></div></div><div class="setsec"><h3>‚≠ê –ù–∞—á–∞–ª—å–Ω–∞—è</h3><div class="fg"><select id="st-s" onchange="D.start=this.value||null;save().then(function(){updateMenu();toast(\'OK\')})"><option value="">‚Äî</option>'+scO+'</select></div></div><div class="setsec"><h3>üíæ</h3><div class="brow"><button class="bs" onclick="expD()">üì§</button><label class="bs" style="cursor:pointer">üì•<input type="file" accept=".json" style="display:none" onchange="impD(this)"></label></div></div><div class="setsec"><button class="bd" onclick="clearAll()">üóë –í—Å—ë</button></div>'}
function expD(){var b=new Blob([JSON.stringify(D,null,2)],{type:'application/json'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='novel.json';a.click()}
function impD(inp){if(!inp.files[0])return;inp.files[0].text().then(function(t){try{var d=JSON.parse(t);if(d.scenes){D=d;save().then(function(){renderTab();updateMenu();toast('OK')})}}catch(e){toast('!',1)}})}
function clearAll(){if(!confirm('–í–°–Å?'))return;D={title:'–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ',bgs:[],chars:[],scenes:[],start:null};save().then(function(){renderTab();updateMenu()})}

/* ‚ïê‚ïê‚ïê NOVEL ‚ïê‚ïê‚ïê */
function startGame(){
  if(!isAdmin&&Date.now()<TARGET){showWaitRoom();return}
  loadData().then(function(ok){if(!ok){toast('!',1);return}updateMenu();var ss=findScene(D.start);if(!ss||!ss.steps||!ss.steps.length){toast('–ü—É—Å—Ç–æ!',1);return}scr('S-game');$('g-end').classList.remove('on');$('g-choices').classList.remove('on');$('g-char').style.display='none';$('g-name').textContent='';$('g-txt').textContent='';gameLoad(D.start)})
}
function findScene(id){for(var i=0;i<D.scenes.length;i++)if(D.scenes[i].id===id)return D.scenes[i];return null}
function findChar(id){for(var i=0;i<D.chars.length;i++)if(D.chars[i].id===id)return D.chars[i];return null}
function findBg(id){for(var i=0;i<D.bgs.length;i++)if(D.bgs[i].id===id)return D.bgs[i];return null}
function gameLoad(sid){var sc=findScene(sid);if(!sc){gameEnd();return}if(!sc.steps||!sc.steps.length){gameTrans(sc);return}G.sid=sid;G.step=0;var bg=findBg(sc.bgId);var el=$('g-bg');if(bg){el.style.backgroundImage='url('+bg.data+')'}else{el.style.backgroundImage='none';el.style.backgroundColor='#1e1e3e'}gameShow()}
function gameTrans(sc){if(sc&&sc.bossFight){bfStart(sc)}else if(sc&&sc.utBoss){utStart(sc)}else if(sc&&sc.next){gameLoad(sc.next)}else{gameEnd()}}
function gameShow(){var sc=findScene(G.sid);if(!sc||G.step>=sc.steps.length){gameTrans(sc);return}var st=sc.steps[G.step];var cel=$('g-char');if(st.chId){var ch=findChar(st.chId);if(ch){cel.src=ch.data;cel.className=st.pos==='left'?'vis pl':st.pos==='right'?'vis pr':'vis pc';cel.style.display='block';$('g-name').textContent=ch.name}else{cel.style.display='none';$('g-name').textContent=''}}else{cel.style.display='none';$('g-name').textContent=''}gameType(st.text||'...');$('g-ind').style.display=(st.hasCh&&st.choices&&st.choices.length)?'none':'block'}
function gameType(t){stopTyping();G.full=t;G.typing=true;var el=$('g-txt');var i=0;el.textContent='';G.timer=setInterval(function(){if(i<t.length){el.textContent+=t.charAt(i);i++}else{stopTyping();gameAfter()}},30)}
function stopTyping(){if(G.timer){clearInterval(G.timer);G.timer=null}G.typing=false}
function gameAfter(){var sc=findScene(G.sid);if(!sc)return;var st=sc.steps[G.step];if(st&&st.hasCh&&st.choices&&st.choices.length){var c=$('g-choices');var h='';for(var i=0;i<st.choices.length;i++)h+='<button class="chb" onclick="gamePick('+i+')">'+esc(st.choices[i].text||'–í–∞—Ä–∏–∞–Ω—Ç '+(i+1))+'</button>';c.innerHTML=h;c.classList.add('on')}}
function advance(){if(G.typing){stopTyping();$('g-txt').textContent=G.full;gameAfter();return}var sc=findScene(G.sid);if(!sc)return;var st=sc.steps[G.step];if(st&&st.hasCh&&st.choices&&st.choices.length)return;G.step++;if(G.step>=sc.steps.length)gameTrans(sc);else gameShow()}
function gamePick(i){var sc=findScene(G.sid);if(!sc)return;var st=sc.steps[G.step];if(!st||!st.choices||!st.choices[i])return;$('g-choices').classList.remove('on');var t=st.choices[i].target;if(t)gameLoad(t);else gameEnd()}
function gameEnd(){stopTyping();$('g-end').classList.add('on')}

/* ‚ïê‚ïê‚ïê BOSS FIGHT (FNF) ‚ïê‚ïê‚ïê */
var BF={active:false,audio:null,actx:null,raf:null,hp:50,score:0,combo:0,maxCombo:0,hits:0,misses:0,perfects:0,notes:[],noteIdx:0,startTime:0,songDur:0,sceneData:null,canvas:null,ctx:null,laneColors:['#c24b99','#00ffff','#12fa05','#f9393f'],laneW:0,hitY:0,speed:400,pressed:[false,false,false,false],hitAnims:[[],[],[],[]]};
function bfStop(){BF.active=false;if(BF.raf){cancelAnimationFrame(BF.raf);BF.raf=null}if(BF.audio){BF.audio.pause();BF.audio=null}if(BF.actx){try{BF.actx.close()}catch(e){}BF.actx=null}}
function bfStart(sd){
  bfStop();BF.sceneData=sd;BF.hp=50;BF.score=0;BF.combo=0;BF.maxCombo=0;BF.hits=0;BF.misses=0;BF.perfects=0;BF.noteIdx=0;
  BF.pressed=[false,false,false,false];BF.hitAnims=[[],[],[],[]];
  var bpm=sd.bfBpm||140;var dur=sd.bfDur||60;BF.songDur=dur*1000;BF.speed=Math.min(200+bpm*1.5,650);BF.notes=bfGenBeatmap(bpm,dur);
  var ch=sd.bfChar?findChar(sd.bfChar):null;
  if(ch){$('bf-opp-img').src=ch.data;$('bf-opp-img').style.display='block';$('bf-opp-name').textContent=ch.name}
  else{$('bf-opp-img').style.display='none';$('bf-opp-name').textContent='???'}
  $('bf-song-name').textContent='‚ô™ '+(sd.bfSongName||'Unknown');
  scr('S-boss');$('bf-result').classList.remove('on');$('bf-hfill').style.width='50%';$('bf-score-txt').textContent='0';
  requestAnimationFrame(function(){requestAnimationFrame(function(){
    bfSetupCanvas();bfLoadAudio(sd.id,function(has){bfCountdown(function(){
      if(has&&BF.audio){BF.audio.currentTime=0;BF.audio.play().catch(function(){})}
      else{BF.actx=new(window.AudioContext||window.webkitAudioContext)();bfGenMusic(BF.actx,bpm,dur)}
      BF.startTime=performance.now();BF.active=true;BF.raf=requestAnimationFrame(bfLoop);
    })});
  })});
}
function bfSetupCanvas(){BF.canvas=$('bf-canvas');var rect=BF.canvas.parentElement.getBoundingClientRect();BF.canvas.width=Math.max(rect.width*2,100);BF.canvas.height=Math.max(rect.height*2,100);BF.canvas.style.width=rect.width+'px';BF.canvas.style.height=rect.height+'px';BF.ctx=BF.canvas.getContext('2d');BF.ctx.scale(2,2);BF.laneW=rect.width/4;BF.hitY=rect.height-100}
function bfLoadAudio(id,cb){fetch('/api/audio-check/'+id).then(function(r){return r.json()}).then(function(d){if(d.exists){BF.audio=new Audio('/api/audio/'+id);BF.audio.preload='auto';BF.audio.volume=.7;var ok=false;BF.audio.oncanplaythrough=function(){if(!ok){ok=true;cb(true)}};BF.audio.onerror=function(){if(!ok){ok=true;cb(false)}};BF.audio.load();setTimeout(function(){if(!ok){ok=true;cb(BF.audio&&BF.audio.readyState>=2)}},5000)}else cb(false)}).catch(function(){cb(false)})}
function bfCountdown(cb){var el=$('bf-countdown');el.classList.add('on');var n=['3','2','1','‚ô™'];var i=0;el.textContent=n[0];var iv=setInterval(function(){i++;if(i<n.length)el.textContent=n[i];else{clearInterval(iv);el.classList.remove('on');cb()}},700)}
function bfGenBeatmap(bpm,dur){var beat=60/bpm;var notes=[];var t=beat*4;var patterns=[[0,1,2,3],[3,2,1,0],[0,2,1,3],[1,3,0,2],[0,0,2,2],[1,1,3,3],[0,1,0,1],[2,3,2,3],[0,2,0,3],[1,3,1,2],[3,1,0,2],[2,0,3,1],[0,1,2,1],[3,2,1,2],[0,3,0,3],[1,2,1,2]];var pi=Math.floor(Math.random()*patterns.length);var si=0;while(t<dur-2){var intensity=Math.min(t/(dur*0.7),1);var pat=patterns[pi%patterns.length];var lane=pat[si%pat.length];notes.push({time:t*1000,lane:lane,hit:false,missed:false});if(intensity>0.2&&Math.random()<intensity*0.5){notes.push({time:(t+beat*0.5)*1000,lane:(lane+1+Math.floor(Math.random()*3))%4,hit:false,missed:false})}if(intensity>0.5&&Math.random()<(intensity-0.5)*0.6){notes.push({time:(t+beat*0.25)*1000,lane:Math.floor(Math.random()*4),hit:false,missed:false})}if(intensity>0.7&&Math.random()<0.15){notes.push({time:(t+beat*0.33)*1000,lane:(lane+2)%4,hit:false,missed:false});notes.push({time:(t+beat*0.67)*1000,lane:(lane+3)%4,hit:false,missed:false})}si++;if(si%pat.length===0&&Math.random()<0.4){pi++;si=0}if(Math.random()<0.15*(1-intensity))t+=beat;t+=beat}notes.sort(function(a,b){return a.time-b.time});return notes}
function bfGenMusic(actx,bpm,dur){var beat=60/bpm;var f=[261.63,293.66,329.63,349.23,392,440,493.88,523.25];var now=actx.currentTime;for(var i=0;i<BF.notes.length;i++){var n=BF.notes[i];bfTn(actx,f[(n.lane*2+i)%8],now+n.time/1000,beat*.35,'square',.06)}for(var t=0;t<dur;t+=beat)bfTn(actx,f[Math.floor(t/beat/4)%4]/2,now+t,beat*.5,'triangle',.1);for(var t=0;t<dur;t+=beat)bfDr(actx,now+t);for(var t=beat/2;t<dur;t+=beat)bfNs(actx,now+t,.02,.03)}
function bfTn(c,f,t,d,tp,v){var o=c.createOscillator();var g=c.createGain();o.type=tp;o.frequency.value=f;g.gain.setValueAtTime(v,t);g.gain.exponentialRampToValueAtTime(.001,t+d);o.connect(g);g.connect(c.destination);o.start(t);o.stop(t+d+.01)}
function bfDr(c,t){var o=c.createOscillator();var g=c.createGain();o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(30,t+.1);g.gain.setValueAtTime(.12,t);g.gain.exponentialRampToValueAtTime(.001,t+.15);o.connect(g);g.connect(c.destination);o.start(t);o.stop(t+.2)}
function bfNs(c,t,d,v){var b=c.createBuffer(1,c.sampleRate*d,c.sampleRate);var da=b.getChannelData(0);for(var i=0;i<da.length;i++)da[i]=Math.random()*2-1;var s=c.createBufferSource();s.buffer=b;var g=c.createGain();g.gain.setValueAtTime(v,t);g.gain.exponentialRampToValueAtTime(.001,t+d);var fl=c.createBiquadFilter();fl.type='highpass';fl.frequency.value=8000;s.connect(fl);fl.connect(g);g.connect(c.destination);s.start(t)}
function bfLoop(){if(!BF.active)return;var el=performance.now()-BF.startTime;for(var i=BF.noteIdx;i<BF.notes.length;i++){var n=BF.notes[i];if(n.hit||n.missed)continue;if(el-n.time>160){n.missed=true;BF.misses++;BF.combo=0;BF.hp=Math.max(0,BF.hp-5);bfRt('MISS','#e94560')}if(n.time-el>2000)break}while(BF.noteIdx<BF.notes.length&&(BF.notes[BF.noteIdx].hit||BF.notes[BF.noteIdx].missed))BF.noteIdx++;$('bf-hfill').style.width=BF.hp+'%';$('bf-score-txt').textContent=Math.floor(BF.score);if(BF.hp<=0){bfEnd(false);return}if(el>=BF.songDur+1000){bfEnd(true);return}bfRender(el);BF.raf=requestAnimationFrame(bfLoop)}
function bfRender(el){var c=BF.ctx;var w=BF.canvas.width/2;var h=BF.canvas.height/2;c.clearRect(0,0,w,h);for(var i=0;i<4;i++){c.fillStyle='rgba(255,255,255,0.02)';c.fillRect(i*BF.laneW,0,BF.laneW,h);c.strokeStyle='rgba(255,255,255,0.06)';c.strokeRect(i*BF.laneW,0,BF.laneW,h)}for(var i=0;i<4;i++){var cx=i*BF.laneW+BF.laneW/2;if(BF.pressed[i]){c.fillStyle=BF.laneColors[i]+'22';c.fillRect(i*BF.laneW,BF.hitY-30,BF.laneW,60)}bfAr(c,cx,BF.hitY,BF.laneW*.32,i,false,BF.pressed[i]?BF.laneColors[i]:'rgba(255,255,255,0.25)')}for(var i=0;i<4;i++){for(var j=BF.hitAnims[i].length-1;j>=0;j--){var a=BF.hitAnims[i][j];var age=el-a.time;if(age>300){BF.hitAnims[i].splice(j,1);continue}c.globalAlpha=1-age/300;bfAr(c,i*BF.laneW+BF.laneW/2,BF.hitY,BF.laneW*.32*(1+age/200),i,true,a.color);c.globalAlpha=1}}for(var i=0;i<BF.notes.length;i++){var n=BF.notes[i];if(n.hit||n.missed)continue;var dt=n.time-el;if(dt>2000)break;if(dt<-300)continue;var y=BF.hitY-dt/1000*BF.speed;if(y<-50||y>h+50)continue;bfAr(c,n.lane*BF.laneW+BF.laneW/2,y,BF.laneW*.32,n.lane,true,BF.laneColors[n.lane])}}
function bfAr(c,x,y,s,l,fill,col){c.save();c.translate(x,y);var r=[Math.PI/2,Math.PI,0,-Math.PI/2];c.rotate(r[l]);c.beginPath();c.moveTo(0,-s);c.lineTo(s*.7,s*.2);c.lineTo(s*.25,s*.2);c.lineTo(s*.25,s);c.lineTo(-s*.25,s);c.lineTo(-s*.25,s*.2);c.lineTo(-s*.7,s*.2);c.closePath();if(fill){c.fillStyle=col;c.fill();c.strokeStyle='rgba(255,255,255,.2)';c.lineWidth=1;c.stroke()}else{c.strokeStyle=col;c.lineWidth=2;c.stroke()}c.restore()}
function bfHit(lane){if(!BF.active)return;BF.pressed[lane]=true;setTimeout(function(){BF.pressed[lane]=false},100);var el=performance.now()-BF.startTime;var best=null,bestDt=Infinity;for(var i=0;i<BF.notes.length;i++){var n=BF.notes[i];if(n.hit||n.missed||n.lane!==lane)continue;var dt=Math.abs(el-n.time);if(dt>200)continue;if(dt<bestDt){bestDt=dt;best=n}}if(!best)return;best.hit=true;BF.hits++;var r,p,heal,col;if(bestDt<35){r='PERFECT';p=400;heal=3;col='#ffff00';BF.perfects++}else if(bestDt<75){r='GREAT';p=280;heal=2;col='#4ecca3'}else if(bestDt<120){r='GOOD';p=150;heal=1;col='#39ffdc'}else{r='OK';p=50;heal=0;col='#7878a0'}BF.combo++;if(BF.combo>BF.maxCombo)BF.maxCombo=BF.combo;BF.score+=p*(1+Math.floor(BF.combo/10)*0.15);BF.hp=Math.min(100,BF.hp+heal);BF.hitAnims[lane].push({time:performance.now()-BF.startTime,color:col});bfRt(r,col);if(BF.combo>0&&BF.combo%10===0)bfCb()}
function bfRt(t,c){var e=$('bf-rating-txt');e.textContent=t;e.style.color=c;e.classList.remove('show');void e.offsetWidth;e.classList.add('show');setTimeout(function(){e.classList.remove('show')},600)}
function bfCb(){var e=$('bf-combo-txt');e.textContent=BF.combo+'x';e.classList.remove('show');void e.offsetWidth;e.classList.add('show');setTimeout(function(){e.classList.remove('show')},800)}
function bfEnd(won){bfStop();$('bf-result').classList.add('on');$('bf-res-title').textContent=won?'–ü–û–ë–ï–î–ê!':'–ü–û–†–ê–ñ–ï–ù–ò–ï';$('bf-res-title').className=won?'win':'lose';$('bf-res-stats').innerHTML='–°—á—ë—Ç: '+Math.floor(BF.score)+'<br>–ö–æ–º–±–æ: '+BF.maxCombo+'x<br>Perfect: '+BF.perfects+'<br>–ü—Ä–æ–º–∞—Ö–∏: '+BF.misses;var btn=$('bf-res-btn');var sc=BF.sceneData;if(won){btn.textContent='–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';btn.onclick=function(){$('bf-result').classList.remove('on');if(sc&&sc.next){scr('S-game');gameLoad(sc.next)}else{scr('S-game');gameEnd()}}}else{btn.textContent='–ï—â—ë —Ä–∞–∑';btn.onclick=function(){$('bf-result').classList.remove('on');bfStart(sc)}}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UNDERTALE BOSS v4 ‚Äî MULTI-PHASE + SANS/PAPYRUS
   Phase 1: Normal (>67% HP) ‚Äî Sans helper
   Phase 2: Sword+Bombs+Honeycomb+Knives (67-33% HP)
   Phase 3: Gun+Wind+LaserBone (33-7% HP) ‚Äî Both skeletons
   Phase 4: Reverse ‚Äî catch projectiles (‚â§7% HP)
   Sans dies (totem) on first player death ‚Üí Papyrus appears
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var UT={
  active:false,raf:null,audio:null,
  tp:'player', // player|attack|dialogue|totem|transition
  sd:null, // sceneData
  // player
  px:0,py:0,ppx:0,ppy:0,spd:3.5,hp:92,mhp:92,inv:0,moving:false,
  // boss
  bhp:1500,bmhp:1500,bn:'',phase:1,
  // box
  bw:200,bh:200,
  // attacks
  proj:[],bones:[],beams:[],
  atT:0,atD:6000,atI:0,tc:0,spA:0,
  // fight bar
  abA:false,abX:0,abD:1,
  keys:{},dlg:[],dlI:0,dlCb:null,diff:2,
  // sans
  sA:true,sDied:false,sans:{x:0,y:0,tx:0,ty:0,mt:0,tt:0,i:false},
  // papyrus
  pA:false,pap:{x:0,y:0,tx:0,ty:0,mt:0,tt:0,i:false},
  // first death
  fd:true,
  // phase entities
  sword:null,gun:null,laser:null,wind:0,
  hcA:false,hcC:null,hcT:0,hcI:0,
  // phase 4
  rev:false,catches:0,
  // fx
  shake:0,bflash:0,
  // colored bone hit (for phrase)
  cbHit:0
};

/* ‚îÄ‚îÄ‚îÄ PHRASES ‚îÄ‚îÄ‚îÄ */
var SP={
  sIdle:['—Ö–µ—Ö.','—Å–∫—É—á–Ω–æ...','*–∑–µ–≤–∞–µ—Ç*','–ø—Ñ—Ñ.','—Ö–µ—Ö–µ—Ö–µ...','–Ω–µ-–∞.','—Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ.',
    '–ö–∞–∂–µ—Ç—Å—è —É —Ç—è–Ω–∫–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –Ω–∞ –Ω–∞—Å –æ—Ç—Ç—è–Ω—É—Ç—Å—è! –•–∞! –•–∞.',
    '–ß—Ç–æ, –Ω—Ä–∞–≤—è—Ç—Å—è –º–æ–∏ —Ö—Ä—É–º–µ—à–∫–∏?!','–î–∞ —ç—Ç–æ –∫–∞–∫–∞—è —Ç–æ –¢—è–Ω–∫–æ–ª–æ–≤–∞–Ω–∏—è!',
    '@SansTimelineparadox –ø–µ—Ä–µ–¥–∞—é –ø—Ä–∏–≤–µ—Ç! –û–π, —á—Ç–æ —ç—Ç–æ —è...'],
  sThrow:['–ø–æ–ª—É—á–∞–π!','–±–µ–∑ —à–∞–Ω—Å–æ–≤.','–º–æ–π —Ö–æ–¥.','–ø–æ–ø—Ä–æ–±—É–π —É–≤–µ—Ä–Ω–∏—Å—å.','‚ò†Ô∏è','–æ–ø–∞.'],
  sCbHit:['–ö–∞–∫ —Ç–∞–∫?! –ú—ã –≤–µ–¥—å —ç—Ç–æ —Å —Ç–æ–±–æ–π –ø—Ä–æ—Ö–æ–¥–∏–ª–∏!'],
  sP2:['–û—Ö-—Ö, –∫–∞–∂–µ—Ç—Å—è —É –º–µ–Ω—è –∑–∞—Ç—Ä—è—Å–ª–∏—Å—å –∫–æ—Å—Ç–∏!'],
  sP3a:['–û–π-–µ–π, –≤ –æ–¥–∏–Ω–æ—á–∫—É –Ω–∞–º –Ω–µ —Å–ø—Ä–∞–≤–∏—Ç—Å—è!'],
  sP3r:['*—Ö—Ä—É–º-—Ö—Ä—É–º* –ê –≤–æ—Ç –∏ —è!'],
  pIdle:['–°–µ–π—á–∞—Å –≤—ã —É–≤–∏–¥–∏—Ç–µ –º–æ—ë... –ú–ê–°–¢–ï–†–°–¢–í–û –°–í–ò–î–ê–ù–ò–ô!!!',
    '–õ–æ–≤—É—à–∫–∞ –¥–ª—è —Ç—è–Ω–æ–∫, –≤–ø–µ—Ä–µ... –ù—É, –∫–∞–∫ –≤—Å–µ–≥–¥–∞.',
    '–ì–¥–µ –º–æ—è... –°–ü–ê–ì–ì–ï–¢–¢–ò –ü–£–®–ö–ê?!',
    '–¢—ã –∫–æ–Ω–µ—á–Ω–æ –Ω–µ –≥–≥ –∞–Ω–¥–µ—Ä—Ç–µ–π–ª–∞, –Ω–æ... –¢–∞–∫, –æ —á—ë–º —ç—Ç–æ —è?!'],
  pThrow:['–ü–æ–ª—É—á–∞–π –º–æ—é —Å–ø–∞–≥–µ—Ç—Ç–∏-–∞—Ç–∞–∫—É!','–ù–¨–ï–•–ï–•–ï–•–ï!','–í–µ–ª–∏–∫–∏–π –ü–∞–ø–∏—Ä—É—Å –∞—Ç–∞–∫—É–µ—Ç!'],
  pSpawnDead:['–°–µ–π—á–∞—Å —è —Ç–µ–±–µ –æ—Ç–æ–º—â—É –∑–∞ —Å–≤–æ–µ–≥–æ –°–ê–ù–°–ï–ß–ö–£!'],
  pSpawnAlive:['–ê —è –Ω–µ —Ç–∞–∫ –ø—Ä–æ—Å—Ç, –¥–∞?'],
  pCbHit:['—Ö–ê! –ü–æ–ø–∞–ª—Å—è –Ω–∞ –º–æ—é –ª–æ–≤—É—à–∫—É! –¢–∞–∫, —Å—Ç–æ–ø...'],
  pP3a:['–ô–æ-—Ö–æ-—Ö–æ! –ö–∞–∂–µ—Ç—Å—è –Ω–∞–º –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å!'],
  pP3s:['–ê –≤–æ—Ç –∏ —è, —Å–∞–ª–∞–≥–∏!']
};
function rp(a){return a[Math.floor(Math.random()*a.length)]}

/* ‚îÄ‚îÄ‚îÄ SANS/PAPYRUS CREATION (document.body) ‚îÄ‚îÄ‚îÄ */
function utMakeHelper(id,emoji,anim){
  var old=document.getElementById(id);if(old)old.remove();
  var w=document.createElement('div');w.id=id;
  w.style.cssText='position:fixed;z-index:99999;pointer-events:none;';
  w.innerHTML='<div style="font-size:48px;line-height:1;filter:drop-shadow(0 0 12px rgba(80,180,255,.7));animation:'+anim+' 2s ease-in-out infinite">'+emoji+'</div>'
    +'<div id="'+id+'-txt" style="position:absolute;top:-32px;left:50%;transform:translateX(-50%);white-space:nowrap;font-family:monospace;font-size:12px;color:#64b5f6;opacity:0;transition:opacity .3s;background:rgba(0,0,20,.9);padding:3px 10px;border-radius:8px;border:1px solid #42a5f5"></div>';
  document.body.appendChild(w);return w;
}
function utRemoveHelper(id){var e=document.getElementById(id);if(e)e.remove()}

var _htTimers={};
function utHelperTxt(id,txt){
  var e=document.getElementById(id+'-txt');if(!e)return;
  e.textContent=txt;e.style.opacity='1';
  if(_htTimers[id])clearTimeout(_htTimers[id]);
  _htTimers[id]=setTimeout(function(){if(e)e.style.opacity='0'},2000);
}

function utUpdateHelper(h,id,bounds,phrases,throwCb){
  if(!h.i){h.i=true;h.x=bounds.w*0.06;h.y=bounds.h*0.35;h.tx=bounds.w*0.15;h.ty=bounds.h*0.4;h.mt=500;h.tt=3000}
  h.x+=(h.tx-h.x)*0.025;h.y+=(h.ty-h.y)*0.025;
  h.mt-=16;if(h.mt<=0){h.mt=1500+Math.random()*2500;h.tx=bounds.w*0.03+Math.random()*bounds.w*0.25;h.ty=bounds.h*0.12+Math.random()*bounds.h*0.55}
  if(UT.tp==='attack'){
    h.tt-=16;
    if(h.tt<=0){h.tt=2500+Math.random()*3500;if(throwCb)throwCb(phrases)}
  }
  var el=document.getElementById(id);
  if(el){el.style.display='block';el.style.left=Math.round(bounds.l+h.x)+'px';el.style.top=Math.round(bounds.t+h.y)+'px'}
}

/* ‚îÄ‚îÄ‚îÄ TOTEM ANIMATION ‚îÄ‚îÄ‚îÄ */
function utTotem(cb){
  UT.tp='totem';
  var ov=$('ut-totem-overlay');ov.classList.add('on');
  $('ut-totem-text').textContent='';
  $('ut-totem-skull').style.fontSize='80px';
  // step 1: skull grows
  setTimeout(function(){$('ut-totem-skull').style.fontSize='120px';$('ut-totem-text').textContent='üíõ SANS –û–¢–î–ê–õ –°–í–û–Æ –ñ–ò–ó–ù–¨'},800);
  // step 2: rays
  setTimeout(function(){var r=$('ut-totem-rays');r.style.animation='none';void r.offsetWidth;r.style.animation='totemRays 1s ease-out forwards'},1200);
  // step 3: fade
  setTimeout(function(){
    ov.classList.remove('on');
    UT.sA=false;UT.sDied=true;
    utRemoveHelper('ut-sans-float');
    // restore player
    UT.hp=UT.mhp;UT.inv=2000;
    utUpdateHp();
    // spawn papyrus
    UT.pA=true;UT.pap.i=false;
    utMakeHelper('ut-pap-float','ü¶¥','papFly');
    utHelperTxt('ut-pap-float',UT.sDied?rp(SP.pSpawnDead):rp(SP.pSpawnAlive));
    if(cb)cb();
  },3000);
}

/* ‚îÄ‚îÄ‚îÄ PHASE TRANSITIONS ‚îÄ‚îÄ‚îÄ */
function utCheckPhase(){
  var pct=UT.bhp/UT.bmhp;
  var np=pct>0.67?1:pct>0.33?2:pct>0.07?3:4;
  if(np!==UT.phase){
    var old=UT.phase;UT.phase=np;
    utPhaseTransition(old,np);
  }
}

function utPhaseTransition(from,to){
  UT.tp='transition';
  // clear attacks
  utClearBox();
  // remove old entities
  if(UT.sword){UT.sword.el.remove();UT.sword=null}
  if(UT.gun){UT.gun.el.remove();UT.gun=null}
  if(UT.laser){UT.laser.el.remove();UT.laser=null}

  // update visuals
  var sut=$('S-ut');
  sut.classList.remove('ut-phase2','ut-phase3','ut-phase4');
  if(to>=2)sut.classList.add('ut-phase'+Math.min(to,4));

  // show phase text
  var ov=$('ut-phase-overlay');ov.textContent='';
  ov.classList.add('on');

  // phase-specific setup + phrases
  var msgs=[];
  if(to===2){
    msgs.push('* PHASE 2 *');
    if(UT.sA)utHelperTxt('ut-sans-float',rp(SP.sP2));
    if(UT.pA)utHelperTxt('ut-pap-float',UT.sA?rp(SP.pSpawnAlive):rp(SP.pP3a));
    // create sword
    setTimeout(function(){utCreateSword()},1500);
  }
  if(to===3){
    msgs.push('* PHASE 3 *');
    // both skeletons
    if(!UT.pA){UT.pA=true;UT.pap.i=false;utMakeHelper('ut-pap-float','ü¶¥','papFly');utHelperTxt('ut-pap-float',UT.sDied?rp(SP.pP3s):rp(SP.pP3a))}
    if(UT.sA)utHelperTxt('ut-sans-float',rp(SP.sP3a));
    if(UT.sDied&&!UT.sA){
      // revive sans for phase 3
      UT.sA=true;UT.sans.i=false;utMakeHelper('ut-sans-float','üíÄ','sansFly');utHelperTxt('ut-sans-float',rp(SP.sP3r));
    }
    setTimeout(function(){utCreateGun()},1500);
  }
  if(to===4){
    msgs.push('* FINAL PHASE *');
    UT.rev=true;UT.catches=0;
    if(UT.gun){UT.gun.el.remove();UT.gun=null}
  }

  ov.textContent=msgs.join('\n');
  $('ut-phase-indicator').textContent='Phase '+to;

  setTimeout(function(){ov.classList.remove('on');UT.tp='player';utShowActs()},2000);
}

/* ‚îÄ‚îÄ‚îÄ CORE ‚îÄ‚îÄ‚îÄ */
function utStop(){
  UT.active=false;if(UT.raf){cancelAnimationFrame(UT.raf);UT.raf=null}
  if(UT.audio){UT.audio.pause();UT.audio=null}
  UT.keys={};
  var mid=$('ut-mid');if(mid)mid.style.transform='';
  var img=$('ut-opp-img');if(img)img.style.filter='';
  utRemoveHelper('ut-sans-float');utRemoveHelper('ut-pap-float');
  if(UT.sword){UT.sword.el.remove();UT.sword=null}
  if(UT.gun){UT.gun.el.remove();UT.gun=null}
  if(UT.laser){UT.laser.el.remove();UT.laser=null}
  $('ut-totem-overlay').classList.remove('on');
  var sut=$('S-ut');sut.classList.remove('ut-phase2','ut-phase3','ut-phase4');
  UT.rev=false;UT.wind=0;
}

function utStart(sd){
  utStop();
  UT.sd=sd;UT.diff=sd.utDiff||2;
  UT.mhp=92;UT.hp=92;
  UT.bmhp=sd.utBossHp||1500;UT.bhp=UT.bmhp;
  UT.phase=1;UT.tc=0;UT.atI=0;UT.fd=true;
  UT.proj=[];UT.bones=[];UT.beams=[];
  UT.tp='dialogue';UT.dlI=0;
  UT.abA=false;UT.inv=0;UT.moving=false;UT.spA=0;
  UT.shake=0;UT.bflash=0;UT.wind=0;UT.rev=false;UT.catches=0;
  UT.spd=[3,3.5,4.2][UT.diff-1];
  UT.sA=true;UT.sDied=false;UT.sans={x:0,y:0,tx:0,ty:0,mt:0,tt:3000,i:false};
  UT.pA=false;UT.pap={x:0,y:0,tx:0,ty:0,mt:0,tt:3000,i:false};
  UT.sword=null;UT.gun=null;UT.laser=null;
  UT.hcA=false;UT.cbHit=0;

  var ch=sd.bfChar?findChar(sd.bfChar):null;
  if(ch){$('ut-opp-img').src=ch.data;$('ut-opp-img').style.display='block';$('ut-opp-name').textContent=ch.name;UT.bn=ch.name}
  else{$('ut-opp-img').style.display='none';$('ut-opp-name').textContent='???';UT.bn='???'}

  scr('S-ut');
  $('ut-result').classList.remove('on');$('ut-atk-bar').classList.remove('show');
  $('ut-phase-indicator').textContent='Phase 1';
  $('ut-phase-overlay').classList.remove('on');

  utMakeHelper('ut-sans-float','üíÄ','sansFly');

  requestAnimationFrame(function(){requestAnimationFrame(function(){
    utSetupBox();utUpdateHp();
    utShowDlg(['* '+UT.bn+' –ø–æ—è–≤–ª—è–µ—Ç—Å—è!','* –ì–æ—Ç–æ–≤—å—Å—è –∫ –±–æ—é!']);
    utLoadAudio(sd.id);
    UT.active=true;UT.raf=requestAnimationFrame(utLoop);
  })});
}

function utSetupBox(){
  var mid=$('ut-mid');var r=mid.getBoundingClientRect();
  var sz=Math.min(r.width*0.6,r.height*0.85,300);
  UT.bw=sz;UT.bh=sz;
  $('ut-box').style.width=sz+'px';$('ut-box').style.height=sz+'px';
  UT.px=sz/2-9;UT.py=sz/2-9;UT.ppx=UT.px;UT.ppy=UT.py;
  $('ut-heart').style.left=UT.px+'px';$('ut-heart').style.top=UT.py+'px';
}

function utLoadAudio(id){fetch('/api/audio-check/'+id).then(function(r){return r.json()}).then(function(d){if(d.exists){UT.audio=new Audio('/api/audio/'+id);UT.audio.loop=true;UT.audio.volume=.5;UT.audio.play().catch(function(){})}}).catch(function(){})}

function utUpdateHp(){
  var p=Math.max(0,UT.hp/UT.mhp*100);
  $('ut-hp-fill').style.width=p+'%';
  $('ut-hp-fill').style.background=p>50?'#ff0':p>25?'#f90':'#f00';
  $('ut-hp-txt').textContent=Math.max(0,Math.ceil(UT.hp))+' / '+UT.mhp;
}

/* ‚îÄ‚îÄ‚îÄ DIALOGUE ‚îÄ‚îÄ‚îÄ */
function utShowDlg(lines,cb){
  UT.tp='dialogue';UT.dlg=lines||['...'];UT.dlI=0;UT.dlCb=cb||null;
  $('ut-dlg').textContent=UT.dlg[0];$('ut-dlg').classList.add('show');
  utHideActs();
}
function utAdvDlg(){
  UT.dlI++;
  if(UT.dlI>=UT.dlg.length){
    $('ut-dlg').classList.remove('show');
    if(UT.dlCb){var cb=UT.dlCb;UT.dlCb=null;cb()}
    else if(UT.tp==='dialogue'){UT.tp='player';utShowActs()}
  }else{$('ut-dlg').textContent=UT.dlg[UT.dlI]}
}
function utHideActs(){var a=document.querySelectorAll('.ut-act');for(var i=0;i<a.length;i++){a[i].style.opacity='.4';a[i].style.pointerEvents='none'}}
function utShowActs(){var a=document.querySelectorAll('.ut-act');for(var i=0;i<a.length;i++){a[i].style.opacity='1';a[i].style.pointerEvents='auto'}}

/* ‚îÄ‚îÄ‚îÄ FIGHT ‚îÄ‚îÄ‚îÄ */
function utAction(t){
  if(UT.tp!=='player')return;
  if(t==='fight'){
    utHideActs();UT.abA=true;UT.abX=0;UT.abD=1;
    $('ut-atk-bar').classList.add('show');
    var bar=$('ut-atk-bar');var bw=bar.offsetWidth;var zw=bw*0.15;
    $('ut-atk-zone').style.left=(bw-zw)/2+'px';$('ut-atk-zone').style.width=zw+'px';
  }
}
function utDoHit(){
  if(!UT.abA)return;UT.abA=false;$('ut-atk-bar').classList.remove('show');
  var bw=$('ut-atk-bar').offsetWidth||300;var zw=bw*0.15;var zx=(bw-zw)/2;
  var dist=Math.abs(UT.abX-(zx+zw/2));var mult=Math.max(0,1-dist/(bw/2));
  var base=UT.rev?5:[25,35,50][UT.diff-1]; // phase 4: minimal fight damage
  var dmg=Math.floor(base+base*2*mult*mult);
  if(mult>0.85)dmg=Math.floor(dmg*1.5);
  UT.bhp-=dmg;utShowDmgNum(dmg,mult>0.85);utBossFlash();
  if(UT.bhp<=0){UT.bhp=0;setTimeout(function(){utEnd(true)},800);return}
  utCheckPhase();
  setTimeout(function(){if(UT.active&&UT.tp!=='transition')utStartAtk()},1000);
}
function utBossFlash(){UT.bflash=300;var img=$('ut-opp-img');if(img)img.style.filter='brightness(3) saturate(0)'}
function utShowDmgNum(d,c){var e=$('ut-dmg');e.textContent=(c?'‚òÖ ':'')+d;e.style.color=c?'#ff0':'#fff';e.style.top='30%';e.style.left='50%';e.style.transform='translateX(-50%)';e.classList.remove('show');void e.offsetWidth;e.classList.add('show');setTimeout(function(){e.classList.remove('show')},800)}
function utShowTurn(t){var e=$('ut-turn-txt');e.textContent=t;e.classList.remove('show');void e.offsetWidth;e.classList.add('show');setTimeout(function(){e.classList.remove('show')},1200)}

/* ‚îÄ‚îÄ‚îÄ ATTACK MANAGEMENT ‚îÄ‚îÄ‚îÄ */
function utStartAtk(){
  UT.tp='attack';utHideActs();$('ut-dlg').classList.remove('show');
  utClearBox();UT.spA=0;UT.wind=0;
  UT.atT=performance.now();UT.atD=[5000,6500,8000][UT.diff-1];
  if(UT.phase>=2)UT.atD+=1500;
  if(UT.phase>=3)UT.atD+=2000;
  UT.tc++;UT.atI++;
  utShowTurn('–•–æ–¥ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞!');
}
function utEndAtk(){
  UT.tp='player';utClearBox();UT.wind=0;
  utShowActs();
  if(UT.tc%2===0&&UT.bhp>0){
    var d=['* ...','* –¢—ã —Å–∏–ª—ë–Ω...','* –ù–µ—Ç...'][Math.min(UT.phase-1,2)];
    utShowDlg([d]);
  }
}
function utClearBox(){
  UT.proj=[];UT.bones=[];UT.beams=[];
  var box=$('ut-box');var old=box.querySelectorAll('.ut-proj,.ut-bone,.ut-beam,.ut-bomb-warn,.ut-bomb-explode,.ut-hc-cell,.ut-knife,.ut-bullet,.ut-laser,.ut-reverse-hint');
  for(var i=0;i<old.length;i++)old[i].remove();
  UT.hcA=false;UT.hcC=null;
}

/* ‚îÄ‚îÄ‚îÄ SPAWN ATTACKS BY PHASE ‚îÄ‚îÄ‚îÄ */
function utSpawn(now){
  var iv=[500,350,220][UT.diff-1];
  UT.spA+=16;if(UT.spA<iv)return;UT.spA=0;

  if(UT.phase===4){utSpawnP4();return}

  // Papyrus converts 40% to orange
  var orangeConvert=UT.pA&&Math.random()<0.4;

  var pool=[];
  // Phase 1 patterns
  pool.push('boneH','boneV','projAim','blue','orange','circle','wave');
  // Phase 2 additions
  if(UT.phase>=2)pool.push('bomb','knife','knife');
  // Phase 3 additions
  if(UT.phase>=3)pool.push('wave','projAim','laserToggle');

  var pat=pool[Math.floor(Math.random()*pool.length)];

  if(orangeConvert&&(pat==='boneH'||pat==='boneV'||pat==='blue')){pat='orange'}

  switch(pat){
    case'boneH':utPatBoneH();break;case'boneV':utPatBoneV();break;
    case'projAim':utPatProj();break;case'blue':utPatBlue();break;
    case'orange':utPatOrange();break;case'circle':utPatCircle();break;
    case'wave':utPatWave();break;case'bomb':utPatBomb();break;
    case'knife':utPatKnife();break;case'laserToggle':utToggleLaser();break;
  }

  // Phase 2: occasional honeycomb
  if(UT.phase>=2&&!UT.hcA&&Math.random()<0.02)utPatHoneycomb();
  // Phase 3: wind gusts
  if(UT.phase>=3&&UT.wind===0&&Math.random()<0.01)utPatWind();
  // Beams
  if(UT.diff>=2&&(now-UT.atT)>3000&&Math.random()<0.002*UT.diff)utSpawnBeam();
}

/* ‚îÄ‚îÄ‚îÄ ATTACK PATTERNS ‚îÄ‚îÄ‚îÄ */
function utPatBoneH(){var gap=55+Math.random()*35;var gy=30+Math.random()*(UT.bh-gap-60);var l=Math.random()>0.5;var s=(l?1:-1)*[1.8,2.5,3.5][UT.diff-1];utAddBone(l?-20:UT.bw,0,20,gy,s,0,'white');utAddBone(l?-20:UT.bw,gy+gap,20,UT.bh-(gy+gap),s,0,'white')}
function utPatBoneV(){var gap=55+Math.random()*35;var gx=30+Math.random()*(UT.bw-gap-60);var t=Math.random()>0.5;var s=(t?1:-1)*[1.8,2.5,3.5][UT.diff-1];utAddBone(0,t?-20:UT.bh,gx,20,0,s,'white');utAddBone(gx+gap,t?-20:UT.bh,UT.bw-(gx+gap),20,0,s,'white')}
function utPatProj(){var cx=UT.px+9,cy=UT.py+9;var sd=Math.floor(Math.random()*4);var x,y;if(sd===0){x=Math.random()*UT.bw;y=-8}else if(sd===1){x=Math.random()*UT.bw;y=UT.bh+8}else if(sd===2){x=-8;y=Math.random()*UT.bh}else{x=UT.bw+8;y=Math.random()*UT.bh}var a=Math.atan2(cy-y,cx-x)+(Math.random()-0.5)*0.6;var sp=[1.8,2.5,3.5][UT.diff-1];utAddProj(x,y,Math.cos(a)*sp,Math.sin(a)*sp,5)}
function utPatBlue(){var l=Math.random()>0.5;var s=(l?1:-1)*[2,3,4][UT.diff-1];var n=[2,3,4][UT.diff-1];var sp=UT.bh/(n+1);for(var i=0;i<n;i++)utAddBone(l?-30:UT.bw+10,sp*(i+1)-10,25,20,s,0,'blue')}
function utPatOrange(){var t=Math.random()>0.5;var s=(t?1:-1)*[2,3,4][UT.diff-1];var n=[2,3,4][UT.diff-1];var sp=UT.bw/(n+1);for(var i=0;i<n;i++)utAddBone(sp*(i+1)-10,t?-30:UT.bh+10,20,25,0,s,'orange')}
function utPatCircle(){var cx=UT.bw/2,cy=UT.bh/2;var n=[5,7,10][UT.diff-1];var s=[1.5,2.2,3][UT.diff-1];var o=Math.random()*Math.PI*2;var ga=Math.random()*Math.PI*2;for(var i=0;i<n;i++){var a=o+i/n*Math.PI*2;var d=Math.abs(((a-ga)%(Math.PI*2)+Math.PI*3)%(Math.PI*2)-Math.PI);if(d<0.5)continue;utAddProj(cx,cy,Math.cos(a)*s,Math.sin(a)*s,4)}}
function utPatWave(){utAddProj(Math.random()*UT.bw,-8,0,[1.5,2.2,3][UT.diff-1],4)}

/* Phase 2: Bombs */
function utPatBomb(){
  var box=$('ut-box');var count=[2,3,5][UT.diff-1];
  for(var i=0;i<count;i++){
    var bx=20+Math.random()*(UT.bw-40);var by=20+Math.random()*(UT.bh-40);var r=20+Math.random()*15;
    var warn=document.createElement('div');warn.className='ut-bomb-warn';
    warn.style.left=(bx-r)+'px';warn.style.top=(by-r)+'px';warn.style.width=r*2+'px';warn.style.height=r*2+'px';
    box.appendChild(warn);
    (function(wx,wy,wr,wel){
      setTimeout(function(){
        if(wel.parentNode)wel.remove();
        var ex=document.createElement('div');ex.className='ut-bomb-explode';
        ex.style.left=(wx-wr)+'px';ex.style.top=(wy-wr)+'px';ex.style.width=wr*2+'px';ex.style.height=wr*2+'px';
        box.appendChild(ex);
        // damage check
        var hx=UT.px+9,hy=UT.py+9;var dd=Math.sqrt((hx-wx)*(hx-wx)+(hy-wy)*(hy-wy));
        if(dd<wr+5&&UT.inv<=0)utTakeDmg([5,8,12][UT.diff-1]);
        setTimeout(function(){if(ex.parentNode)ex.remove()},500);
      },1000);
    })(bx,by,r,warn);
  }
}

/* Phase 2: Knives */
function utPatKnife(){
  var box=$('ut-box');var fromTop=Math.random()>0.5;var count=[3,5,7][UT.diff-1];
  for(var i=0;i<count;i++){
    var x=Math.random()*UT.bw;
    var el=document.createElement('div');el.className='ut-knife'+(fromTop?'':' up');
    el.style.left=x+'px';el.style.top=(fromTop?-20:UT.bh+20)+'px';
    box.appendChild(el);
    var vy=(fromTop?1:-1)*[4,6,8][UT.diff-1];
    UT.proj.push({el:el,x:x,y:fromTop?-20:UT.bh+20,vx:0,vy:vy,r:6});
  }
}

/* Phase 2: Honeycomb */
function utPatHoneycomb(){
  if(UT.hcA)return;UT.hcA=true;
  var box=$('ut-box');var cols=3,rows=2;var cw=UT.bw/cols,ch=UT.bh/rows;
  UT.hcC=[];
  for(var r=0;r<rows;r++)for(var c=0;c<cols;c++){
    var el=document.createElement('div');el.className='ut-hc-cell safe';
    el.style.left=c*cw+'px';el.style.top=r*ch+'px';el.style.width=cw+'px';el.style.height=ch+'px';
    box.appendChild(el);
    UT.hcC.push({el:el,x:c*cw,y:r*ch,w:cw,h:ch,state:'safe',visited:false});
  }
  // shuffle order
  var order=[];for(var i=0;i<UT.hcC.length;i++)order.push(i);
  for(var i=order.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=order[i];order[i]=order[j];order[j]=t}
  UT.hcI=0;UT.hcT=performance.now();
  // drop cells sequentially
  function dropNext(){
    if(!UT.hcA||UT.hcI>=order.length-1)return; // leave last one
    var idx=order[UT.hcI];var cell=UT.hcC[idx];
    cell.el.classList.remove('safe');cell.el.classList.add('warn');
    setTimeout(function(){
      cell.el.classList.remove('warn');cell.el.classList.add('fall');cell.state='fallen';
      // damage if player on this cell
      var hx=UT.px+9,hy=UT.py+9;
      if(hx>=cell.x&&hx<cell.x+cell.w&&hy>=cell.y&&hy<cell.y+cell.h&&UT.inv<=0){utTakeDmg([5,8,12][UT.diff-1])}
      UT.hcI++;
      if(UT.hcI<order.length-1)setTimeout(dropNext,800);
      else setTimeout(function(){utClearHC()},1500);
    },600);
  }
  setTimeout(dropNext,500);
}
function utClearHC(){
  UT.hcA=false;
  if(UT.hcC){for(var i=0;i<UT.hcC.length;i++){if(UT.hcC[i].el.parentNode)UT.hcC[i].el.remove()}}
  UT.hcC=null;
}

/* Phase 3: Wind */
function utPatWind(){
  UT.wind=Math.random()>0.5?1:-1;
  // spawn knives from wind direction
  for(var i=0;i<[3,5,7][UT.diff-1];i++){
    var x=UT.wind>0?UT.bw+10:-10;var y=Math.random()*UT.bh;
    utAddProj(x,y,-UT.wind*[2,3,4][UT.diff-1],(Math.random()-0.5)*1.5,4);
  }
  setTimeout(function(){UT.wind=0},3000);
}

/* Phase 3: Laser bone */
function utToggleLaser(){
  var box=$('ut-box');
  if(!UT.laser){
    var el=document.createElement('div');el.className='ut-laser blue';
    el.style.left=Math.random()*(UT.bw-20)+'px';el.style.top=Math.random()*(UT.bh-20)+'px';
    box.appendChild(el);
    UT.laser={el:el,x:parseFloat(el.style.left),y:parseFloat(el.style.top),color:'blue',timer:0,moveTimer:0};
  }else{
    // toggle color
    UT.laser.color=UT.laser.color==='blue'?'orange':'blue';
    UT.laser.el.classList.remove('blue','orange');
    UT.laser.el.classList.add(UT.laser.color);
  }
}

/* Phase 2: Sword entity */
function utCreateSword(){
  var box=$('ut-box');var el=document.createElement('div');el.className='ut-sword';el.textContent='‚öîÔ∏è';
  el.style.left=UT.bw/2+'px';el.style.top='10px';
  box.appendChild(el);
  UT.sword={el:el,x:UT.bw/2,y:10,vx:1.5,vy:1.2,lunge:0,lt:2000};
}

/* Phase 3: Gun entity */
function utCreateGun(){
  var box=$('ut-box');var el=document.createElement('div');el.className='ut-gun';el.textContent='üî´';
  el.style.left=UT.bw-30+'px';el.style.top=UT.bh-30+'px';
  box.appendChild(el);
  UT.gun={el:el,x:UT.bw-30,y:UT.bh-30,st:0};
}

/* ‚îÄ‚îÄ‚îÄ Phase 4: Reverse ‚Äî slow projectiles, catch them ‚îÄ‚îÄ‚îÄ */
function utSpawnP4(){
  // slow projectiles from edges
  if(Math.random()<0.03){
    var sd=Math.floor(Math.random()*4);var x,y,vx,vy;
    if(sd===0){x=Math.random()*UT.bw;y=-8;vx=0;vy=1}
    else if(sd===1){x=Math.random()*UT.bw;y=UT.bh+8;vx=0;vy=-1}
    else if(sd===2){x=-8;y=Math.random()*UT.bh;vx=1;vy=0}
    else{x=UT.bw+8;y=Math.random()*UT.bh;vx=-1;vy=0}
    var el=document.createElement('div');el.className='ut-proj';
    el.style.width='12px';el.style.height='12px';el.style.background='#ff0';el.style.borderRadius='50%';
    el.style.left=(x-6)+'px';el.style.top=(y-6)+'px';el.style.boxShadow='0 0 8px #ff0';
    $('ut-box').appendChild(el);
    UT.proj.push({el:el,x:x,y:y,vx:vx,vy:vy,r:6,golden:true});
  }
  // hint
  if(!document.querySelector('.ut-reverse-hint')){
    var h=document.createElement('div');h.className='ut-reverse-hint';h.textContent='‚òÖ –õ–û–í–ò –°–ù–ê–†–Ø–î–´! ‚òÖ';
    $('ut-box').appendChild(h);
  }
}

/* ‚îÄ‚îÄ‚îÄ ADD ENTITIES ‚îÄ‚îÄ‚îÄ */
function utAddBone(x,y,w,h,vx,vy,col){
  var el=document.createElement('div');el.className='ut-bone';
  el.style.left=x+'px';el.style.top=y+'px';el.style.width=Math.max(4,w)+'px';el.style.height=Math.max(4,h)+'px';
  if(col==='blue'){el.style.background='#42a5f5';el.style.boxShadow='0 0 8px #42a5f5'}
  else if(col==='orange'){el.style.background='#ffa726';el.style.boxShadow='0 0 8px #ffa726'}
  else{el.style.background='#fff'}
  $('ut-box').appendChild(el);
  UT.bones.push({el:el,x:x,y:y,w:w,h:h,vx:vx,vy:vy,color:col||'white'});
}
function utAddProj(x,y,vx,vy,r){
  var el=document.createElement('div');el.className='ut-proj';
  el.style.width=r*2+'px';el.style.height=r*2+'px';el.style.background='#fff';
  el.style.left=(x-r)+'px';el.style.top=(y-r)+'px';el.style.borderRadius='50%';
  $('ut-box').appendChild(el);
  UT.proj.push({el:el,x:x,y:y,vx:vx,vy:vy,r:r});
}
function utSpawnBeam(){var h=Math.random()>0.5;var p=20+Math.random()*((h?UT.bh:UT.bw)-40);var el=document.createElement('div');el.className='ut-beam';var box=$('ut-box');if(h){el.style.left='0';el.style.width='100%';el.style.top=p+'px';el.style.height='20px'}else{el.style.top='0';el.style.height='100%';el.style.left=p+'px';el.style.width='20px'}box.appendChild(el);el.classList.add('warn');setTimeout(function(){el.classList.remove('warn');el.classList.add('fire');UT.beams.push({el:el,horiz:h,pos:p})},1000);setTimeout(function(){el.classList.remove('fire');setTimeout(function(){if(el.parentNode)el.remove()},200);UT.beams=UT.beams.filter(function(b){return b.el!==el})},1600)}

/* ‚îÄ‚îÄ‚îÄ MAIN LOOP ‚îÄ‚îÄ‚îÄ */
function utLoop(){
  if(!UT.active)return;
  var now=performance.now();
  if(UT.inv>0)UT.inv-=16;

  var dx=UT.px-UT.ppx,dy=UT.py-UT.ppy;
  UT.moving=Math.abs(dx)>0.3||Math.abs(dy)>0.3;
  UT.ppx=UT.px;UT.ppy=UT.py;

  if(UT.tp==='attack'){
    utMoveHeart();
    utSpawn(now);
    utMoveProj();utMoveBones();
    utUpdateSword();utUpdateGun();utUpdateLaser();
    if(UT.rev)utCheckReverse();else utCheckCol();
    utCheckBeams();
    if(now-UT.atT>UT.atD)utEndAtk();
  }else if(UT.tp==='player'){
    if(UT.abA)utMoveAtkCur();
  }

  // helpers
  var R=$('S-ut').getBoundingClientRect();
  var bounds={l:R.left,t:R.top,w:R.width,h:R.height};
  if(UT.sA)utUpdateHelper(UT.sans,'ut-sans-float',bounds,SP.sIdle,function(ph){
    if(Math.random()>0.5){utAddProj(Math.random()*UT.bw,-10,(Math.random()-0.5)*0.8,[1.5,2,3][UT.diff-1],4);utHelperTxt('ut-sans-float',rp(SP.sThrow))}
    else{var d=5+Math.floor(Math.random()*15);UT.bhp=Math.max(0,UT.bhp-d);utBossFlash();utHelperTxt('ut-sans-float',rp(SP.sThrow)+' -'+d);if(UT.bhp<=0)setTimeout(function(){utEnd(true)},800);utCheckPhase()}
  });
  if(UT.pA)utUpdateHelper(UT.pap,'ut-pap-float',bounds,SP.pIdle,function(ph){
    // Papyrus throws orange bones
    utPatOrange();utHelperTxt('ut-pap-float',rp(SP.pThrow));
  });

  // boss flash
  if(UT.bflash>0){UT.bflash-=16;if(UT.bflash<=0){UT.bflash=0;var img=$('ut-opp-img');if(img)img.style.filter=''}}
  // shake
  if(UT.shake>0){UT.shake-=16;var mid=$('ut-mid');if(mid)mid.style.transform='translate('+(Math.random()-0.5)*6+'px,'+(Math.random()-0.5)*6+'px)';if(UT.shake<=0&&mid)mid.style.transform=''}

  utUpdateHp();
  if(UT.hp<=0){
    if(UT.fd&&UT.sA){
      // First death ‚Üí totem
      UT.fd=false;UT.hp=1;
      utTotem(function(){UT.tp='player';utShowActs()});
    }else{utEnd(false)}
    UT.raf=requestAnimationFrame(utLoop);return;
  }
  UT.raf=requestAnimationFrame(utLoop);
}

/* ‚îÄ‚îÄ‚îÄ MOVEMENT ‚îÄ‚îÄ‚îÄ */
function utMoveHeart(){
  var s=UT.spd,k=UT.keys;
  if(k.ArrowLeft||k.KeyA||k.a||k['—Ñ'])UT.px-=s;
  if(k.ArrowRight||k.KeyD||k.d||k['–≤'])UT.px+=s;
  if(k.ArrowUp||k.KeyW||k.w||k['—Ü'])UT.py-=s;
  if(k.ArrowDown||k.KeyS||k.s||k['—ã'])UT.py+=s;
  // wind push
  if(UT.wind)UT.px+=UT.wind*[1,1.5,2][UT.diff-1];
  UT.px=Math.max(0,Math.min(UT.bw-18,UT.px));
  UT.py=Math.max(0,Math.min(UT.bh-18,UT.py));
  $('ut-heart').style.left=UT.px+'px';$('ut-heart').style.top=UT.py+'px';
  $('ut-heart').style.opacity=(UT.inv>0&&Math.floor(UT.inv/50)%2===0)?'0.3':'1';
}
function utMoveProj(){for(var i=UT.proj.length-1;i>=0;i--){var p=UT.proj[i];p.x+=p.vx;p.y+=p.vy;p.el.style.left=(p.x-p.r)+'px';p.el.style.top=(p.y-p.r)+'px';if(p.x<-40||p.x>UT.bw+40||p.y<-40||p.y>UT.bh+40){p.el.remove();UT.proj.splice(i,1)}}}
function utMoveBones(){for(var i=UT.bones.length-1;i>=0;i--){var b=UT.bones[i];b.x+=b.vx;b.y+=b.vy;b.el.style.left=b.x+'px';b.el.style.top=b.y+'px';if(b.x<-100||b.x>UT.bw+100||b.y<-100||b.y>UT.bh+100){b.el.remove();UT.bones.splice(i,1)}}}

/* ‚îÄ‚îÄ‚îÄ SWORD (Phase 2) ‚îÄ‚îÄ‚îÄ */
function utUpdateSword(){
  if(!UT.sword||UT.phase<2||UT.phase>=3)return;
  var sw=UT.sword;
  sw.lt-=16;
  if(sw.lt<=0&&sw.lunge===0){
    // lunge toward player
    sw.lunge=1;
    var ang=Math.atan2(UT.py+9-sw.y,UT.px+9-sw.x);
    sw.vx=Math.cos(ang)*[5,7,9][UT.diff-1];
    sw.vy=Math.sin(ang)*[5,7,9][UT.diff-1];
    setTimeout(function(){sw.lunge=0;sw.lt=1500+Math.random()*1500;sw.vx=1.5*(Math.random()>0.5?1:-1);sw.vy=1.2*(Math.random()>0.5?1:-1)},400);
  }
  sw.x+=sw.vx;sw.y+=sw.vy;
  if(sw.x<0||sw.x>UT.bw-28){sw.vx*=-1;sw.x=Math.max(0,Math.min(UT.bw-28,sw.x))}
  if(sw.y<0||sw.y>UT.bh-28){sw.vy*=-1;sw.y=Math.max(0,Math.min(UT.bh-28,sw.y))}
  sw.el.style.left=sw.x+'px';sw.el.style.top=sw.y+'px';
  // collision
  if(UT.inv<=0){var dx=UT.px+9-sw.x-14,dy=UT.py+9-sw.y-14;if(Math.sqrt(dx*dx+dy*dy)<20)utTakeDmg([8,12,16][UT.diff-1])}
}

/* ‚îÄ‚îÄ‚îÄ GUN (Phase 3) ‚îÄ‚îÄ‚îÄ */
function utUpdateGun(){
  if(!UT.gun||UT.phase<3||UT.phase>=4)return;
  var g=UT.gun;g.st-=16;
  if(g.st<=0){
    g.st=[600,400,250][UT.diff-1];
    // shoot bullet at player
    var ang=Math.atan2(UT.py+9-g.y,UT.px+9-g.x)+(Math.random()-0.5)*0.3;
    var bel=document.createElement('div');bel.className='ut-bullet';
    bel.style.left=g.x+'px';bel.style.top=g.y+'px';
    $('ut-box').appendChild(bel);
    UT.proj.push({el:bel,x:g.x,y:g.y,vx:Math.cos(ang)*[3,4,5.5][UT.diff-1],vy:Math.sin(ang)*[3,4,5.5][UT.diff-1],r:3});
  }
}

/* ‚îÄ‚îÄ‚îÄ LASER BONE (Phase 3) ‚îÄ‚îÄ‚îÄ */
function utUpdateLaser(){
  if(!UT.laser)return;
  var L=UT.laser;L.moveTimer-=16;
  if(L.moveTimer<=0){
    L.moveTimer=2000+Math.random()*1500;
    L.x=Math.random()*(UT.bw-20);L.y=Math.random()*(UT.bh-20);
    L.el.style.left=L.x+'px';L.el.style.top=L.y+'px';
  }
  L.timer-=16;
  if(L.timer<=0){
    L.timer=1500+Math.random()*1000;
    L.color=L.color==='blue'?'orange':'blue';
    L.el.classList.remove('blue','orange');L.el.classList.add(L.color);
  }
  // collision
  if(UT.inv<=0){
    var hx=UT.px+4,hy=UT.py+4;
    if(hx<L.x+20&&hx+10>L.x&&hy<L.y+20&&hy+10>L.y){
      if(L.color==='blue'&&UT.moving){utTakeDmg([5,8,12][UT.diff-1]);utCBhit()}
      else if(L.color==='orange'&&!UT.moving){utTakeDmg([5,8,12][UT.diff-1]);utCBhit()}
    }
  }
}

/* ‚îÄ‚îÄ‚îÄ COLLISIONS ‚îÄ‚îÄ‚îÄ */
function utCheckCol(){
  if(UT.inv>0)return;
  var hx=UT.px+4,hy=UT.py+4,hw=10,hh=10,dmg=[5,8,12][UT.diff-1];
  for(var i=0;i<UT.proj.length;i++){var p=UT.proj[i];if(p.golden)continue;var dx=hx+hw/2-p.x,dy=hy+hh/2-p.y;if(Math.sqrt(dx*dx+dy*dy)<p.r+5){utTakeDmg(dmg);return}}
  for(var i=0;i<UT.bones.length;i++){var b=UT.bones[i];if(hx<b.x+b.w&&hx+hw>b.x&&hy<b.y+b.h&&hy+hh>b.y){
    if(b.color==='blue'){if(UT.moving){utTakeDmg(dmg);utCBhit();return}}
    else if(b.color==='orange'){if(!UT.moving){utTakeDmg(dmg);utCBhit();return}}
    else{utTakeDmg(dmg);return}
  }}
}
function utCheckBeams(){if(UT.inv>0)return;var hx=UT.px+4,hy=UT.py+4,dmg=[8,12,18][UT.diff-1];for(var i=0;i<UT.beams.length;i++){var b=UT.beams[i];if(b.horiz){if(hy>b.pos-5&&hy<b.pos+25){utTakeDmg(dmg);return}}else{if(hx>b.pos-5&&hx<b.pos+25){utTakeDmg(dmg);return}}}}

/* ‚îÄ‚îÄ‚îÄ PHASE 4: REVERSE COLLISIONS ‚îÄ‚îÄ‚îÄ */
function utCheckReverse(){
  if(UT.inv>0)return;
  var hx=UT.px+4,hy=UT.py+4,hw=10,hh=10;
  for(var i=UT.proj.length-1;i>=0;i--){
    var p=UT.proj[i];var dx=hx+hw/2-p.x,dy=hy+hh/2-p.y;
    if(Math.sqrt(dx*dx+dy*dy)<p.r+8){
      // CATCH! Deflect to boss
      p.el.remove();UT.proj.splice(i,1);
      UT.catches++;
      var deflDmg=15+Math.floor(Math.random()*20);
      UT.bhp=Math.max(0,UT.bhp-deflDmg);
      utBossFlash();utShowDmgNum(deflDmg,true);
      // skeleton reaction
      var who=UT.catches%2===0;
      if(UT.sA)utHelperTxt('ut-sans-float',who?'—Ö–µ—Ö! -'+deflDmg:'–µ—â—ë!');
      if(UT.pA)utHelperTxt('ut-pap-float',who?'':'–ù–¨–ï–•–ï–•–ï! -'+deflDmg);
      UT.shake=100;
      if(UT.bhp<=0){setTimeout(function(){utEnd(true)},800)}
      utCheckPhase();
      return;
    }
  }
  // white bones still hurt in phase 4
  for(var i=0;i<UT.bones.length;i++){var b=UT.bones[i];if(b.color!=='white')continue;if(hx<b.x+b.w&&hx+hw>b.x&&hy<b.y+b.h&&hy+hh>b.y){utTakeDmg([3,5,7][UT.diff-1]);return}}
}

function utCBhit(){
  if(performance.now()-UT.cbHit<3000)return;UT.cbHit=performance.now();
  if(UT.sA)utHelperTxt('ut-sans-float',rp(SP.sCbHit));
  else if(UT.pA)utHelperTxt('ut-pap-float',rp(SP.pCbHit));
}

function utTakeDmg(d){UT.hp-=d;UT.inv=1000;UT.shake=250;utUpdateHp()}
function utMoveAtkCur(){var bw=$('ut-atk-bar').offsetWidth||300;var sp=[4,6,9][UT.diff-1];UT.abX+=sp*UT.abD;if(UT.abX>=bw){UT.abX=bw;UT.abD=-1}if(UT.abX<=0){UT.abX=0;UT.abD=1}$('ut-atk-cursor').style.left=UT.abX+'px'}

function utEnd(won){
  utStop();$('ut-result').classList.add('on');
  $('ut-res-title').textContent=won?'* YOU WON!':'* YOU DIED';
  $('ut-res-title').className=won?'win':'lose';
  $('ut-res-stats').innerHTML='HP: '+Math.ceil(Math.max(0,UT.hp))+'/'+UT.mhp
    +'<br>Boss HP: '+Math.ceil(Math.max(0,UT.bhp))+'/'+UT.bmhp
    +'<br>Phase: '+UT.phase
    +(UT.rev?'<br>Catches: '+UT.catches:'')
    +'<br>Turns: '+UT.tc;
  var btn=$('ut-res-btn'),sc=UT.sd;
  if(won){btn.textContent='* Continue';btn.onclick=function(){$('ut-result').classList.remove('on');if(sc&&sc.next){scr('S-game');gameLoad(sc.next)}else{scr('S-game');gameEnd()}}}
  else{btn.textContent='* Try Again';btn.onclick=function(){$('ut-result').classList.remove('on');utStart(sc)}}
}

/* ‚ïê‚ïê‚ïê GLOBAL CONTROLS ‚ïê‚ïê‚ïê */
document.addEventListener('keydown',function(e){
  // FNF
  if(BF.active){if(e.key==='ArrowLeft'||e.code==='KeyA')bfHit(0);else if(e.key==='ArrowDown'||e.code==='KeyS')bfHit(1);else if(e.key==='ArrowUp'||e.code==='KeyW')bfHit(2);else if(e.key==='ArrowRight'||e.code==='KeyD')bfHit(3)}
  // UT
  UT.keys[e.key]=true;UT.keys[e.code]=true;
  if(UT.active){
    if(UT.tp==='dialogue'&&(e.key==='z'||e.key==='Enter'||e.key===' '||e.key==='—è'))utAdvDlg();
    if(UT.abA&&(e.key==='z'||e.key==='Enter'||e.key===' '||e.key==='—è'))utDoHit();
  }
  // Dino
  if(DG.active&&(e.code==='Space'||e.code==='ArrowUp'||e.code==='KeyW')){e.preventDefault();dinoJump()}
});
document.addEventListener('keyup',function(e){UT.keys[e.key]=false;UT.keys[e.code]=false});
document.addEventListener('click',function(e){if(!UT.active)return;if(UT.tp==='dialogue')utAdvDlg();else if(UT.abA)utDoHit()});
(function(){var tx=0,ty=0,t=false;document.addEventListener('touchstart',function(e){if(!UT.active||UT.tp!=='attack')return;t=true;tx=e.touches[0].clientX;ty=e.touches[0].clientY});document.addEventListener('touchmove',function(e){if(!t||!UT.active||UT.tp!=='attack')return;e.preventDefault();var c=e.touches[0];UT.px+=c.clientX-tx;UT.py+=c.clientY-ty;UT.px=Math.max(0,Math.min(UT.bw-18,UT.px));UT.py=Math.max(0,Math.min(UT.bh-18,UT.py));tx=c.clientX;ty=c.clientY},{passive:false});document.addEventListener('touchend',function(){t=false})})();

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
(function(){
  if(window.Telegram&&Telegram.WebApp){Telegram.WebApp.ready();Telegram.WebApp.expand()}
  loadData().then(function(){updateMenu();$('loader').classList.add('hide');setTimeout(function(){$('loader').style.display='none'},600)});
})();
</script>
</body>
</html>





