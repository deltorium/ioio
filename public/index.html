<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<title>Visual Novel</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0b0b1a;--card:#161630;--inp:#101028;
  --acc:#e94560;--acc2:#ff6b81;--txt:#eaeaea;--sub:#7878a0;
  --brd:#2a2a50;--ok:#4ecca3;--bad:#e94560
}
html,body{width:100%;height:100%;overflow:hidden;
  font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
  background:var(--bg);color:var(--txt);user-select:none;touch-action:manipulation}

#rotate{display:none;position:fixed;inset:0;background:var(--bg);z-index:9999;
  flex-direction:column;align-items:center;justify-content:center;gap:20px}
#rotate .ri{font-size:56px;animation:rr 2s ease-in-out infinite}
@keyframes rr{0%,100%{transform:rotate(0)}50%{transform:rotate(90deg)}}
#rotate p{font-size:17px;color:var(--sub)}
@media(orientation:portrait)and(max-width:900px){
  #rotate{display:flex}#app{display:none!important}}

#loader{position:fixed;inset:0;background:var(--bg);z-index:9998;
  display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;transition:opacity .5s}
.spinner{width:42px;height:42px;border:3px solid var(--brd);border-top-color:var(--acc);
  border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#loader.hide{opacity:0;pointer-events:none}

#app{width:100vw;height:100vh;position:relative}
.scr{display:none;position:absolute;inset:0}.scr.on{display:flex}

/* ‚ïê‚ïê‚ïê MENU ‚ïê‚ïê‚ïê */
#S-menu{flex-direction:column;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#0b0b1a 0%,#161630 40%,#1a1040 100%);gap:20px}
#m-title{font-size:clamp(26px,5vw,58px);font-weight:900;letter-spacing:3px;text-align:center;
  text-transform:uppercase;padding:0 20px;
  background:linear-gradient(135deg,var(--acc),var(--acc2),var(--acc));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  animation:glo 3s ease-in-out infinite}
@keyframes glo{0%,100%{filter:brightness(1)}50%{filter:brightness(1.4)}}
#menu-status{text-align:center;margin:10px 0;min-height:24px}
#menu-status .st-ok{color:var(--ok);font-size:14px}
#menu-status .st-no{color:var(--bad);font-size:14px}
.bplay{padding:16px 64px;font-size:20px;font-weight:700;background:var(--acc);color:#fff;
  border:none;border-radius:50px;cursor:pointer;transition:.3s;letter-spacing:2px;text-transform:uppercase}
.bplay:hover{background:var(--acc2);transform:scale(1.05);box-shadow:0 0 40px rgba(233,69,96,.4)}
.bplay:disabled{opacity:.4;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.bgear{position:absolute;top:14px;right:14px;width:44px;height:44px;
  background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);border-radius:12px;
  color:var(--sub);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.3s}
.bgear:hover{background:rgba(255,255,255,.15);color:var(--txt)}

/* ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:1000;
  align-items:center;justify-content:center;backdrop-filter:blur(6px)}
.modal.on{display:flex}
.mbox{background:var(--card);border:1px solid var(--brd);border-radius:16px;
  padding:28px;min-width:300px;max-width:92vw;max-height:90vh;overflow-y:auto}
.mbox h2{margin-bottom:18px;font-size:19px;display:flex;align-items:center;justify-content:space-between}
.mx{background:0;border:0;color:var(--sub);font-size:22px;cursor:pointer;padding:4px}
.mx:hover{color:var(--txt)}
.mlg{width:90vw;max-width:820px}
.fg{margin-bottom:15px}
.fg label{display:block;font-size:11px;color:var(--sub);margin-bottom:5px;
  font-weight:600;text-transform:uppercase;letter-spacing:.8px}
.fg input,.fg textarea,.fg select{width:100%;padding:10px 13px;background:var(--inp);
  border:1px solid var(--brd);border-radius:8px;color:var(--txt);font-size:14px;outline:0;font-family:inherit}
.fg input:focus,.fg textarea:focus,.fg select:focus{border-color:var(--acc)}
.fg textarea{min-height:60px;resize:vertical}
.fg select{cursor:pointer}
.ipv{width:100%;max-height:130px;object-fit:contain;border-radius:8px;margin-top:8px;background:var(--inp)}
.fbtn{display:inline-block;padding:8px 20px;background:rgba(255,255,255,.08);
  border:1px solid var(--brd);border-radius:8px;color:var(--txt);font-size:14px;cursor:pointer;transition:.3s}
.fbtn:hover{background:rgba(255,255,255,.15)}
.bp{padding:10px 24px;background:var(--acc);color:#fff;border:0;border-radius:8px;font-size:14px;cursor:pointer;transition:.3s}
.bp:hover{background:var(--acc2)}
.bs{padding:10px 24px;background:rgba(255,255,255,.08);color:var(--txt);
  border:1px solid var(--brd);border-radius:8px;font-size:14px;cursor:pointer;transition:.3s}
.bs:hover{background:rgba(255,255,255,.14)}
.bd{padding:10px 24px;background:0;color:var(--bad);border:1px solid var(--bad);
  border-radius:8px;font-size:14px;cursor:pointer;transition:.3s}
.bd:hover{background:var(--bad);color:#fff}
.brow{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.err-msg{color:var(--bad);font-size:13px;margin-top:-8px;margin-bottom:10px}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GAME SCREEN
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#S-game{
  position:relative;
  /* –Ω–µ flex! –ø—Ä–æ—Å—Ç–æ block —á—Ç–æ–±—ã absolute –¥–µ—Ç–∏ —Ä–∞–±–æ—Ç–∞–ª–∏ */
  display:none;
}
#S-game.on{
  display:block !important;
}

/* —Ñ–æ–Ω ‚Äî –∑–∞–ø–æ–ª–Ω—è–µ—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
#g-bg{
  position:absolute;
  top:0;left:0;right:0;bottom:0;
  z-index:1;
  background-color:#1a1a3e;
  background-size:cover;
  background-position:center;
}

/* –ø–µ—Ä—Å–æ–Ω–∞–∂ */
#g-char{
  position:absolute;
  bottom:0;
  z-index:2;
  height:75%;
  max-width:40%;
  object-fit:contain;
  pointer-events:none;
  display:none;
}
#g-char.vis{display:block}
#g-char.pl{left:3%}
#g-char.pc{left:50%;transform:translateX(-50%)}
#g-char.pr{right:3%;left:auto}

/* ‚îÄ‚îÄ‚îÄ DIALOGUE BOX ‚îÄ‚îÄ‚îÄ */
#g-dlg{
  position:absolute;
  bottom:0;
  left:0;
  right:0;
  z-index:10;
  /* SOLID background ‚Äî –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ –∑–∞–º–µ—Ç–∏—Ç—å */
  background-color:#0a0a24;
  border-top:3px solid #e94560;
  min-height:140px;
  padding:20px 30px 18px;
  cursor:pointer;
}

#g-name{
  display:inline-block;
  padding:4px 16px;
  background:#e94560;
  border-radius:6px;
  font-size:16px;
  font-weight:700;
  color:#ffffff;
  margin-bottom:8px;
}
#g-name:empty{display:none}

#g-txt{
  font-size:17px;
  line-height:1.7;
  color:#ffffff;
  white-space:pre-wrap;
  min-height:40px;
}

#g-ind{
  position:absolute;
  bottom:10px;
  right:20px;
  color:rgba(255,255,255,.4);
  font-size:14px;
  animation:bk 1.4s infinite;
}
@keyframes bk{0%,100%{opacity:1}50%{opacity:.2}}

/* –≤—ã–±–æ—Ä—ã */
#g-choices{
  position:absolute;
  top:0;left:0;right:0;bottom:0;
  z-index:20;
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:12px;
  background:rgba(0,0,0,.6);
}
#g-choices.on{display:flex}
.chb{
  padding:14px 44px;min-width:260px;max-width:80%;
  background:rgba(20,20,50,.95);border:2px solid var(--acc);border-radius:12px;
  color:#fff;font-size:16px;cursor:pointer;transition:.3s;text-align:center;
}
.chb:hover{background:var(--acc);transform:scale(1.03)}

/* –∫–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ */
.bbk{
  position:absolute;top:10px;left:10px;z-index:30;padding:8px 18px;
  background:rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.3);border-radius:8px;
  color:#fff;font-size:13px;cursor:pointer;
}
.bbk:hover{background:rgba(0,0,0,.9)}

/* –∫–æ–Ω–µ—Ü */
#g-end{
  position:absolute;top:0;left:0;right:0;bottom:0;
  z-index:25;display:none;flex-direction:column;
  align-items:center;justify-content:center;background:rgba(0,0,0,.88);gap:30px;
}
#g-end.on{display:flex}
#g-end h2{font-size:clamp(28px,4vw,48px);color:var(--acc)}

/* –æ—Ç–ª–∞–¥–∫–∞ */
#g-debug{
  position:absolute;top:10px;right:60px;z-index:30;
  background:rgba(0,0,0,.85);color:#00ff00;font-size:12px;
  padding:8px 14px;border-radius:8px;font-family:monospace;
  max-width:400px;word-break:break-all;
  border:1px solid #00ff00;
  white-space:pre-wrap;
}

/* ‚ïê‚ïê‚ïê DEV PANEL ‚ïê‚ïê‚ïê */
#S-dev{flex-direction:column;background:var(--bg)}
.dh{display:flex;align-items:center;padding:10px 18px;background:var(--card);
  border-bottom:1px solid var(--brd);gap:14px;flex-shrink:0}
.dh h1{font-size:17px;flex:1}
.dtabs{display:flex;background:var(--card);border-bottom:1px solid var(--brd);flex-shrink:0;overflow-x:auto}
.dt{padding:11px 20px;font-size:13px;color:var(--sub);cursor:pointer;
  border-bottom:2px solid transparent;transition:.3s;white-space:nowrap}
.dt:hover{color:var(--txt);background:rgba(255,255,255,.04)}
.dt.on{color:var(--acc);border-bottom-color:var(--acc)}
.dc{flex:1;overflow-y:auto;padding:20px}
.dgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:15px}
.dcard{background:var(--card);border:1px solid var(--brd);border-radius:12px;overflow:hidden;
  cursor:pointer;transition:.3s}
.dcard:hover{border-color:var(--acc);transform:translateY(-2px);box-shadow:0 4px 18px rgba(233,69,96,.18)}
.dcimg{width:100%;height:115px;background:var(--inp);background-size:cover;background-position:center}
.dcinf{padding:11px}
.dcn{font-size:14px;font-weight:600;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dcs{font-size:12px;color:var(--sub)}
.dcadd{display:flex;align-items:center;justify-content:center;min-height:165px;
  border-style:dashed;flex-direction:column;gap:8px}
.dcadd .ico{font-size:34px;color:var(--sub)}
.dcadd span{font-size:13px;color:var(--sub)}
.dcard.start{border-color:var(--ok)}
.dcard.start .dcs{color:var(--ok)}
.steps{display:flex;flex-direction:column;gap:12px;margin-top:10px}
.si{background:var(--inp);border:1px solid var(--brd);border-radius:10px;padding:14px}
.sih{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.sin{font-size:12px;color:var(--acc);font-weight:700;text-transform:uppercase}
.sia{display:flex;gap:5px}
.sia button{width:27px;height:27px;background:rgba(255,255,255,.07);border:1px solid var(--brd);
  border-radius:6px;color:var(--sub);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.sia button:hover{background:rgba(255,255,255,.14);color:var(--txt)}
.sf{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.sf .fw{grid-column:1/-1}
.sf label{font-size:11px;color:var(--sub);margin-bottom:4px;display:block}
.sf input,.sf textarea,.sf select{width:100%;padding:8px 10px;background:var(--bg);
  border:1px solid var(--brd);border-radius:6px;color:var(--txt);font-size:13px;outline:0;font-family:inherit}
.sf textarea{min-height:48px;resize:vertical}
.csec{margin-top:10px;padding-top:10px;border-top:1px solid var(--brd)}
.crow{display:flex;gap:7px;margin-bottom:8px;align-items:center}
.crow input{flex:1}
.crow select{width:130px}
.crow input,.crow select{padding:7px 9px;background:var(--bg);border:1px solid var(--brd);
  border-radius:6px;color:var(--txt);font-size:12px;outline:0}
.crow button{width:27px;height:27px;background:rgba(233,69,96,.15);border:1px solid var(--bad);
  border-radius:6px;color:var(--bad);cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:13px;flex-shrink:0}
.cbtog{display:flex;align-items:center;gap:8px;margin-top:10px}
.cbtog input[type=checkbox]{width:17px;height:17px;accent-color:var(--acc)}
.cbtog label{font-size:13px;color:var(--txt);margin:0;cursor:pointer}
.bsm{padding:5px 13px;background:rgba(255,255,255,.07);border:1px solid var(--brd);
  border-radius:6px;color:var(--sub);font-size:12px;cursor:pointer;margin-top:6px}
.bsm:hover{background:rgba(255,255,255,.14);color:var(--txt)}
.setsec{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:20px;margin-bottom:16px}
.setsec h3{font-size:16px;margin-bottom:12px}

#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(100px);
  padding:14px 28px;border-radius:10px;font-size:15px;font-weight:600;z-index:5000;
  transition:transform .3s;pointer-events:none;max-width:90vw;text-align:center}
#toast.show{transform:translateX(-50%) translateY(0)}

::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:0}
::-webkit-scrollbar-thumb{background:var(--brd);border-radius:3px}
</style>
</head>
<body>

<div id="rotate"><div class="ri">üì±</div><p>–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ</p></div>

<div id="loader">
  <div class="spinner"></div>
  <div style="color:var(--sub);font-size:15px">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
</div>

<div id="app">

<div id="S-menu" class="scr on">
  <button class="bgear" onclick="openCode()">üîß</button>
  <h1 id="m-title">–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ</h1>
  <div id="menu-status"></div>
  <button class="bplay" id="btn-play" onclick="startGame()">–ò–≥—Ä–∞—Ç—å</button>
</div>

<div id="S-game" class="scr">
  <div id="g-bg"></div>
  <img id="g-char" src="" alt="">
  <div id="g-dlg" onclick="advance()">
    <div id="g-name"></div>
    <div id="g-txt">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="g-ind">‚ñº</div>
  </div>
  <div id="g-choices"></div>
  <div id="g-end">
    <h2>–ö–æ–Ω–µ—Ü</h2>
    <button class="bplay" onclick="toMenu()" style="font-size:16px;padding:12px 44px">–í –º–µ–Ω—é</button>
  </div>
  <button class="bbk" onclick="toMenu()">‚Üê –ú–µ–Ω—é</button>
  <div id="g-debug"></div>
</div>

<div id="S-dev" class="scr">
  <div class="dh">
    <button class="bs" onclick="toMenu()" style="padding:7px 14px;font-size:13px">‚Üê –ù–∞–∑–∞–¥</button>
    <h1>–ü–∞–Ω–µ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</h1>
  </div>
  <div class="dtabs">
    <div class="dt on" onclick="dTab('bg',this)">üñº –§–æ–Ω—ã</div>
    <div class="dt" onclick="dTab('ch',this)">üë§ –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</div>
    <div class="dt" onclick="dTab('sc',this)">üìú –°—Ü–µ–Ω—ã</div>
    <div class="dt" onclick="dTab('set',this)">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
  </div>
  <div class="dc" id="dc"></div>
</div>

</div>

<div class="modal" id="M-code"><div class="mbox">
  <h2>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞</h2>
  <div class="fg">
    <label for="i-code">–ö–æ–¥</label>
    <input type="password" id="i-code" name="access-code" placeholder="–ö–æ–¥‚Ä¶" maxlength="10">
  </div>
  <div class="err-msg" id="code-err" style="display:none">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥</div>
  <div class="brow">
    <button class="bp" onclick="checkCode()">–í–æ–π—Ç–∏</button>
    <button class="bs" onclick="hideM('M-code')">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div></div>

<div class="modal" id="M-bg"><div class="mbox mlg">
  <h2><span id="bg-t">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ–Ω</span><button class="mx" onclick="hideM('M-bg')">‚úï</button></h2>
  <div class="fg">
    <label for="bg-name">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
    <input id="bg-name" name="bg-name" placeholder="–õ–µ—Å, –®–∫–æ–ª–∞‚Ä¶">
  </div>
  <div class="fg">
    <label for="bg-file">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
    <label class="fbtn">üìÅ –í—ã–±—Ä–∞—Ç—å
      <input type="file" accept="image/*" id="bg-file" name="bg-file" style="display:none"
        onchange="pvF(this,'bg-pv',1920,1080,false,'_bgD')">
    </label>
    <img id="bg-pv" class="ipv" style="display:none" alt="preview">
  </div>
  <div class="brow">
    <button class="bp" onclick="saveBg()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="bd" id="bg-del" style="display:none" onclick="delBg()">–£–¥–∞–ª–∏—Ç—å</button>
  </div>
</div></div>

<div class="modal" id="M-ch"><div class="mbox mlg">
  <h2><span id="ch-t">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</span><button class="mx" onclick="hideM('M-ch')">‚úï</button></h2>
  <div class="fg">
    <label for="ch-name">–ò–º—è</label>
    <input id="ch-name" name="ch-name" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞">
  </div>
  <div class="fg">
    <label for="ch-file">–°–ø—Ä–∞–π—Ç (PNG)</label>
    <label class="fbtn">üìÅ –í—ã–±—Ä–∞—Ç—å
      <input type="file" accept="image/*" id="ch-file" name="ch-file" style="display:none"
        onchange="pvF(this,'ch-pv',600,900,true,'_chD')">
    </label>
    <img id="ch-pv" class="ipv" style="display:none" alt="preview">
  </div>
  <div class="brow">
    <button class="bp" onclick="saveCh()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="bd" id="ch-del" style="display:none" onclick="delCh()">–£–¥–∞–ª–∏—Ç—å</button>
  </div>
</div></div>

<div class="modal" id="M-sc"><div class="mbox mlg" style="max-height:88vh">
  <h2><span id="sc-t">–î–æ–±–∞–≤–∏—Ç—å —Å—Ü–µ–Ω—É</span><button class="mx" onclick="hideM('M-sc')">‚úï</button></h2>
  <div id="sc-ed"></div>
</div></div>

<div id="toast"></div>

<script>
const CODE='050412';
let D={title:'–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ',bgs:[],chars:[],scenes:[],start:null};
let curTab='bg',editId=null,eScData=null;
window._bgD=null;window._chD=null;
let G={sid:null,step:0,typing:false,timer:null,full:''};
let debugLog=[];

function dbg(msg){
  console.log('[VN]',msg);
  debugLog.push(msg);
  if(debugLog.length>8)debugLog.shift();
  const el=document.getElementById('g-debug');
  if(el)el.textContent=debugLog.join('\n');
}

async function api(method,body){
  try{
    const opt={method,headers:{'Content-Type':'application/json'}};
    if(body)opt.body=JSON.stringify(body);
    const r=await fetch('/api/data',opt);
    if(!r.ok)throw new Error('HTTP '+r.status);
    return await r.json();
  }catch(e){console.error('API:',e);return null}
}
async function loadData(){
  const d=await api('GET');
  if(d){D=d;D.title=D.title||'–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ';D.bgs=D.bgs||[];D.chars=D.chars||[];D.scenes=D.scenes||[];return true}
  return false;
}
async function save(){const ok=await api('POST',D);if(!ok)toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!',1);return!!ok}

function uid(){return'i'+Date.now()+'_'+Math.random().toString(36).substr(2,6)}
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function $(id){return document.getElementById(id)}

function scr(id){
  document.querySelectorAll('.scr').forEach(s=>s.classList.remove('on'));
  $(id).classList.add('on');
  dbg('screen: '+id);
}
function showM(id){$(id).classList.add('on')}
function hideM(id){$(id).classList.remove('on')}
function toast(m,err){const t=$('toast');t.textContent=m;
  t.style.background=err?'var(--bad)':'var(--ok)';t.style.color=err?'#fff':'#000';
  t.classList.add('show');setTimeout(()=>t.classList.remove('show'),4000)}
function updateMenu(){
  $('m-title').textContent=D.title||'–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ';
  const ss=D.start?D.scenes.find(s=>s.id===D.start):null;
  const st=$('menu-status');const btn=$('btn-play');
  if(!D.scenes.length){st.innerHTML='<div class="st-no">‚ùå –ù–æ–≤–µ–ª–ª–∞ –ø—É—Å—Ç–∞ ‚Äî –Ω–∞–∂–º–∏—Ç–µ üîß</div>';btn.disabled=true}
  else if(!D.start||!ss){st.innerHTML='<div class="st-no">‚ö†Ô∏è –ù–µ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–π —Å—Ü–µ–Ω—ã ‚Äî üîß‚Üí–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>';btn.disabled=true}
  else if(!ss.steps||!ss.steps.length){st.innerHTML='<div class="st-no">‚ö†Ô∏è –°—Ü–µ–Ω–∞ –ø—É—Å—Ç–∞</div>';btn.disabled=true}
  else{st.innerHTML=`<div class="st-ok">‚úÖ ${D.scenes.length} —Å—Ü–µ–Ω ¬∑ ¬´${esc(ss.name)}¬ª</div>`;btn.disabled=false}
}

function openCode(){$('i-code').value='';$('code-err').style.display='none';showM('M-code');$('i-code').focus()}
$('i-code').addEventListener('keydown',e=>{if(e.key==='Enter')checkCode()});
async function checkCode(){
  if($('i-code').value!==CODE){$('code-err').style.display='block';return}
  hideM('M-code');await loadData();updateMenu();scr('S-dev');renderTab()}
function toMenu(){stopTyping();scr('S-menu');updateMenu()}

function readFile(f){return new Promise(r=>{const x=new FileReader;x.onload=e=>r(e.target.result);x.readAsDataURL(f)})}
function resize(url,mw,mh,png){return new Promise(r=>{const i=new Image;i.onload=()=>{
  let w=i.width,h=i.height;if(w>mw||h>mh){const k=Math.min(mw/w,mh/h);w=Math.round(w*k);h=Math.round(h*k)}
  const c=document.createElement('canvas');c.width=w;c.height=h;
  c.getContext('2d').drawImage(i,0,0,w,h);r(png?c.toDataURL('image/png'):c.toDataURL('image/jpeg',.72))};i.src=url})}
async function pvF(inp,pvId,mw,mh,png,varName){
  if(!inp.files[0])return;const raw=await readFile(inp.files[0]);
  const data=await resize(raw,mw,mh,png);window[varName]=data;
  const p=$(pvId);p.src=data;p.style.display='block'}

function dTab(t,el){curTab=t;document.querySelectorAll('.dt').forEach(x=>x.classList.remove('on'));
  if(el)el.classList.add('on');renderTab()}
function renderTab(){const c=$('dc');
  if(curTab==='bg')rBgs(c);else if(curTab==='ch')rChars(c);
  else if(curTab==='sc')rScenes(c);else rSettings(c)}

function rBgs(c){let h='<div class="dgrid">';
  D.bgs.forEach(b=>{h+=`<div class="dcard" onclick="eBg('${b.id}')">
    <div class="dcimg" style="background-image:url('${b.data}')"></div>
    <div class="dcinf"><div class="dcn">${esc(b.name)}</div><div class="dcs">–§–æ–Ω</div></div></div>`});
  h+=`<div class="dcard dcadd" onclick="aBg()"><div class="ico">+</div><span>–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ–Ω</span></div></div>`;
  c.innerHTML=h}
function aBg(){editId=null;_bgD=null;$('bg-t').textContent='–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ–Ω';$('bg-name').value='';
  $('bg-file').value='';$('bg-pv').style.display='none';$('bg-del').style.display='none';showM('M-bg')}
function eBg(id){const b=D.bgs.find(x=>x.id===id);if(!b)return;editId=id;_bgD=null;
  $('bg-t').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';$('bg-name').value=b.name;$('bg-file').value='';
  $('bg-pv').src=b.data;$('bg-pv').style.display='block';$('bg-del').style.display='inline-block';showM('M-bg')}
async function saveBg(){const n=$('bg-name').value.trim();if(!n){toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ',1);return}
  if(editId){const b=D.bgs.find(x=>x.id===editId);if(b){b.name=n;if(_bgD)b.data=_bgD}}
  else{if(!_bgD){toast('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',1);return}D.bgs.push({id:uid(),name:n,data:_bgD})}
  _bgD=null;await save();hideM('M-bg');renderTab();toast('–§–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω')}
async function delBg(){if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;D.bgs=D.bgs.filter(x=>x.id!==editId);
  await save();hideM('M-bg');renderTab();toast('–£–¥–∞–ª–µ–Ω–æ')}

function rChars(c){let h='<div class="dgrid">';
  D.chars.forEach(ch=>{h+=`<div class="dcard" onclick="eCh('${ch.id}')">
    <div class="dcimg" style="background-image:url('${ch.data}');background-size:contain;background-repeat:no-repeat;background-position:center"></div>
    <div class="dcinf"><div class="dcn">${esc(ch.name)}</div><div class="dcs">–ü–µ—Ä—Å–æ–Ω–∞–∂</div></div></div>`});
  h+=`<div class="dcard dcadd" onclick="aCh()"><div class="ico">+</div><span>–î–æ–±–∞–≤–∏—Ç—å</span></div></div>`;
  c.innerHTML=h}
function aCh(){editId=null;_chD=null;$('ch-t').textContent='–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞';$('ch-name').value='';
  $('ch-file').value='';$('ch-pv').style.display='none';$('ch-del').style.display='none';showM('M-ch')}
function eCh(id){const ch=D.chars.find(x=>x.id===id);if(!ch)return;editId=id;_chD=null;
  $('ch-t').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';$('ch-name').value=ch.name;$('ch-file').value='';
  $('ch-pv').src=ch.data;$('ch-pv').style.display='block';$('ch-del').style.display='inline-block';showM('M-ch')}
async function saveCh(){const n=$('ch-name').value.trim();if(!n){toast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è',1);return}
  if(editId){const ch=D.chars.find(x=>x.id===editId);if(ch){ch.name=n;if(_chD)ch.data=_chD}}
  else{if(!_chD){toast('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',1);return}D.chars.push({id:uid(),name:n,data:_chD})}
  _chD=null;await save();hideM('M-ch');renderTab();toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')}
async function delCh(){if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;D.chars=D.chars.filter(x=>x.id!==editId);
  await save();hideM('M-ch');renderTab();toast('–£–¥–∞–ª–µ–Ω–æ')}

function rScenes(c){let h='<div class="dgrid">';
  D.scenes.forEach(sc=>{const isS=sc.id===D.start;const bg=D.bgs.find(b=>b.id===sc.bgId);
    h+=`<div class="dcard${isS?' start':''}" onclick="eSc('${sc.id}')">
      <div class="dcimg" style="${bg?`background-image:url('${bg.data}')`:'display:flex;align-items:center;justify-content:center;font-size:38px;color:var(--sub)'}">
        ${bg?'':'üìú'}</div>
      <div class="dcinf"><div class="dcn">${esc(sc.name||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
      <div class="dcs">${isS?'‚≠ê –ù–∞—á–∞–ª—å–Ω–∞—è':sc.steps.length+' —à–∞–≥(–æ–≤)'}</div></div></div>`});
  h+=`<div class="dcard dcadd" onclick="aSc()"><div class="ico">+</div><span>–î–æ–±–∞–≤–∏—Ç—å —Å—Ü–µ–Ω—É</span></div></div>`;
  c.innerHTML=h}

function mkStep(){return{chId:null,pos:'center',text:'',hasCh:false,choices:[]}}
function aSc(){editId=null;eScData={id:uid(),name:'',bgId:null,steps:[mkStep()],next:null};
  $('sc-t').textContent='–î–æ–±–∞–≤–∏—Ç—å —Å—Ü–µ–Ω—É';rScEd();showM('M-sc')}
function eSc(id){const sc=D.scenes.find(s=>s.id===id);if(!sc)return;editId=id;
  eScData=JSON.parse(JSON.stringify(sc));
  eScData.steps.forEach(s=>{if(s.hasCh===undefined)s.hasCh=!!(s.choices&&s.choices.length)});
  $('sc-t').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';rScEd();showM('M-sc')}

function gather(){const ed=$('sc-ed');if(!ed)return;
  const v=x=>ed.querySelector(x);
  const ni=v('#sce-name');if(ni)eScData.name=ni.value;
  const bi=v('#sce-bg');if(bi)eScData.bgId=bi.value||null;
  const nsi=v('#sce-next');if(nsi)eScData.next=nsi.value||null;
  ed.querySelectorAll('.si').forEach((el,i)=>{const s=eScData.steps[i];if(!s)return;
    const gv=x=>el.querySelector(x);
    const ch=gv('.sc-ch');if(ch)s.chId=ch.value||null;
    const ps=gv('.sc-ps');if(ps)s.pos=ps.value;
    const tx=gv('.sc-tx');if(tx)s.text=tx.value;
    el.querySelectorAll('.crow').forEach((cr,ci)=>{if(!s.choices[ci])return;
      const ct=cr.querySelector('.sc-ct');if(ct)s.choices[ci].text=ct.value;
      const cs=cr.querySelector('.sc-cs');if(cs)s.choices[ci].target=cs.value||null})})}

function rScEd(){const sc=eScData;
  const bgO=D.bgs.map(b=>`<option value="${b.id}"${sc.bgId===b.id?' selected':''}>${esc(b.name)}</option>`).join('');
  const allSc=D.scenes.filter(s=>s.id!==sc.id);let stH='';
  sc.steps.forEach((st,i)=>{
    const chO=D.chars.map(c=>`<option value="${c.id}"${st.chId===c.id?' selected':''}>${esc(c.name)}</option>`).join('');
    let chcH='';
    if(st.hasCh){
      chcH='<div class="csec"><label style="font-size:11px;color:var(--sub)">–í–∞—Ä–∏–∞–Ω—Ç—ã:</label>';
      (st.choices||[]).forEach((ch,ci)=>{
        const csO=allSc.map(s=>`<option value="${s.id}"${ch.target===s.id?' selected':''}>${esc(s.name)}</option>`).join('');
        chcH+=`<div class="crow"><input class="sc-ct" name="ct-${i}-${ci}" value="${esc(ch.text)}" placeholder="–¢–µ–∫—Å—Ç">
          <select class="sc-cs" name="cs-${i}-${ci}"><option value="">‚Üí –°—Ü–µ–Ω–∞‚Ä¶</option>${csO}</select>
          <button onclick="gather();eScData.steps[${i}].choices.splice(${ci},1);rScEd()">‚úï</button></div>`});
      chcH+=`<button class="bsm" onclick="gather();eScData.steps[${i}].choices.push({text:'',target:null});rScEd()">+ –í–∞—Ä–∏–∞–Ω—Ç</button></div>`}
    stH+=`<div class="si"><div class="sih"><span class="sin">–®–∞–≥ ${i+1}</span><div class="sia">
      ${i>0?`<button onclick="gather();swSt(${i},-1)">‚Üë</button>`:''}
      ${i<sc.steps.length-1?`<button onclick="gather();swSt(${i},1)">‚Üì</button>`:''}
      ${sc.steps.length>1?`<button onclick="gather();eScData.steps.splice(${i},1);rScEd()">‚úï</button>`:''}
    </div></div>
    <div class="sf">
      <div><label for="sch${i}">–ü–µ—Ä—Å–æ–Ω–∞–∂</label><select class="sc-ch" id="sch${i}" name="sch${i}"><option value="">‚Äî –†–∞—Å—Å–∫–∞–∑—á–∏–∫ ‚Äî</option>${chO}</select></div>
      <div><label for="sps${i}">–ü–æ–∑–∏—Ü–∏—è</label><select class="sc-ps" id="sps${i}" name="sps${i}">
        <option value="left"${st.pos==='left'?' selected':''}>–°–ª–µ–≤–∞</option>
        <option value="center"${st.pos==='center'?' selected':''}>–ü–æ —Ü–µ–Ω—Ç—Ä—É</option>
        <option value="right"${st.pos==='right'?' selected':''}>–°–ø—Ä–∞–≤–∞</option></select></div>
      <div class="fw"><label for="stx${i}">–¢–µ–∫—Å—Ç</label><textarea class="sc-tx" id="stx${i}" name="stx${i}" placeholder="–î–∏–∞–ª–æ–≥‚Ä¶">${esc(st.text)}</textarea></div>
    </div>
    <div class="cbtog">
      <input type="checkbox" id="cb${i}" name="cb${i}"${st.hasCh?' checked':''}
        onchange="gather();eScData.steps[${i}].hasCh=this.checked;if(this.checked&&(!eScData.steps[${i}].choices||!eScData.steps[${i}].choices.length))eScData.steps[${i}].choices=[{text:'',target:null}];rScEd()">
      <label for="cb${i}">–í–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞</label>
    </div>${chcH}</div>`});
  const nxO=allSc.map(s=>`<option value="${s.id}"${sc.next===s.id?' selected':''}>${esc(s.name)}</option>`).join('');
  $('sc-ed').innerHTML=`
    <div class="fg"><label for="sce-name">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="sce-name" name="sce-name" value="${esc(sc.name)}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ‚Ä¶"></div>
    <div class="fg"><label for="sce-bg">–§–æ–Ω</label><select id="sce-bg" name="sce-bg"><option value="">‚Äî –ë–µ–∑ —Ñ–æ–Ω–∞ ‚Äî</option>${bgO}</select></div>
    <div class="fg"><label>–®–∞–≥–∏</label><div class="steps">${stH}</div>
      <button class="bsm" onclick="gather();eScData.steps.push(mkStep());rScEd()" style="margin-top:12px">+ –®–∞–≥</button></div>
    <div class="fg"><label for="sce-next">–°–ª–µ–¥—É—é—â–∞—è —Å—Ü–µ–Ω–∞</label>
      <select id="sce-next" name="sce-next"><option value="">‚Äî –ö–æ–Ω–µ—Ü ‚Äî</option>${nxO}</select></div>
    <div class="brow" style="margin-top:18px">
      <button class="bp" onclick="saveSc()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      ${editId?'<button class="bd" onclick="delSc()">–£–¥–∞–ª–∏—Ç—å</button>':''}</div>`}

function swSt(i,d){const s=eScData.steps;[s[i],s[i+d]]=[s[i+d],s[i]];rScEd()}
async function saveSc(){gather();const sc=eScData;sc.name=sc.name||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
  sc.steps.forEach(s=>{if(!s.hasCh)s.choices=[]});
  if(editId){const idx=D.scenes.findIndex(s=>s.id===editId);if(idx>=0)D.scenes[idx]=sc}
  else{D.scenes.push(sc);if(!D.start)D.start=sc.id}
  await save();hideM('M-sc');renderTab();toast('–°—Ü–µ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞')}
async function delSc(){if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;D.scenes=D.scenes.filter(s=>s.id!==editId);
  if(D.start===editId)D.start=D.scenes.length?D.scenes[0].id:null;
  await save();hideM('M-sc');renderTab();toast('–£–¥–∞–ª–µ–Ω–æ')}

function rSettings(c){
  const scO=D.scenes.map(s=>`<option value="${s.id}"${D.start===s.id?' selected':''}>${esc(s.name)}</option>`).join('');
  c.innerHTML=`
    <div class="setsec"><h3>‚úèÔ∏è –ù–∞–∑–≤–∞–Ω–∏–µ</h3><div class="fg"><label for="st-t">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
      <input id="st-t" name="st-t" value="${esc(D.title)}" onchange="D.title=this.value;save();updateMenu();toast('OK')"></div></div>
    <div class="setsec"><h3>‚≠ê –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ü–µ–Ω–∞</h3><div class="fg"><label for="st-s">–°—Ü–µ–Ω–∞</label>
      <select id="st-s" name="st-s" onchange="D.start=this.value||null;save();updateMenu();toast('OK')">
        <option value="">‚Äî –ù–µ—Ç ‚Äî</option>${scO}</select></div></div>
    <div class="setsec"><h3>üíæ –≠–∫—Å–ø–æ—Ä—Ç / –ò–º–ø–æ—Ä—Ç</h3><div class="brow">
      <button class="bs" onclick="expD()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
      <label class="bs" style="cursor:pointer">üì• –ò–º–ø–æ—Ä—Ç
        <input type="file" accept=".json" name="imp" style="display:none" onchange="impD(this)"></label></div></div>
    <div class="setsec"><h3>üóë –û—á–∏—Å—Ç–∫–∞</h3><button class="bd" onclick="clearAll()">–£–¥–∞–ª–∏—Ç—å –≤—Å—ë</button></div>
    <div class="setsec"><h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
      <p style="color:var(--sub);font-size:13px">–§–æ–Ω–æ–≤: ${D.bgs.length} ¬∑ –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π: ${D.chars.length} ¬∑ –°—Ü–µ–Ω: ${D.scenes.length}</p></div>`}
function expD(){const b=new Blob([JSON.stringify(D,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='novel.json';a.click()}
async function impD(inp){if(!inp.files[0])return;try{const t=await inp.files[0].text();const d=JSON.parse(t);
  if(d.bgs&&d.scenes){D=d;await save();renderTab();updateMenu();toast('OK')}
  else toast('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞',1)}catch(e){toast('–û—à–∏–±–∫–∞',1)}}
async function clearAll(){if(!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï?'))return;
  D={title:'–Ø –ù–ï –ü–†–ò–î–£–ú–ê–õ',bgs:[],chars:[],scenes:[],start:null};
  await save();renderTab();updateMenu();toast('–û—á–∏—â–µ–Ω–æ')}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GAME ENGINE ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ–π
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

async function startGame(){
  debugLog=[];
  dbg('–ó–∞–≥—Ä—É–∑–∫–∞...');

  const ok=await loadData();
  if(!ok){toast('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞!',1);return}
  updateMenu();

  dbg('–°—Ü–µ–Ω: '+D.scenes.length+' start='+D.start);

  if(!D.scenes.length){toast('–ù–æ–≤–µ–ª–ª–∞ –ø—É—Å—Ç–∞!',1);return}
  const startScene=D.scenes.find(s=>s.id===D.start);
  if(!startScene){toast('–ù–µ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–π —Å—Ü–µ–Ω—ã!',1);return}
  if(!startScene.steps||!startScene.steps.length){toast('–°—Ü–µ–Ω–∞ –ø—É—Å—Ç–∞!',1);return}

  dbg('–°—Ç–∞—Ä—Ç: ¬´'+startScene.name+'¬ª —à–∞–≥–æ–≤='+startScene.steps.length);

  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω
  scr('S-game');

  // –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å
  $('g-end').classList.remove('on');
  $('g-choices').classList.remove('on');
  $('g-char').classList.remove('vis','pl','pc','pr');
  $('g-char').style.display='none';
  $('g-name').textContent='';
  $('g-txt').textContent='';

  // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –¥–µ–ª–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤–∏–¥–∏–º—ã–º
  var dlg=$('g-dlg');
  dlg.style.display='block';
  dlg.style.visibility='visible';
  dlg.style.opacity='1';

  dbg('–≠–∫—Ä–∞–Ω –≥–æ—Ç–æ–≤, –∑–∞–ø—É—Å–∫ —Å—Ü–µ–Ω—ã...');

  // –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ü–µ–Ω—É –Ω–∞–ø—Ä—è–º—É—é
  doLoadScene(D.start);
}

function doLoadScene(sid){
  dbg('doLoadScene: '+sid);

  var sc=D.scenes.find(function(s){return s.id===sid});

  if(!sc){
    dbg('–û–®–ò–ë–ö–ê: —Å—Ü–µ–Ω–∞ '+sid+' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
    dbg('–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ü–µ–Ω—ã: '+D.scenes.map(function(s){return s.id}).join(', '));
    endGame();
    return;
  }

  if(!sc.steps||sc.steps.length===0){
    dbg('–°—Ü–µ–Ω–∞ –ø—É—Å—Ç–∞ ‚Üí next='+sc.next);
    if(sc.next){doLoadScene(sc.next)}else{endGame()}
    return;
  }

  G.sid=sid;
  G.step=0;

  // —Å—Ç–∞–≤–∏–º —Ñ–æ–Ω
  var bg=D.bgs.find(function(b){return b.id===sc.bgId});
  var bgEl=$('g-bg');
  if(bg){
    bgEl.style.backgroundImage='url('+bg.data+')';
    dbg('–§–æ–Ω: '+bg.name);
  }else{
    bgEl.style.backgroundImage='none';
    bgEl.style.backgroundColor='#1e1e3e';
    dbg('–§–æ–Ω: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π');
  }

  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —à–∞–≥
  doShowStep();
}

function doShowStep(){
  var sc=D.scenes.find(function(s){return s.id===G.sid});
  if(!sc){dbg('–ù–µ—Ç —Å—Ü–µ–Ω—ã!');endGame();return}

  if(G.step>=sc.steps.length){
    dbg('–í—Å–µ —à–∞–≥–∏ –ø—Ä–æ–π–¥–µ–Ω—ã ‚Üí next='+sc.next);
    if(sc.next){doLoadScene(sc.next)}else{endGame()}
    return;
  }

  var st=sc.steps[G.step];
  var stepText=st.text||'(–ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç)';

  dbg('–®–∞–≥ '+(G.step+1)+'/'+sc.steps.length+': ¬´'+stepText.substring(0,30)+'...¬ª');

  // –ø–µ—Ä—Å–æ–Ω–∞–∂
  var cel=$('g-char');
  if(st.chId){
    var ch=D.chars.find(function(c){return c.id===st.chId});
    if(ch){
      cel.src=ch.data;
      cel.className='';
      cel.classList.add(st.pos==='left'?'pl':st.pos==='right'?'pr':'pc');
      cel.classList.add('vis');
      cel.style.display='block';
      $('g-name').textContent=ch.name;
      dbg('–ü–µ—Ä—Å–æ–Ω–∞–∂: '+ch.name);
    }else{
      cel.style.display='none';cel.classList.remove('vis');
      $('g-name').textContent='';
    }
  }else{
    cel.style.display='none';cel.classList.remove('vis');
    $('g-name').textContent='';
  }

  // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û —Å—Ç–∞–≤–∏–º —Ç–µ–∫—Å—Ç
  var txtEl=$('g-txt');
  txtEl.style.color='#ffffff';
  txtEl.style.fontSize='18px';

  // –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–∞–±–æ—Ä —Ç–µ–∫—Å—Ç–∞
  doTypeText(stepText);

  // –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
  $('g-ind').style.display=(st.hasCh&&st.choices&&st.choices.length)?'none':'block';
}

function doTypeText(text){
  stopTyping();
  G.full=text;
  G.typing=true;

  var el=$('g-txt');
  var i=0;
  el.textContent='';

  dbg('–ü–µ—á–∞—Ç–∞—é: ¬´'+text.substring(0,40)+'¬ª');

  G.timer=setInterval(function(){
    if(i<text.length){
      el.textContent=el.textContent+text[i];
      i++;
    }else{
      stopTyping();
      dbg('–¢–µ–∫—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
      doAfterType();
    }
  },30);
}

function stopTyping(){
  if(G.timer){clearInterval(G.timer);G.timer=null}
  G.typing=false;
}

function doAfterType(){
  var sc=D.scenes.find(function(s){return s.id===G.sid});
  if(!sc)return;
  var st=sc.steps[G.step];
  if(st&&st.hasCh&&st.choices&&st.choices.length){
    dbg('–ü–æ–∫–∞–∑—ã–≤–∞—é '+st.choices.length+' –≤–∞—Ä–∏–∞–Ω—Ç(–æ–≤)');
    doShowChoices(st.choices);
  }
}

function advance(){
  if(G.typing){
    stopTyping();
    $('g-txt').textContent=G.full;
    doAfterType();
    return;
  }
  var sc=D.scenes.find(function(s){return s.id===G.sid});
  if(!sc)return;
  var st=sc.steps[G.step];
  if(st&&st.hasCh&&st.choices&&st.choices.length)return;

  G.step++;
  dbg('‚Üí —à–∞–≥ '+G.step);

  if(G.step>=sc.steps.length){
    if(sc.next){doLoadScene(sc.next)}else{endGame()}
  }else{
    doShowStep();
  }
}

function doShowChoices(choices){
  var c=$('g-choices');
  var html='';
  for(var i=0;i<choices.length;i++){
    html+='<button class="chb" onclick="doPick('+i+')">'+esc(choices[i].text||'–í–∞—Ä–∏–∞–Ω—Ç '+(i+1))+'</button>';
  }
  c.innerHTML=html;
  c.classList.add('on');
}

function doPick(i){
  var sc=D.scenes.find(function(s){return s.id===G.sid});
  if(!sc)return;
  var st=sc.steps[G.step];
  if(!st||!st.choices||!st.choices[i])return;
  $('g-choices').classList.remove('on');
  var t=st.choices[i].target;
  dbg('–í—ã–±–æ—Ä '+i+' ‚Üí '+(t||'–∫–æ–Ω–µ—Ü'));
  if(t){doLoadScene(t)}else{endGame()}
}

function endGame(){
  stopTyping();
  dbg('*** –ö–û–ù–ï–¶ ***');
  $('g-end').classList.add('on');
}


/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
(async function(){
  if(window.Telegram&&Telegram.WebApp){Telegram.WebApp.ready();Telegram.WebApp.expand()}
  await loadData();
  updateMenu();
  $('loader').classList.add('hide');
  setTimeout(function(){$('loader').style.display='none'},600);
})();
</script>
</body>
</html>
